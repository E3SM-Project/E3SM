===============
ABOUT THIS TOOL
===============

The src/ directory here contains F90 files and a Makefile to produce the
runoff_map executable. The executable reads runoff_map.nml and produces three
maps:

1) A nearest neighbor mapping from the rof grid to the ocean grid.
   * The optional file_ocn_coast_mask file allows mapping to a subset of ocean
     cells, presumably the coastal cells)
2) A smoothing map from the ocean grid to the ocean grid.
   * The optional file_ocn_coast_mask file allows mapping from a subset of
     ocean cells, presumably the coastal cells)
   * By default, the source domain of this map is only cells that appear as
     destination cells of the nearest neighbor map. Optionally, one can
     generate a map that maps from all ocean cells, even if they are not
     destination cells of the nearest neighbor map. This option allows the
     smoothing map to be reused when mapping from multiple runoff grids onto
     the same ocean grid.
3) The product of the previous two maps.

The ncl/ directory contains an NCL script to compute a fourth map (which is
actually a combination of two existing maps):

4) Map (1) from above for rof grid cells that map into the open ocean, or map
   (3) for the rof grid cells that map into a marginal sea.

====================
HOW TO USE THIS TOOL
====================

1) Build (see the INSTALL file in this directory for details)
2) Setup a namelist file (see any of runoff_map_*.nml for an example)
3) Run with the following command:
$ ./runoff_map < [namelist file]
4) Run ./run_merge_mapping_files.sh (will produce map 4)

============
HOW TO BUILD
============

See INSTALL file in this directory

====================
NAMELIST FILE FORMAT
====================

The namelist file must be called "runoff_map.nml".  That name is hardwired
into the executable.

The namelist looks like this

where

&input_nml
   gridtype     = 'rtm'
   file_roff    = '/glade/p/cesm/cseg/inputdata/lnd/clm2/rtmdata/rdirc.05.061026'
   file_ocn     = '/glade/p/cesm/cseg/mapping/grids/gx1v7_151008.nc'
   file_ocn_coastal_mask = '/glade/p/cesm/cseg/mapping/grids/gx1v7_coast_170322.nc'
   file_nn      = 'map_r05_to_gx1v7_coast_nearestdtos_170324.nc'
   file_smooth  = 'map_gx1v7_coast_to_gx1v7_sm_e1000r300_170324.nc'
   file_new     = 'map_r05_to_gx1v7_nnsm_e1000r300_170324.nc'
   title        = 'runoff map: r05 -> gx1v7, nearest neighbor and smoothed'
   eFold        = 1000000.0
   rMax         =  300000.0
   restrict_smooth_src_to_nn_dest = .true.
   step1 = .true.
   step2 = .true.
   step3 = .true.
/

Input grid files:
  gridtype =  type of file_roff file, "rtm" or "obs" or "scrip"
              * rtm is a 720 x 360 grid ascii file
              * obs is a netcdf file with xc, yc, xv, yv, mask and area variable names
              * scrip is a scrip type grid file (must contain grid_area along with
                typical scrip grid variables)
  file_roff  =  an ascii rdirc file OR an obs rtm file OR a scrip grid file
  file_ocn   =  a scrip ocean grid file where the mask is 1 for all ocean grid
                cells (see note 3 below)
  file_ocn_coastal_mask  =  a scrip ocean grid file where the mask is only 1
                            for coastal grid cells (see note 3 below)

NOTES:
1) gridtype, file_roff, and file_ocn MUST be specified in the namelist
2) if file_ocn_coastal_mask is not specified, file_ocn will be used
3) The file_ocn and file_ocn_coast_mask must be standard scrip grid files that
   include the cell area

Input parameters:
  eFold = smoothing eFold distance in meters (default: 1000000)
  rMax  = maximum radius of effect in meters (default: 300000)

Settings:
  title                 = ascii string to add to mapping files (default: 'unset')
  restrict_smooth_src_to_nn_dest = option to limit the srouce points for step2 to
                                   just the points that get mapped to in step1; if
                                   false, use all ocean points in
                                   file_ocn_coastal_mask instead (default: .true.)
  step1                 = computes nearest neighbor map (default: .true.)
  step2                 = computes smooth map (default: .true.)
  step3                 = multiply two maps together (default: .true.)

Output fields:
  file_nn     = nearest neighbor mapping file (default: 'nn.nc')
  file_smooth = smoother mapping file (default: 'smooth.nc')
  file_new    = combined file (default: 'nnsm.nc')


==========
HOW TO RUN
==========

Execute the binary ./runoff_map (again, this will read the runoff_map.nml
namelist file - see above section for tips on creating the file)

