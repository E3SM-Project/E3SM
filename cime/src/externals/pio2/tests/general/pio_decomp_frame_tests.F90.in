! Get a 3D column decomposition
! If force_rearrange is FALSE, the decomposition is such that
! # All even procs have VEC_HGT_SZ blocks of 
! (VEC_COL_SZ rows x VEC_ROW_SZ columns) elements
! # All odd procs have  VEC_HGT_SZ blocks of
! (VEC_COL_SZ rows x VEC_ROW_SZ + 1 columns) elements
! e.g. For VEC_ROW_SZ = 2, VEC_COL_SZ = 2, VEC_HGT_SZ = 2
! and ranks 0, 1, 2,
! e.g. 1) |(1,1,1) (1,2,1) (2,1,1) (2,2,1)|
!         |(1,1,2) (1,2,2) (2,1,2) (2,2,2)| ,
!         |(1,3,1) (1,4,1) (1,5,1) (2,3,1) (2,4,1) (2,5,1)|
!         |(1,3,2) (1,4,2) (1,5,2) (2,3,2) (2,4,2) (2,5,2)|,
!         |(1,6,1) (1,7,1) (2,6,1) (2,7,1)|
!         |(1,6,2) (1,7,2) (2,6,2) (2,7,2)|
! If force_rearrange is TRUE, the decomposition is such that,
! If possible, the even rank "exchanges" elements with the next
! higher ranked odd proc.
! e.g. For VEC_ROW_SZ = 2, VEC_COL_SZ = 2, VEC_HGT_SZ = 2
! and ranks 0, 1, 2,
! e.g. 1  |(1,3,1) (1,4,1) (1,5,1) (2,3,1) (2,4,1) (2,5,1)|
!         |(1,3,2) (1,4,2) (1,5,2) (2,3,2) (2,4,2) (2,5,2)|,
!         |(1,1,1) (1,2,1) (2,1,1) (2,2,1)|
!         |(1,1,2) (1,2,2) (2,1,2) (2,2,2)| ,
!         |(1,6,1) (1,7,1) (2,6,1) (2,7,1)|
!         |(1,6,2) (1,7,2) (2,6,2) (2,7,2)|
! This for example can be used to force rearrangement when reading
! or writing data.
SUBROUTINE get_3d_col_decomp_info(rank, sz, dims, start, count, force_rearrange)
  integer, parameter :: VEC_ROW_SZ = 2
  integer, parameter :: VEC_COL_SZ = 2
  integer, parameter :: VEC_HGT_SZ = 2
  integer, parameter :: NDIMS = 3
  integer, intent(in) :: rank
  integer, intent(in) :: sz
  integer, dimension(NDIMS), intent(out) :: dims
  integer, dimension(NDIMS), intent(out) :: start
  integer, dimension(NDIMS), intent(out) :: count
  logical, intent(in) :: force_rearrange

  logical :: is_even_rank
  integer :: num_odd_procs, num_even_procs
  integer :: iodd, ieven

  is_even_rank = .false.
  if (mod(rank, 2) == 0) then
    is_even_rank = .true.
  end if
  num_odd_procs = sz / 2
  num_even_procs = sz - num_odd_procs
  dims(1) = VEC_COL_SZ
  dims(2) = num_even_procs * VEC_ROW_SZ + num_odd_procs * (VEC_ROW_SZ + 1)
  dims(3) = VEC_HGT_SZ
  ! Number of odd and even procs before this rank
  iodd = rank / 2
  ieven = (rank + 1) / 2

  ! Rows
  start(1) = 1
  count(1) = VEC_COL_SZ

  ! Columns
  if(force_rearrange) then
    ! Make sure that we force rearrangement
    if (is_even_rank) then
      if(rank + 1 < sz) then
        ! Force rearrangement
        count(2) = VEC_ROW_SZ + 1
        start(2) = ieven * VEC_ROW_SZ + iodd * (VEC_ROW_SZ + 1) + (VEC_ROW_SZ) + 1
      else
        count(2) = VEC_ROW_SZ
        start(2) = ieven * VEC_ROW_SZ + iodd * (VEC_ROW_SZ + 1) + 1
      end if
    else
      ! For all odd procs there is an even lower ranked, rank-1, proc
      ! So force rearrangement
      count(2) = VEC_ROW_SZ
      start(2) = ieven * VEC_ROW_SZ + iodd * (VEC_ROW_SZ + 1) - (VEC_ROW_SZ) + 1
    end if
  else
    if (is_even_rank) then
      count(2) = VEC_ROW_SZ
    else
      count(2) = VEC_ROW_SZ + 1
    end if
    start(2) = ieven * VEC_ROW_SZ + iodd * (VEC_ROW_SZ + 1) + 1
  end if

  ! Height
  start(3) = 1
  count(3) = VEC_HGT_SZ
END SUBROUTINE

! Write with one decomp (to force rearrangement) and read with another (no
! rearrangement)

SUBROUTINE nc_write_read_4d_col_decomp_PIO_int_integer__
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 6
  type(var_desc_t)  :: pio_var
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  integer, dimension(:,:,:,:), allocatable :: rbuf, wbuf, exp_val
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:115
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(wbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf(i,j,k,f) = wbuf(i,j,k,f) + int(f - 1) * (dims(1) * dims(2) * dims(3))
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) = int(wbuf(i,j,k,1))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:137
  call PIO_initdecomp(pio_tf_iosystem_, PIO_int, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:140
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  allocate(exp_val(nrows, ncols, nhgts, NFRAMES))
   ! pio_decomp_frame_tests.F90.in:150
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val(i,j,k,f) = compdof(tmp_idx) + int(f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:163
  call PIO_initdecomp(pio_tf_iosystem_, PIO_int, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:166
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_int : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:173)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:174
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:176)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:177
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:179)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:180
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:182)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:183
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time', pio_unlimited, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:185)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:186
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_var', PIO_int, pio_dims, pio_var)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:188)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:189
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:191)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:192
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var, wr_iodesc, wbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:197)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:199
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:201
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      call PIO_read_darray(pio_file, pio_var, rd_iodesc, rbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:205)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:207
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf(:,:,:,f), exp_val(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:209)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:211
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:216
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:221
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
  deallocate(exp_val)
  deallocate(rbuf)
  deallocate(wbuf)
END SUBROUTINE nc_write_read_4d_col_decomp_PIO_int_integer__


SUBROUTINE nc_write_read_4d_col_decomp_PIO_real_real_kind_fc_real___
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 6
  type(var_desc_t)  :: pio_var
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  real(kind=fc_real), dimension(:,:,:,:), allocatable :: rbuf, wbuf, exp_val
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:115
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(wbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf(i,j,k,f) = wbuf(i,j,k,f) + real(f - 1) * real(dims(1) * dims(2) * dims(3))
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) = int(wbuf(i,j,k,1))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:137
  call PIO_initdecomp(pio_tf_iosystem_, PIO_real, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:140
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  allocate(exp_val(nrows, ncols, nhgts, NFRAMES))
   ! pio_decomp_frame_tests.F90.in:150
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val(i,j,k,f) = compdof(tmp_idx) + real(f - 1) * real(dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:163
  call PIO_initdecomp(pio_tf_iosystem_, PIO_real, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:166
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_real : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:173)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:174
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:176)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:177
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:179)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:180
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:182)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:183
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time', pio_unlimited, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:185)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:186
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_var', PIO_real, pio_dims, pio_var)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:188)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:189
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:191)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:192
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var, wr_iodesc, wbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:197)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:199
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:201
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      call PIO_read_darray(pio_file, pio_var, rd_iodesc, rbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:205)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:207
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf(:,:,:,f), exp_val(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:209)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:211
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:216
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:221
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
  deallocate(exp_val)
  deallocate(rbuf)
  deallocate(wbuf)
END SUBROUTINE nc_write_read_4d_col_decomp_PIO_real_real_kind_fc_real___


SUBROUTINE nc_write_read_4d_col_decomp_PIO_double_real_kind_fc_double___
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 6
  type(var_desc_t)  :: pio_var
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  real(kind=fc_double), dimension(:,:,:,:), allocatable :: rbuf, wbuf, exp_val
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:115
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(wbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf(i,j,k,f) = wbuf(i,j,k,f) + (f - 1) * (dims(1) * dims(2) * dims(3))
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) = int(wbuf(i,j,k,1))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:137
  call PIO_initdecomp(pio_tf_iosystem_, PIO_double, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:140
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  allocate(exp_val(nrows, ncols, nhgts, NFRAMES))
   ! pio_decomp_frame_tests.F90.in:150
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val(i,j,k,f) = compdof(tmp_idx) + (f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:163
  call PIO_initdecomp(pio_tf_iosystem_, PIO_double, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:166
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_double : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:173)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:174
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:176)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:177
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:179)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:180
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:182)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:183
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time', pio_unlimited, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:185)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:186
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_var', PIO_double, pio_dims, pio_var)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:188)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:189
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:191)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:192
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var, wr_iodesc, wbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:197)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:199
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:201
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      call PIO_read_darray(pio_file, pio_var, rd_iodesc, rbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:205)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:207
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf(:,:,:,f), exp_val(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:209)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:211
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:216
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:221
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
  deallocate(exp_val)
  deallocate(rbuf)
  deallocate(wbuf)
END SUBROUTINE nc_write_read_4d_col_decomp_PIO_double_real_kind_fc_double___
   ! pio_decomp_frame_tests.F90.in:227

! Using a 3d decomp for writing out a 3d and a 4d var
! Write with one decomp (to force rearrangement) and read with another (no
! rearrangement)

SUBROUTINE nc_reuse_3d_decomp_PIO_int_integer__
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 3
  type(var_desc_t)  :: pio_var3d, pio_var4d
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  integer, dimension(:,:,:,:), allocatable :: rbuf4d, wbuf4d, exp_val4d
  integer, dimension(:,:,:), allocatable :: rbuf3d, wbuf3d, exp_val3d
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:846
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  ! Initialize the 4d var
  allocate(wbuf4d(nrows, ncols, nhgts, NFRAMES))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf4d(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf4d(i,j,k,f) = wbuf4d(i,j,k,f) + int(f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
  allocate(compdof(nrows * ncols * nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
        compdof(tmp_idx) = int(wbuf4d(i,j,k,1))
      end do
    end do
  end do
  ! Initialize the 3d var
  allocate(wbuf3d(nrows, ncols, nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        wbuf3d(i,j,k) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                      (start(2) - 1 + j - 1) * dims(1) + i
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:885
  call PIO_initdecomp(pio_tf_iosystem_, PIO_int, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:888
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf4d(nrows, ncols, nhgts, NFRAMES))
  rbuf4d = 0
  ! Expected val for 4d var
  allocate(exp_val4d(nrows, ncols, nhgts, NFRAMES))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          exp_val4d(i,j,k,f) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val4d(i,j,k,f) = exp_val4d(i,j,k,f) + int(f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
  allocate(compdof(nrows * ncols * nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
        compdof(tmp_idx) = int(exp_val4d(i,j,k,1))
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:919
  allocate(rbuf3d(nrows, ncols, nhgts))
  rbuf3d = 0
  ! Expected val for 3d var
  allocate(exp_val3d(nrows, ncols, nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        exp_val3d(i,j,k) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                            (start(2) - 1 + j - 1) * dims(1) + i
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:932
  call PIO_initdecomp(pio_tf_iosystem_, PIO_int, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:935
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_int : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:942)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:943
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:945)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:946
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:948)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:949
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:951)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:952
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time', pio_unlimited, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:954)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:955
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_3d_var', PIO_int, pio_dims(1:3), pio_var3d)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a 3d var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:957)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:958
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_4d_var', PIO_int, pio_dims, pio_var4d)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a 4d var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:960)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:961
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:963)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:964
    call PIO_write_darray(pio_file, pio_var3d, wr_iodesc, wbuf3d, ierr)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to write 3d darray : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:966)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:967
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var4d, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var4d, wr_iodesc, wbuf4d(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write 4d darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:972)"
        END IF
        RETURN
      END IF
    end do
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:975
    rbuf4d = 0
    rbuf3d = 0
   ! pio_decomp_frame_tests.F90.in:978
    call PIO_read_darray(pio_file, pio_var3d, rd_iodesc, rbuf3d, ierr)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to read 3d darray : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:980)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:981
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var4d, f)
      call PIO_read_darray(pio_file, pio_var4d, rd_iodesc, rbuf4d(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read 4d darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:985)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:987
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf4d(:,:,:,f), exp_val4d(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong 4d val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:989)"
        END IF
        RETURN
      END IF
    end do

    IF (.NOT. PIO_TF_Check_val_(rbuf3d, exp_val3d)) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Check failed:",&
           "Got wrong 3dd val",&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:991)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:992
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:997
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:1002
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
   ! pio_decomp_frame_tests.F90.in:1005
  deallocate(exp_val3d)
  deallocate(rbuf3d)
  deallocate(wbuf3d)
   ! pio_decomp_frame_tests.F90.in:1009
  deallocate(exp_val4d)
  deallocate(rbuf4d)
  deallocate(wbuf4d)
END SUBROUTINE nc_reuse_3d_decomp_PIO_int_integer__


SUBROUTINE nc_reuse_3d_decomp_PIO_real_real_kind_fc_real___
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 3
  type(var_desc_t)  :: pio_var3d, pio_var4d
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  real(kind=fc_real), dimension(:,:,:,:), allocatable :: rbuf4d, wbuf4d, exp_val4d
  real(kind=fc_real), dimension(:,:,:), allocatable :: rbuf3d, wbuf3d, exp_val3d
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:846
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  ! Initialize the 4d var
  allocate(wbuf4d(nrows, ncols, nhgts, NFRAMES))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf4d(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf4d(i,j,k,f) = wbuf4d(i,j,k,f) + real(f - 1) * real(dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
  allocate(compdof(nrows * ncols * nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
        compdof(tmp_idx) = int(wbuf4d(i,j,k,1))
      end do
    end do
  end do
  ! Initialize the 3d var
  allocate(wbuf3d(nrows, ncols, nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        wbuf3d(i,j,k) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                      (start(2) - 1 + j - 1) * dims(1) + i
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:885
  call PIO_initdecomp(pio_tf_iosystem_, PIO_real, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:888
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf4d(nrows, ncols, nhgts, NFRAMES))
  rbuf4d = 0
  ! Expected val for 4d var
  allocate(exp_val4d(nrows, ncols, nhgts, NFRAMES))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          exp_val4d(i,j,k,f) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val4d(i,j,k,f) = exp_val4d(i,j,k,f) + real(f - 1) * real(dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
  allocate(compdof(nrows * ncols * nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
        compdof(tmp_idx) = int(exp_val4d(i,j,k,1))
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:919
  allocate(rbuf3d(nrows, ncols, nhgts))
  rbuf3d = 0
  ! Expected val for 3d var
  allocate(exp_val3d(nrows, ncols, nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        exp_val3d(i,j,k) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                            (start(2) - 1 + j - 1) * dims(1) + i
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:932
  call PIO_initdecomp(pio_tf_iosystem_, PIO_real, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:935
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_real : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:942)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:943
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:945)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:946
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:948)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:949
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:951)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:952
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time', pio_unlimited, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:954)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:955
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_3d_var', PIO_real, pio_dims(1:3), pio_var3d)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a 3d var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:957)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:958
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_4d_var', PIO_real, pio_dims, pio_var4d)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a 4d var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:960)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:961
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:963)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:964
    call PIO_write_darray(pio_file, pio_var3d, wr_iodesc, wbuf3d, ierr)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to write 3d darray : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:966)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:967
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var4d, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var4d, wr_iodesc, wbuf4d(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write 4d darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:972)"
        END IF
        RETURN
      END IF
    end do
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:975
    rbuf4d = 0
    rbuf3d = 0
   ! pio_decomp_frame_tests.F90.in:978
    call PIO_read_darray(pio_file, pio_var3d, rd_iodesc, rbuf3d, ierr)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to read 3d darray : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:980)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:981
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var4d, f)
      call PIO_read_darray(pio_file, pio_var4d, rd_iodesc, rbuf4d(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read 4d darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:985)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:987
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf4d(:,:,:,f), exp_val4d(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong 4d val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:989)"
        END IF
        RETURN
      END IF
    end do

    IF (.NOT. PIO_TF_Check_val_(rbuf3d, exp_val3d)) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Check failed:",&
           "Got wrong 3dd val",&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:991)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:992
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:997
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:1002
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
   ! pio_decomp_frame_tests.F90.in:1005
  deallocate(exp_val3d)
  deallocate(rbuf3d)
  deallocate(wbuf3d)
   ! pio_decomp_frame_tests.F90.in:1009
  deallocate(exp_val4d)
  deallocate(rbuf4d)
  deallocate(wbuf4d)
END SUBROUTINE nc_reuse_3d_decomp_PIO_real_real_kind_fc_real___


SUBROUTINE nc_reuse_3d_decomp_PIO_double_real_kind_fc_double___
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 3
  type(var_desc_t)  :: pio_var3d, pio_var4d
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  real(kind=fc_double), dimension(:,:,:,:), allocatable :: rbuf4d, wbuf4d, exp_val4d
  real(kind=fc_double), dimension(:,:,:), allocatable :: rbuf3d, wbuf3d, exp_val3d
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:846
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  ! Initialize the 4d var
  allocate(wbuf4d(nrows, ncols, nhgts, NFRAMES))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf4d(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf4d(i,j,k,f) = wbuf4d(i,j,k,f) + (f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
  allocate(compdof(nrows * ncols * nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
        compdof(tmp_idx) = int(wbuf4d(i,j,k,1))
      end do
    end do
  end do
  ! Initialize the 3d var
  allocate(wbuf3d(nrows, ncols, nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        wbuf3d(i,j,k) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                      (start(2) - 1 + j - 1) * dims(1) + i
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:885
  call PIO_initdecomp(pio_tf_iosystem_, PIO_double, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:888
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf4d(nrows, ncols, nhgts, NFRAMES))
  rbuf4d = 0
  ! Expected val for 4d var
  allocate(exp_val4d(nrows, ncols, nhgts, NFRAMES))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          exp_val4d(i,j,k,f) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val4d(i,j,k,f) = exp_val4d(i,j,k,f)+(f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
  allocate(compdof(nrows * ncols * nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
        compdof(tmp_idx) = int(exp_val4d(i,j,k,1))
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:919
  allocate(rbuf3d(nrows, ncols, nhgts))
  rbuf3d = 0
  ! Expected val for 3d var
  allocate(exp_val3d(nrows, ncols, nhgts))
  do k=1,nhgts
    do j=1,ncols
      do i=1,nrows
        exp_val3d(i,j,k) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                            (start(2) - 1 + j - 1) * dims(1) + i
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:932
  call PIO_initdecomp(pio_tf_iosystem_, PIO_double, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:935
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_double : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:942)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:943
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:945)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:946
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:948)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:949
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:951)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:952
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time', pio_unlimited, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:954)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:955
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_3d_var', PIO_double, pio_dims(1:3), pio_var3d)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a 3d var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:957)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:958
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_4d_var', PIO_double, pio_dims, pio_var4d)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a 4d var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:960)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:961
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:963)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:964
    call PIO_write_darray(pio_file, pio_var3d, wr_iodesc, wbuf3d, ierr)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to write 3d darray : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:966)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:967
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var4d, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var4d, wr_iodesc, wbuf4d(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write 4d darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:972)"
        END IF
        RETURN
      END IF
    end do
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:975
    rbuf4d = 0
    rbuf3d = 0
   ! pio_decomp_frame_tests.F90.in:978
    call PIO_read_darray(pio_file, pio_var3d, rd_iodesc, rbuf3d, ierr)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to read 3d darray : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:980)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:981
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var4d, f)
      call PIO_read_darray(pio_file, pio_var4d, rd_iodesc, rbuf4d(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read 4d darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:985)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:987
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf4d(:,:,:,f), exp_val4d(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong 4d val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:989)"
        END IF
        RETURN
      END IF
    end do

    IF (.NOT. PIO_TF_Check_val_(rbuf3d, exp_val3d)) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Check failed:",&
           "Got wrong 3dd val",&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:991)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:992
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:997
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:1002
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
   ! pio_decomp_frame_tests.F90.in:1005
  deallocate(exp_val3d)
  deallocate(rbuf3d)
  deallocate(wbuf3d)
   ! pio_decomp_frame_tests.F90.in:1009
  deallocate(exp_val4d)
  deallocate(rbuf4d)
  deallocate(wbuf4d)
END SUBROUTINE nc_reuse_3d_decomp_PIO_double_real_kind_fc_double___
   ! pio_decomp_frame_tests.F90.in:1013


! Same as nc_write_read_4d_col_decomp, but use a limited time dimension instead

SUBROUTINE nc_test_limited_time_dim_PIO_int_integer__
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 6
  type(var_desc_t)  :: pio_var
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  integer, dimension(:,:,:,:), allocatable :: rbuf, wbuf, exp_val
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:1862
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(wbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf(i,j,k,f) = wbuf(i,j,k,f) + int(f - 1) * (dims(1) * dims(2) * dims(3))
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) = int(wbuf(i,j,k,1))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:1884
  call PIO_initdecomp(pio_tf_iosystem_, PIO_int, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:1887
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  allocate(exp_val(nrows, ncols, nhgts, NFRAMES))
   ! pio_decomp_frame_tests.F90.in:1897
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val(i,j,k,f) = compdof(tmp_idx) + int(f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:1910
  call PIO_initdecomp(pio_tf_iosystem_, PIO_int, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:1913
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_int : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1920)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1921
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1923)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1924
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1926)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1927
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1929)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1930
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time_limited', NFRAMES, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1932)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1933
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_var', PIO_int, pio_dims, pio_var)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1935)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1936
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1938)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1939
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var, wr_iodesc, wbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1944)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1946
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:1948
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      call PIO_read_darray(pio_file, pio_var, rd_iodesc, rbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1952)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1954
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf(:,:,:,f), exp_val(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1956)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1958
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:1963
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:1968
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
  deallocate(exp_val)
  deallocate(rbuf)
  deallocate(wbuf)
END SUBROUTINE nc_test_limited_time_dim_PIO_int_integer__


SUBROUTINE nc_test_limited_time_dim_PIO_real_real_kind_fc_real___
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 6
  type(var_desc_t)  :: pio_var
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  real(kind=fc_real), dimension(:,:,:,:), allocatable :: rbuf, wbuf, exp_val
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:1862
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(wbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf(i,j,k,f) = wbuf(i,j,k,f) + real(f - 1) * real(dims(1) * dims(2) * dims(3))
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) = int(wbuf(i,j,k,1))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:1884
  call PIO_initdecomp(pio_tf_iosystem_, PIO_real, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:1887
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  allocate(exp_val(nrows, ncols, nhgts, NFRAMES))
   ! pio_decomp_frame_tests.F90.in:1897
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val(i,j,k,f) = compdof(tmp_idx) + real(f - 1) * real(dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:1910
  call PIO_initdecomp(pio_tf_iosystem_, PIO_real, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:1913
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_real : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1920)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1921
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1923)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1924
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1926)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1927
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1929)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1930
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time_limited', NFRAMES, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1932)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1933
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_var', PIO_real, pio_dims, pio_var)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1935)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1936
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1938)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1939
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var, wr_iodesc, wbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1944)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1946
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:1948
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      call PIO_read_darray(pio_file, pio_var, rd_iodesc, rbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1952)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1954
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf(:,:,:,f), exp_val(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1956)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1958
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:1963
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:1968
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
  deallocate(exp_val)
  deallocate(rbuf)
  deallocate(wbuf)
END SUBROUTINE nc_test_limited_time_dim_PIO_real_real_kind_fc_real___


SUBROUTINE nc_test_limited_time_dim_PIO_double_real_kind_fc_double___
USE pio_tutil

  implicit none
  integer, parameter :: NDIMS = 4
  integer, parameter :: NFRAMES = 6
  type(var_desc_t)  :: pio_var
  type(file_desc_t) :: pio_file
  character(len=PIO_TF_MAX_STR_LEN) :: filename
  type(io_desc_t) :: wr_iodesc, rd_iodesc
  integer, dimension(:), allocatable :: compdof
  integer, dimension(NDIMS) :: start, count
  real(kind=fc_double), dimension(:,:,:,:), allocatable :: rbuf, wbuf, exp_val
  integer, dimension(NDIMS-1) :: dims
  integer, dimension(NDIMS) :: pio_dims
  integer :: i, j, k, tmp_idx, ierr, nrows, ncols, nhgts
  integer(kind=pio_offset_kind) :: f
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs
  integer :: num_iotypes
   ! pio_decomp_frame_tests.F90.in:1862
  ! Set the decomposition for writing data - forcing rearrangement
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .true.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(wbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          wbuf(i,j,k,f) = (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                        (start(2) - 1 + j - 1) * dims(1) + i
          wbuf(i,j,k,f) = wbuf(i,j,k,f) + (f - 1) * (dims(1) * dims(2) * dims(3))
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) = int(wbuf(i,j,k,1))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:1884
  call PIO_initdecomp(pio_tf_iosystem_, PIO_double, dims, compdof, wr_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:1887
  ! Set the decomposition for reading data - different from the write decomp
  call get_3d_col_decomp_info(pio_tf_world_rank_, pio_tf_world_sz_, dims, start, count, .false.)
  nrows = count(1)
  ncols = count(2)
  nhgts = count(3)

  allocate(rbuf(nrows, ncols, nhgts, NFRAMES))
  allocate(compdof(nrows * ncols * nhgts))
  allocate(exp_val(nrows, ncols, nhgts, NFRAMES))
   ! pio_decomp_frame_tests.F90.in:1897
  do f=1,NFRAMES
    do k=1,nhgts
      do j=1,ncols
        do i=1,nrows
          tmp_idx = (k - 1) * (ncols * nrows) + (j - 1) * nrows + i
          compdof(tmp_idx) =  (start(3) - 1 + k - 1) * (dims(1) * dims(2)) +&
                              (start(2) - 1 + j - 1) * dims(1) + i
          exp_val(i,j,k,f) = compdof(tmp_idx) + (f - 1) * (dims(1) * dims(2) * dims(3))
        end do
      end do
    end do
  end do
   ! pio_decomp_frame_tests.F90.in:1910
  call PIO_initdecomp(pio_tf_iosystem_, PIO_double, dims, compdof, rd_iodesc)
  deallocate(compdof)
   ! pio_decomp_frame_tests.F90.in:1913
  num_iotypes = 0
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)
  filename = "test_pio_decomp_simple_tests.testfile"
  do i=1,num_iotypes

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : PIO_double : ", iotype_descs(i)
      END IF
    END IF
    ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotypes(i), filename, PIO_CLOBBER)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not create file " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1920)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1921
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_row', dims(1), pio_dims(1))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1923)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1924
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_col', dims(2), pio_dims(2))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1926)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1927
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_hgt', dims(3), pio_dims(3))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1929)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1930
    ierr = PIO_def_dim(pio_file, 'PIO_TF_test_dim_time_limited', NFRAMES, pio_dims(4))

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a dim : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1932)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1933
    ierr = PIO_def_var(pio_file, 'PIO_TF_test_var', PIO_double, pio_dims, pio_var)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define a var : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1935)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1936
    ierr = PIO_enddef(pio_file)

    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to end redef mode : " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_decomp_frame_tests.F90.in:1938)"
      END IF
      RETURN
    END IF
   ! pio_decomp_frame_tests.F90.in:1939
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      ! Write the current frame
      call PIO_write_darray(pio_file, pio_var, wr_iodesc, wbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to write darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1944)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1946
    call PIO_syncfile(pio_file)
   ! pio_decomp_frame_tests.F90.in:1948
    do f=1,NFRAMES
      call PIO_setframe(pio_file, pio_var, f)
      call PIO_read_darray(pio_file, pio_var, rd_iodesc, rbuf(:,:,:,f), ierr)

      IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "Failed to read darray : " // trim(filename),&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1952)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1954
    do f=1,NFRAMES

      IF (.NOT. PIO_TF_Check_val_(rbuf(:,:,:,f), exp_val(:,:,:,f))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Check failed:",&
             "Got wrong val, frame=", f,&
            ":", __FILE__, ":", __LINE__,&
            "(pio_decomp_frame_tests.F90.in:1956)"
        END IF
        RETURN
      END IF
    end do
   ! pio_decomp_frame_tests.F90.in:1958
    call PIO_closefile(pio_file)

    call PIO_deletefile(pio_tf_iosystem_, filename);
  end do
   ! pio_decomp_frame_tests.F90.in:1963
  if(allocated(iotypes)) then
    deallocate(iotypes)
    deallocate(iotype_descs)
  end if
   ! pio_decomp_frame_tests.F90.in:1968
  call PIO_freedecomp(pio_tf_iosystem_, rd_iodesc)
  call PIO_freedecomp(pio_tf_iosystem_, wr_iodesc)
  deallocate(exp_val)
  deallocate(rbuf)
  deallocate(wbuf)
END SUBROUTINE nc_test_limited_time_dim_PIO_double_real_kind_fc_double___
