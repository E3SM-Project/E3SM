<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CICE: ice_therm_vertical.F90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Types&nbsp;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>ice_therm_vertical.F90</h1><a href="ice__therm__vertical_8F90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">!=========================================================================</span>
<a name="l00002"></a>00002 <span class="comment">!BOP</span>
<a name="l00003"></a>00003 <span class="comment">!</span>
<a name="l00004"></a>00004 <span class="comment">! !MODULE: ice_therm_vertical - thermo calculations before call to coupler</span>
<a name="l00005"></a>00005 <span class="comment">!</span>
<a name="l00006"></a>00006 <span class="comment">! !DESCRIPTION:</span>
<a name="l00007"></a>00007 <span class="comment">!</span>
<a name="l00008"></a>00008 <span class="comment">! Update ice and snow internal temperatures and compute</span>
<a name="l00009"></a>00009 <span class="comment">! thermodynamic growth rates and atmospheric fluxes.</span>
<a name="l00010"></a>00010 <span class="comment">!</span>
<a name="l00011"></a>00011 <span class="comment">! NOTE: The thermodynamic calculation is split in two for load balancing.</span>
<a name="l00012"></a>00012 <span class="comment">!       First ice_therm_vertical computes vertical growth rates and coupler</span>
<a name="l00013"></a>00013 <span class="comment">!       fluxes.  Then ice_therm_itd does thermodynamic calculations not</span>
<a name="l00014"></a>00014 <span class="comment">!       needed for coupling.</span>
<a name="l00015"></a>00015 <span class="comment">!</span>
<a name="l00016"></a>00016 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00017"></a>00017 <span class="comment">!  SVN:$Id: ice_therm_vertical.F90 152 2008-09-24 20:48:59Z eclare $</span>
<a name="l00018"></a>00018 <span class="comment">!</span>
<a name="l00019"></a>00019 <span class="comment">! authors: William H. Lipscomb, LANL</span>
<a name="l00020"></a>00020 <span class="comment">!          C. M. Bitz, UW</span>
<a name="l00021"></a>00021 <span class="comment">!          Elizabeth C. Hunke, LANL</span>
<a name="l00022"></a>00022 <span class="comment">!</span>
<a name="l00023"></a>00023 <span class="comment">! 2003: Vectorized by Clifford Chen (Fujitsu) and William Lipscomb</span>
<a name="l00024"></a>00024 <span class="comment">! 2004: Block structure added by William Lipscomb</span>
<a name="l00025"></a>00025 <span class="comment">! 2006: Streamlined for efficiency by Elizabeth Hunke</span>
<a name="l00026"></a>00026 <span class="comment">!       Converted to free source form (F90)</span>
<a name="l00027"></a>00027 <span class="comment">!</span>
<a name="l00028"></a>00028 <span class="comment">! !INTERFACE:</span>
<a name="l00029"></a>00029 <span class="comment">!</span>
<a name="l00030"></a><a class="code" href="namespaceice__therm__vertical.html">00030</a>       <span class="keyword">module</span> ice_therm_vertical
<a name="l00031"></a>00031 <span class="comment">!</span>
<a name="l00032"></a>00032 <span class="comment">! !USES:</span>
<a name="l00033"></a>00033 <span class="comment">!</span>
<a name="l00034"></a>00034       use <span class="keywordflow">ice_kinds_mod</span>
<a name="l00035"></a>00035       use <span class="keywordflow">ice_domain_size</span>, only: ncat, nilyr, nslyr, ntilyr, ntslyr, ntrcr
<a name="l00036"></a>00036       use <span class="keywordflow">ice_constants</span>
<a name="l00037"></a>00037       use <span class="keywordflow">ice_fileunits</span>, only: nu_diag
<a name="l00038"></a>00038       use <span class="keywordflow">ice_prescribed_mod</span>, only: prescribed_ice
<a name="l00039"></a>00039 <span class="comment">!</span>
<a name="l00040"></a>00040 <span class="comment">!EOP</span>
<a name="l00041"></a>00041 <span class="comment">!</span>
<a name="l00042"></a>00042       <span class="keyword">implicit none</span>
<a name="l00043"></a>00043       <span class="keywordtype">save</span>
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="namespaceice__therm__vertical.html#abca199468a09d7af2a96e7ceb456b8c4">00045</a>       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l00046"></a>00046          saltmax = 3.2_dbl_kind,   <span class="comment">! max salinity at ice base (ppt)</span>
<a name="l00047"></a>00047          hs_min = 1.e-4_dbl_kind,  <span class="comment">! min snow thickness for computing Tsno (m)</span>
<a name="l00048"></a>00048          betak   = 0.13_dbl_kind,  <span class="comment">! constant in formula for k (W m-1 ppt-1)</span>
<a name="l00049"></a>00049          kimin   = 0.10_dbl_kind    <span class="comment">! min conductivity of saline ice (W m-1 deg-1)</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">00051</a>       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nilyr+1) </span>:: 
<a name="l00052"></a>00052          salin       ,  <span class="comment">! salinity (ppt)   </span>
<a name="l00053"></a>00053          Tmlt            <span class="comment">! melting temp, -depressT * salinity</span>
<a name="l00054"></a>00054                          <span class="comment">! nilyr + 1 index is for bottom surface</span>
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="namespaceice__therm__vertical.html#a95faafaf9b21d14aa8dcf5fd91e50cac">00056</a>       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00057"></a>00057          ustar_scale     <span class="comment">! scaling for ice-ocean heat flux</span>
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="namespaceice__therm__vertical.html#a0721a294c629506af790049e6d607d53">00059</a>       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span>, <span class="keywordtype">private</span> :: 
<a name="l00060"></a>00060          ferrmax = 1.0e-3_dbl_kind    <span class="comment">! max allowed energy flux error (W m-2)</span>
<a name="l00061"></a>00061                                       <span class="comment">! recommend ferrmax &lt; 0.01 W m-2</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="namespaceice__therm__vertical.html#a11814e124127a01f102f5b38e9ede650">00063</a>       <span class="keywordtype">character (char_len) </span>:: stoplabel
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">00065</a>       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l00066"></a>00066          l_brine         <span class="comment">! if true, treat brine pocket effects</span>
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">00068</a>       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l00069"></a>00069          heat_capacity, <span class="comment">! if true, ice has nonzero heat capacity</span>
<a name="l00070"></a>00070                          <span class="comment">! if false, use zero-layer thermodynamics</span>
<a name="l00071"></a>00071          calc_Tsfc       <span class="comment">! if true, calculate surface temperature</span>
<a name="l00072"></a>00072                          <span class="comment">! if false, Tsfc is computed elsewhere and</span>
<a name="l00073"></a>00073                          <span class="comment">! atmos-ice fluxes are provided to CICE</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">!=======================================================================</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077       <span class="keyword">contains</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">!=======================================================================</span>
<a name="l00080"></a>00080 <span class="comment">!BOP</span>
<a name="l00081"></a>00081 <span class="comment">!</span>
<a name="l00082"></a>00082 <span class="comment">! !ROUTINE: thermo_vertical - driver for pre-coupler thermodynamics</span>
<a name="l00083"></a>00083 <span class="comment">!</span>
<a name="l00084"></a>00084 <span class="comment">! !DESCRIPTION:</span>
<a name="l00085"></a>00085 <span class="comment">!</span>
<a name="l00086"></a>00086 <span class="comment">! Driver for updating ice and snow internal temperatures and</span>
<a name="l00087"></a>00087 <span class="comment">! computing thermodynamic growth rates and atmospheric fluxes.</span>
<a name="l00088"></a>00088 <span class="comment">!</span>
<a name="l00089"></a>00089 <span class="comment">!</span>
<a name="l00090"></a>00090 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00091"></a>00091 <span class="comment">!</span>
<a name="l00092"></a>00092 <span class="comment">! authors: William H. Lipscomb, LANL</span>
<a name="l00093"></a>00093 <span class="comment">!          C. M. Bitz, UW</span>
<a name="l00094"></a>00094 <span class="comment">!</span>
<a name="l00095"></a>00095 <span class="comment">! !INTERFACE:</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="namespaceice__therm__vertical.html#a6a3853686daba96faa929c71f0a65cd6">00098</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a6a3853686daba96faa929c71f0a65cd6">thermo_vertical</a> (nx_block,    ny_block,  &amp;
<a name="l00099"></a>00099                                   dt,          icells,    &amp;
<a name="l00100"></a>00100                                   indxi,       indxj,     &amp;
<a name="l00101"></a>00101                                   aicen,       trcrn,     &amp;
<a name="l00102"></a>00102                                   vicen,       vsnon,     &amp;
<a name="l00103"></a>00103                                   eicen,       esnon,     &amp;
<a name="l00104"></a>00104                                   flw,         potT,      &amp;
<a name="l00105"></a>00105                                   Qa,          rhoa,      &amp;
<a name="l00106"></a>00106                                   fsnow,                  &amp;
<a name="l00107"></a>00107                                   fbot,        Tbot,      &amp;
<a name="l00108"></a>00108                                   lhcoef,      shcoef,    &amp;
<a name="l00109"></a>00109                                   fswsfc,      fswint,    &amp;
<a name="l00110"></a>00110                                   fswthrun,               &amp;
<a name="l00111"></a>00111                                   Sswabs,      Iswabs,    &amp;
<a name="l00112"></a>00112                                   fsurfn,      fcondtopn, &amp;
<a name="l00113"></a>00113                                   fsensn,      flatn,     &amp;
<a name="l00114"></a>00114                                   fswabsn,     flwoutn,   &amp;
<a name="l00115"></a>00115                                   evapn,       freshn,    &amp;
<a name="l00116"></a>00116                                   fsaltn,      fhocnn,    &amp;
<a name="l00117"></a>00117                                   meltt,       melts,     &amp;
<a name="l00118"></a>00118                                   meltb,                  &amp;
<a name="l00119"></a>00119                                   congel,      snoice,    &amp;
<a name="l00120"></a>00120                                   mlt_onset,   frz_onset, &amp;
<a name="l00121"></a>00121                                   yday,        l_stop,    &amp;
<a name="l00122"></a>00122                                   istop,       jstop)
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="comment">! </span>
<a name="l00125"></a>00125 <span class="comment">! !USES:</span>
<a name="l00126"></a>00126 <span class="comment">!</span>
<a name="l00127"></a>00127       use <span class="keywordflow">ice_communicate</span>, only: my_task, master_task
<a name="l00128"></a>00128       use <span class="keywordflow">ice_calendar</span>, only: istep1
<a name="l00129"></a>00129       use <span class="keywordflow">ice_exit</span>
<a name="l00130"></a>00130       use <span class="keywordflow">ice_ocean</span>
<a name="l00131"></a>00131       use <span class="keywordflow">ice_itd</span>, only: ilyr1, slyr1, ilyrn, slyrn
<a name="l00132"></a>00132       use <span class="keywordflow">ice_state</span>, only: nt_Tsfc, nt_iage, tr_iage
<a name="l00133"></a>00133 <span class="comment">!</span>
<a name="l00134"></a>00134 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00135"></a>00135 <span class="comment">!</span>
<a name="l00136"></a>00136       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00137"></a>00137          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l00138"></a>00138          icells                <span class="comment">! number of cells with ice present</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l00141"></a>00141          <span class="keywordtype">intent(in)</span> :: 
<a name="l00142"></a>00142          indxi, indxj     <span class="comment">! compressed indices for cells with ice</span>
<a name="l00143"></a>00143 
<a name="l00144"></a>00144       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00145"></a>00145          dt      <span class="comment">! time step</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147       <span class="comment">! ice state variables</span>
<a name="l00148"></a>00148       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l00149"></a>00149          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00150"></a>00150          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l00151"></a>00151          vicen ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l00152"></a>00152          vsnon     <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l00153"></a>00153 
<a name="l00154"></a>00154       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr)</span>, 
<a name="l00155"></a>00155          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00156"></a>00156          trcrn
<a name="l00157"></a>00157 
<a name="l00158"></a>00158       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,nilyr)</span>, 
<a name="l00159"></a>00159          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00160"></a>00160          eicen     <span class="comment">! energy of melting for each ice layer (J/m^2)</span>
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,nslyr)</span>, 
<a name="l00163"></a>00163          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00164"></a>00164          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166       <span class="comment">! input from atmosphere</span>
<a name="l00167"></a>00167       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l00168"></a>00168          <span class="keywordtype">intent(in)</span> :: 
<a name="l00169"></a>00169          flw     ,  <span class="comment">! incoming longwave radiation (W/m^2)</span>
<a name="l00170"></a>00170          potT    ,  <span class="comment">! air potential temperature  (K) </span>
<a name="l00171"></a>00171          Qa      ,  <span class="comment">! specific humidity (kg/kg) </span>
<a name="l00172"></a>00172          rhoa    ,  <span class="comment">! air density (kg/m^3) </span>
<a name="l00173"></a>00173          fsnow   ,  <span class="comment">! snowfall rate (kg m-2 s-1)</span>
<a name="l00174"></a>00174          shcoef  ,  <span class="comment">! transfer coefficient for sensible heat</span>
<a name="l00175"></a>00175          lhcoef      <span class="comment">! transfer coefficient for latent heat</span>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l00178"></a>00178          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00179"></a>00179          fswsfc  ,  <span class="comment">! SW absorbed at ice/snow surface (W m-2)</span>
<a name="l00180"></a>00180          fswint  ,  <span class="comment">! SW absorbed in ice interior, below surface (W m-2)</span>
<a name="l00181"></a>00181          fswthrun    <span class="comment">! SW through ice to ocean         (W/m^2)</span>
<a name="l00182"></a>00182 
<a name="l00183"></a>00183       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nslyr)</span>, 
<a name="l00184"></a>00184          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00185"></a>00185          Sswabs      <span class="comment">! SW radiation absorbed in snow layers (W m-2)</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nilyr)</span>, 
<a name="l00188"></a>00188          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00189"></a>00189          Iswabs      <span class="comment">! SW radiation absorbed in ice layers (W m-2)</span>
<a name="l00190"></a>00190 
<a name="l00191"></a>00191       <span class="comment">! input from ocean</span>
<a name="l00192"></a>00192       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00193"></a>00193          fbot    ,  <span class="comment">! ice-ocean heat flux at bottom surface (W/m^2)</span>
<a name="l00194"></a>00194          Tbot        <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196       <span class="comment">! coupler fluxes to atmosphere</span>
<a name="l00197"></a>00197       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l00198"></a>00198          fsensn  ,  <span class="comment">! sensible heat flux (W/m^2) </span>
<a name="l00199"></a>00199          fswabsn ,  <span class="comment">! shortwave flux absorbed in ice and ocean (W/m^2) </span>
<a name="l00200"></a>00200          flwoutn ,  <span class="comment">! outgoing longwave radiation (W/m^2) </span>
<a name="l00201"></a>00201          evapn       <span class="comment">! evaporative water flux (kg/m^2/s) </span>
<a name="l00202"></a>00202 
<a name="l00203"></a>00203       <span class="comment">! Note: these are intent out if calc_Tsfc = T, otherwise intent in</span>
<a name="l00204"></a>00204       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(inout)</span>:: 
<a name="l00205"></a>00205          flatn    ,  <span class="comment">! latent heat flux   (W/m^2) </span>
<a name="l00206"></a>00206          fsurfn   ,  <span class="comment">! net flux to top surface, excluding fcondtopn</span>
<a name="l00207"></a>00207          fcondtopn    <span class="comment">! downward cond flux at top surface (W m-2)</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209       <span class="comment">! coupler fluxes to ocean</span>
<a name="l00210"></a>00210       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l00211"></a>00211          freshn  ,  <span class="comment">! fresh water flux to ocean (kg/m^2/s)</span>
<a name="l00212"></a>00212          fsaltn  ,  <span class="comment">! salt flux to ocean (kg/m^2/s)</span>
<a name="l00213"></a>00213          fhocnn      <span class="comment">! net heat flux to ocean (W/m^2) </span>
<a name="l00214"></a>00214 
<a name="l00215"></a>00215       <span class="comment">! diagnostic fields</span>
<a name="l00216"></a>00216       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block)</span>, 
<a name="l00217"></a>00217          <span class="keywordtype">intent(inout)</span>:: 
<a name="l00218"></a>00218          meltt    ,  <span class="comment">! top ice melt             (m/step--&gt;cm/day) </span>
<a name="l00219"></a>00219          melts    ,  <span class="comment">! snow melt                (m/step--&gt;cm/day) </span>
<a name="l00220"></a>00220          meltb    ,  <span class="comment">! basal ice melt           (m/step--&gt;cm/day) </span>
<a name="l00221"></a>00221          congel   ,  <span class="comment">! basal ice growth         (m/step--&gt;cm/day) </span>
<a name="l00222"></a>00222          snoice   ,  <span class="comment">! snow-ice formation       (m/step--&gt;cm/day) </span>
<a name="l00223"></a>00223          mlt_onset,  <span class="comment">! day of year that sfc melting begins </span>
<a name="l00224"></a>00224          frz_onset    <span class="comment">! day of year that freezing begins (congel or frazil) </span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00227"></a>00227          yday      <span class="comment">! day of year</span>
<a name="l00228"></a>00228 
<a name="l00229"></a>00229       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l00230"></a>00230          l_stop          <span class="comment">! if true, print diagnostics and abort on return</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l00233"></a>00233          istop, jstop    <span class="comment">! indices of grid cell where code aborts</span>
<a name="l00234"></a>00234 <span class="comment">!</span>
<a name="l00235"></a>00235 <span class="comment">!EOP</span>
<a name="l00236"></a>00236 <span class="comment">!</span>
<a name="l00237"></a>00237       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00238"></a>00238          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l00239"></a>00239          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l00240"></a>00240          ilo,ihi,jlo,jhi,  <span class="comment">! beginning and end of physical domain</span>
<a name="l00241"></a>00241          k           ,  <span class="comment">! ice layer index</span>
<a name="l00242"></a>00242          il1, il2    ,  <span class="comment">! ice layer indices for eice</span>
<a name="l00243"></a>00243          sl1, sl2        <span class="comment">! snow layer indices for esno</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00246"></a>00246          dhi         ,  <span class="comment">! change in ice thickness</span>
<a name="l00247"></a>00247          dhs             <span class="comment">! change in snow thickness</span>
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="comment">! 2D state variables (thickness, temperature, enthalpy)</span>
<a name="l00250"></a>00250 
<a name="l00251"></a>00251       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l00252"></a>00252          hilyr       ,  <span class="comment">! ice layer thickness</span>
<a name="l00253"></a>00253          hslyr       ,  <span class="comment">! snow layer thickness</span>
<a name="l00254"></a>00254          Tsf         ,  <span class="comment">! ice/snow top surface temp, same as Tsfcn (deg C)</span>
<a name="l00255"></a>00255          hin         ,  <span class="comment">! ice thickness (m)</span>
<a name="l00256"></a>00256          hsn         ,  <span class="comment">! snow thickness (m)</span>
<a name="l00257"></a>00257          hsn_new     ,  <span class="comment">! thickness of new snow (m)</span>
<a name="l00258"></a>00258          worki       ,  <span class="comment">! local work array</span>
<a name="l00259"></a>00259          works           <span class="comment">! local work array</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr) </span>:: 
<a name="l00262"></a>00262          qin         ,  <span class="comment">! ice layer enthalpy, qin &lt; 0 (J m-3)</span>
<a name="l00263"></a>00263          Tin             <span class="comment">! internal ice layer temperatures</span>
<a name="l00264"></a>00264 
<a name="l00265"></a>00265       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr) </span>:: 
<a name="l00266"></a>00266          qsn         ,  <span class="comment">! snow layer enthalpy, qsn &lt; 0 (J m-3)</span>
<a name="l00267"></a>00267          Tsn             <span class="comment">! internal snow layer temperatures</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="comment">! other 2D flux and energy variables</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l00272"></a>00272          fcondbot    ,  <span class="comment">! downward cond flux at bottom surface (W m-2)</span>
<a name="l00273"></a>00273          einit       ,  <span class="comment">! initial energy of melting (J m-2)</span>
<a name="l00274"></a>00274          efinal          <span class="comment">! final energy of melting (J m-2)</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="comment">! ech: the size of these arrays should be reduced to icells</span>
<a name="l00277"></a>00277       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block) </span>:: 
<a name="l00278"></a>00278          Tsfcn,  <span class="comment">! temperature of ice/snow top surface  (C)</span>
<a name="l00279"></a>00279          iage     <span class="comment">! ice age (s)</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00282"></a>00282       <span class="comment">! Initialize</span>
<a name="l00283"></a>00283       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00284"></a>00284 
<a name="l00285"></a>00285       l_stop = .false.
<a name="l00286"></a>00286       istop = 0
<a name="l00287"></a>00287       jstop = 0
<a name="l00288"></a>00288 
<a name="l00289"></a>00289       <span class="keyword">do</span> j=1, ny_block
<a name="l00290"></a>00290       <span class="keyword">do</span> i=1, nx_block
<a name="l00291"></a>00291          fsensn (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00292"></a>00292          fswabsn(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00293"></a>00293          flwoutn(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00294"></a>00294          evapn  (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296          freshn (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00297"></a>00297          fsaltn (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00298"></a>00298          fhocnn (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00299"></a>00299 
<a name="l00300"></a>00300          meltt  (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00301"></a>00301          meltb  (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00302"></a>00302          melts  (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00303"></a>00303          congel (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00304"></a>00304          snoice (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00305"></a>00305 
<a name="l00306"></a>00306          Tsfcn(i,j) = trcrn(i,j,<a class="code" href="namespaceice__state.html#a40b462400c0ddbc648e6aa0dd6a417b7">nt_Tsfc</a>)
<a name="l00307"></a>00307          <span class="keyword">if</span> (<a class="code" href="namespaceice__state.html#adad96297f8eb0305b0e5ed4db6e6fbd3">tr_iage</a>) iage(i,j) = trcrn(i,j,<a class="code" href="namespaceice__state.html#aeae23c004739caada7b1be2f39df0927">nt_iage</a>)
<a name="l00308"></a>00308       <span class="keyword">enddo</span>
<a name="l00309"></a>00309       <span class="keyword">enddo</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311       <span class="keyword">if</span> (calc_Tsfc) <span class="keyword">then</span>
<a name="l00312"></a>00312          <span class="keyword">do</span> j=1, ny_block
<a name="l00313"></a>00313          <span class="keyword">do</span> i=1, nx_block
<a name="l00314"></a>00314             flatn    (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00315"></a>00315             fsurfn   (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00316"></a>00316             fcondtopn(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00317"></a>00317          <span class="keyword">enddo</span>
<a name="l00318"></a>00318          <span class="keyword">enddo</span>
<a name="l00319"></a>00319       <span class="keyword">endif</span>
<a name="l00320"></a>00320 
<a name="l00321"></a>00321       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00322"></a>00322       <span class="comment">! Compute variables needed for vertical thermo calculation</span>
<a name="l00323"></a>00323       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00324"></a>00324 
<a name="l00325"></a>00325       call <a class="code" href="namespaceice__therm__vertical.html#a9e8915673a763c6533b1bf688775f02c">init_vertical_profile </a>(nx_block,     ny_block,     &amp;
<a name="l00326"></a>00326                                   <a class="code" href="namespaceice__communicate.html#a70e729e746e2e5ec592ccba505136002">my_task</a>,      <a class="code" href="namespaceice__calendar.html#a56f19d1b69c0acd3d8fd3a6f06855e48">istep1</a>,       &amp;
<a name="l00327"></a>00327                                   icells,                     &amp;
<a name="l00328"></a>00328                                   indxi,        indxj,        &amp;
<a name="l00329"></a>00329                                   aicen(:,:),                 &amp;
<a name="l00330"></a>00330                                   vicen(:,:),   vsnon(:,:),   &amp;
<a name="l00331"></a>00331                                   Tsfcn(:,:),                 &amp;
<a name="l00332"></a>00332                                   eicen(:,:,:), esnon(:,:,:), &amp;
<a name="l00333"></a>00333                                   hin,          hilyr,        &amp;
<a name="l00334"></a>00334                                   hsn,          hslyr,        &amp;
<a name="l00335"></a>00335                                   qin,          Tin,          &amp;
<a name="l00336"></a>00336                                   qsn,          Tsn,          &amp;
<a name="l00337"></a>00337                                   Tsf,          einit,        &amp;
<a name="l00338"></a>00338                                   l_stop,                     &amp;
<a name="l00339"></a>00339                                   istop,        jstop)
<a name="l00340"></a>00340 
<a name="l00341"></a>00341       <span class="keyword">if</span> (l_stop) return
<a name="l00342"></a>00342 
<a name="l00343"></a>00343       <span class="keyword">do</span> ij = 1, icells
<a name="l00344"></a>00344          <span class="comment">! Save initial ice and snow thickness (for fresh and fsalt)</span>
<a name="l00345"></a>00345          worki(ij) = hin(ij)
<a name="l00346"></a>00346          works(ij) = hsn(ij)
<a name="l00347"></a>00347       <span class="keyword">enddo</span>
<a name="l00348"></a>00348    
<a name="l00349"></a>00349       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00350"></a>00350       <span class="comment">! Compute new surface temperature and internal ice and snow</span>
<a name="l00351"></a>00351       <span class="comment">!  temperatures.</span>
<a name="l00352"></a>00352       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00353"></a>00353 
<a name="l00354"></a>00354       <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>   <span class="comment">! usual case</span>
<a name="l00355"></a>00355 
<a name="l00356"></a>00356          call <a class="code" href="namespaceice__therm__vertical.html#afe7e9128dd994fd74827b779ddeaf789">temperature_changes</a>(nx_block,      ny_block, &amp;
<a name="l00357"></a>00357                                   <a class="code" href="namespaceice__communicate.html#a70e729e746e2e5ec592ccba505136002">my_task</a>,       <a class="code" href="namespaceice__calendar.html#a56f19d1b69c0acd3d8fd3a6f06855e48">istep1</a>,   &amp;
<a name="l00358"></a>00358                                   dt,            icells,   &amp; 
<a name="l00359"></a>00359                                   indxi,         indxj,    &amp;
<a name="l00360"></a>00360                                   rhoa,          flw,      &amp;
<a name="l00361"></a>00361                                   potT,          Qa,       &amp;
<a name="l00362"></a>00362                                   shcoef,        lhcoef,   &amp;
<a name="l00363"></a>00363                                   fswsfc,        fswint,   &amp;
<a name="l00364"></a>00364                                   fswthrun,      Sswabs(:,:,:),&amp;
<a name="l00365"></a>00365                                   Iswabs,                  &amp;
<a name="l00366"></a>00366                                   hilyr,         hslyr,    &amp;
<a name="l00367"></a>00367                                   qin,           Tin,      &amp;
<a name="l00368"></a>00368                                   qsn,           Tsn,      &amp;
<a name="l00369"></a>00369                                   Tsf,           Tbot,     &amp;
<a name="l00370"></a>00370                                   fsensn,        flatn,    &amp;
<a name="l00371"></a>00371                                   fswabsn,       flwoutn,  &amp;
<a name="l00372"></a>00372                                   fsurfn,                  &amp;
<a name="l00373"></a>00373                                   fcondtopn,     fcondbot, &amp;
<a name="l00374"></a>00374                                   einit,         l_stop,   &amp;
<a name="l00375"></a>00375                                   istop,         jstop)
<a name="l00376"></a>00376 
<a name="l00377"></a>00377       <span class="keyword">else</span>
<a name="l00378"></a>00378 
<a name="l00379"></a>00379          <span class="keyword">if</span> (calc_Tsfc) <span class="keyword">then</span>       
<a name="l00380"></a>00380 
<a name="l00381"></a>00381             call <a class="code" href="namespaceice__therm__vertical.html#a862eb3ec0eaa2a5ae48961730e1ba7ce">zerolayer_temperature</a>(nx_block,      ny_block, &amp;
<a name="l00382"></a>00382                                        <a class="code" href="namespaceice__communicate.html#a70e729e746e2e5ec592ccba505136002">my_task</a>,       <a class="code" href="namespaceice__calendar.html#a56f19d1b69c0acd3d8fd3a6f06855e48">istep1</a>,   &amp;
<a name="l00383"></a>00383                                        dt,            icells,   &amp; 
<a name="l00384"></a>00384                                        indxi,         indxj,    &amp;
<a name="l00385"></a>00385                                        rhoa,          flw,      &amp;
<a name="l00386"></a>00386                                        potT,          Qa,       &amp;
<a name="l00387"></a>00387                                        shcoef,        lhcoef,   &amp;
<a name="l00388"></a>00388                                        fswsfc,        fswthrun, &amp;
<a name="l00389"></a>00389                                        hilyr,         hslyr,    &amp;
<a name="l00390"></a>00390                                        Tsf,           Tbot,     &amp;
<a name="l00391"></a>00391                                        fsensn,        flatn,    &amp;
<a name="l00392"></a>00392                                        fswabsn,       flwoutn,  &amp;
<a name="l00393"></a>00393                                        fsurfn,                  &amp;
<a name="l00394"></a>00394                                        fcondtopn,     fcondbot, &amp;
<a name="l00395"></a>00395                                        l_stop,                  &amp;
<a name="l00396"></a>00396                                        istop,         jstop)
<a name="l00397"></a>00397 
<a name="l00398"></a>00398          <span class="keyword">else</span>
<a name="l00399"></a>00399 
<a name="l00400"></a>00400             <span class="comment">!------------------------------------------------------------</span>
<a name="l00401"></a>00401             <span class="comment">! Set fcondbot = fcondtop for zero layer thermodynamics</span>
<a name="l00402"></a>00402             <span class="comment">! fcondtop is set in call to set_sfcflux in step_therm1</span>
<a name="l00403"></a>00403             <span class="comment">!------------------------------------------------------------</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405             <span class="keyword">do</span> ij = 1, icells
<a name="l00406"></a>00406                i = indxi(ij)
<a name="l00407"></a>00407                j = indxj(ij)
<a name="l00408"></a>00408                fcondbot(ij)  = fcondtopn(i,j)   <span class="comment">! zero layer         </span>
<a name="l00409"></a>00409             <span class="keyword">enddo</span>
<a name="l00410"></a>00410       
<a name="l00411"></a>00411          <span class="keyword">endif</span>      <span class="comment">! calc_Tsfc</span>
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <span class="keyword">endif</span>         <span class="comment">! heat_capacity</span>
<a name="l00414"></a>00414 
<a name="l00415"></a>00415       <span class="keyword">if</span> (l_stop) return
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00418"></a>00418       <span class="comment">! Compute growth and/or melting at the top and bottom surfaces.</span>
<a name="l00419"></a>00419       <span class="comment">! Add new snowfall.</span>
<a name="l00420"></a>00420       <span class="comment">! Repartition ice into equal-thickness layers, conserving energy.</span>
<a name="l00421"></a>00421       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423       call <a class="code" href="namespaceice__therm__vertical.html#ad24b5fda2cb4af3cda6722209668aa77">thickness_changes</a>(nx_block,     ny_block, &amp;
<a name="l00424"></a>00424                              dt,                     &amp;
<a name="l00425"></a>00425                              yday,         icells,   &amp;
<a name="l00426"></a>00426                              indxi,        indxj,    &amp;
<a name="l00427"></a>00427                              efinal,                 &amp;
<a name="l00428"></a>00428                              hin,          hilyr,    &amp;
<a name="l00429"></a>00429                              hsn,          hslyr,    &amp;
<a name="l00430"></a>00430                              qin,          qsn,      &amp;
<a name="l00431"></a>00431                              fbot,         Tbot,     &amp;
<a name="l00432"></a>00432                              flatn,        fsurfn,   &amp;
<a name="l00433"></a>00433                              fcondtopn,    fcondbot, &amp;
<a name="l00434"></a>00434                              fsnow,        hsn_new,  &amp;
<a name="l00435"></a>00435                              fhocnn,       evapn,    &amp;
<a name="l00436"></a>00436                              meltt,        melts,    &amp;
<a name="l00437"></a>00437                              meltb,        iage,     &amp;
<a name="l00438"></a>00438                              congel,       snoice,   &amp;
<a name="l00439"></a>00439                              mlt_onset,    frz_onset)
<a name="l00440"></a>00440 
<a name="l00441"></a>00441       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00442"></a>00442       <span class="comment">! Check for energy conservation by comparing the change in energy</span>
<a name="l00443"></a>00443       <span class="comment">! to the net energy input</span>
<a name="l00444"></a>00444       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00445"></a>00445 
<a name="l00446"></a>00446       call <a class="code" href="namespaceice__therm__vertical.html#a4f2f790706910417fe9bbaaa1ad6efa3">conservation_check_vthermo</a>(nx_block, ny_block, &amp;
<a name="l00447"></a>00447                                       <a class="code" href="namespaceice__communicate.html#a70e729e746e2e5ec592ccba505136002">my_task</a>,  <a class="code" href="namespaceice__calendar.html#a56f19d1b69c0acd3d8fd3a6f06855e48">istep1</a>,   &amp;
<a name="l00448"></a>00448                                       dt,       icells,   &amp;
<a name="l00449"></a>00449                                       indxi,    indxj,    &amp;
<a name="l00450"></a>00450                                       fsurfn,   flatn,    &amp;
<a name="l00451"></a>00451                                       fhocnn,   fswint,   &amp;
<a name="l00452"></a>00452                                       fsnow,              &amp;
<a name="l00453"></a>00453                                       einit,    efinal,   &amp;
<a name="l00454"></a>00454                                       l_stop,             &amp;
<a name="l00455"></a>00455                                       istop,    jstop)
<a name="l00456"></a>00456 
<a name="l00457"></a>00457       <span class="keyword">if</span> (l_stop) return
<a name="l00458"></a>00458 
<a name="l00459"></a>00459       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00460"></a>00460       <span class="comment">! If prescribed ice, set hi back to old values</span>
<a name="l00461"></a>00461       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463       <span class="keyword">if</span> (<a class="code" href="namespaceice__prescribed__mod.html#a1b42a8c2b0357eb657332946d2b6c78a">prescribed_ice</a>) <span class="keyword">then</span>
<a name="l00464"></a>00464          <span class="keyword">do</span> ij = 1, icells
<a name="l00465"></a>00465             i = indxi(ij)
<a name="l00466"></a>00466             j = indxj(ij)
<a name="l00467"></a>00467             hin(ij) = worki(ij)
<a name="l00468"></a>00468             fhocnn(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>             <span class="comment">! for diagnostics</span>
<a name="l00469"></a>00469          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l00470"></a>00470       <span class="keyword">endif</span>
<a name="l00471"></a>00471 
<a name="l00472"></a>00472       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00473"></a>00473       <span class="comment">! Compute fluxes of water and salt from ice to ocean.</span>
<a name="l00474"></a>00474       <span class="comment">! evapn &lt; 0 =&gt; sublimation, evapn &gt; 0 =&gt; condensation</span>
<a name="l00475"></a>00475       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477       <span class="keyword">do</span> ij = 1, icells
<a name="l00478"></a>00478          i = indxi(ij)
<a name="l00479"></a>00479          j = indxj(ij)
<a name="l00480"></a>00480             
<a name="l00481"></a>00481          dhi = hin(ij) - worki(ij)
<a name="l00482"></a>00482          dhs = hsn(ij) - works(ij)
<a name="l00483"></a>00483                
<a name="l00484"></a>00484          freshn(i,j) = evapn(i,j) - &amp;
<a name="l00485"></a>00485                        (<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*dhi + <a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*(dhs-hsn_new(ij))) / dt
<a name="l00486"></a>00486          fsaltn(i,j) = -<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*dhi*ice_ref_salinity*<a class="code" href="namespaceice__constants.html#a32bc94e42275169979f5be642d23634e">p001</a>/dt
<a name="l00487"></a>00487 
<a name="l00488"></a>00488       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l00489"></a>00489 
<a name="l00490"></a>00490       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00491"></a>00491       <span class="comment">!  Given the vertical thermo state variables (hin, hsn, Tsf,</span>
<a name="l00492"></a>00492       <span class="comment">!   qin, qsn,), compute the new ice state variables (vicen, vsnon,</span>
<a name="l00493"></a>00493       <span class="comment">!   Tsfcn, eicen, esnon).</span>
<a name="l00494"></a>00494       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00495"></a>00495 
<a name="l00496"></a>00496       call <a class="code" href="namespaceice__therm__vertical.html#a64f63f03c5a0e61472486ace19c6b9d5">update_state_vthermo</a>(nx_block,     ny_block,   &amp;
<a name="l00497"></a>00497                                 icells,                   &amp;
<a name="l00498"></a>00498                                 indxi,        indxj,      &amp;
<a name="l00499"></a>00499                                 Tbot,         Tsf,        &amp;     
<a name="l00500"></a>00500                                 hin,          hsn,        &amp;
<a name="l00501"></a>00501                                 qin,          qsn,        &amp;
<a name="l00502"></a>00502                                 aicen(:,:),               &amp;
<a name="l00503"></a>00503                                 vicen(:,:),   vsnon(:,:), &amp;
<a name="l00504"></a>00504                                 Tsfcn(:,:),               &amp;
<a name="l00505"></a>00505                                 eicen(:,:,:), esnon(:,:,:))
<a name="l00506"></a>00506 
<a name="l00507"></a>00507       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00508"></a>00508       <span class="comment">! Reload tracer array</span>
<a name="l00509"></a>00509       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00510"></a>00510 
<a name="l00511"></a>00511       <span class="keyword">do</span> j = 1, ny_block
<a name="l00512"></a>00512       <span class="keyword">do</span> i = 1, nx_block
<a name="l00513"></a>00513          trcrn(i,j,<a class="code" href="namespaceice__state.html#a40b462400c0ddbc648e6aa0dd6a417b7">nt_Tsfc</a>) = Tsfcn(i,j)
<a name="l00514"></a>00514          <span class="keyword">if</span> (<a class="code" href="namespaceice__state.html#adad96297f8eb0305b0e5ed4db6e6fbd3">tr_iage</a>) trcrn(i,j,<a class="code" href="namespaceice__state.html#aeae23c004739caada7b1be2f39df0927">nt_iage</a>) = iage(i,j)
<a name="l00515"></a>00515       <span class="keyword">enddo</span>
<a name="l00516"></a>00516       <span class="keyword">enddo</span>
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 <span class="keyword">      end subroutine thermo_vertical</span>
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="comment">!=======================================================================</span>
<a name="l00521"></a>00521 <span class="comment">!BOP</span>
<a name="l00522"></a>00522 <span class="comment">!</span>
<a name="l00523"></a>00523 <span class="comment">! !ROUTINE: init_thermo_vertical - initialize salinity and melting temp</span>
<a name="l00524"></a>00524 <span class="comment">!</span>
<a name="l00525"></a>00525 <span class="comment">! !DESCRIPTION:</span>
<a name="l00526"></a>00526 <span class="comment">!</span>
<a name="l00527"></a>00527 <span class="comment">! Initialize the vertical profile of ice salinity and melting temperature.</span>
<a name="l00528"></a>00528 <span class="comment">!</span>
<a name="l00529"></a>00529 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00530"></a>00530 <span class="comment">!</span>
<a name="l00531"></a>00531 <span class="comment">! authors: C. M. Bitz, UW</span>
<a name="l00532"></a>00532 <span class="comment">!          William H. Lipscomb, LANL</span>
<a name="l00533"></a>00533 <span class="comment">!</span>
<a name="l00534"></a>00534 <span class="comment">! !INTERFACE:</span>
<a name="l00535"></a>00535 <span class="comment">!</span>
<a name="l00536"></a><a class="code" href="namespaceice__therm__vertical.html#a1123b2b5ee24c8b82a26c5a831c88405">00536</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a1123b2b5ee24c8b82a26c5a831c88405">init_thermo_vertical</a>
<a name="l00537"></a>00537 <span class="comment">!</span>
<a name="l00538"></a>00538 <span class="comment">! !USES:</span>
<a name="l00539"></a>00539 <span class="comment">!</span>
<a name="l00540"></a>00540 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00541"></a>00541 <span class="comment">!</span>
<a name="l00542"></a>00542 <span class="comment">!EOP</span>
<a name="l00543"></a>00543 <span class="comment">!</span>
<a name="l00544"></a>00544       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l00545"></a>00545          nsal    = 0.407_dbl_kind, 
<a name="l00546"></a>00546          msal    = 0.573_dbl_kind, 
<a name="l00547"></a>00547          min_salin = 0.1_dbl_kind  <span class="comment">! threshold for brine pocket treatment </span>
<a name="l00548"></a>00548 
<a name="l00549"></a>00549       <span class="keywordtype">integer (kind=int_kind) </span>:: k        <span class="comment">! ice layer index</span>
<a name="l00550"></a>00550       <span class="keywordtype">real (kind=dbl_kind)    </span>:: zn       <span class="comment">! normalized ice thickness</span>
<a name="l00551"></a>00551 
<a name="l00552"></a>00552       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00553"></a>00553       <span class="comment">! Determine l_brine based on saltmax.</span>
<a name="l00554"></a>00554       <span class="comment">! Thermodynamic solver will not converge if l_brine is true and</span>
<a name="l00555"></a>00555       <span class="comment">!  saltmax is close to zero.</span>
<a name="l00556"></a>00556       <span class="comment">! Set l_brine to false for zero layer thermodynamics</span>
<a name="l00557"></a>00557       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00558"></a>00558 
<a name="l00559"></a>00559       <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#abca199468a09d7af2a96e7ceb456b8c4">saltmax</a> &gt; min_salin .and. <a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l00560"></a>00560          <a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a> = .true.
<a name="l00561"></a>00561       <span class="keyword">else</span>
<a name="l00562"></a>00562          <a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a> = .false.
<a name="l00563"></a>00563       <span class="keyword">endif</span>
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00566"></a>00566       <span class="comment">! Prescibe vertical profile of salinity and melting temperature.</span>
<a name="l00567"></a>00567       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00568"></a>00568 
<a name="l00569"></a>00569       <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span>
<a name="l00570"></a>00570          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l00571"></a>00571             zn = (<span class="keywordtype">real</span>(k,kind=dbl_kind)-p5) /  
<a name="l00572"></a>00572                   <span class="keywordtype">real</span>(nilyr,kind=dbl_kind)
<a name="l00573"></a>00573             <a class="code" href="namespaceice__therm__vertical.html#a484442c434b314140ae3763d41fc9075">salin</a>(k)=(<a class="code" href="namespaceice__therm__vertical.html#abca199468a09d7af2a96e7ceb456b8c4">saltmax</a>/<a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a>)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>-cos(<a class="code" href="namespaceice__constants.html#ab88fe0d16ebc9529ef11d6fe4343c387">pi</a>*zn**(nsal/(msal+zn))))
<a name="l00574"></a>00574 <span class="comment">!            salin(k)=saltmax ! for isosaline ice</span>
<a name="l00575"></a>00575             <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k) = -<a class="code" href="namespaceice__therm__vertical.html#a484442c434b314140ae3763d41fc9075">salin</a>(k)*depressT
<a name="l00576"></a>00576          <span class="keyword">enddo</span>
<a name="l00577"></a>00577          <a class="code" href="namespaceice__therm__vertical.html#a484442c434b314140ae3763d41fc9075">salin</a>(nilyr+1) = <a class="code" href="namespaceice__therm__vertical.html#abca199468a09d7af2a96e7ceb456b8c4">saltmax</a>
<a name="l00578"></a>00578          <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(nilyr+1) = -<a class="code" href="namespaceice__therm__vertical.html#a484442c434b314140ae3763d41fc9075">salin</a>(nilyr+1)*depressT
<a name="l00579"></a>00579       <span class="keyword">else</span>
<a name="l00580"></a>00580          <span class="keyword">do</span> k = 1, nilyr+1
<a name="l00581"></a>00581             <a class="code" href="namespaceice__therm__vertical.html#a484442c434b314140ae3763d41fc9075">salin</a>(k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00582"></a>00582             <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00583"></a>00583          <span class="keyword">enddo</span>
<a name="l00584"></a>00584       <span class="keyword">endif</span>
<a name="l00585"></a>00585 
<a name="l00586"></a>00586       <a class="code" href="namespaceice__therm__vertical.html#a95faafaf9b21d14aa8dcf5fd91e50cac">ustar_scale</a> = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>           <span class="comment">! for nonzero currents</span>
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="keyword">      end subroutine init_thermo_vertical</span>
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="comment">!=======================================================================</span>
<a name="l00591"></a>00591 <span class="comment">!BOP</span>
<a name="l00592"></a>00592 <span class="comment">!</span>
<a name="l00593"></a>00593 <span class="comment">! !ROUTINE: frzmlt_bottom_lateral - bottom and lateral heat fluxes</span>
<a name="l00594"></a>00594 <span class="comment">!</span>
<a name="l00595"></a>00595 <span class="comment">! !DESCRIPTION:</span>
<a name="l00596"></a>00596 <span class="comment">!</span>
<a name="l00597"></a>00597 <span class="comment">! Adjust frzmlt to account for changes in fhocn since from_coupler.</span>
<a name="l00598"></a>00598 <span class="comment">! Compute heat flux to bottom surface.</span>
<a name="l00599"></a>00599 <span class="comment">! Compute fraction of ice that melts laterally.</span>
<a name="l00600"></a>00600 <span class="comment">!</span>
<a name="l00601"></a>00601 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00602"></a>00602 <span class="comment">!</span>
<a name="l00603"></a>00603 <span class="comment">! authors C. M. Bitz, UW</span>
<a name="l00604"></a>00604 <span class="comment">!         William H. Lipscomb, LANL</span>
<a name="l00605"></a>00605 <span class="comment">!         Elizabeth C. Hunke, LANL</span>
<a name="l00606"></a>00606 <span class="comment">!</span>
<a name="l00607"></a>00607 <span class="comment">! !INTERFACE:</span>
<a name="l00608"></a>00608 <span class="comment">!</span>
<a name="l00609"></a><a class="code" href="namespaceice__therm__vertical.html#ae86ac5bb13d456664da2d8a1aae2f80c">00609</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#ae86ac5bb13d456664da2d8a1aae2f80c">frzmlt_bottom_lateral</a> (nx_block, ny_block, &amp;
<a name="l00610"></a>00610                                         ilo, ihi, jlo, jhi, &amp;
<a name="l00611"></a>00611                                         dt,                 &amp;
<a name="l00612"></a>00612                                         aice,     frzmlt,   &amp;
<a name="l00613"></a>00613                                         eicen,    esnon,    &amp;
<a name="l00614"></a>00614                                         sst,      Tf,       &amp;
<a name="l00615"></a>00615                                         strocnxT, strocnyT, &amp;
<a name="l00616"></a>00616                                         Tbot,     fbot,     &amp;
<a name="l00617"></a>00617                                         rside)
<a name="l00618"></a>00618 <span class="comment">!</span>
<a name="l00619"></a>00619 <span class="comment">! !USES:</span>
<a name="l00620"></a>00620 <span class="comment">!</span>
<a name="l00621"></a>00621       use <span class="keywordflow">ice_itd</span>, only: ilyr1, slyr1
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00626"></a>00626          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l00627"></a>00627          ilo,ihi,jlo,jhi       <span class="comment">! beginning and end of physical domain</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00630"></a>00630          dt                  <span class="comment">! time step</span>
<a name="l00631"></a>00631 
<a name="l00632"></a>00632       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00633"></a>00633          aice    ,  <span class="comment">! ice concentration</span>
<a name="l00634"></a>00634          frzmlt  ,  <span class="comment">! freezing/melting potential (W/m^2)</span>
<a name="l00635"></a>00635          sst     ,  <span class="comment">! sea surface temperature (C)</span>
<a name="l00636"></a>00636          Tf      ,  <span class="comment">! freezing temperature (C)</span>
<a name="l00637"></a>00637          strocnxT,  <span class="comment">! ice-ocean stress, x-direction</span>
<a name="l00638"></a>00638          strocnyT    <span class="comment">! ice-ocean stress, y-direction</span>
<a name="l00639"></a>00639 
<a name="l00640"></a>00640       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,ntilyr)</span>, 
<a name="l00641"></a>00641          <span class="keywordtype">intent(in)</span> :: 
<a name="l00642"></a>00642          eicen       <span class="comment">! energy of melting for each ice layer (J/m^2)</span>
<a name="l00643"></a>00643 
<a name="l00644"></a>00644       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,ntslyr)</span>, 
<a name="l00645"></a>00645          <span class="keywordtype">intent(in)</span> :: 
<a name="l00646"></a>00646          esnon       <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l00647"></a>00647 
<a name="l00648"></a>00648       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block)</span>, 
<a name="l00649"></a>00649          <span class="keywordtype">intent(out)</span> :: 
<a name="l00650"></a>00650          Tbot    ,  <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l00651"></a>00651          fbot    ,  <span class="comment">! heat flux to ice bottom  (W/m^2)</span>
<a name="l00652"></a>00652          rside       <span class="comment">! fraction of ice that melts laterally</span>
<a name="l00653"></a>00653 <span class="comment">!</span>
<a name="l00654"></a>00654 <span class="comment">!EOP</span>
<a name="l00655"></a>00655 <span class="comment">!</span>
<a name="l00656"></a>00656       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00657"></a>00657          i, j           ,  <span class="comment">! horizontal indices</span>
<a name="l00658"></a>00658          n              ,  <span class="comment">! thickness category index</span>
<a name="l00659"></a>00659          k              ,  <span class="comment">! layer index</span>
<a name="l00660"></a>00660          ij             ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l00661"></a>00661          imelt              <span class="comment">! number of cells with ice melting</span>
<a name="l00662"></a>00662 
<a name="l00663"></a>00663       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block) </span>:: 
<a name="l00664"></a>00664          indxi, indxj     <span class="comment">! compressed indices for cells with ice melting</span>
<a name="l00665"></a>00665 
<a name="l00666"></a>00666       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:)</span>, <span class="keywordtype">allocatable</span> :: 
<a name="l00667"></a>00667          etot    ,  <span class="comment">! total energy in column</span>
<a name="l00668"></a>00668          fside       <span class="comment">! lateral heat flux (W/m^2)</span>
<a name="l00669"></a>00669 
<a name="l00670"></a>00670       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00671"></a>00671          deltaT    ,  <span class="comment">! SST - Tbot &gt;= 0</span>
<a name="l00672"></a>00672          ustar     ,  <span class="comment">! skin friction velocity for fbot (m/s)</span>
<a name="l00673"></a>00673          wlat      ,  <span class="comment">! lateral melt rate (m/s)</span>
<a name="l00674"></a>00674          xtmp          <span class="comment">! temporary variable</span>
<a name="l00675"></a>00675 
<a name="l00676"></a>00676       <span class="comment">! Parameters for bottom melting</span>
<a name="l00677"></a>00677 
<a name="l00678"></a>00678       <span class="comment">! 0.006 = unitless param for basal heat flx ala McPhee and Maykut</span>
<a name="l00679"></a>00679 
<a name="l00680"></a>00680       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l00681"></a>00681          cpchr = -cp_ocn*rhow*0.006_dbl_kind, 
<a name="l00682"></a>00682          ustar_min = 5.e-3_dbl_kind
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 
<a name="l00685"></a>00685       <span class="comment">! Parameters for lateral melting</span>
<a name="l00686"></a>00686 
<a name="l00687"></a>00687       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l00688"></a>00688          floediam = 300.0_dbl_kind,  <span class="comment">! effective floe diameter (m)</span>
<a name="l00689"></a>00689          alpha    = 0.66_dbl_kind ,  <span class="comment">! constant from Steele (unitless)</span>
<a name="l00690"></a>00690          m1 = 1.6e-6_dbl_kind     ,  <span class="comment">! constant from Maykut &amp; Perovich</span>
<a name="l00691"></a>00691                                       <span class="comment">! (m/s/deg^(-m2))</span>
<a name="l00692"></a>00692          m2 = 1.36_dbl_kind           <span class="comment">! constant from Maykut &amp; Perovich</span>
<a name="l00693"></a>00693                                       <span class="comment">! (unitless)</span>
<a name="l00694"></a>00694 
<a name="l00695"></a>00695       <span class="keyword">do</span> j = 1, ny_block
<a name="l00696"></a>00696       <span class="keyword">do</span> i = 1, nx_block
<a name="l00697"></a>00697          rside(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00698"></a>00698          Tbot (i,j) = Tf(i,j)
<a name="l00699"></a>00699          fbot (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00700"></a>00700       <span class="keyword">enddo</span>
<a name="l00701"></a>00701       <span class="keyword">enddo</span>
<a name="l00702"></a>00702 
<a name="l00703"></a>00703       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00704"></a>00704       <span class="comment">! Identify grid cells where ice can melt.</span>
<a name="l00705"></a>00705       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00706"></a>00706 
<a name="l00707"></a>00707       imelt = 0
<a name="l00708"></a>00708       <span class="keyword">do</span> j = jlo, jhi
<a name="l00709"></a>00709       <span class="keyword">do</span> i = ilo, ihi
<a name="l00710"></a>00710          <span class="keyword">if</span> (aice(i,j) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. frzmlt(i,j) &lt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span> <span class="comment">! ice can melt</span>
<a name="l00711"></a>00711             imelt = imelt + 1
<a name="l00712"></a>00712             indxi(imelt) = i
<a name="l00713"></a>00713             indxj(imelt) = j
<a name="l00714"></a>00714          <span class="keyword">endif</span>
<a name="l00715"></a>00715       <span class="keyword">enddo</span>                     <span class="comment">! i</span>
<a name="l00716"></a>00716       <span class="keyword">enddo</span>                     <span class="comment">! j</span>
<a name="l00717"></a>00717 
<a name="l00718"></a>00718       <span class="keyword">allocate</span>(etot (imelt))
<a name="l00719"></a>00719       <span class="keyword">allocate</span>(fside(imelt))
<a name="l00720"></a>00720 
<a name="l00721"></a>00721       <span class="keyword">do</span> ij = 1, imelt  <span class="comment">! cells where ice can melt</span>
<a name="l00722"></a>00722          i = indxi(ij)
<a name="l00723"></a>00723          j = indxj(ij)
<a name="l00724"></a>00724 
<a name="l00725"></a>00725          fside(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00726"></a>00726 
<a name="l00727"></a>00727       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00728"></a>00728       <span class="comment">! Use boundary layer theory for fbot.</span>
<a name="l00729"></a>00729       <span class="comment">! See Maykut and McPhee (1995): JGR, 100, 24,691-24,703.</span>
<a name="l00730"></a>00730       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00731"></a>00731 
<a name="l00732"></a>00732          deltaT = max((sst(i,j)-Tbot(i,j)),<a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l00733"></a>00733 
<a name="l00734"></a>00734          <span class="comment">! strocnx has units N/m^2 so strocnx/rho has units m^2/s^2</span>
<a name="l00735"></a>00735          ustar = sqrt (sqrt(strocnxT(i,j)**2+strocnyT(i,j)**2)/rhow)
<a name="l00736"></a>00736          ustar = max (ustar,ustar_min*<a class="code" href="namespaceice__therm__vertical.html#a95faafaf9b21d14aa8dcf5fd91e50cac">ustar_scale</a>)
<a name="l00737"></a>00737 
<a name="l00738"></a>00738          fbot(i,j) = cpchr * deltaT * ustar <span class="comment">! &lt; 0</span>
<a name="l00739"></a>00739          fbot(i,j) = max (fbot(i,j), frzmlt(i,j)) <span class="comment">! frzmlt &lt; fbot &lt; 0</span>
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="comment">!!! uncomment to use all frzmlt for standalone runs</span>
<a name="l00742"></a>00742 <span class="comment">!!!         fbot(i,j) = min (c0, frzmlt(i,j))</span>
<a name="l00743"></a>00743 
<a name="l00744"></a>00744       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00745"></a>00745       <span class="comment">! Compute rside.  See these references:</span>
<a name="l00746"></a>00746       <span class="comment">!    Maykut and Perovich (1987): JGR, 92, 7032-7044</span>
<a name="l00747"></a>00747       <span class="comment">!    Steele (1992): JGR, 97, 17,729-17,738</span>
<a name="l00748"></a>00748       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00749"></a>00749 
<a name="l00750"></a>00750          wlat = m1 * deltaT**m2 <span class="comment">! Maykut &amp; Perovich</span>
<a name="l00751"></a>00751          rside(i,j) = wlat*dt*<a class="code" href="namespaceice__constants.html#ab88fe0d16ebc9529ef11d6fe4343c387">pi</a>/(alpha*floediam) <span class="comment">! Steele</span>
<a name="l00752"></a>00752          rside(i,j) = max(<a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>,min(rside(i,j),<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>))
<a name="l00753"></a>00753 
<a name="l00754"></a>00754       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l00755"></a>00755 
<a name="l00756"></a>00756       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00757"></a>00757       <span class="comment">! Compute heat flux associated with this value of rside.</span>
<a name="l00758"></a>00758       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00759"></a>00759 
<a name="l00760"></a>00760       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l00761"></a>00761 
<a name="l00762"></a>00762          <span class="keyword">do</span> ij = 1, imelt
<a name="l00763"></a>00763             etot(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00764"></a>00764          <span class="keyword">enddo</span>
<a name="l00765"></a>00765 
<a name="l00766"></a>00766          <span class="comment">! melting energy/unit area in each column, etot &lt; 0</span>
<a name="l00767"></a>00767 
<a name="l00768"></a>00768          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l00769"></a>00769 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00770"></a>00770 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00771"></a>00771 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00772"></a>00772             <span class="keyword">do</span> ij = 1, imelt
<a name="l00773"></a>00773                i = indxi(ij)
<a name="l00774"></a>00774                j = indxj(ij)
<a name="l00775"></a>00775                etot(ij) = etot(ij) + esnon(i,j,slyr1(n)+k-1)
<a name="l00776"></a>00776             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l00777"></a>00777          <span class="keyword">enddo</span>
<a name="l00778"></a>00778 
<a name="l00779"></a>00779          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l00780"></a>00780 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00781"></a>00781 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00782"></a>00782 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00783"></a>00783             <span class="keyword">do</span> ij = 1, imelt
<a name="l00784"></a>00784                i = indxi(ij)
<a name="l00785"></a>00785                j = indxj(ij)
<a name="l00786"></a>00786                etot(ij) = etot(ij) + eicen(i,j,ilyr1(n)+k-1)
<a name="l00787"></a>00787             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l00788"></a>00788          <span class="keyword">enddo</span>                  <span class="comment">! nilyr</span>
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00791"></a>00791 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00792"></a>00792 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00793"></a>00793          <span class="keyword">do</span> ij = 1, imelt
<a name="l00794"></a>00794             i = indxi(ij)
<a name="l00795"></a>00795             j = indxj(ij)
<a name="l00796"></a>00796             <span class="comment">! lateral heat flux</span>
<a name="l00797"></a>00797             fside(ij) = fside(ij) + rside(i,j)*etot(ij)/dt <span class="comment">! fside &lt; 0</span>
<a name="l00798"></a>00798          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l00799"></a>00799 
<a name="l00800"></a>00800       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l00801"></a>00801 
<a name="l00802"></a>00802       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00803"></a>00803       <span class="comment">! Limit bottom and lateral heat fluxes if necessary.</span>
<a name="l00804"></a>00804       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00807"></a>00807 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00808"></a>00808 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <span class="keyword">do</span> ij = 1, imelt
<a name="l00812"></a>00812          i = indxi(ij)
<a name="l00813"></a>00813          j = indxj(ij)
<a name="l00814"></a>00814 
<a name="l00815"></a>00815          xtmp = frzmlt(i,j)/(fbot(i,j) + fside(ij) + <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) 
<a name="l00816"></a>00816          xtmp = min(xtmp, <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)
<a name="l00817"></a>00817          fbot(i,j)  = fbot(i,j)  * xtmp
<a name="l00818"></a>00818          rside(i,j) = rside(i,j) * xtmp
<a name="l00819"></a>00819       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l00820"></a>00820 
<a name="l00821"></a>00821       <span class="keyword">deallocate</span>(etot)
<a name="l00822"></a>00822       <span class="keyword">deallocate</span>(fside)
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="keyword">      end subroutine frzmlt_bottom_lateral</span>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 <span class="comment">!=======================================================================</span>
<a name="l00827"></a>00827 <span class="comment">!BOP</span>
<a name="l00828"></a>00828 <span class="comment">!</span>
<a name="l00829"></a>00829 <span class="comment">! !ROUTINE: init_vertical_profile - initial thickness, enthalpy, temperature</span>
<a name="l00830"></a>00830 <span class="comment">!</span>
<a name="l00831"></a>00831 <span class="comment">! !DESCRIPTION:</span>
<a name="l00832"></a>00832 <span class="comment">!</span>
<a name="l00833"></a>00833 <span class="comment">! Given the state variables (vicen, vsnon, eicen, esnon, Tsfcn),</span>
<a name="l00834"></a>00834 <span class="comment">! compute variables needed for the vertical thermodynamics</span>
<a name="l00835"></a>00835 <span class="comment">! (hin, hsn, qin, qsn, Tin, Tsn, Tsf).</span>
<a name="l00836"></a>00836 <span class="comment">!</span>
<a name="l00837"></a>00837 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00838"></a>00838 <span class="comment">!</span>
<a name="l00839"></a>00839 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l00840"></a>00840 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l00841"></a>00841 <span class="comment">!</span>
<a name="l00842"></a>00842 <span class="comment">! !INTERFACE:</span>
<a name="l00843"></a>00843 <span class="comment">!</span>
<a name="l00844"></a><a class="code" href="namespaceice__therm__vertical.html#a9e8915673a763c6533b1bf688775f02c">00844</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a9e8915673a763c6533b1bf688775f02c">init_vertical_profile</a>(nx_block, ny_block, &amp;
<a name="l00845"></a>00845                                        my_task,  istep1,   &amp;
<a name="l00846"></a>00846                                        icells,             &amp;
<a name="l00847"></a>00847                                        indxi,    indxj,    &amp;
<a name="l00848"></a>00848                                        aicen,    vicen,    &amp;
<a name="l00849"></a>00849                                        vsnon,    Tsfcn,    &amp;
<a name="l00850"></a>00850                                        eicen,    esnon,    &amp;
<a name="l00851"></a>00851                                        hin,      hilyr,    &amp;
<a name="l00852"></a>00852                                        hsn,      hslyr,    &amp;
<a name="l00853"></a>00853                                        qin,      Tin,      &amp;
<a name="l00854"></a>00854                                        qsn,      Tsn,      &amp;
<a name="l00855"></a>00855                                        Tsf,      einit,    &amp;
<a name="l00856"></a>00856                                        l_stop,             &amp;
<a name="l00857"></a>00857                                        istop,    jstop)
<a name="l00858"></a>00858 <span class="comment">!</span>
<a name="l00859"></a>00859 <span class="comment">! !USES:</span>
<a name="l00860"></a>00860 <span class="comment">!</span>
<a name="l00861"></a>00861 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00862"></a>00862 <span class="comment">!</span>
<a name="l00863"></a>00863       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00864"></a>00864          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l00865"></a>00865          my_task           ,  <span class="comment">! task number (diagnostic only)</span>
<a name="l00866"></a>00866          istep1            ,  <span class="comment">! time step index (diagnostic only)</span>
<a name="l00867"></a>00867          icells                <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l00868"></a>00868 
<a name="l00869"></a>00869       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l00870"></a>00870          <span class="keywordtype">intent(in)</span> :: 
<a name="l00871"></a>00871          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l00872"></a>00872 
<a name="l00873"></a>00873       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00874"></a>00874          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l00875"></a>00875          vicen ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l00876"></a>00876          vsnon ,  <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l00877"></a>00877          Tsfcn     <span class="comment">! temperature of ice/snow top surface  (C)</span>
<a name="l00878"></a>00878 
<a name="l00879"></a>00879       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,nilyr)</span>, 
<a name="l00880"></a>00880          <span class="keywordtype">intent(in)</span> :: 
<a name="l00881"></a>00881          eicen     <span class="comment">! energy of melting for each ice layer (J/m^2)</span>
<a name="l00882"></a>00882 
<a name="l00883"></a>00883       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,nslyr)</span>, 
<a name="l00884"></a>00884          <span class="keywordtype">intent(in)</span> :: 
<a name="l00885"></a>00885          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l00886"></a>00886 
<a name="l00887"></a>00887       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l00888"></a>00888          hilyr       ,  <span class="comment">! ice layer thickness</span>
<a name="l00889"></a>00889          hslyr       ,  <span class="comment">! snow layer thickness</span>
<a name="l00890"></a>00890          Tsf         ,  <span class="comment">! ice/snow surface temperature, Tsfcn</span>
<a name="l00891"></a>00891          einit           <span class="comment">! initial energy of melting (J m-2)</span>
<a name="l00892"></a>00892 
<a name="l00893"></a>00893       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l00894"></a>00894          hin         ,  <span class="comment">! ice thickness (m)</span>
<a name="l00895"></a>00895          hsn             <span class="comment">! snow thickness (m)</span>
<a name="l00896"></a>00896 
<a name="l00897"></a>00897       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l00898"></a>00898          <span class="keywordtype">intent(out)</span> :: 
<a name="l00899"></a>00899          qin         ,  <span class="comment">! ice layer enthalpy (J m-3)</span>
<a name="l00900"></a>00900          Tin             <span class="comment">! internal ice layer temperatures</span>
<a name="l00901"></a>00901 
<a name="l00902"></a>00902       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l00903"></a>00903          <span class="keywordtype">intent(out)</span> :: 
<a name="l00904"></a>00904          qsn         ,  <span class="comment">! snow enthalpy</span>
<a name="l00905"></a>00905          Tsn             <span class="comment">! snow temperature</span>
<a name="l00906"></a>00906 
<a name="l00907"></a>00907       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l00908"></a>00908          l_stop          <span class="comment">! if true, print diagnostics and abort model</span>
<a name="l00909"></a>00909 
<a name="l00910"></a>00910       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l00911"></a>00911          istop, jstop    <span class="comment">! i and j indices of cell where model fails</span>
<a name="l00912"></a>00912 <span class="comment">!</span>
<a name="l00913"></a>00913 <span class="comment">!EOP</span>
<a name="l00914"></a>00914 <span class="comment">!</span>
<a name="l00915"></a>00915       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l00916"></a>00916          Tmin = -100._dbl_kind <span class="comment">! min allowed internal temperature (deg C)</span>
<a name="l00917"></a>00917 
<a name="l00918"></a>00918       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00919"></a>00919          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l00920"></a>00920          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l00921"></a>00921          k               <span class="comment">! ice layer index</span>
<a name="l00922"></a>00922 
<a name="l00923"></a>00923       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00924"></a>00924          rnslyr,         <span class="comment">! real(nslyr)</span>
<a name="l00925"></a>00925          aa1, bb1, cc1,  <span class="comment">! terms in quadratic formula</span>
<a name="l00926"></a>00926          Tmax             <span class="comment">! maximum allowed snow/ice temperature (deg C)</span>
<a name="l00927"></a>00927 
<a name="l00928"></a>00928       <span class="keywordtype">logical (kind=log_kind) </span>::    <span class="comment">! for vector-friendly error checks</span>
<a name="l00929"></a>00929          tsno_high   ,  <span class="comment">! flag for Tsn &gt; Tmax</span>
<a name="l00930"></a>00930          tice_high   ,  <span class="comment">! flag for Tin &gt; Tmlt</span>
<a name="l00931"></a>00931          tsno_low    ,  <span class="comment">! flag for Tsn &lt; Tmin</span>
<a name="l00932"></a>00932          tice_low        <span class="comment">! flag for Tin &lt; Tmin</span>
<a name="l00933"></a>00933 
<a name="l00934"></a>00934       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00935"></a>00935       <span class="comment">! Initialize</span>
<a name="l00936"></a>00936       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00937"></a>00937 
<a name="l00938"></a>00938       rnslyr = <span class="keywordtype">real</span>(nslyr,kind=dbl_kind)
<a name="l00939"></a>00939 
<a name="l00940"></a>00940       <span class="keyword">do</span> ij = 1, icells
<a name="l00941"></a>00941          einit(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00942"></a>00942       <span class="keyword">enddo</span>
<a name="l00943"></a>00943 
<a name="l00944"></a>00944       tsno_high = .false.
<a name="l00945"></a>00945       tice_high = .false.
<a name="l00946"></a>00946       tsno_low  = .false.
<a name="l00947"></a>00947       tice_low  = .false.
<a name="l00948"></a>00948 
<a name="l00949"></a>00949       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00950"></a>00950       <span class="comment">! Load arrays for vertical thermo calculation.</span>
<a name="l00951"></a>00951       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00952"></a>00952 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00953"></a>00953 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00954"></a>00954 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00955"></a>00955       <span class="keyword">do</span> ij = 1, icells
<a name="l00956"></a>00956          i = indxi(ij)
<a name="l00957"></a>00957          j = indxj(ij)
<a name="l00958"></a>00958 
<a name="l00959"></a>00959       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00960"></a>00960       <span class="comment">! Surface temperature, ice and snow thickness</span>
<a name="l00961"></a>00961       <span class="comment">! Initialize internal energy</span>
<a name="l00962"></a>00962       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00963"></a>00963 
<a name="l00964"></a>00964          Tsf(ij)    = Tsfcn(i,j)
<a name="l00965"></a>00965          hin(ij)    = vicen(i,j) / aicen(i,j)
<a name="l00966"></a>00966          hsn(ij)    = vsnon(i,j) / aicen(i,j)
<a name="l00967"></a>00967          hilyr(ij)    = hin(ij) / <span class="keywordtype">real</span>(nilyr,kind=dbl_kind)
<a name="l00968"></a>00968          hslyr(ij)    = hsn(ij) / rnslyr
<a name="l00969"></a>00969 
<a name="l00970"></a>00970       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l00971"></a>00971 
<a name="l00972"></a>00972       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00973"></a>00973       <span class="comment">! Snow enthalpy and maximum allowed snow temperature</span>
<a name="l00974"></a>00974       <span class="comment">! If heat_capacity = F, qsn and Tsn are never used.</span>
<a name="l00975"></a>00975       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00976"></a>00976 
<a name="l00977"></a>00977       <span class="keyword">do</span> k = 1, nslyr
<a name="l00978"></a>00978 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00979"></a>00979 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00980"></a>00980 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00981"></a>00981          <span class="keyword">do</span> ij = 1, icells
<a name="l00982"></a>00982             i = indxi(ij)
<a name="l00983"></a>00983             j = indxj(ij)
<a name="l00984"></a>00984 
<a name="l00985"></a>00985       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00986"></a>00986       <span class="comment">!</span>
<a name="l00987"></a>00987       <span class="comment">! Tmax based on the idea that dT ~ dq / (rhos*cp_ice)</span>
<a name="l00988"></a>00988       <span class="comment">!                             dq ~ q dv / v</span>
<a name="l00989"></a>00989       <span class="comment">!                             dv ~ puny = eps11</span>
<a name="l00990"></a>00990       <span class="comment">! where &apos;d&apos; denotes an error due to roundoff.</span>
<a name="l00991"></a>00991       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00992"></a>00992 
<a name="l00993"></a>00993             <span class="keyword">if</span> (hslyr(ij) &gt; <a class="code" href="namespaceice__therm__vertical.html#af7421836575fc4323bfe4b53fbc5f1ac">hs_min</a>/rnslyr .and. <a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l00994"></a>00994                <span class="comment">! qsn, esnon &lt; 0              </span>
<a name="l00995"></a>00995                qsn  (ij,k) = esnon(i,j,k)*rnslyr/vsnon(i,j) 
<a name="l00996"></a>00996                Tmax = -qsn(ij,k)*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*rnslyr / &amp;
<a name="l00997"></a>00997                        (<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*cp_ice*vsnon(i,j))
<a name="l00998"></a>00998             <span class="keyword">else</span>
<a name="l00999"></a>00999                qsn  (ij,k) = -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a> * Lfresh
<a name="l01000"></a>01000                Tmax = <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>
<a name="l01001"></a>01001             <span class="keyword">endif</span>
<a name="l01002"></a>01002 
<a name="l01003"></a>01003       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01004"></a>01004       <span class="comment">! Compute snow temperatures from enthalpies.</span>
<a name="l01005"></a>01005       <span class="comment">! Note: qsn &lt;= -rhos*Lfresh, so Tsn &lt;= 0.</span>
<a name="l01006"></a>01006       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01007"></a>01007             Tsn(ij,k) = (Lfresh + qsn(ij,k)/<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>)/cp_ice
<a name="l01008"></a>01008   
<a name="l01009"></a>01009       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01010"></a>01010       <span class="comment">! Check for Tsn &gt; Tmax (allowing for roundoff error) and Tsn &lt; Tmin.</span>
<a name="l01011"></a>01011       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01012"></a>01012             <span class="keyword">if</span> (Tsn(ij,k) &gt; Tmax) <span class="keyword">then</span>
<a name="l01013"></a>01013                tsno_high = .true.
<a name="l01014"></a>01014             elseif (Tsn(ij,k) &lt; Tmin) <span class="keyword">then</span>
<a name="l01015"></a>01015                tsno_low  = .true.
<a name="l01016"></a>01016             <span class="keyword">endif</span>
<a name="l01017"></a>01017 
<a name="l01018"></a>01018          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01019"></a>01019       <span class="keyword">enddo</span>                     <span class="comment">! nslyr</span>
<a name="l01020"></a>01020 
<a name="l01021"></a>01021       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01022"></a>01022       <span class="comment">! If Tsn is out of bounds, print diagnostics and exit.</span>
<a name="l01023"></a>01023       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01024"></a>01024 
<a name="l01025"></a>01025       <span class="keyword">if</span> (tsno_high .and. <a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l01026"></a>01026          <span class="keyword">do</span> k = 1, nslyr
<a name="l01027"></a>01027             <span class="keyword">do</span> ij = 1, icells
<a name="l01028"></a>01028                i = indxi(ij)
<a name="l01029"></a>01029                j = indxj(ij)
<a name="l01030"></a>01030 
<a name="l01031"></a>01031                <span class="keyword">if</span> (hslyr(ij) &gt; <a class="code" href="namespaceice__therm__vertical.html#af7421836575fc4323bfe4b53fbc5f1ac">hs_min</a>/rnslyr) <span class="keyword">then</span>
<a name="l01032"></a>01032                   Tmax = -qsn(ij,k)*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*rnslyr / &amp;
<a name="l01033"></a>01033                            (<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*cp_ice*vsnon(i,j))
<a name="l01034"></a>01034                <span class="keyword">else</span>
<a name="l01035"></a>01035                   Tmax = <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>
<a name="l01036"></a>01036                <span class="keyword">endif</span>
<a name="l01037"></a>01037 
<a name="l01038"></a>01038                <span class="keyword">if</span> (Tsn(ij,k) &gt; Tmax) <span class="keyword">then</span>
<a name="l01039"></a>01039                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01040"></a>01040                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Starting thermo, Tsn &gt; Tmax&apos;</span>
<a name="l01041"></a>01041                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tsn=&apos;</span>,Tsn(ij,k)
<a name="l01042"></a>01042                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tmax=&apos;</span>,Tmax
<a name="l01043"></a>01043                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l01044"></a>01044                                     istep1, my_task, i, j
<a name="l01045"></a>01045                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;qsn&apos;</span>,qsn(ij,k)
<a name="l01046"></a>01046                   l_stop = .true.
<a name="l01047"></a>01047                   istop = i
<a name="l01048"></a>01048                   jstop = j
<a name="l01049"></a>01049                   return
<a name="l01050"></a>01050                <span class="keyword">endif</span>
<a name="l01051"></a>01051 
<a name="l01052"></a>01052             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01053"></a>01053          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l01054"></a>01054       <span class="keyword">endif</span>                     <span class="comment">! tsno_high</span>
<a name="l01055"></a>01055 
<a name="l01056"></a>01056       <span class="keyword">if</span> (tsno_low .and. <a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l01057"></a>01057          <span class="keyword">do</span> k = 1, nslyr
<a name="l01058"></a>01058             <span class="keyword">do</span> ij = 1, icells
<a name="l01059"></a>01059                i = indxi(ij)
<a name="l01060"></a>01060                j = indxj(ij)
<a name="l01061"></a>01061 
<a name="l01062"></a>01062                <span class="keyword">if</span> (Tsn(ij,k) &lt; Tmin) <span class="keyword">then</span> <span class="comment">! allowing for roundoff error</span>
<a name="l01063"></a>01063                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01064"></a>01064                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Starting thermo, Tsn &lt; Tmin&apos;</span>
<a name="l01065"></a>01065                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tsn=&apos;</span>, Tsn(ij,k)
<a name="l01066"></a>01066                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tmin=&apos;</span>, Tmin
<a name="l01067"></a>01067                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l01068"></a>01068                                     istep1, my_task, i, j
<a name="l01069"></a>01069                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;qsn&apos;</span>, qsn(ij,k)
<a name="l01070"></a>01070                   l_stop = .true.
<a name="l01071"></a>01071                   istop = i
<a name="l01072"></a>01072                   jstop = j
<a name="l01073"></a>01073                   return
<a name="l01074"></a>01074                <span class="keyword">endif</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01077"></a>01077          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l01078"></a>01078       <span class="keyword">endif</span>                     <span class="comment">! tsno_low</span>
<a name="l01079"></a>01079 
<a name="l01080"></a>01080       <span class="keyword">do</span> k = 1, nslyr
<a name="l01081"></a>01081 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01082"></a>01082 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01083"></a>01083 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01084"></a>01084          <span class="keyword">do</span> ij = 1, icells
<a name="l01085"></a>01085 
<a name="l01086"></a>01086             <span class="keyword">if</span> (Tsn(ij,k) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>   <span class="comment">! correct roundoff error</span>
<a name="l01087"></a>01087                Tsn(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01088"></a>01088                qsn(ij,k) = -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*Lfresh
<a name="l01089"></a>01089             <span class="keyword">endif</span>
<a name="l01090"></a>01090 
<a name="l01091"></a>01091       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01092"></a>01092       <span class="comment">! initial energy per unit area of ice/snow, relative to 0 C</span>
<a name="l01093"></a>01093       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01094"></a>01094             einit(ij) = einit(ij) + hslyr(ij)*qsn(ij,k)
<a name="l01095"></a>01095 
<a name="l01096"></a>01096          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01097"></a>01097       <span class="keyword">enddo</span>                     <span class="comment">! nslyr</span>
<a name="l01098"></a>01098 
<a name="l01099"></a>01099       <span class="keyword">do</span> k = 1, nilyr
<a name="l01100"></a>01100 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01101"></a>01101 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01102"></a>01102 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01103"></a>01103          <span class="keyword">do</span> ij = 1, icells
<a name="l01104"></a>01104             i = indxi(ij)
<a name="l01105"></a>01105             j = indxj(ij)
<a name="l01106"></a>01106 
<a name="l01107"></a>01107       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01108"></a>01108       <span class="comment">! Compute ice enthalpy</span>
<a name="l01109"></a>01109       <span class="comment">! If heat_capacity = F, qin and Tin are never used.</span>
<a name="l01110"></a>01110       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01111"></a>01111             <span class="comment">! qin, eicen &lt; 0</span>
<a name="l01112"></a>01112             qin(ij,k) = eicen(i,j,k)*<span class="keywordtype">real(nilyr,kind=dbl_kind)</span> 
<a name="l01113"></a>01113                         /vicen(i,j)  
<a name="l01114"></a>01114 
<a name="l01115"></a>01115       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01116"></a>01116       <span class="comment">! Compute ice temperatures from enthalpies using quadratic formula</span>
<a name="l01117"></a>01117       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01118"></a>01118 
<a name="l01119"></a>01119             <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span>
<a name="l01120"></a>01120                aa1 = cp_ice
<a name="l01121"></a>01121                bb1 = (cp_ocn-cp_ice)*<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k) - qin(ij,k)/<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a> - Lfresh 
<a name="l01122"></a>01122                cc1 = Lfresh * <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)
<a name="l01123"></a>01123                Tin(ij,k) =  (-bb1 - sqrt(bb1*bb1 - <a class="code" href="namespaceice__constants.html#a6f2f40b7da63dfa1a4f38dd0126cd848">c4</a>*aa1*cc1)) /  &amp;
<a name="l01124"></a>01124                              (<a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a>*aa1)
<a name="l01125"></a>01125                Tmax = <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)
<a name="l01126"></a>01126 
<a name="l01127"></a>01127             <span class="keyword">else</span>                <span class="comment">! fresh ice</span>
<a name="l01128"></a>01128                Tin(ij,k) = (Lfresh + qin(ij,k)/<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>) / cp_ice
<a name="l01129"></a>01129                Tmax = -qin(ij,k)*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>/(<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*cp_ice*vicen(i,j))
<a name="l01130"></a>01130                          <span class="comment">! as above for snow</span>
<a name="l01131"></a>01131             <span class="keyword">endif</span>
<a name="l01132"></a>01132 
<a name="l01133"></a>01133       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01134"></a>01134       <span class="comment">! Check for Tin &gt; Tmax and Tin &lt; Tmin</span>
<a name="l01135"></a>01135       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01136"></a>01136             <span class="keyword">if</span> (Tin(ij,k) &gt; Tmax) <span class="keyword">then</span>
<a name="l01137"></a>01137                tice_high = .true.
<a name="l01138"></a>01138             elseif (Tin(ij,k) &lt; Tmin) <span class="keyword">then</span>
<a name="l01139"></a>01139                tice_low  = .true.
<a name="l01140"></a>01140             <span class="keyword">endif</span>
<a name="l01141"></a>01141 
<a name="l01142"></a>01142          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01143"></a>01143 
<a name="l01144"></a>01144       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01145"></a>01145       <span class="comment">! If Tin is out of bounds, print diagnostics and exit.</span>
<a name="l01146"></a>01146       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01147"></a>01147 
<a name="l01148"></a>01148          <span class="keyword">if</span> (tice_high .and. <a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l01149"></a>01149             <span class="keyword">do</span> ij = 1, icells
<a name="l01150"></a>01150                i = indxi(ij)
<a name="l01151"></a>01151                j = indxj(ij)
<a name="l01152"></a>01152 
<a name="l01153"></a>01153                <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span>
<a name="l01154"></a>01154                   Tmax = <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)
<a name="l01155"></a>01155                <span class="keyword">else</span>             <span class="comment">! fresh ice</span>
<a name="l01156"></a>01156                   Tmax = -qin(ij,k)*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>/(<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*cp_ice*vicen(i,j))
<a name="l01157"></a>01157                <span class="keyword">endif</span>
<a name="l01158"></a>01158 
<a name="l01159"></a>01159                <span class="keyword">if</span> (Tin(ij,k) &gt; Tmax) <span class="keyword">then</span>
<a name="l01160"></a>01160                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01161"></a>01161                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Starting thermo, T &gt; Tmax, layer&apos;</span>, k
<a name="l01162"></a>01162                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tin=&apos;</span>,Tin(ij,k),<span class="stringliteral">&apos;, Tmax=&apos;</span>,Tmax
<a name="l01163"></a>01163                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l01164"></a>01164                                     istep1, my_task, i, j
<a name="l01165"></a>01165                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;qin&apos;</span>,qin(ij,k)
<a name="l01166"></a>01166                   l_stop = .true.
<a name="l01167"></a>01167                   istop = i
<a name="l01168"></a>01168                   jstop = j
<a name="l01169"></a>01169                   return
<a name="l01170"></a>01170                <span class="keyword">endif</span>
<a name="l01171"></a>01171             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01172"></a>01172          <span class="keyword">endif</span>                  <span class="comment">! tice_high</span>
<a name="l01173"></a>01173 
<a name="l01174"></a>01174          <span class="keyword">if</span> (tice_low .and. <a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l01175"></a>01175             <span class="keyword">do</span> ij = 1, icells
<a name="l01176"></a>01176                i = indxi(ij)
<a name="l01177"></a>01177                j = indxj(ij)
<a name="l01178"></a>01178 
<a name="l01179"></a>01179                <span class="keyword">if</span> (Tin(ij,k) &lt; Tmin) <span class="keyword">then</span>
<a name="l01180"></a>01180                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01181"></a>01181                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Starting thermo T &lt; Tmin, layer&apos;</span>, k
<a name="l01182"></a>01182                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tin =&apos;</span>, Tin(ij,k)
<a name="l01183"></a>01183                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tmin =&apos;</span>, Tmin
<a name="l01184"></a>01184                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l01185"></a>01185                                     istep1, my_task, i, j
<a name="l01186"></a>01186                   l_stop = .true.
<a name="l01187"></a>01187                   istop = i
<a name="l01188"></a>01188                   jstop = j
<a name="l01189"></a>01189                   return
<a name="l01190"></a>01190                <span class="keyword">endif</span>
<a name="l01191"></a>01191             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01192"></a>01192          <span class="keyword">endif</span>                  <span class="comment">! tice_low</span>
<a name="l01193"></a>01193 
<a name="l01194"></a>01194       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01195"></a>01195       <span class="comment">! initial energy per unit area of ice/snow, relative to 0 C</span>
<a name="l01196"></a>01196       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01199"></a>01199 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01200"></a>01200 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01201"></a>01201          <span class="keyword">do</span> ij = 1, icells
<a name="l01202"></a>01202 
<a name="l01203"></a>01203             <span class="keyword">if</span> (Tin(ij,k) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span> <span class="comment">! correct roundoff error</span>
<a name="l01204"></a>01204                Tin(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01205"></a>01205                qin(ij,k) = -<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*Lfresh
<a name="l01206"></a>01206             <span class="keyword">endif</span>
<a name="l01207"></a>01207             
<a name="l01208"></a>01208             einit(ij) = einit(ij) + hilyr(ij)*qin(ij,k) 
<a name="l01209"></a>01209             
<a name="l01210"></a>01210          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 
<a name="l01213"></a>01213       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l01214"></a>01214 
<a name="l01215"></a>01215 <span class="keyword">      end subroutine init_vertical_profile</span>
<a name="l01216"></a>01216 
<a name="l01217"></a>01217 <span class="comment">!=======================================================================</span>
<a name="l01218"></a>01218 <span class="comment">!BOP</span>
<a name="l01219"></a>01219 <span class="comment">!</span>
<a name="l01220"></a>01220 <span class="comment">! !ROUTINE: temperature_changes  - new vertical temperature profile</span>
<a name="l01221"></a>01221 <span class="comment">!</span>
<a name="l01222"></a>01222 <span class="comment">! !DESCRIPTION:</span>
<a name="l01223"></a>01223 <span class="comment">!</span>
<a name="l01224"></a>01224 <span class="comment">! Compute new surface temperature and internal ice and snow</span>
<a name="l01225"></a>01225 <span class="comment">! temperatures.  Include effects of salinity on sea ice heat</span>
<a name="l01226"></a>01226 <span class="comment">! capacity in a way that conserves energy (Bitz and Lipscomb, 1999).</span>
<a name="l01227"></a>01227 <span class="comment">!</span>
<a name="l01228"></a>01228 <span class="comment">! New temperatures are computed iteratively by solving a tridiagonal</span>
<a name="l01229"></a>01229 <span class="comment">! system of equations; heat capacity is updated with each iteration.</span>
<a name="l01230"></a>01230 <span class="comment">! Finite differencing is backward implicit.</span>
<a name="l01231"></a>01231 <span class="comment">!</span>
<a name="l01232"></a>01232 <span class="comment">! See Bitz, C.M., and W.H. Lipscomb, 1999:</span>
<a name="l01233"></a>01233 <span class="comment">! An energy-conserving thermodynamic model of sea ice,</span>
<a name="l01234"></a>01234 <span class="comment">! J. Geophys. Res., 104, 15,669-15,677.</span>
<a name="l01235"></a>01235 <span class="comment">!</span>
<a name="l01236"></a>01236 <span class="comment">! !REVISION HISTORY:</span>
<a name="l01237"></a>01237 <span class="comment">!</span>
<a name="l01238"></a>01238 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l01239"></a>01239 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l01240"></a>01240 <span class="comment">!</span>
<a name="l01241"></a>01241 <span class="comment">! !INTERFACE:</span>
<a name="l01242"></a>01242 <span class="comment">!</span>
<a name="l01243"></a><a class="code" href="namespaceice__therm__vertical.html#afe7e9128dd994fd74827b779ddeaf789">01243</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#afe7e9128dd994fd74827b779ddeaf789">temperature_changes</a> (nx_block, ny_block, &amp;
<a name="l01244"></a>01244                                       my_task,  istep1,   &amp;
<a name="l01245"></a>01245                                       dt,       icells,   &amp; 
<a name="l01246"></a>01246                                       indxi,    indxj,    &amp;
<a name="l01247"></a>01247                                       rhoa,     flw,      &amp;
<a name="l01248"></a>01248                                       potT,     Qa,       &amp;
<a name="l01249"></a>01249                                       shcoef,   lhcoef,   &amp;
<a name="l01250"></a>01250                                       fswsfc,   fswint,   &amp;
<a name="l01251"></a>01251                                       fswthrun, Sswabs,   &amp;
<a name="l01252"></a>01252                                       Iswabs,             &amp;
<a name="l01253"></a>01253                                       hilyr,    hslyr,    &amp;
<a name="l01254"></a>01254                                       qin,      Tin,      &amp;
<a name="l01255"></a>01255                                       qsn,      Tsn,      &amp;
<a name="l01256"></a>01256                                       Tsf,      Tbot,     &amp;
<a name="l01257"></a>01257                                       fsensn,   flatn,    &amp;
<a name="l01258"></a>01258                                       fswabsn,  flwoutn,  &amp;
<a name="l01259"></a>01259                                       fsurfn,             &amp;
<a name="l01260"></a>01260                                       fcondtopn,fcondbot, &amp;
<a name="l01261"></a>01261                                       einit,    l_stop,   &amp;
<a name="l01262"></a>01262                                       istop,    jstop)
<a name="l01263"></a>01263 <span class="comment">!</span>
<a name="l01264"></a>01264 <span class="comment">! !USES:</span>
<a name="l01265"></a>01265 <span class="comment">!</span>
<a name="l01266"></a>01266 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l01267"></a>01267 <span class="comment">!</span>
<a name="l01268"></a>01268       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01269"></a>01269          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l01270"></a>01270          my_task     ,  <span class="comment">! task number (diagnostic only)</span>
<a name="l01271"></a>01271          istep1      ,  <span class="comment">! time step index (diagnostic only)</span>
<a name="l01272"></a>01272          icells          <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l01273"></a>01273 
<a name="l01274"></a>01274       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01275"></a>01275          dt              <span class="comment">! time step</span>
<a name="l01276"></a>01276 
<a name="l01277"></a>01277       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l01278"></a>01278          <span class="keywordtype">intent(in)</span> :: 
<a name="l01279"></a>01279          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l01280"></a>01280 
<a name="l01281"></a>01281       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l01282"></a>01282          <span class="keywordtype">intent(in)</span> :: 
<a name="l01283"></a>01283          rhoa        ,  <span class="comment">! air density (kg/m^3)</span>
<a name="l01284"></a>01284          flw         ,  <span class="comment">! incoming longwave radiation (W/m^2)</span>
<a name="l01285"></a>01285          potT        ,  <span class="comment">! air potential temperature  (K)</span>
<a name="l01286"></a>01286          Qa          ,  <span class="comment">! specific humidity (kg/kg)</span>
<a name="l01287"></a>01287          shcoef      ,  <span class="comment">! transfer coefficient for sensible heat</span>
<a name="l01288"></a>01288          lhcoef      ,  <span class="comment">! transfer coefficient for latent heat</span>
<a name="l01289"></a>01289          Tbot            <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l01290"></a>01290 
<a name="l01291"></a>01291       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l01292"></a>01292          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01293"></a>01293          fswsfc      ,  <span class="comment">! SW absorbed at ice/snow surface (W m-2)</span>
<a name="l01294"></a>01294          fswint      ,  <span class="comment">! SW absorbed in ice interior below surface (W m-2)</span>
<a name="l01295"></a>01295          fswthrun        <span class="comment">! SW through ice to ocean         (W m-2)</span>
<a name="l01296"></a>01296 
<a name="l01297"></a>01297       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01298"></a>01298          hilyr       ,  <span class="comment">! ice layer thickness (m)</span>
<a name="l01299"></a>01299          hslyr       ,  <span class="comment">! snow layer thickness (m)</span>
<a name="l01300"></a>01300          einit           <span class="comment">! initial energy of melting (J m-2)</span>
<a name="l01301"></a>01301 
<a name="l01302"></a>01302       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nslyr)</span>, 
<a name="l01303"></a>01303          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01304"></a>01304          Sswabs          <span class="comment">! SW radiation absorbed in snow layers (W m-2)</span>
<a name="l01305"></a>01305 
<a name="l01306"></a>01306       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nilyr)</span>, 
<a name="l01307"></a>01307          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01308"></a>01308          Iswabs          <span class="comment">! SW radiation absorbed in ice layers (W m-2)</span>
<a name="l01309"></a>01309 
<a name="l01310"></a>01310       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(inout)</span>:: 
<a name="l01311"></a>01311          fsurfn      ,  <span class="comment">! net flux to top surface, excluding fcondtopn</span>
<a name="l01312"></a>01312          fcondtopn   ,  <span class="comment">! downward cond flux at top surface (W m-2)</span>
<a name="l01313"></a>01313          fsensn      ,  <span class="comment">! surface downward sensible heat (W m-2)</span>
<a name="l01314"></a>01314          flatn       ,  <span class="comment">! surface downward latent heat (W m-2)</span>
<a name="l01315"></a>01315          fswabsn     ,  <span class="comment">! shortwave absorbed by ice (W m-2)</span>
<a name="l01316"></a>01316          flwoutn         <span class="comment">! upward LW at surface (W m-2)</span>
<a name="l01317"></a>01317 
<a name="l01318"></a>01318       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l01319"></a>01319          fcondbot        <span class="comment">! downward cond flux at bottom surface (W m-2)</span>
<a name="l01320"></a>01320 
<a name="l01321"></a>01321       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l01322"></a>01322          <span class="keywordtype">intent(inout)</span>:: 
<a name="l01323"></a>01323          Tsf             <span class="comment">! ice/snow surface temperature, Tsfcn</span>
<a name="l01324"></a>01324 
<a name="l01325"></a>01325       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l01326"></a>01326          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01327"></a>01327          qin         ,  <span class="comment">! ice layer enthalpy (J m-3)</span>
<a name="l01328"></a>01328          Tin             <span class="comment">! internal ice layer temperatures</span>
<a name="l01329"></a>01329 
<a name="l01330"></a>01330       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l01331"></a>01331          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01332"></a>01332          qsn         ,  <span class="comment">! snow layer enthalpy (J m-3)</span>
<a name="l01333"></a>01333          Tsn             <span class="comment">! internal snow layer temperatures</span>
<a name="l01334"></a>01334 
<a name="l01335"></a>01335       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l01336"></a>01336          l_stop          <span class="comment">! if true, print diagnostics and abort model</span>
<a name="l01337"></a>01337 
<a name="l01338"></a>01338       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l01339"></a>01339          istop, jstop    <span class="comment">! i and j indices of cell where model fails</span>
<a name="l01340"></a>01340 <span class="comment">!</span>
<a name="l01341"></a>01341 <span class="comment">!EOP</span>
<a name="l01342"></a>01342 <span class="comment">!</span>
<a name="l01343"></a>01343       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l01344"></a>01344          nitermax = 50,  <span class="comment">! max number of iterations in temperature solver</span>
<a name="l01345"></a>01345          nmat = nslyr + nilyr + 1  <span class="comment">! matrix dimension</span>
<a name="l01346"></a>01346 
<a name="l01347"></a>01347       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l01348"></a>01348          Tsf_errmax = 5.e-4_dbl_kind <span class="comment">! max allowed error in Tsf</span>
<a name="l01349"></a>01349                                      <span class="comment">! recommend Tsf_errmax &lt; 0.01 K</span>
<a name="l01350"></a>01350 
<a name="l01351"></a>01351       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01352"></a>01352          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l01353"></a>01353          ij, m       ,  <span class="comment">! horizontal indices, combine i and j loops</span>
<a name="l01354"></a>01354          k           ,  <span class="comment">! ice layer index</span>
<a name="l01355"></a>01355          niter           <span class="comment">! iteration counter in temperature solver</span>
<a name="l01356"></a>01356 
<a name="l01357"></a>01357       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01358"></a>01358          isolve          <span class="comment">! number of cells with temps not converged</span>
<a name="l01359"></a>01359 
<a name="l01360"></a>01360       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l01361"></a>01361          indxii, indxjj  <span class="comment">! compressed indices for cells not converged</span>
<a name="l01362"></a>01362 
<a name="l01363"></a>01363       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l01364"></a>01364          indxij          <span class="comment">! compressed 1D index for cells not converged</span>
<a name="l01365"></a>01365 
<a name="l01366"></a>01366       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l01367"></a>01367          l_snow      ,  <span class="comment">! true if snow temperatures are computed</span>
<a name="l01368"></a>01368          l_cold          <span class="comment">! true if surface temperature is computed</span>
<a name="l01369"></a>01369 
<a name="l01370"></a>01370       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:)</span>, <span class="keywordtype">allocatable</span> :: 
<a name="l01371"></a>01371          Tsf_start   ,  <span class="comment">! Tsf at start of iteration</span>
<a name="l01372"></a>01372          dTsf        ,  <span class="comment">! Tsf - Tsf_start</span>
<a name="l01373"></a>01373          dTi1        ,  <span class="comment">! Ti1(1) - Tin_start(1)</span>
<a name="l01374"></a>01374          dfsurf_dT   ,  <span class="comment">! derivative of fsurf wrt Tsf</span>
<a name="l01375"></a>01375          avg_Tsi     ,  <span class="comment">! = 1. if new snow/ice temps avg&apos;d w/starting temps</span>
<a name="l01376"></a>01376          enew            <span class="comment">! new energy of melting after temp change (J m-2)</span>
<a name="l01377"></a>01377 
<a name="l01378"></a>01378       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l01379"></a>01379          dTsf_prev   ,  <span class="comment">! dTsf from previous iteration</span>
<a name="l01380"></a>01380          dTi1_prev   ,  <span class="comment">! dTi1 from previous iteration</span>
<a name="l01381"></a>01381          dfsens_dT   ,  <span class="comment">! deriv of fsens wrt Tsf (W m-2 deg-1)</span>
<a name="l01382"></a>01382          dflat_dT    ,  <span class="comment">! deriv of flat wrt Tsf (W m-2 deg-1)</span>
<a name="l01383"></a>01383          dflwout_dT  ,  <span class="comment">! deriv of flwout wrt Tsf (W m-2 deg-1)</span>
<a name="l01384"></a>01384          dt_rhoi_hlyr    <span class="comment">! dt/(rhoi*hilyr)</span>
<a name="l01385"></a>01385 
<a name="l01386"></a>01386       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr) </span>:: 
<a name="l01387"></a>01387          Tin_init    ,  <span class="comment">! Tin at beginning of time step</span>
<a name="l01388"></a>01388          Tin_start       <span class="comment">! Tin at start of iteration</span>
<a name="l01389"></a>01389 
<a name="l01390"></a>01390       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr) </span>:: 
<a name="l01391"></a>01391          Tsn_init    ,  <span class="comment">! Tsn at beginning of time step</span>
<a name="l01392"></a>01392          Tsn_start   ,  <span class="comment">! Tsn at start of iteration</span>
<a name="l01393"></a>01393          etas            <span class="comment">! dt / (rho * cp * h) for snow layers</span>
<a name="l01394"></a>01394 
<a name="l01395"></a>01395       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:,:)</span>, <span class="keywordtype">allocatable</span> :: 
<a name="l01396"></a>01396          etai        ,  <span class="comment">! dt / (rho * cp * h) for ice layers</span>
<a name="l01397"></a>01397          sbdiag      ,  <span class="comment">! sub-diagonal matrix elements</span>
<a name="l01398"></a>01398          diag        ,  <span class="comment">! diagonal matrix elements</span>
<a name="l01399"></a>01399          spdiag      ,  <span class="comment">! super-diagonal matrix elements</span>
<a name="l01400"></a>01400          rhs         ,  <span class="comment">! rhs of tri-diagonal matrix equation</span>
<a name="l01401"></a>01401          Tmat            <span class="comment">! matrix output temperatures</span>
<a name="l01402"></a>01402 
<a name="l01403"></a>01403       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells,nilyr+nslyr+1)</span>:: 
<a name="l01404"></a>01404          kh              <span class="comment">! effective conductivity at interfaces (W m-2 deg-1)</span>
<a name="l01405"></a>01405 
<a name="l01406"></a>01406       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l01407"></a>01407          ci          ,  <span class="comment">! specific heat of sea ice (J kg-1 deg-1)</span>
<a name="l01408"></a>01408          avg_Tsf     ,  <span class="comment">! = 1. if Tsf averaged w/Tsf_start, else = 0.</span>
<a name="l01409"></a>01409          ferr        ,  <span class="comment">! energy conservation error (W m-2)</span>
<a name="l01410"></a>01410          Iswabs_tmp  , 
<a name="l01411"></a>01411          Sswabs_tmp  , 
<a name="l01412"></a>01412          etai_tmp
<a name="l01413"></a>01413 
<a name="l01414"></a>01414       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l01415"></a>01415          converged      <span class="comment">! = true when local solution has converged</span>
<a name="l01416"></a>01416 
<a name="l01417"></a>01417       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l01418"></a>01418          all_converged  <span class="comment">! = true when all cells have converged</span>
<a name="l01419"></a>01419 
<a name="l01420"></a>01420       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01421"></a>01421       <span class="comment">! Initialize</span>
<a name="l01422"></a>01422       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01423"></a>01423 
<a name="l01424"></a>01424       all_converged   = .false.
<a name="l01425"></a>01425 
<a name="l01426"></a>01426       <span class="keyword">do</span> ij = 1, icells
<a name="l01427"></a>01427 
<a name="l01428"></a>01428          converged (ij) = .false.
<a name="l01429"></a>01429          l_snow    (ij) = .false.
<a name="l01430"></a>01430          l_cold    (ij) = .true.
<a name="l01431"></a>01431          fcondbot  (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01432"></a>01432          dTsf_prev (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01433"></a>01433          dTi1_prev (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01434"></a>01434          dfsens_dT (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01435"></a>01435          dflat_dT  (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01436"></a>01436          dflwout_dT(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>  
<a name="l01437"></a>01437          dt_rhoi_hlyr(ij) = dt / (<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*hilyr(ij))  <span class="comment">! hilyr &gt; 0</span>
<a name="l01438"></a>01438          <span class="keyword">if</span> (hslyr(ij) &gt; <a class="code" href="namespaceice__therm__vertical.html#af7421836575fc4323bfe4b53fbc5f1ac">hs_min</a>/<span class="keywordtype">real</span>(nslyr,kind=dbl_kind)) 
<a name="l01439"></a>01439             l_snow(ij) = .true.
<a name="l01440"></a>01440       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l01441"></a>01441 
<a name="l01442"></a>01442       <span class="keyword">do</span> k = 1, nslyr
<a name="l01443"></a>01443          <span class="keyword">do</span> ij = 1, icells
<a name="l01444"></a>01444             Tsn_init (ij,k) = Tsn(ij,k) <span class="comment">! beginning of time step</span>
<a name="l01445"></a>01445             Tsn_start(ij,k) = Tsn(ij,k) <span class="comment">! beginning of iteration</span>
<a name="l01446"></a>01446             <span class="keyword">if</span> (l_snow(ij)) <span class="keyword">then</span>
<a name="l01447"></a>01447                etas(ij,k) = dt/(<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*cp_ice*hslyr(ij))
<a name="l01448"></a>01448             <span class="keyword">else</span>
<a name="l01449"></a>01449                etas(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01450"></a>01450             <span class="keyword">endif</span>
<a name="l01451"></a>01451          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01452"></a>01452       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l01453"></a>01453 
<a name="l01454"></a>01454       <span class="keyword">do</span> k = 1, nilyr
<a name="l01455"></a>01455          <span class="keyword">do</span> ij = 1, icells
<a name="l01456"></a>01456             Tin_init (ij,k) = Tin(ij,k)   <span class="comment">! beginning of time step</span>
<a name="l01457"></a>01457             Tin_start(ij,k) = Tin(ij,k)   <span class="comment">! beginning of iteration</span>
<a name="l01458"></a>01458          <span class="keyword">enddo</span>
<a name="l01459"></a>01459       <span class="keyword">enddo</span>
<a name="l01460"></a>01460 
<a name="l01461"></a>01461       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01462"></a>01462       <span class="comment">! Compute thermal conductivity at interfaces (held fixed during</span>
<a name="l01463"></a>01463       <span class="comment">!  subsequent iterations).</span>
<a name="l01464"></a>01464       <span class="comment">! Ice and snow interfaces are combined into one array (kh) to</span>
<a name="l01465"></a>01465       <span class="comment">!  simplify the logic.</span>
<a name="l01466"></a>01466       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01467"></a>01467 
<a name="l01468"></a>01468       call <a class="code" href="namespaceice__therm__vertical.html#aeeb37e6f39ffa2d7269ac471d047a789">conductivity </a>(nx_block, ny_block,         &amp;
<a name="l01469"></a>01469                          l_snow,   icells,           &amp;
<a name="l01470"></a>01470                          indxi,    indxj,    indxij, &amp;
<a name="l01471"></a>01471                          hilyr,    hslyr,            &amp;
<a name="l01472"></a>01472                          Tin,      kh )
<a name="l01473"></a>01473 
<a name="l01474"></a>01474       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01475"></a>01475       <span class="comment">! Check for excessive absorbed solar radiation that may result in</span>
<a name="l01476"></a>01476       <span class="comment">! temperature overshoots.  Switch that radiation to fswsfc if necessary. </span>
<a name="l01477"></a>01477       <span class="comment">! NOTE: This option is not available if the atmosphere model</span>
<a name="l01478"></a>01478       <span class="comment">!       has already computed fsurf.  (Unless we adjust fsurf here)</span>
<a name="l01479"></a>01479       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01480"></a>01480 <span class="comment">!mclaren: Should there be an if calc_Tsfc statement here then?? </span>
<a name="l01481"></a>01481 
<a name="l01482"></a>01482       <span class="keyword">do</span> k = 1, nilyr
<a name="l01483"></a>01483          <span class="keyword">do</span> ij = 1, icells
<a name="l01484"></a>01484             i = indxi(ij)
<a name="l01485"></a>01485             j = indxj(ij)
<a name="l01486"></a>01486 
<a name="l01487"></a>01487             <span class="keyword">if</span> (Tin_init(ij,k) &lt;= (<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k) - <a class="code" href="namespaceice__constants.html#a985c2a8f778734c09e77d0a0cdaaa190">p01</a>)) <span class="keyword">then</span>
<a name="l01488"></a>01488 
<a name="l01489"></a>01489             <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span>
<a name="l01490"></a>01490                ci = cp_ice - Lfresh*<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k) /  &amp;
<a name="l01491"></a>01491                   max( Tin_init(ij,k)**2, <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)**2 )
<a name="l01492"></a>01492                etai_tmp = dt_rhoi_hlyr(ij) / ci
<a name="l01493"></a>01493                Iswabs_tmp = min(Iswabs(i,j,k), &amp;
<a name="l01494"></a>01494                                 (<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)-Tin_init(ij,k))/etai_tmp)
<a name="l01495"></a>01495             <span class="keyword">else</span>
<a name="l01496"></a>01496                ci = cp_ice
<a name="l01497"></a>01497                etai_tmp = dt_rhoi_hlyr(ij) / ci
<a name="l01498"></a>01498                Iswabs_tmp = min(Iswabs(i,j,k), &amp;
<a name="l01499"></a>01499                                 Tin_init(ij,k)/etai_tmp)
<a name="l01500"></a>01500             <span class="keyword">endif</span>
<a name="l01501"></a>01501 
<a name="l01502"></a>01502             fswsfc(i,j)   = fswsfc(i,j) + (Iswabs(i,j,k) - Iswabs_tmp)
<a name="l01503"></a>01503             fswint(i,j)   = fswint(i,j) - (Iswabs(i,j,k) - Iswabs_tmp)
<a name="l01504"></a>01504             Iswabs(i,j,k) = Iswabs_tmp
<a name="l01505"></a>01505 
<a name="l01506"></a>01506             <span class="keyword">else</span>
<a name="l01507"></a>01507 
<a name="l01508"></a>01508             fswsfc(i,j)   = fswsfc(i,j) + Iswabs(i,j,k)
<a name="l01509"></a>01509             fswint(i,j)   = fswint(i,j) - Iswabs(i,j,k)
<a name="l01510"></a>01510             Iswabs(i,j,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01511"></a>01511 
<a name="l01512"></a>01512             <span class="keyword">endif</span>
<a name="l01513"></a>01513          <span class="keyword">enddo</span>
<a name="l01514"></a>01514       <span class="keyword">enddo</span>
<a name="l01515"></a>01515 
<a name="l01516"></a>01516       <span class="keyword">do</span> k = 1, nslyr
<a name="l01517"></a>01517          <span class="keyword">do</span> ij = 1, icells
<a name="l01518"></a>01518             <span class="keyword">if</span> (l_snow(ij)) <span class="keyword">then</span>
<a name="l01519"></a>01519                i = indxi(ij)
<a name="l01520"></a>01520                j = indxj(ij)
<a name="l01521"></a>01521 
<a name="l01522"></a>01522                <span class="keyword">if</span> (Tsn_init(ij,k) &lt;= -<a class="code" href="namespaceice__constants.html#a985c2a8f778734c09e77d0a0cdaaa190">p01</a>) <span class="keyword">then</span>
<a name="l01523"></a>01523 
<a name="l01524"></a>01524                Sswabs_tmp = min(Sswabs(i,j,k), &amp;
<a name="l01525"></a>01525                             -0.9_dbl_kind*Tsn_init(ij,k)/etas(ij,k))
<a name="l01526"></a>01526 
<a name="l01527"></a>01527                fswsfc(i,j)   = fswsfc(i,j) + (Sswabs(i,j,k) - Sswabs_tmp)
<a name="l01528"></a>01528                fswint(i,j)   = fswint(i,j) - (Sswabs(i,j,k) - Sswabs_tmp)
<a name="l01529"></a>01529                Sswabs(i,j,k) = Sswabs_tmp
<a name="l01530"></a>01530 
<a name="l01531"></a>01531                <span class="keyword">else</span>
<a name="l01532"></a>01532 
<a name="l01533"></a>01533                fswsfc(i,j)   = fswsfc(i,j) + Sswabs(i,j,k)
<a name="l01534"></a>01534                fswint(i,j)   = fswint(i,j) - Sswabs(i,j,k)
<a name="l01535"></a>01535                Sswabs(i,j,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01536"></a>01536 
<a name="l01537"></a>01537                <span class="keyword">endif</span>
<a name="l01538"></a>01538             <span class="keyword">endif</span>
<a name="l01539"></a>01539          <span class="keyword">enddo</span>
<a name="l01540"></a>01540       <span class="keyword">enddo</span>
<a name="l01541"></a>01541 
<a name="l01542"></a>01542 <span class="comment">!lipscomb - This could be done in the shortwave module instead.</span>
<a name="l01543"></a>01543 <span class="comment">!           (Change zerolayer routine also)</span>
<a name="l01544"></a>01544       <span class="comment">! absorbed shortwave flux for coupler</span>
<a name="l01545"></a>01545 
<a name="l01546"></a>01546       <span class="keyword">do</span> ij = 1, icells
<a name="l01547"></a>01547          i = indxi(ij)
<a name="l01548"></a>01548          j = indxj(ij)
<a name="l01549"></a>01549          fswabsn(i,j) = fswsfc(i,j) + fswint(i,j) + fswthrun(i,j)
<a name="l01550"></a>01550       <span class="keyword">enddo</span>
<a name="l01551"></a>01551 
<a name="l01552"></a>01552       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01553"></a>01553       <span class="comment">! Solve for new temperatures.</span>
<a name="l01554"></a>01554       <span class="comment">! Iterate until temperatures converge with minimal energy error.</span>
<a name="l01555"></a>01555       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01556"></a>01556 
<a name="l01557"></a>01557       <span class="keyword">do</span> niter = 1, nitermax
<a name="l01558"></a>01558 
<a name="l01559"></a>01559       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01560"></a>01560       <span class="comment">! Identify cells, if any, where calculation has not converged.</span>
<a name="l01561"></a>01561       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01562"></a>01562 
<a name="l01563"></a>01563          <span class="keyword">if</span> (all_converged) <span class="keyword">then</span>  <span class="comment">! thermo calculation is done</span>
<a name="l01564"></a>01564             exit
<a name="l01565"></a>01565          <span class="keyword">else</span>                     <span class="comment">! identify cells not yet converged</span>
<a name="l01566"></a>01566             isolve = 0
<a name="l01567"></a>01567             <span class="keyword">do</span> ij = 1, icells
<a name="l01568"></a>01568                i = indxi(ij)
<a name="l01569"></a>01569                j = indxj(ij)
<a name="l01570"></a>01570                <span class="keyword">if</span> (.not.converged(ij)) <span class="keyword">then</span>
<a name="l01571"></a>01571                   isolve = isolve + 1
<a name="l01572"></a>01572                   indxii(isolve) = i
<a name="l01573"></a>01573                   indxjj(isolve) = j
<a name="l01574"></a>01574                   indxij(isolve) = ij
<a name="l01575"></a>01575                <span class="keyword">endif</span>
<a name="l01576"></a>01576             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01577"></a>01577          <span class="keyword">endif</span>
<a name="l01578"></a>01578 
<a name="l01579"></a>01579       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01580"></a>01580       <span class="comment">! Allocate and initialize</span>
<a name="l01581"></a>01581       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01582"></a>01582 
<a name="l01583"></a>01583          <span class="keyword">allocate</span>(   sbdiag(isolve,nilyr+nslyr+1))
<a name="l01584"></a>01584          <span class="keyword">allocate</span>(     diag(isolve,nilyr+nslyr+1))
<a name="l01585"></a>01585          <span class="keyword">allocate</span>(   spdiag(isolve,nilyr+nslyr+1))
<a name="l01586"></a>01586          <span class="keyword">allocate</span>(      rhs(isolve,nilyr+nslyr+1))
<a name="l01587"></a>01587          <span class="keyword">allocate</span>(     Tmat(isolve,nilyr+nslyr+1))
<a name="l01588"></a>01588          <span class="keyword">allocate</span>(     etai(isolve,nilyr))
<a name="l01589"></a>01589          <span class="keyword">allocate</span>(Tsf_start(isolve))
<a name="l01590"></a>01590          <span class="keyword">allocate</span>(     dTsf(isolve))
<a name="l01591"></a>01591          <span class="keyword">allocate</span>(dfsurf_dT(isolve))
<a name="l01592"></a>01592          <span class="keyword">allocate</span>(  avg_Tsi(isolve))
<a name="l01593"></a>01593          <span class="keyword">allocate</span>(     enew(isolve))
<a name="l01594"></a>01594          <span class="keyword">allocate</span>(     dTi1(isolve))
<a name="l01595"></a>01595 
<a name="l01596"></a>01596          all_converged = .true.
<a name="l01597"></a>01597 
<a name="l01598"></a>01598          <span class="keyword">do</span> ij = 1, isolve
<a name="l01599"></a>01599             m = indxij(ij)
<a name="l01600"></a>01600             converged(m)  = .true.
<a name="l01601"></a>01601             dfsurf_dT(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01602"></a>01602             avg_Tsi  (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01603"></a>01603             enew     (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01604"></a>01604          <span class="keyword">enddo</span>
<a name="l01605"></a>01605 
<a name="l01606"></a>01606       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01607"></a>01607       <span class="comment">! Update specific heat of ice layers.</span>
<a name="l01608"></a>01608       <span class="comment">! To ensure energy conservation, the specific heat is a function of</span>
<a name="l01609"></a>01609       <span class="comment">! both the starting temperature and the (latest guess for) the</span>
<a name="l01610"></a>01610       <span class="comment">! final temperature.</span>
<a name="l01611"></a>01611       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01612"></a>01612 
<a name="l01613"></a>01613          <span class="keyword">do</span> k = 1, nilyr
<a name="l01614"></a>01614             <span class="keyword">do</span> ij = 1, isolve
<a name="l01615"></a>01615                m = indxij(ij)
<a name="l01616"></a>01616                i = indxii(ij)
<a name="l01617"></a>01617                j = indxjj(ij)
<a name="l01618"></a>01618 
<a name="l01619"></a>01619                <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span>
<a name="l01620"></a>01620                   ci = cp_ice - Lfresh*<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k) /  &amp;
<a name="l01621"></a>01621                                 (Tin(m,k)*Tin_init(m,k))
<a name="l01622"></a>01622                <span class="keyword">else</span>
<a name="l01623"></a>01623                   ci = cp_ice
<a name="l01624"></a>01624                <span class="keyword">endif</span>
<a name="l01625"></a>01625                etai(ij,k) = dt_rhoi_hlyr(m) / ci
<a name="l01626"></a>01626 
<a name="l01627"></a>01627             <span class="keyword">enddo</span>
<a name="l01628"></a>01628          <span class="keyword">enddo</span>
<a name="l01629"></a>01629 
<a name="l01630"></a>01630          <span class="keyword">if</span> (calc_Tsfc) <span class="keyword">then</span>
<a name="l01631"></a>01631 
<a name="l01632"></a>01632       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01633"></a>01633       <span class="comment">! Update radiative and turbulent fluxes and their derivatives</span>
<a name="l01634"></a>01634       <span class="comment">! with respect to Tsf.</span>
<a name="l01635"></a>01635       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01636"></a>01636 
<a name="l01637"></a>01637           call <a class="code" href="namespaceice__therm__vertical.html#aa2320460f9c52d821db02db2209fa888">surface_fluxes</a>(nx_block,    ny_block,          &amp;
<a name="l01638"></a>01638                               isolve,      icells,            &amp;
<a name="l01639"></a>01639                               indxii,      indxjj,    indxij, &amp;
<a name="l01640"></a>01640                               Tsf,         fswsfc,            &amp;
<a name="l01641"></a>01641                               rhoa,        flw,               &amp;
<a name="l01642"></a>01642                               potT,        Qa,                &amp;
<a name="l01643"></a>01643                               shcoef,      lhcoef,            &amp;
<a name="l01644"></a>01644                               flwoutn,     fsensn,            &amp;
<a name="l01645"></a>01645                               flatn,       fsurfn,            &amp;
<a name="l01646"></a>01646                               dflwout_dT,  dfsens_dT,         &amp;
<a name="l01647"></a>01647                               dflat_dT,    dfsurf_dT)
<a name="l01648"></a>01648 
<a name="l01649"></a>01649 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01650"></a>01650 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01651"></a>01651 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01652"></a>01652           <span class="keyword">do</span> ij = 1, isolve
<a name="l01653"></a>01653             i = indxii(ij)
<a name="l01654"></a>01654             j = indxjj(ij)
<a name="l01655"></a>01655             m = indxij(ij)
<a name="l01656"></a>01656 
<a name="l01657"></a>01657       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01658"></a>01658       <span class="comment">! Compute conductive flux at top surface, fcondtopn.</span>
<a name="l01659"></a>01659       <span class="comment">! If fsurfn &lt; fcondtopn and Tsf = 0, then reset Tsf to slightly less</span>
<a name="l01660"></a>01660       <span class="comment">!  than zero (but not less than -puny).</span>
<a name="l01661"></a>01661       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01662"></a>01662 
<a name="l01663"></a>01663             <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l01664"></a>01664                fcondtopn(i,j) = kh(m,1) * (Tsf(m) - Tsn(m,1))
<a name="l01665"></a>01665             <span class="keyword">else</span>
<a name="l01666"></a>01666                fcondtopn(i,j) = kh(m,1+nslyr) * (Tsf(m) - Tin(m,1))
<a name="l01667"></a>01667             <span class="keyword">endif</span>
<a name="l01668"></a>01668 
<a name="l01669"></a>01669             <span class="keyword">if</span> (fsurfn(i,j) &lt; fcondtopn(i,j)) &amp;
<a name="l01670"></a>01670                  Tsf(m) = min (Tsf(m), -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)
<a name="l01671"></a>01671 
<a name="l01672"></a>01672       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01673"></a>01673       <span class="comment">! Save surface temperature at start of iteration</span>
<a name="l01674"></a>01674       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01675"></a>01675 
<a name="l01676"></a>01676             Tsf_start(ij) = Tsf(m)
<a name="l01677"></a>01677 
<a name="l01678"></a>01678             <span class="keyword">if</span> (Tsf(m) &lt;= -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01679"></a>01679                l_cold(m) = .true.
<a name="l01680"></a>01680             <span class="keyword">else</span>
<a name="l01681"></a>01681                l_cold(m) = .false.
<a name="l01682"></a>01682             <span class="keyword">endif</span>
<a name="l01683"></a>01683           <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01684"></a>01684 
<a name="l01685"></a>01685       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01686"></a>01686       <span class="comment">! Compute elements of tridiagonal matrix.</span>
<a name="l01687"></a>01687       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01688"></a>01688 
<a name="l01689"></a>01689             call <a class="code" href="namespaceice__therm__vertical.html#a40c9d90a69710b5b555fd78ff83c3009">get_matrix_elements_calc_Tsfc</a> &amp;
<a name="l01690"></a>01690                                   (nx_block, ny_block,         &amp;
<a name="l01691"></a>01691                                    isolve,   icells,           &amp;
<a name="l01692"></a>01692                                    indxii,   indxjj,   indxij, &amp;
<a name="l01693"></a>01693                                    l_snow,   l_cold,           &amp;
<a name="l01694"></a>01694                                    Tsf,      Tbot,             &amp;
<a name="l01695"></a>01695                                    fsurfn,   dfsurf_dT,        &amp;
<a name="l01696"></a>01696                                    Tin_init, Tsn_init,         &amp;
<a name="l01697"></a>01697                                    kh,       Sswabs(:,:,:),    &amp;
<a name="l01698"></a>01698                                    Iswabs,                     &amp;
<a name="l01699"></a>01699                                    etai,     etas,             &amp;
<a name="l01700"></a>01700                                    sbdiag,   diag,             &amp;
<a name="l01701"></a>01701                                    spdiag,   rhs)
<a name="l01702"></a>01702 
<a name="l01703"></a>01703          <span class="keyword">else</span>
<a name="l01704"></a>01704             call <a class="code" href="namespaceice__therm__vertical.html#ad636d3bbc26f9737173a670b7c43bfec">get_matrix_elements_know_Tsfc</a> &amp;
<a name="l01705"></a>01705                                   (nx_block, ny_block,         &amp;
<a name="l01706"></a>01706                                    isolve,   icells,           &amp;
<a name="l01707"></a>01707                                    indxii,   indxjj,   indxij, &amp;
<a name="l01708"></a>01708                                    l_snow,   Tbot,             &amp;
<a name="l01709"></a>01709                                    Tin_init, Tsn_init,         &amp;
<a name="l01710"></a>01710                                    kh,       Sswabs(:,:,:),    &amp;
<a name="l01711"></a>01711                                    Iswabs,                     &amp;
<a name="l01712"></a>01712                                    etai,     etas,             &amp;
<a name="l01713"></a>01713                                    sbdiag,   diag,             &amp;
<a name="l01714"></a>01714                                    spdiag,   rhs,              &amp;
<a name="l01715"></a>01715                                    fcondtopn)
<a name="l01716"></a>01716          <span class="keyword">endif</span>  <span class="comment">! calc_Tsfc</span>
<a name="l01717"></a>01717 
<a name="l01718"></a>01718       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01719"></a>01719       <span class="comment">! Solve tridiagonal matrix to obtain the new temperatures.</span>
<a name="l01720"></a>01720       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01721"></a>01721 
<a name="l01722"></a>01722          call <a class="code" href="namespaceice__therm__vertical.html#aa5780ef62e3f9b27790b7ba6c47116a0">tridiag_solver </a>(nx_block, ny_block, &amp;
<a name="l01723"></a>01723                               isolve,   icells,   &amp;
<a name="l01724"></a>01724                               indxii,   indxjj,   &amp;
<a name="l01725"></a>01725                               nmat,     sbdiag,   &amp;
<a name="l01726"></a>01726                               diag,     spdiag,   &amp;
<a name="l01727"></a>01727                               rhs,      Tmat)
<a name="l01728"></a>01728 
<a name="l01729"></a>01729       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01730"></a>01730       <span class="comment">! Determine whether the computation has converged to an acceptable</span>
<a name="l01731"></a>01731       <span class="comment">! solution.  Five conditions must be satisfied:</span>
<a name="l01732"></a>01732       <span class="comment">!</span>
<a name="l01733"></a>01733       <span class="comment">!    (1) Tsf &lt;= 0 C.</span>
<a name="l01734"></a>01734       <span class="comment">!    (2) Tsf is not oscillating; i.e., if both dTsf(niter) and</span>
<a name="l01735"></a>01735       <span class="comment">!        dTsf(niter-1) have magnitudes greater than puny, then</span>
<a name="l01736"></a>01736       <span class="comment">!        dTsf(niter)/dTsf(niter-1) cannot be a negative number</span>
<a name="l01737"></a>01737       <span class="comment">!        with magnitude greater than 0.5.  </span>
<a name="l01738"></a>01738       <span class="comment">!    (3) abs(dTsf) &lt; Tsf_errmax</span>
<a name="l01739"></a>01739       <span class="comment">!    (4) If Tsf = 0 C, then the downward turbulent/radiative </span>
<a name="l01740"></a>01740       <span class="comment">!        flux, fsurfn, must be greater than or equal to the downward</span>
<a name="l01741"></a>01741       <span class="comment">!        conductive flux, fcondtopn.</span>
<a name="l01742"></a>01742       <span class="comment">!    (5) The net energy added to the ice per unit time must equal </span>
<a name="l01743"></a>01743       <span class="comment">!        the net change in internal ice energy per unit time,</span>
<a name="l01744"></a>01744       <span class="comment">!        within the prescribed error ferrmax.</span>
<a name="l01745"></a>01745       <span class="comment">!</span>
<a name="l01746"></a>01746       <span class="comment">! For briny ice (the standard case), Tsn and Tin are limited</span>
<a name="l01747"></a>01747       <span class="comment">!  to prevent them from exceeding their melting temperatures.</span>
<a name="l01748"></a>01748       <span class="comment">!  (Note that the specific heat formula for briny ice assumes</span>
<a name="l01749"></a>01749       <span class="comment">!  that T &lt; Tmlt.)  </span>
<a name="l01750"></a>01750       <span class="comment">! For fresh ice there is no limiting, since there are cases</span>
<a name="l01751"></a>01751       <span class="comment">!  when the only convergent solution has Tsn &gt; 0 and/or Tin &gt; 0.</span>
<a name="l01752"></a>01752       <span class="comment">!  Above-zero temperatures are then reset to zero (with melting </span>
<a name="l01753"></a>01753       <span class="comment">!  to conserve energy) in the thickness_changes subroutine.</span>
<a name="l01754"></a>01754       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01755"></a>01755 
<a name="l01756"></a>01756          <span class="keyword">if</span> (calc_Tsfc) <span class="keyword">then</span>
<a name="l01757"></a>01757 
<a name="l01758"></a>01758 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01759"></a>01759 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01760"></a>01760 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01761"></a>01761           <span class="keyword">do</span> ij = 1, isolve
<a name="l01762"></a>01762             m = indxij(ij)
<a name="l01763"></a>01763 
<a name="l01764"></a>01764       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01765"></a>01765       <span class="comment">! Reload Tsf from matrix solution</span>
<a name="l01766"></a>01766       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01767"></a>01767 
<a name="l01768"></a>01768             <span class="keyword">if</span> (l_cold(m)) <span class="keyword">then</span>
<a name="l01769"></a>01769                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l01770"></a>01770                   Tsf(m) = Tmat(ij,1)
<a name="l01771"></a>01771                <span class="keyword">else</span>
<a name="l01772"></a>01772                   Tsf(m) = Tmat(ij,1+nslyr)
<a name="l01773"></a>01773                <span class="keyword">endif</span>
<a name="l01774"></a>01774             <span class="keyword">else</span>                <span class="comment">! melting surface</span>
<a name="l01775"></a>01775                Tsf(m) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01776"></a>01776             <span class="keyword">endif</span>
<a name="l01777"></a>01777 
<a name="l01778"></a>01778       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01779"></a>01779       <span class="comment">! Initialize convergence flag (true until proven false), dTsf,</span>
<a name="l01780"></a>01780       <span class="comment">!  and temperature-averaging coefficients.</span>
<a name="l01781"></a>01781       <span class="comment">! Average only if test 1 or 2 fails.</span>
<a name="l01782"></a>01782       <span class="comment">! Initialize energy.</span>
<a name="l01783"></a>01783       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01784"></a>01784 
<a name="l01785"></a>01785             dTsf(ij) = Tsf(m) - Tsf_start(ij)
<a name="l01786"></a>01786             avg_Tsf  = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01787"></a>01787 
<a name="l01788"></a>01788       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01789"></a>01789       <span class="comment">! Condition 1: check for Tsf &gt; 0</span>
<a name="l01790"></a>01790       <span class="comment">! If Tsf &gt; 0, set Tsf = 0, then average Tsn and Tin to force</span>
<a name="l01791"></a>01791       <span class="comment">! internal temps below their melting temps.</span>
<a name="l01792"></a>01792       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01793"></a>01793 
<a name="l01794"></a>01794             <span class="keyword">if</span> (Tsf(m) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01795"></a>01795                Tsf(m) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01796"></a>01796                dTsf(ij) = -Tsf_start(ij)
<a name="l01797"></a>01797                <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) avg_Tsi(ij) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>   <span class="comment">! avg with starting temp</span>
<a name="l01798"></a>01798                converged(m) = .false.
<a name="l01799"></a>01799                all_converged = .false.
<a name="l01800"></a>01800 
<a name="l01801"></a>01801       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01802"></a>01802       <span class="comment">! Condition 2: check for oscillating Tsf</span>
<a name="l01803"></a>01803       <span class="comment">! If oscillating, average all temps to increase rate of convergence.</span>
<a name="l01804"></a>01804       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01805"></a>01805 
<a name="l01806"></a>01806             elseif (niter &gt; 1 &amp;                <span class="comment">! condition (2)</span>
<a name="l01807"></a>01807               .and. Tsf_start(ij) &lt;= -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l01808"></a>01808               .and. abs(dTsf(ij)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l01809"></a>01809               .and. abs(dTsf_prev(m)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l01810"></a>01810               .and. -dTsf(ij)/(dTsf_prev(m)+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &gt; <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a>) <span class="keyword">then</span>
<a name="l01811"></a>01811 
<a name="l01812"></a>01812                <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span> <span class="comment">! average with starting temp</span>
<a name="l01813"></a>01813                   avg_Tsf  = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>    
<a name="l01814"></a>01814                   avg_Tsi(ij) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>
<a name="l01815"></a>01815                <span class="keyword">endif</span>
<a name="l01816"></a>01816                dTsf(ij) = <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a> * dTsf(ij)
<a name="l01817"></a>01817                converged(m) = .false.
<a name="l01818"></a>01818                all_converged = .false.
<a name="l01819"></a>01819             <span class="keyword">endif</span>
<a name="l01820"></a>01820 
<a name="l01821"></a>01821 <span class="comment">!!!            dTsf_prev(m) = dTsf(ij)</span>
<a name="l01822"></a>01822 
<a name="l01823"></a>01823       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01824"></a>01824       <span class="comment">! If condition 2 failed, average new surface temperature with</span>
<a name="l01825"></a>01825       <span class="comment">!  starting value.</span>
<a name="l01826"></a>01826       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01827"></a>01827             Tsf(m)  = Tsf(m) &amp;
<a name="l01828"></a>01828                       + avg_Tsf * <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a> * (Tsf_start(ij) - Tsf(m))
<a name="l01829"></a>01829 
<a name="l01830"></a>01830           <span class="keyword">enddo</span>  <span class="comment">! ij</span>
<a name="l01831"></a>01831 
<a name="l01832"></a>01832          <span class="keyword">endif</span>   <span class="comment">! calc_Tsfc</span>
<a name="l01833"></a>01833 
<a name="l01834"></a>01834          <span class="keyword">do</span> k = 1, nslyr
<a name="l01835"></a>01835 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01836"></a>01836 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01837"></a>01837 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01838"></a>01838             <span class="keyword">do</span> ij = 1, isolve
<a name="l01839"></a>01839                m = indxij(ij)
<a name="l01840"></a>01840 
<a name="l01841"></a>01841       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01842"></a>01842       <span class="comment">! Reload Tsn from matrix solution</span>
<a name="l01843"></a>01843       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01844"></a>01844 
<a name="l01845"></a>01845                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l01846"></a>01846                   Tsn(m,k) = Tmat(ij,k+1)
<a name="l01847"></a>01847                <span class="keyword">else</span>
<a name="l01848"></a>01848                   Tsn(m,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01849"></a>01849                <span class="keyword">endif</span>
<a name="l01850"></a>01850                <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) Tsn(m,k) = min(Tsn(m,k), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l01851"></a>01851 
<a name="l01852"></a>01852       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01853"></a>01853       <span class="comment">! If condition 1 or 2 failed, average new snow layer</span>
<a name="l01854"></a>01854       <span class="comment">!  temperatures with their starting values.</span>
<a name="l01855"></a>01855       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01856"></a>01856                Tsn(m,k) = Tsn(m,k) &amp;
<a name="l01857"></a>01857                          + avg_Tsi(ij)*<a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a>*(Tsn_start(m,k)-Tsn(m,k))
<a name="l01858"></a>01858 
<a name="l01859"></a>01859       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01860"></a>01860       <span class="comment">! Compute qsn and increment new energy.</span>
<a name="l01861"></a>01861       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01862"></a>01862                qsn(m,k) = -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a> * (Lfresh - cp_ice*Tsn(m,k))
<a name="l01863"></a>01863                enew(ij) = enew(ij) + hslyr(m) * qsn(m,k)
<a name="l01864"></a>01864 
<a name="l01865"></a>01865                Tsn_start(m,k) = Tsn(m,k) <span class="comment">! for next iteration</span>
<a name="l01866"></a>01866 
<a name="l01867"></a>01867             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01868"></a>01868          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l01869"></a>01869 
<a name="l01870"></a>01870          <span class="keyword">do</span> k = 1, nilyr
<a name="l01871"></a>01871 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01872"></a>01872 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01873"></a>01873 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01874"></a>01874             <span class="keyword">do</span> ij = 1, isolve
<a name="l01875"></a>01875                m = indxij(ij)
<a name="l01876"></a>01876 
<a name="l01877"></a>01877       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01878"></a>01878       <span class="comment">! Reload Tin from matrix solution</span>
<a name="l01879"></a>01879       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01880"></a>01880                Tin(m,k) = Tmat(ij,k+1+nslyr)
<a name="l01881"></a>01881                <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) Tin(m,k) = min(Tin(m,k), <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k))
<a name="l01882"></a>01882 
<a name="l01883"></a>01883       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01884"></a>01884       <span class="comment">! Condition 2b: check for oscillating Tin(1)</span>
<a name="l01885"></a>01885       <span class="comment">! If oscillating, average all ice temps to increase rate of convergence.</span>
<a name="l01886"></a>01886       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01887"></a>01887 
<a name="l01888"></a>01888                <span class="keyword">if</span> (k==1 .and. .not.calc_Tsfc) <span class="keyword">then</span>
<a name="l01889"></a>01889                   dTi1(ij) = Tin(m,k) - Tin_start(m,k)
<a name="l01890"></a>01890 
<a name="l01891"></a>01891                   <span class="keyword">if</span> (niter &gt; 1 &amp;                    <span class="comment">! condition 2b    </span>
<a name="l01892"></a>01892                       .and. abs(dTi1(ij)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l01893"></a>01893                       .and. abs(dTi1_prev(m)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l01894"></a>01894                       .and. -dTi1(ij)/(dTi1_prev(m)+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &gt; <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a>) <span class="keyword">then</span>
<a name="l01895"></a>01895 
<a name="l01896"></a>01896                      <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) avg_Tsi(ij) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>
<a name="l01897"></a>01897                      dTi1(ij) = <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a> * dTi1(ij)
<a name="l01898"></a>01898                      converged(m) = .false.
<a name="l01899"></a>01899                      all_converged = .false.
<a name="l01900"></a>01900                   <span class="keyword">endif</span>
<a name="l01901"></a>01901                   dTi1_prev(m) = dTi1(ij)
<a name="l01902"></a>01902                <span class="keyword">endif</span>   <span class="comment">! k = 1 .and. calc_Tsfc = F</span>
<a name="l01903"></a>01903 
<a name="l01904"></a>01904       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01905"></a>01905       <span class="comment">! If condition 1 or 2 failed, average new ice layer</span>
<a name="l01906"></a>01906       <span class="comment">!  temperatures with their starting values.</span>
<a name="l01907"></a>01907       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01908"></a>01908                Tin(m,k) = Tin(m,k) &amp;
<a name="l01909"></a>01909                          + avg_Tsi(ij)*<a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a>*(Tin_start(m,k)-Tin(m,k))
<a name="l01910"></a>01910 
<a name="l01911"></a>01911       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01912"></a>01912       <span class="comment">! Compute qin and increment new energy.</span>
<a name="l01913"></a>01913       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01914"></a>01914                qin(m,k) = -<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a> * (cp_ice*(<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)-Tin(m,k)) &amp;
<a name="l01915"></a>01915                                    + Lfresh*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>-<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k)/Tin(m,k)) &amp;
<a name="l01916"></a>01916                                    - cp_ocn*<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(k))
<a name="l01917"></a>01917                enew(ij) = enew(ij) + hilyr(m) * qin(m,k)
<a name="l01918"></a>01918 
<a name="l01919"></a>01919                Tin_start(m,k) = Tin(m,k) <span class="comment">! for next iteration</span>
<a name="l01920"></a>01920 
<a name="l01921"></a>01921             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01922"></a>01922          <span class="keyword">enddo</span>                  <span class="comment">! nilyr</span>
<a name="l01923"></a>01923 
<a name="l01924"></a>01924          <span class="keyword">if</span> (calc_Tsfc) <span class="keyword">then</span>
<a name="l01925"></a>01925 
<a name="l01926"></a>01926 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01927"></a>01927 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01928"></a>01928 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01929"></a>01929           <span class="keyword">do</span> ij = 1, isolve
<a name="l01930"></a>01930             i = indxii(ij)
<a name="l01931"></a>01931             j = indxjj(ij)
<a name="l01932"></a>01932             m = indxij(ij)
<a name="l01933"></a>01933 
<a name="l01934"></a>01934       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01935"></a>01935       <span class="comment">! Condition 3: check for large change in Tsf</span>
<a name="l01936"></a>01936       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01937"></a>01937 
<a name="l01938"></a>01938             <span class="keyword">if</span> (abs(dTsf(ij)) &gt; Tsf_errmax) <span class="keyword">then</span>
<a name="l01939"></a>01939                converged(m) = .false.
<a name="l01940"></a>01940                all_converged = .false.
<a name="l01941"></a>01941             <span class="keyword">endif</span>
<a name="l01942"></a>01942 
<a name="l01943"></a>01943       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01944"></a>01944       <span class="comment">! Condition 4: check for fsurfn &lt; fcondtopn with Tsf &gt; 0</span>
<a name="l01945"></a>01945       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01946"></a>01946 
<a name="l01947"></a>01947             fsurfn(i,j) = fsurfn(i,j) + dTsf(ij)*dfsurf_dT(ij)
<a name="l01948"></a>01948             <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l01949"></a>01949                fcondtopn(i,j) = kh(m,1) * (Tsf(m)-Tsn(m,1))
<a name="l01950"></a>01950             <span class="keyword">else</span>
<a name="l01951"></a>01951                fcondtopn(i,j) = kh(m,1+nslyr) * (Tsf(m)-Tin(m,1))
<a name="l01952"></a>01952             <span class="keyword">endif</span>
<a name="l01953"></a>01953 
<a name="l01954"></a>01954             <span class="keyword">if</span> (Tsf(m) &gt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. fsurfn(i,j) &lt; fcondtopn(i,j)) <span class="keyword">then</span>
<a name="l01955"></a>01955                converged(m) = .false.
<a name="l01956"></a>01956                all_converged = .false.
<a name="l01957"></a>01957             <span class="keyword">endif</span>
<a name="l01958"></a>01958 
<a name="l01959"></a>01959             dTsf_prev(m) = dTsf(ij)
<a name="l01960"></a>01960 
<a name="l01961"></a>01961           <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01962"></a>01962          <span class="keyword">endif</span>                   <span class="comment">! calc_Tsfc</span>
<a name="l01963"></a>01963 
<a name="l01964"></a>01964       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01965"></a>01965       <span class="comment">! Condition 5: check for energy conservation error</span>
<a name="l01966"></a>01966       <span class="comment">! Change in internal ice energy should equal net energy input.</span>
<a name="l01967"></a>01967       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01968"></a>01968 
<a name="l01969"></a>01969          <span class="keyword">do</span> ij = 1, isolve
<a name="l01970"></a>01970             i = indxii(ij)
<a name="l01971"></a>01971             j = indxjj(ij)
<a name="l01972"></a>01972             m = indxij(ij)
<a name="l01973"></a>01973 
<a name="l01974"></a>01974             fcondbot(m) = kh(m,1+nslyr+nilyr) * &amp;
<a name="l01975"></a>01975                            (Tin(m,nilyr)   - Tbot(i,j))
<a name="l01976"></a>01976 
<a name="l01977"></a>01977             ferr = abs( (enew(ij)-einit(m))/dt &amp;
<a name="l01978"></a>01978                  - (fcondtopn(i,j) - fcondbot(m) + fswint(i,j)) )
<a name="l01979"></a>01979 
<a name="l01980"></a>01980             <span class="comment">! factor of 0.9 allows for roundoff errors later</span>
<a name="l01981"></a>01981             <span class="keyword">if</span> (ferr &gt; 0.9_dbl_kind*<a class="code" href="namespaceice__therm__vertical.html#a0721a294c629506af790049e6d607d53">ferrmax</a>) <span class="keyword">then</span>         <span class="comment">! condition (5)</span>
<a name="l01982"></a>01982                converged(m) = .false.
<a name="l01983"></a>01983                all_converged = .false.
<a name="l01984"></a>01984             <span class="keyword">endif</span>
<a name="l01985"></a>01985 
<a name="l01986"></a>01986          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01987"></a>01987 
<a name="l01988"></a>01988          <span class="keyword">deallocate</span>(sbdiag)
<a name="l01989"></a>01989          <span class="keyword">deallocate</span>(diag)
<a name="l01990"></a>01990          <span class="keyword">deallocate</span>(spdiag)
<a name="l01991"></a>01991          <span class="keyword">deallocate</span>(rhs)
<a name="l01992"></a>01992          <span class="keyword">deallocate</span>(Tmat)
<a name="l01993"></a>01993          <span class="keyword">deallocate</span>(etai)
<a name="l01994"></a>01994          <span class="keyword">deallocate</span>(Tsf_start)
<a name="l01995"></a>01995          <span class="keyword">deallocate</span>(dTsf)
<a name="l01996"></a>01996          <span class="keyword">deallocate</span>(dfsurf_dT)
<a name="l01997"></a>01997          <span class="keyword">deallocate</span>(avg_Tsi)
<a name="l01998"></a>01998          <span class="keyword">deallocate</span>(enew)
<a name="l01999"></a>01999          <span class="keyword">deallocate</span>(dTi1)
<a name="l02000"></a>02000 
<a name="l02001"></a>02001       <span class="keyword">enddo</span>                     <span class="comment">! temperature iteration niter</span>
<a name="l02002"></a>02002 
<a name="l02003"></a>02003       <span class="keyword">if</span> (.not.all_converged) <span class="keyword">then</span>
<a name="l02004"></a>02004 
<a name="l02005"></a>02005          <span class="keyword">do</span> ij = 1, icells
<a name="l02006"></a>02006             i = indxi(ij)
<a name="l02007"></a>02007             j = indxj(ij)
<a name="l02008"></a>02008 
<a name="l02009"></a>02009       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02010"></a>02010       <span class="comment">! Check for convergence failures.</span>
<a name="l02011"></a>02011       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02012"></a>02012             <span class="keyword">if</span> (.not.converged(ij)) <span class="keyword">then</span>
<a name="l02013"></a>02013                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Thermo iteration does not converge,&apos;</span>, &amp;
<a name="l02014"></a>02014                                 <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l02015"></a>02015                                  istep1, my_task, i, j
<a name="l02016"></a>02016                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Ice thickness:&apos;</span>,  hilyr(ij)*nilyr
<a name="l02017"></a>02017                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Snow thickness:&apos;</span>, hslyr(ij)*nslyr
<a name="l02018"></a>02018                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;dTsf, Tsf_errmax:&apos;</span>,dTsf_prev(ij), &amp;
<a name="l02019"></a>02019                                  Tsf_errmax
<a name="l02020"></a>02020                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tsf:&apos;</span>, Tsf(ij)
<a name="l02021"></a>02021                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fsurf:&apos;</span>, fsurfn(i,j)
<a name="l02022"></a>02022                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fcondtop, fcondbot, fswint&apos;</span>, &amp;
<a name="l02023"></a>02023                                  fcondtopn(i,j), fcondbot(ij), fswint(i,j)
<a name="l02024"></a>02024                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fswsfc, fswthrun&apos;</span>, &amp;
<a name="l02025"></a>02025                                  fswsfc(i,j), fswthrun(i,j)
<a name="l02026"></a>02026                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Flux conservation error =&apos;</span>, ferr
<a name="l02027"></a>02027                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Internal snow absorption:&apos;</span>
<a name="l02028"></a>02028                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) (Sswabs(i,j,k),k=1,nslyr)
<a name="l02029"></a>02029                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Internal ice absorption:&apos;</span>
<a name="l02030"></a>02030                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) (Iswabs(i,j,k),k=1,nilyr)
<a name="l02031"></a>02031                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Initial snow temperatures:&apos;</span>
<a name="l02032"></a>02032                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) (Tsn_init(ij,k),k=1,nslyr)
<a name="l02033"></a>02033                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Initial ice temperatures:&apos;</span>
<a name="l02034"></a>02034                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) (Tin_init(ij,k),k=1,nilyr)
<a name="l02035"></a>02035                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Final snow temperatures:&apos;</span>
<a name="l02036"></a>02036                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) (Tsn(ij,k),k=1,nslyr)
<a name="l02037"></a>02037                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Final ice temperatures:&apos;</span>
<a name="l02038"></a>02038                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) (Tin(ij,k),k=1,nilyr)
<a name="l02039"></a>02039                l_stop = .true.
<a name="l02040"></a>02040                istop = i
<a name="l02041"></a>02041                jstop = j
<a name="l02042"></a>02042                return
<a name="l02043"></a>02043             <span class="keyword">endif</span>
<a name="l02044"></a>02044          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02045"></a>02045       <span class="keyword">endif</span>                     <span class="comment">! all_converged</span>
<a name="l02046"></a>02046 
<a name="l02047"></a>02047       <span class="keyword">if</span> (calc_Tsfc) <span class="keyword">then</span>
<a name="l02048"></a>02048 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02049"></a>02049 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02050"></a>02050 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02051"></a>02051          <span class="keyword">do</span> ij = 1, icells
<a name="l02052"></a>02052             i = indxi(ij)
<a name="l02053"></a>02053             j = indxj(ij)
<a name="l02054"></a>02054 
<a name="l02055"></a>02055             <span class="comment">! update fluxes that depend on Tsf</span>
<a name="l02056"></a>02056             flwoutn(i,j) = flwoutn(i,j) + dTsf_prev(ij) * dflwout_dT(ij)
<a name="l02057"></a>02057             fsensn(i,j)  = fsensn(i,j)  + dTsf_prev(ij) * dfsens_dT(ij)
<a name="l02058"></a>02058             flatn(i,j)   = flatn(i,j)   + dTsf_prev(ij) * dflat_dT(ij)
<a name="l02059"></a>02059 
<a name="l02060"></a>02060          <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l02061"></a>02061       <span class="keyword">endif</span>                        <span class="comment">! calc_Tsfc</span>
<a name="l02062"></a>02062 
<a name="l02063"></a>02063 <span class="keyword">      end subroutine temperature_changes</span>
<a name="l02064"></a>02064 
<a name="l02065"></a>02065 <span class="comment">!=======================================================================</span>
<a name="l02066"></a>02066 <span class="comment">!BOP</span>
<a name="l02067"></a>02067 <span class="comment">!</span>
<a name="l02068"></a>02068 <span class="comment">! !ROUTINE: conductivity - compute ice thermal conductivity</span>
<a name="l02069"></a>02069 <span class="comment">!</span>
<a name="l02070"></a>02070 <span class="comment">! !DESCRIPTION:</span>
<a name="l02071"></a>02071 <span class="comment">!</span>
<a name="l02072"></a>02072 <span class="comment">! Compute thermal conductivity at interfaces (held fixed during</span>
<a name="l02073"></a>02073 <span class="comment">!  the subsequent iteration).</span>
<a name="l02074"></a>02074 <span class="comment">!</span>
<a name="l02075"></a>02075 <span class="comment">! NOTE: Ice conductivity must be &gt;= kimin</span>
<a name="l02076"></a>02076 <span class="comment">!</span>
<a name="l02077"></a>02077 <span class="comment">! !REVISION HISTORY:</span>
<a name="l02078"></a>02078 <span class="comment">!</span>
<a name="l02079"></a>02079 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l02080"></a>02080 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l02081"></a>02081 <span class="comment">!</span>
<a name="l02082"></a>02082 <span class="comment">! !INTERFACE:</span>
<a name="l02083"></a>02083 <span class="comment">!</span>
<a name="l02084"></a><a class="code" href="namespaceice__therm__vertical.html#aeeb37e6f39ffa2d7269ac471d047a789">02084</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#aeeb37e6f39ffa2d7269ac471d047a789">conductivity</a> (nx_block, ny_block,         &amp;
<a name="l02085"></a>02085                                l_snow,   icells,           &amp;
<a name="l02086"></a>02086                                indxi,    indxj,    indxij, &amp;
<a name="l02087"></a>02087                                hilyr,    hslyr,            &amp;
<a name="l02088"></a>02088                                Tin,      kh)
<a name="l02089"></a>02089 <span class="comment">!</span>
<a name="l02090"></a>02090 <span class="comment">! !USES:</span>
<a name="l02091"></a>02091 <span class="comment">!</span>
<a name="l02092"></a>02092 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l02093"></a>02093 <span class="comment">!</span>
<a name="l02094"></a>02094       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02095"></a>02095          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l02096"></a>02096          icells          <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l02097"></a>02097 
<a name="l02098"></a>02098       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension(icells)</span>, 
<a name="l02099"></a>02099          <span class="keywordtype">intent(in)</span> :: 
<a name="l02100"></a>02100          l_snow          <span class="comment">! true if snow temperatures are computed</span>
<a name="l02101"></a>02101 
<a name="l02102"></a>02102       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l02103"></a>02103          <span class="keywordtype">intent(in)</span> :: 
<a name="l02104"></a>02104          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l02105"></a>02105 
<a name="l02106"></a>02106       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l02107"></a>02107          <span class="keywordtype">intent(in)</span> :: 
<a name="l02108"></a>02108          indxij          <span class="comment">! compressed 1D index for cells not converged</span>
<a name="l02109"></a>02109 
<a name="l02110"></a>02110       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02111"></a>02111          hilyr       ,  <span class="comment">! ice layer thickness (same for all ice layers)</span>
<a name="l02112"></a>02112          hslyr           <span class="comment">! snow layer thickness (same for all snow layers)</span>
<a name="l02113"></a>02113 
<a name="l02114"></a>02114       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l02115"></a>02115          <span class="keywordtype">intent(in)</span> :: 
<a name="l02116"></a>02116          Tin             <span class="comment">! internal ice layer temperatures</span>
<a name="l02117"></a>02117 
<a name="l02118"></a>02118       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr+nslyr+1)</span>, 
<a name="l02119"></a>02119          <span class="keywordtype">intent(out)</span> :: 
<a name="l02120"></a>02120          kh              <span class="comment">! effective conductivity at interfaces (W m-2 deg-1)</span>
<a name="l02121"></a>02121 <span class="comment">!</span>
<a name="l02122"></a>02122 <span class="comment">!EOP</span>
<a name="l02123"></a>02123 <span class="comment">!</span>
<a name="l02124"></a>02124       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l02125"></a>02125          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l02126"></a>02126          ij, m       ,  <span class="comment">! horizontal indices, combine i and j loops</span>
<a name="l02127"></a>02127          k               <span class="comment">! vertical index</span>
<a name="l02128"></a>02128 
<a name="l02129"></a>02129       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr) </span>:: 
<a name="l02130"></a>02130          kilyr           <span class="comment">! thermal cond at ice layer midpoints (W m-1 deg-1)</span>
<a name="l02131"></a>02131 
<a name="l02132"></a>02132       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr) </span>:: 
<a name="l02133"></a>02133          kslyr           <span class="comment">! thermal cond at snow layer midpoints (W m-1 deg-1)</span>
<a name="l02134"></a>02134 
<a name="l02135"></a>02135       <span class="comment">! interior snow layers (simple for now, but may be fancier later)</span>
<a name="l02136"></a>02136       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02137"></a>02137          <span class="keyword">do</span> ij = 1, icells
<a name="l02138"></a>02138             kslyr(ij,k) = ksno
<a name="l02139"></a>02139          <span class="keyword">enddo</span>
<a name="l02140"></a>02140       <span class="keyword">enddo</span>                     <span class="comment">! nslyr</span>
<a name="l02141"></a>02141 
<a name="l02142"></a>02142       <span class="comment">! interior ice layers</span>
<a name="l02143"></a>02143       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l02144"></a>02144 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02145"></a>02145 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02146"></a>02146 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02147"></a>02147          <span class="keyword">do</span> ij = 1, icells
<a name="l02148"></a>02148             kilyr(ij,k) = kice + <a class="code" href="namespaceice__therm__vertical.html#a5d1e969b838504de79a78a45daba6424">betak</a>*<a class="code" href="namespaceice__therm__vertical.html#a484442c434b314140ae3763d41fc9075">salin</a>(k)/min(-<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>,Tin(ij,k))
<a name="l02149"></a>02149             kilyr(ij,k) = max (kilyr(ij,k), <a class="code" href="namespaceice__therm__vertical.html#ac9c4fb671c6d11d24a29369d6c7410fa">kimin</a>)
<a name="l02150"></a>02150          <span class="keyword">enddo</span>
<a name="l02151"></a>02151       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l02152"></a>02152 
<a name="l02153"></a>02153       <span class="comment">! top snow interface, top and bottom ice interfaces</span>
<a name="l02154"></a>02154       <span class="keyword">do</span> ij = 1, icells
<a name="l02155"></a>02155          <span class="comment">! top of snow layer; top surface of top ice layer</span>
<a name="l02156"></a>02156          <span class="keyword">if</span> (l_snow(ij)) <span class="keyword">then</span>
<a name="l02157"></a>02157             kh(ij,1)       = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * kslyr(ij,1) / hslyr(ij)
<a name="l02158"></a>02158             kh(ij,1+<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>) = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * kslyr(ij,<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>) * kilyr(ij,1) / &amp;
<a name="l02159"></a>02159                              ( kslyr(ij,<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>)*hilyr(ij) +  &amp;
<a name="l02160"></a>02160                                kilyr(ij,1    )*hslyr(ij) )
<a name="l02161"></a>02161          <span class="keyword">else</span>
<a name="l02162"></a>02162             kh(ij,1)       = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02163"></a>02163             kh(ij,1+<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>) = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * kilyr(ij,1) / hilyr(ij)
<a name="l02164"></a>02164          <span class="keyword">endif</span>
<a name="l02165"></a>02165 
<a name="l02166"></a>02166          <span class="comment">! bottom surface of bottom ice layer</span>
<a name="l02167"></a>02167          kh(ij,1+<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>+<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * kilyr(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) / hilyr(ij)
<a name="l02168"></a>02168 
<a name="l02169"></a>02169       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l02170"></a>02170 
<a name="l02171"></a>02171       <span class="comment">! interior snow interfaces</span>
<a name="l02172"></a>02172 
<a name="l02173"></a>02173       <span class="keyword">if</span> (<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a> &gt; 1) <span class="keyword">then</span>
<a name="l02174"></a>02174          <span class="keyword">do</span> k = 2, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02175"></a>02175             <span class="keyword">do</span> ij = 1, icells
<a name="l02176"></a>02176                <span class="keyword">if</span> (l_snow(ij)) <span class="keyword">then</span>
<a name="l02177"></a>02177                   kh(ij,k) = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * kslyr(ij,k-1) * kslyr(ij,k) / &amp;
<a name="l02178"></a>02178                             ((kslyr(ij,k-1) + kslyr(ij,k))*hslyr(ij))
<a name="l02179"></a>02179                <span class="keyword">else</span>
<a name="l02180"></a>02180                   kh(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02181"></a>02181                <span class="keyword">endif</span>
<a name="l02182"></a>02182             <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02183"></a>02183          <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l02184"></a>02184       <span class="keyword">endif</span> <span class="comment">! nslyr &gt; 1</span>
<a name="l02185"></a>02185 
<a name="l02186"></a>02186       <span class="comment">! interior ice interfaces</span>
<a name="l02187"></a>02187       <span class="keyword">do</span> k = 2, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l02188"></a>02188          <span class="keyword">do</span> ij = 1, icells
<a name="l02189"></a>02189             kh(ij,k+<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>) = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * kilyr(ij,k-1) * kilyr(ij,k) / &amp;
<a name="l02190"></a>02190                             ((kilyr(ij,k-1) + kilyr(ij,k))*hilyr(ij))
<a name="l02191"></a>02191          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02192"></a>02192       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l02193"></a>02193 
<a name="l02194"></a>02194 <span class="keyword">      end subroutine conductivity</span>
<a name="l02195"></a>02195 
<a name="l02196"></a>02196 <span class="comment">!=======================================================================</span>
<a name="l02197"></a>02197 <span class="comment">!BOP</span>
<a name="l02198"></a>02198 <span class="comment">!</span>
<a name="l02199"></a>02199 <span class="comment">! !ROUTINE: surface_fluxes - surface radiative and turbulent fluxes</span>
<a name="l02200"></a>02200 <span class="comment">!</span>
<a name="l02201"></a>02201 <span class="comment">! !DESCRIPTION:</span>
<a name="l02202"></a>02202 <span class="comment">!</span>
<a name="l02203"></a>02203 <span class="comment">! Compute radiative and turbulent fluxes and their derivatives</span>
<a name="l02204"></a>02204 <span class="comment">! with respect to Tsf.</span>
<a name="l02205"></a>02205 <span class="comment">!</span>
<a name="l02206"></a>02206 <span class="comment">! !REVISION HISTORY:</span>
<a name="l02207"></a>02207 <span class="comment">!</span>
<a name="l02208"></a>02208 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l02209"></a>02209 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l02210"></a>02210 <span class="comment">!</span>
<a name="l02211"></a>02211 <span class="comment">! !INTERFACE:</span>
<a name="l02212"></a>02212 <span class="comment">!</span>
<a name="l02213"></a><a class="code" href="namespaceice__therm__vertical.html#aa2320460f9c52d821db02db2209fa888">02213</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#aa2320460f9c52d821db02db2209fa888">surface_fluxes</a> (nx_block,   ny_block,          &amp;
<a name="l02214"></a>02214                                  isolve,     icells,            &amp;
<a name="l02215"></a>02215                                  indxii,     indxjj,    indxij, &amp;
<a name="l02216"></a>02216                                  Tsf,        fswsfc,            &amp;
<a name="l02217"></a>02217                                  rhoa,       flw,               &amp;
<a name="l02218"></a>02218                                  potT,       Qa,                &amp;
<a name="l02219"></a>02219                                  shcoef,     lhcoef,            &amp;
<a name="l02220"></a>02220                                  flwoutn,    fsensn,            &amp;
<a name="l02221"></a>02221                                  flatn,      fsurfn,            &amp;
<a name="l02222"></a>02222                                  dflwout_dT, dfsens_dT,         &amp;
<a name="l02223"></a>02223                                  dflat_dT,   dfsurf_dT)
<a name="l02224"></a>02224 <span class="comment">!</span>
<a name="l02225"></a>02225 <span class="comment">! !USES:</span>
<a name="l02226"></a>02226 <span class="comment">!</span>
<a name="l02227"></a>02227 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l02228"></a>02228 <span class="comment">!</span>
<a name="l02229"></a>02229       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02230"></a>02230          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l02231"></a>02231          isolve            ,  <span class="comment">! number of cells with temps not converged</span>
<a name="l02232"></a>02232          icells                <span class="comment">! number of cells with ice present</span>
<a name="l02233"></a>02233 
<a name="l02234"></a>02234       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(icells)</span>, 
<a name="l02235"></a>02235          <span class="keywordtype">intent(in)</span> :: 
<a name="l02236"></a>02236          indxii, indxjj  <span class="comment">! compressed indices for cells not converged</span>
<a name="l02237"></a>02237 
<a name="l02238"></a>02238       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l02239"></a>02239          indxij          <span class="comment">! compressed 1D index for cells not converged</span>
<a name="l02240"></a>02240 
<a name="l02241"></a>02241       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02242"></a>02242          Tsf             <span class="comment">! ice/snow surface temperature, Tsfcn</span>
<a name="l02243"></a>02243 
<a name="l02244"></a>02244       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02245"></a>02245          fswsfc      ,  <span class="comment">! SW absorbed at ice/snow surface (W m-2)</span>
<a name="l02246"></a>02246          rhoa        ,  <span class="comment">! air density (kg/m^3)</span>
<a name="l02247"></a>02247          flw         ,  <span class="comment">! incoming longwave radiation (W/m^2)</span>
<a name="l02248"></a>02248          potT        ,  <span class="comment">! air potential temperature  (K)</span>
<a name="l02249"></a>02249          Qa          ,  <span class="comment">! specific humidity (kg/kg)</span>
<a name="l02250"></a>02250          shcoef      ,  <span class="comment">! transfer coefficient for sensible heat</span>
<a name="l02251"></a>02251          lhcoef          <span class="comment">! transfer coefficient for latent heat</span>
<a name="l02252"></a>02252 
<a name="l02253"></a>02253       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l02254"></a>02254          <span class="keywordtype">intent(inout)</span> :: 
<a name="l02255"></a>02255          fsensn      ,  <span class="comment">! surface downward sensible heat (W m-2)</span>
<a name="l02256"></a>02256          flatn       ,  <span class="comment">! surface downward latent heat (W m-2)</span>
<a name="l02257"></a>02257          flwoutn     ,  <span class="comment">! upward LW at surface (W m-2)</span>
<a name="l02258"></a>02258          fsurfn          <span class="comment">! net flux to top surface, excluding fcondtopn</span>
<a name="l02259"></a>02259 
<a name="l02260"></a>02260       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l02261"></a>02261          <span class="keywordtype">intent(inout)</span> :: 
<a name="l02262"></a>02262          dfsens_dT   ,  <span class="comment">! deriv of fsens wrt Tsf (W m-2 deg-1)</span>
<a name="l02263"></a>02263          dflat_dT    ,  <span class="comment">! deriv of flat wrt Tsf (W m-2 deg-1)</span>
<a name="l02264"></a>02264          dflwout_dT      <span class="comment">! deriv of flwout wrt Tsf (W m-2 deg-1)</span>
<a name="l02265"></a>02265 
<a name="l02266"></a>02266       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve)</span>, 
<a name="l02267"></a>02267          <span class="keywordtype">intent(inout)</span> :: 
<a name="l02268"></a>02268          dfsurf_dT       <span class="comment">! derivative of fsurfn wrt Tsf</span>
<a name="l02269"></a>02269 <span class="comment">!</span>
<a name="l02270"></a>02270 <span class="comment">!EOP</span>
<a name="l02271"></a>02271 <span class="comment">!</span>
<a name="l02272"></a>02272       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l02273"></a>02273          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l02274"></a>02274          ij, m       ,  <span class="comment">! horizontal indices, combine i and j loops</span>
<a name="l02275"></a>02275          k               <span class="comment">! ice layer index</span>
<a name="l02276"></a>02276 
<a name="l02277"></a>02277       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l02278"></a>02278          TsfK        ,  <span class="comment">! ice/snow surface temperature (K)</span>
<a name="l02279"></a>02279          Qsfc        ,  <span class="comment">! saturated surface specific humidity (kg/kg)</span>
<a name="l02280"></a>02280          dQsfcdT     ,  <span class="comment">! derivative of Qsfc wrt surface temperature</span>
<a name="l02281"></a>02281          qsat        ,  <span class="comment">! the saturation humidity of air (kg/m^3)</span>
<a name="l02282"></a>02282          flwdabs     ,  <span class="comment">! downward longwave absorbed heat flx (W/m^2)</span>
<a name="l02283"></a>02283          tmpvar          <span class="comment">! 1/TsfK</span>
<a name="l02284"></a>02284 
<a name="l02285"></a>02285 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02286"></a>02286 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02287"></a>02287 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02288"></a>02288       <span class="keyword">do</span> ij = 1, isolve
<a name="l02289"></a>02289          i = indxii(ij)         <span class="comment">! NOTE: not indxi and indxj</span>
<a name="l02290"></a>02290          j = indxjj(ij)
<a name="l02291"></a>02291          m = indxij(ij)
<a name="l02292"></a>02292 
<a name="l02293"></a>02293          <span class="comment">! ice surface temperature in Kelvin</span>
<a name="l02294"></a>02294          TsfK = Tsf(m) + Tffresh
<a name="l02295"></a>02295          tmpvar = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>/TsfK
<a name="l02296"></a>02296 
<a name="l02297"></a>02297          <span class="comment">! saturation humidity</span>
<a name="l02298"></a>02298          qsat    = <a class="code" href="namespaceice__constants.html#a99597a5a1a0a2eb223e155e209b95538">qqqice</a> * exp(-<a class="code" href="namespaceice__constants.html#abca4267cd2edc853a5213d463487c28f">TTTice</a>*tmpvar)
<a name="l02299"></a>02299          Qsfc    = qsat / rhoa(i,j)
<a name="l02300"></a>02300          dQsfcdT = <a class="code" href="namespaceice__constants.html#abca4267cd2edc853a5213d463487c28f">TTTice</a> * tmpvar*tmpvar * Qsfc
<a name="l02301"></a>02301 
<a name="l02302"></a>02302          <span class="comment">! longwave radiative flux</span>
<a name="l02303"></a>02303          flwdabs =  emissivity * flw(i,j)
<a name="l02304"></a>02304          flwoutn(i,j) = -emissivity * stefan_boltzmann * TsfK**4
<a name="l02305"></a>02305 
<a name="l02306"></a>02306          <span class="comment">! downward latent and sensible heat fluxes</span>
<a name="l02307"></a>02307          fsensn(i,j) = shcoef(i,j) * (potT(i,j) - TsfK)
<a name="l02308"></a>02308          flatn(i,j)  = lhcoef(i,j) * (Qa(i,j) - Qsfc)
<a name="l02309"></a>02309 
<a name="l02310"></a>02310          <span class="comment">! derivatives wrt surface temp</span>
<a name="l02311"></a>02311          dflwout_dT(m) = - emissivity*stefan_boltzmann * <a class="code" href="namespaceice__constants.html#a6f2f40b7da63dfa1a4f38dd0126cd848">c4</a>*TsfK**3
<a name="l02312"></a>02312          dfsens_dT(m)  = - shcoef(i,j)
<a name="l02313"></a>02313          dflat_dT(m)   = - lhcoef(i,j) * dQsfcdT
<a name="l02314"></a>02314 
<a name="l02315"></a>02315          fsurfn(i,j) = fswsfc(i,j) + flwdabs + flwoutn(i,j) &amp;
<a name="l02316"></a>02316                      + fsensn(i,j) + flatn(i,j)
<a name="l02317"></a>02317          dfsurf_dT(ij) = dflwout_dT(m) &amp;
<a name="l02318"></a>02318                          + dfsens_dT(m) + dflat_dT(m)
<a name="l02319"></a>02319 
<a name="l02320"></a>02320       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l02321"></a>02321 
<a name="l02322"></a>02322 <span class="keyword">      end subroutine surface_fluxes</span>
<a name="l02323"></a>02323 
<a name="l02324"></a>02324 <span class="comment">!=======================================================================</span>
<a name="l02325"></a>02325 <span class="comment">!BOP</span>
<a name="l02326"></a>02326 <span class="comment">!</span>
<a name="l02327"></a>02327 <span class="comment">! !ROUTINE: get_matrix_elements - compute tridiagonal matrix elements</span>
<a name="l02328"></a>02328 <span class="comment">!</span>
<a name="l02329"></a>02329 <span class="comment">! !DESCRIPTION:</span>
<a name="l02330"></a>02330 <span class="comment">!</span>
<a name="l02331"></a>02331 <span class="comment">! Compute terms in tridiagonal matrix that will be solved to find</span>
<a name="l02332"></a>02332 <span class="comment">!  the new vertical temperature profile</span>
<a name="l02333"></a>02333 <span class="comment">! This routine is for the case in which Tsfc is being computed.</span>
<a name="l02334"></a>02334 <span class="comment">!</span>
<a name="l02335"></a>02335 <span class="comment">! !REVISION HISTORY:</span>
<a name="l02336"></a>02336 <span class="comment">!</span>
<a name="l02337"></a>02337 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l02338"></a>02338 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l02339"></a>02339 <span class="comment">!</span>
<a name="l02340"></a>02340 <span class="comment">!</span>
<a name="l02341"></a>02341 <span class="comment">! March 2004 by William H. Lipscomb for multiple snow layers</span>
<a name="l02342"></a>02342 <span class="comment">! April 2008 by E. C. Hunke, divided into two routines based on calc_Tsfc </span>
<a name="l02343"></a>02343 <span class="comment">!</span>
<a name="l02344"></a>02344 <span class="comment">! !INTERFACE:</span>
<a name="l02345"></a>02345 <span class="comment">!</span>
<a name="l02346"></a><a class="code" href="namespaceice__therm__vertical.html#a40c9d90a69710b5b555fd78ff83c3009">02346</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a40c9d90a69710b5b555fd78ff83c3009">get_matrix_elements_calc_Tsfc</a> &amp;
<a name="l02347"></a>02347                                      (nx_block, ny_block,         &amp;
<a name="l02348"></a>02348                                       isolve,   icells,           &amp;
<a name="l02349"></a>02349                                       indxii,   indxjj,   indxij, &amp;
<a name="l02350"></a>02350                                       l_snow,   l_cold,           &amp;
<a name="l02351"></a>02351                                       Tsf,      Tbot,             &amp;
<a name="l02352"></a>02352                                       fsurfn,   dfsurf_dT,        &amp;
<a name="l02353"></a>02353                                       Tin_init, Tsn_init,         &amp;
<a name="l02354"></a>02354                                       kh,       Sswabs,           &amp;
<a name="l02355"></a>02355                                       Iswabs,                     &amp;
<a name="l02356"></a>02356                                       etai,     etas,             &amp;
<a name="l02357"></a>02357                                       sbdiag,   diag,             &amp;
<a name="l02358"></a>02358                                       spdiag,   rhs)
<a name="l02359"></a>02359 <span class="comment">!</span>
<a name="l02360"></a>02360 <span class="comment">! !USES:</span>
<a name="l02361"></a>02361 <span class="comment">!</span>
<a name="l02362"></a>02362 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l02363"></a>02363 <span class="comment">!</span>
<a name="l02364"></a>02364       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02365"></a>02365          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l02366"></a>02366          isolve            ,  <span class="comment">! number of cells with temps not converged</span>
<a name="l02367"></a>02367          icells                <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l02368"></a>02368 
<a name="l02369"></a>02369       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(icells)</span>, 
<a name="l02370"></a>02370          <span class="keywordtype">intent(in)</span> :: 
<a name="l02371"></a>02371          indxii, indxjj  <span class="comment">! compressed indices for cells not converged</span>
<a name="l02372"></a>02372 
<a name="l02373"></a>02373       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l02374"></a>02374          <span class="keywordtype">intent(in)</span> :: 
<a name="l02375"></a>02375          indxij          <span class="comment">! compressed 1D index for cells not converged</span>
<a name="l02376"></a>02376 
<a name="l02377"></a>02377       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l02378"></a>02378          <span class="keywordtype">intent(in)</span> :: 
<a name="l02379"></a>02379          l_snow      ,  <span class="comment">! true if snow temperatures are computed</span>
<a name="l02380"></a>02380          l_cold          <span class="comment">! true if surface temperature is computed</span>
<a name="l02381"></a>02381 
<a name="l02382"></a>02382       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02383"></a>02383          Tsf             <span class="comment">! ice/snow top surface temp (deg C)</span>
<a name="l02384"></a>02384 
<a name="l02385"></a>02385       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02386"></a>02386          fsurfn      ,  <span class="comment">! net flux to top surface, excluding fcondtopn (W/m^2)</span>
<a name="l02387"></a>02387          Tbot            <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l02388"></a>02388 
<a name="l02389"></a>02389       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02390"></a>02390          dfsurf_dT       <span class="comment">! derivative of fsurf wrt Tsf</span>
<a name="l02391"></a>02391 
<a name="l02392"></a>02392       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve,nilyr)</span>, 
<a name="l02393"></a>02393          <span class="keywordtype">intent(in)</span> :: 
<a name="l02394"></a>02394          etai            <span class="comment">! dt / (rho*cp*h) for ice layers</span>
<a name="l02395"></a>02395 
<a name="l02396"></a>02396       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l02397"></a>02397          <span class="keywordtype">intent(in)</span> :: 
<a name="l02398"></a>02398          Tin_init        <span class="comment">! ice temp at beginning of time step</span>
<a name="l02399"></a>02399 
<a name="l02400"></a>02400       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nslyr)</span>, 
<a name="l02401"></a>02401          <span class="keywordtype">intent(in)</span> :: 
<a name="l02402"></a>02402          Sswabs          <span class="comment">! SW radiation absorbed in snow layers (W m-2)</span>
<a name="l02403"></a>02403 
<a name="l02404"></a>02404       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nilyr)</span>, 
<a name="l02405"></a>02405          <span class="keywordtype">intent(in)</span> :: 
<a name="l02406"></a>02406          Iswabs          <span class="comment">! absorbed SW flux in ice layers</span>
<a name="l02407"></a>02407 
<a name="l02408"></a>02408       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l02409"></a>02409          <span class="keywordtype">intent(in)</span> :: 
<a name="l02410"></a>02410          etas        ,  <span class="comment">! dt / (rho*cp*h) for snow layers</span>
<a name="l02411"></a>02411          Tsn_init        <span class="comment">! snow temp at beginning of time step</span>
<a name="l02412"></a>02412                          <span class="comment">! Note: no absorbed SW in snow layers</span>
<a name="l02413"></a>02413 
<a name="l02414"></a>02414       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr+nilyr+1)</span>, 
<a name="l02415"></a>02415          <span class="keywordtype">intent(in)</span> :: 
<a name="l02416"></a>02416          kh              <span class="comment">! effective conductivity at layer interfaces</span>
<a name="l02417"></a>02417 
<a name="l02418"></a>02418       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve,nslyr+nilyr+1)</span>, 
<a name="l02419"></a>02419          <span class="keywordtype">intent(inout)</span> :: 
<a name="l02420"></a>02420          sbdiag      ,  <span class="comment">! sub-diagonal matrix elements</span>
<a name="l02421"></a>02421          diag        ,  <span class="comment">! diagonal matrix elements</span>
<a name="l02422"></a>02422          spdiag      ,  <span class="comment">! super-diagonal matrix elements</span>
<a name="l02423"></a>02423          rhs             <span class="comment">! rhs of tri-diagonal matrix eqn.</span>
<a name="l02424"></a>02424 <span class="comment">!</span>
<a name="l02425"></a>02425 <span class="comment">!EOP</span>
<a name="l02426"></a>02426 <span class="comment">!</span>
<a name="l02427"></a>02427       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l02428"></a>02428          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l02429"></a>02429          ij, m       ,  <span class="comment">! horizontal indices, combine i and j loops</span>
<a name="l02430"></a>02430          k, ks, ki, kr   <span class="comment">! vertical indices and row counters</span>
<a name="l02431"></a>02431 
<a name="l02432"></a>02432       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02433"></a>02433       <span class="comment">! Initialize matrix elements.</span>
<a name="l02434"></a>02434       <span class="comment">! Note: When we do not need to solve for the surface or snow</span>
<a name="l02435"></a>02435       <span class="comment">!       temperature, we solve dummy equations with solution T = 0.</span>
<a name="l02436"></a>02436       <span class="comment">!       Ice layers are fully initialized below.</span>
<a name="l02437"></a>02437       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02438"></a>02438 
<a name="l02439"></a>02439       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>+1
<a name="l02440"></a>02440          <span class="keyword">do</span> ij = 1, isolve
<a name="l02441"></a>02441             sbdiag(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02442"></a>02442             diag  (ij,k) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>
<a name="l02443"></a>02443             spdiag(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02444"></a>02444             rhs   (ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02445"></a>02445          <span class="keyword">enddo</span>
<a name="l02446"></a>02446       <span class="keyword">enddo</span>
<a name="l02447"></a>02447             
<a name="l02448"></a>02448       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02449"></a>02449       <span class="comment">! Compute matrix elements</span>
<a name="l02450"></a>02450       <span class="comment">!</span>
<a name="l02451"></a>02451       <span class="comment">! Four possible cases to solve:</span>
<a name="l02452"></a>02452       <span class="comment">!   (1) Cold surface (Tsf &lt; 0), snow present</span>
<a name="l02453"></a>02453       <span class="comment">!   (2) Melting surface (Tsf = 0), snow present</span>
<a name="l02454"></a>02454       <span class="comment">!   (3) Cold surface (Tsf &lt; 0), no snow</span>
<a name="l02455"></a>02455       <span class="comment">!   (4) Melting surface (Tsf = 0), no snow</span>
<a name="l02456"></a>02456       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02457"></a>02457 
<a name="l02458"></a>02458          <span class="keyword">do</span> ij = 1, isolve
<a name="l02459"></a>02459             i = indxii(ij)
<a name="l02460"></a>02460             j = indxjj(ij)
<a name="l02461"></a>02461             m = indxij(ij)
<a name="l02462"></a>02462 
<a name="l02463"></a>02463       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02464"></a>02464       <span class="comment">! Tsf equation for case of cold surface (with or without snow)</span>
<a name="l02465"></a>02465       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02466"></a>02466             <span class="keyword">if</span> (l_cold(m)) <span class="keyword">then</span>
<a name="l02467"></a>02467                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02468"></a>02468                   k = 1
<a name="l02469"></a>02469                <span class="keyword">else</span>                <span class="comment">! no snow</span>
<a name="l02470"></a>02470                   k = 1 + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02471"></a>02471                <span class="keyword">endif</span>
<a name="l02472"></a>02472                kr = k
<a name="l02473"></a>02473             
<a name="l02474"></a>02474                sbdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02475"></a>02475                diag  (ij,kr) = dfsurf_dT(ij) - kh(m,k)
<a name="l02476"></a>02476                spdiag(ij,kr) = kh(m,k)
<a name="l02477"></a>02477                rhs   (ij,kr) = dfsurf_dT(ij)*Tsf(m) - fsurfn(i,j)
<a name="l02478"></a>02478 
<a name="l02479"></a>02479             <span class="keyword">endif</span>                  <span class="comment">! l_cold</span>
<a name="l02480"></a>02480 
<a name="l02481"></a>02481       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02482"></a>02482       <span class="comment">! top snow layer</span>
<a name="l02483"></a>02483       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02484"></a>02484 <span class="comment">!           k = 1</span>
<a name="l02485"></a>02485 <span class="comment">!           kr = 2</span>
<a name="l02486"></a>02486 
<a name="l02487"></a>02487             <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02488"></a>02488                <span class="keyword">if</span> (l_cold(m)) <span class="keyword">then</span>
<a name="l02489"></a>02489                   sbdiag(ij,2) = -etas(m,1) * kh(m,1)
<a name="l02490"></a>02490                   spdiag(ij,2) = -etas(m,1) * kh(m,2)
<a name="l02491"></a>02491                   diag  (ij,2) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02492"></a>02492                                 + etas(m,1) * (kh(m,1) + kh(m,2))
<a name="l02493"></a>02493                   rhs   (ij,2) = Tsn_init(m,1) &amp;
<a name="l02494"></a>02494                                 + etas(m,1) * Sswabs(i,j,1)
<a name="l02495"></a>02495                <span class="keyword">else</span>                <span class="comment">! melting surface</span>
<a name="l02496"></a>02496                   sbdiag(ij,2) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02497"></a>02497                   spdiag(ij,2) = -etas(m,1) * kh(m,2)
<a name="l02498"></a>02498                   diag  (ij,2) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02499"></a>02499                                 + etas(m,1) * (kh(m,1) + kh(m,2))
<a name="l02500"></a>02500                   rhs   (ij,2) = Tsn_init(m,1) &amp;
<a name="l02501"></a>02501                                 + etas(m,1)*kh(m,1)*Tsf(m) &amp;
<a name="l02502"></a>02502                                 + etas(m,1) * Sswabs(i,j,1)
<a name="l02503"></a>02503                <span class="keyword">endif</span>               <span class="comment">! l_cold</span>
<a name="l02504"></a>02504             <span class="keyword">endif</span>                  <span class="comment">! l_snow</span>
<a name="l02505"></a>02505 
<a name="l02506"></a>02506          <span class="keyword">enddo</span>                    <span class="comment">! ij</span>
<a name="l02507"></a>02507 
<a name="l02508"></a>02508       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02509"></a>02509       <span class="comment">! remaining snow layers</span>
<a name="l02510"></a>02510       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02511"></a>02511 
<a name="l02512"></a>02512       <span class="keyword">if</span> (<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a> &gt; 1) <span class="keyword">then</span>
<a name="l02513"></a>02513 
<a name="l02514"></a>02514          <span class="keyword">do</span> k = 2, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02515"></a>02515             kr = k + 1
<a name="l02516"></a>02516 
<a name="l02517"></a>02517             <span class="keyword">do</span> ij = 1, isolve
<a name="l02518"></a>02518                i = indxii(ij)
<a name="l02519"></a>02519                j = indxjj(ij)
<a name="l02520"></a>02520                m = indxij(ij)
<a name="l02521"></a>02521 
<a name="l02522"></a>02522                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02523"></a>02523                   sbdiag(ij,kr) = -etas(m,k) * kh(m,k)
<a name="l02524"></a>02524                   spdiag(ij,kr) = -etas(m,k) * kh(m,k+1)
<a name="l02525"></a>02525                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02526"></a>02526                                + etas(m,k) * (kh(m,k) + kh(m,k+1))
<a name="l02527"></a>02527                   rhs   (ij,kr) = Tsn_init(m,k) &amp;
<a name="l02528"></a>02528                                + etas(m,k) * Sswabs(i,j,k)
<a name="l02529"></a>02529                <span class="keyword">endif</span>
<a name="l02530"></a>02530             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l02531"></a>02531          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l02532"></a>02532 
<a name="l02533"></a>02533       <span class="keyword">endif</span>                     <span class="comment">! nslyr &gt; 1</span>
<a name="l02534"></a>02534 
<a name="l02535"></a>02535 
<a name="l02536"></a>02536       <span class="keyword">if</span> (<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a> &gt; 1) <span class="keyword">then</span>
<a name="l02537"></a>02537 
<a name="l02538"></a>02538       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02539"></a>02539       <span class="comment">! top ice layer</span>
<a name="l02540"></a>02540       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02541"></a>02541 
<a name="l02542"></a>02542          ki = 1
<a name="l02543"></a>02543          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02544"></a>02544          kr = k + 1
<a name="l02545"></a>02545 
<a name="l02546"></a>02546             <span class="keyword">do</span> ij = 1, isolve
<a name="l02547"></a>02547                i = indxii(ij)
<a name="l02548"></a>02548                j = indxjj(ij)
<a name="l02549"></a>02549                m = indxij(ij)
<a name="l02550"></a>02550 
<a name="l02551"></a>02551                <span class="keyword">if</span> (l_snow(m) .or. l_cold(m)) <span class="keyword">then</span>
<a name="l02552"></a>02552                   sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02553"></a>02553                   spdiag(ij,kr) = -etai(ij,ki) * kh(m,k+1)
<a name="l02554"></a>02554                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02555"></a>02555                                  + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02556"></a>02556                   rhs   (ij,kr) = Tin_init(m,ki) &amp;
<a name="l02557"></a>02557                                  + etai(ij,ki)*Iswabs(i,j,ki)
<a name="l02558"></a>02558                <span class="keyword">else</span>    <span class="comment">! no snow, warm surface</span>
<a name="l02559"></a>02559                   sbdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02560"></a>02560                   spdiag(ij,kr) = -etai(ij,ki) * kh(m,k+1)
<a name="l02561"></a>02561                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02562"></a>02562                                  + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02563"></a>02563                   rhs   (ij,kr) = Tin_init(m,ki) &amp;
<a name="l02564"></a>02564                                  + etai(ij,ki)*Iswabs(i,j,ki) &amp;
<a name="l02565"></a>02565                                  + etai(ij,ki)*kh(m,k)*Tsf(m)
<a name="l02566"></a>02566                <span class="keyword">endif</span>
<a name="l02567"></a>02567             
<a name="l02568"></a>02568             <span class="keyword">enddo</span>    <span class="comment">! ij</span>
<a name="l02569"></a>02569 
<a name="l02570"></a>02570       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02571"></a>02571       <span class="comment">! bottom ice layer</span>
<a name="l02572"></a>02572       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02573"></a>02573 
<a name="l02574"></a>02574          ki = <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l02575"></a>02575          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02576"></a>02576          kr = k + 1
<a name="l02577"></a>02577       
<a name="l02578"></a>02578          <span class="keyword">do</span> ij = 1, isolve
<a name="l02579"></a>02579             i = indxii(ij)
<a name="l02580"></a>02580             j = indxjj(ij)
<a name="l02581"></a>02581             m = indxij(ij)
<a name="l02582"></a>02582             sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02583"></a>02583             spdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02584"></a>02584             diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>  &amp;
<a name="l02585"></a>02585                            + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02586"></a>02586             rhs   (ij,kr) = Tin_init(m,ki) &amp;
<a name="l02587"></a>02587                            + etai(ij,ki)*Iswabs(i,j,ki) &amp;
<a name="l02588"></a>02588                            + etai(ij,ki)*kh(m,k+1)*Tbot(i,j)
<a name="l02589"></a>02589 
<a name="l02590"></a>02590          <span class="keyword">enddo</span>                   <span class="comment">! ij</span>
<a name="l02591"></a>02591       
<a name="l02592"></a>02592       <span class="keyword">else</span>         <span class="comment">! nilyr = 1</span>
<a name="l02593"></a>02593 
<a name="l02594"></a>02594       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02595"></a>02595       <span class="comment">! single ice layer</span>
<a name="l02596"></a>02596       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02597"></a>02597 
<a name="l02598"></a>02598          ki = 1
<a name="l02599"></a>02599          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02600"></a>02600          kr = k + 1
<a name="l02601"></a>02601 
<a name="l02602"></a>02602             <span class="keyword">do</span> ij = 1, isolve
<a name="l02603"></a>02603                i = indxii(ij)
<a name="l02604"></a>02604                j = indxjj(ij)
<a name="l02605"></a>02605                m = indxij(ij)
<a name="l02606"></a>02606 
<a name="l02607"></a>02607                <span class="keyword">if</span> (l_snow(m) .or. l_cold(m)) <span class="keyword">then</span>
<a name="l02608"></a>02608                   sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02609"></a>02609                   spdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02610"></a>02610                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                 &amp;
<a name="l02611"></a>02611                                  + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02612"></a>02612                   rhs   (ij,kr) = Tin_init(m,ki)                     &amp;
<a name="l02613"></a>02613                                  + etai(ij,ki) * Iswabs(i,j,ki)      &amp;
<a name="l02614"></a>02614                                  + etai(ij,ki) * kh(m,k+1)*Tbot(i,j)
<a name="l02615"></a>02615                <span class="keyword">else</span>   <span class="comment">! no snow, warm surface</span>
<a name="l02616"></a>02616                   sbdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02617"></a>02617                   spdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02618"></a>02618                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                 &amp;
<a name="l02619"></a>02619                                  + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02620"></a>02620                   rhs   (ij,kr) = Tin_init(m,ki)                     &amp;
<a name="l02621"></a>02621                                  + etai(ij,ki) * Iswabs(i,j,ki)      &amp;
<a name="l02622"></a>02622                                  + etai(ij,ki) * kh(m,k)*Tsf(m)      &amp;
<a name="l02623"></a>02623                                  + etai(ij,ki) * kh(m,k+1)*Tbot(i,j)
<a name="l02624"></a>02624                <span class="keyword">endif</span>
<a name="l02625"></a>02625             <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02626"></a>02626  
<a name="l02627"></a>02627       <span class="keyword">endif</span>        <span class="comment">! nilyr &gt; 1</span>
<a name="l02628"></a>02628 
<a name="l02629"></a>02629       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02630"></a>02630       <span class="comment">! interior ice layers</span>
<a name="l02631"></a>02631       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02632"></a>02632 
<a name="l02633"></a>02633       <span class="keyword">do</span> ki = 2, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>-1
<a name="l02634"></a>02634            
<a name="l02635"></a>02635          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02636"></a>02636          kr = k + 1
<a name="l02637"></a>02637          <span class="keyword">do</span> ij = 1, isolve
<a name="l02638"></a>02638             i = indxii(ij)
<a name="l02639"></a>02639             j = indxjj(ij)
<a name="l02640"></a>02640             m = indxij(ij)
<a name="l02641"></a>02641 
<a name="l02642"></a>02642             sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02643"></a>02643             spdiag(ij,kr) = -etai(ij,ki) * kh(m,k+1)
<a name="l02644"></a>02644             diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02645"></a>02645                            + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02646"></a>02646             rhs   (ij,kr) = Tin_init(m,ki) &amp;
<a name="l02647"></a>02647                            + etai(ij,ki)*Iswabs(i,j,ki)
<a name="l02648"></a>02648 
<a name="l02649"></a>02649          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02650"></a>02650       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l02651"></a>02651 
<a name="l02652"></a>02652 <span class="keyword">      end subroutine get_matrix_elements_calc_Tsfc</span>
<a name="l02653"></a>02653 
<a name="l02654"></a>02654 <span class="comment">!=======================================================================</span>
<a name="l02655"></a>02655 <span class="comment">!BOP</span>
<a name="l02656"></a>02656 <span class="comment">!</span>
<a name="l02657"></a>02657 <span class="comment">! !ROUTINE: get_matrix_elements - compute tridiagonal matrix elements</span>
<a name="l02658"></a>02658 <span class="comment">!</span>
<a name="l02659"></a>02659 <span class="comment">! !DESCRIPTION:</span>
<a name="l02660"></a>02660 <span class="comment">!</span>
<a name="l02661"></a>02661 <span class="comment">! Compute terms in tridiagonal matrix that will be solved to find</span>
<a name="l02662"></a>02662 <span class="comment">!  the new vertical temperature profile</span>
<a name="l02663"></a>02663 <span class="comment">! This routine is for the case in which Tsfc is already known.</span>
<a name="l02664"></a>02664 <span class="comment">!</span>
<a name="l02665"></a>02665 <span class="comment">! !REVISION HISTORY:</span>
<a name="l02666"></a>02666 <span class="comment">!</span>
<a name="l02667"></a>02667 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l02668"></a>02668 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l02669"></a>02669 <span class="comment">!</span>
<a name="l02670"></a>02670 <span class="comment">!</span>
<a name="l02671"></a>02671 <span class="comment">! March 2004 by William H. Lipscomb for multiple snow layers</span>
<a name="l02672"></a>02672 <span class="comment">! April 2008 by E. C. Hunke, divided into two routines based on calc_Tsfc </span>
<a name="l02673"></a>02673 <span class="comment">!</span>
<a name="l02674"></a>02674 <span class="comment">! !INTERFACE:</span>
<a name="l02675"></a>02675 <span class="comment">!</span>
<a name="l02676"></a><a class="code" href="namespaceice__therm__vertical.html#ad636d3bbc26f9737173a670b7c43bfec">02676</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#ad636d3bbc26f9737173a670b7c43bfec">get_matrix_elements_know_Tsfc</a> &amp;
<a name="l02677"></a>02677                                      (nx_block, ny_block,         &amp;
<a name="l02678"></a>02678                                       isolve,   icells,           &amp;
<a name="l02679"></a>02679                                       indxii,   indxjj,   indxij, &amp;
<a name="l02680"></a>02680                                       l_snow,   Tbot,             &amp;
<a name="l02681"></a>02681                                       Tin_init, Tsn_init,         &amp;
<a name="l02682"></a>02682                                       kh,       Sswabs,           &amp;
<a name="l02683"></a>02683                                       Iswabs,                     &amp;
<a name="l02684"></a>02684                                       etai,     etas,             &amp;
<a name="l02685"></a>02685                                       sbdiag,   diag,             &amp;
<a name="l02686"></a>02686                                       spdiag,   rhs,              &amp;
<a name="l02687"></a>02687                                       fcondtopn)
<a name="l02688"></a>02688 <span class="comment">!</span>
<a name="l02689"></a>02689 <span class="comment">! !USES:</span>
<a name="l02690"></a>02690 <span class="comment">!</span>
<a name="l02691"></a>02691 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l02692"></a>02692 <span class="comment">!</span>
<a name="l02693"></a>02693       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02694"></a>02694          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l02695"></a>02695          isolve            ,  <span class="comment">! number of cells with temps not converged</span>
<a name="l02696"></a>02696          icells                <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l02697"></a>02697 
<a name="l02698"></a>02698       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(icells)</span>, 
<a name="l02699"></a>02699          <span class="keywordtype">intent(in)</span> :: 
<a name="l02700"></a>02700          indxii, indxjj  <span class="comment">! compressed indices for cells not converged</span>
<a name="l02701"></a>02701 
<a name="l02702"></a>02702       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l02703"></a>02703          <span class="keywordtype">intent(in)</span> :: 
<a name="l02704"></a>02704          indxij          <span class="comment">! compressed 1D index for cells not converged</span>
<a name="l02705"></a>02705 
<a name="l02706"></a>02706       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l02707"></a>02707          <span class="keywordtype">intent(in)</span> :: 
<a name="l02708"></a>02708          l_snow          <span class="comment">! true if snow temperatures are computed</span>
<a name="l02709"></a>02709 
<a name="l02710"></a>02710       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02711"></a>02711          Tbot            <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l02712"></a>02712 
<a name="l02713"></a>02713       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve,nilyr)</span>, 
<a name="l02714"></a>02714          <span class="keywordtype">intent(in)</span> :: 
<a name="l02715"></a>02715          etai            <span class="comment">! dt / (rho*cp*h) for ice layers</span>
<a name="l02716"></a>02716 
<a name="l02717"></a>02717       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l02718"></a>02718          <span class="keywordtype">intent(in)</span> :: 
<a name="l02719"></a>02719          Tin_init        <span class="comment">! ice temp at beginning of time step</span>
<a name="l02720"></a>02720 
<a name="l02721"></a>02721       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nslyr)</span>, 
<a name="l02722"></a>02722          <span class="keywordtype">intent(in)</span> :: 
<a name="l02723"></a>02723          Sswabs          <span class="comment">! SW radiation absorbed in snow layers (W m-2)</span>
<a name="l02724"></a>02724 
<a name="l02725"></a>02725       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nilyr)</span>, 
<a name="l02726"></a>02726          <span class="keywordtype">intent(in)</span> :: 
<a name="l02727"></a>02727          Iswabs          <span class="comment">! absorbed SW flux in ice layers</span>
<a name="l02728"></a>02728 
<a name="l02729"></a>02729       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l02730"></a>02730          <span class="keywordtype">intent(in)</span> :: 
<a name="l02731"></a>02731          etas        ,  <span class="comment">! dt / (rho*cp*h) for snow layers</span>
<a name="l02732"></a>02732          Tsn_init        <span class="comment">! snow temp at beginning of time step</span>
<a name="l02733"></a>02733                          <span class="comment">! Note: no absorbed SW in snow layers</span>
<a name="l02734"></a>02734 
<a name="l02735"></a>02735       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr+nilyr+1)</span>, 
<a name="l02736"></a>02736          <span class="keywordtype">intent(in)</span> :: 
<a name="l02737"></a>02737          kh              <span class="comment">! effective conductivity at layer interfaces</span>
<a name="l02738"></a>02738 
<a name="l02739"></a>02739       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve,nslyr+nilyr+1)</span>, 
<a name="l02740"></a>02740          <span class="keywordtype">intent(inout)</span> :: 
<a name="l02741"></a>02741          sbdiag      ,  <span class="comment">! sub-diagonal matrix elements</span>
<a name="l02742"></a>02742          diag        ,  <span class="comment">! diagonal matrix elements</span>
<a name="l02743"></a>02743          spdiag      ,  <span class="comment">! super-diagonal matrix elements</span>
<a name="l02744"></a>02744          rhs             <span class="comment">! rhs of tri-diagonal matrix eqn.</span>
<a name="l02745"></a>02745 
<a name="l02746"></a>02746       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span>,  
<a name="l02747"></a>02747          <span class="keywordtype">optional</span> :: 
<a name="l02748"></a>02748          fcondtopn       <span class="comment">! conductive flux at top sfc, positive down (W/m^2)</span>
<a name="l02749"></a>02749 <span class="comment">!</span>
<a name="l02750"></a>02750 <span class="comment">!EOP</span>
<a name="l02751"></a>02751 <span class="comment">!</span>
<a name="l02752"></a>02752       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l02753"></a>02753          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l02754"></a>02754          ij, m       ,  <span class="comment">! horizontal indices, combine i and j loops</span>
<a name="l02755"></a>02755          k, ks, ki, kr   <span class="comment">! vertical indices and row counters</span>
<a name="l02756"></a>02756 
<a name="l02757"></a>02757       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02758"></a>02758       <span class="comment">! Initialize matrix elements.</span>
<a name="l02759"></a>02759       <span class="comment">! Note: When we do not need to solve for the surface or snow</span>
<a name="l02760"></a>02760       <span class="comment">!       temperature, we solve dummy equations with solution T = 0.</span>
<a name="l02761"></a>02761       <span class="comment">!       Ice layers are fully initialized below.</span>
<a name="l02762"></a>02762       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02763"></a>02763 
<a name="l02764"></a>02764       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>+1
<a name="l02765"></a>02765          <span class="keyword">do</span> ij = 1, isolve
<a name="l02766"></a>02766             sbdiag(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02767"></a>02767             diag  (ij,k) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>
<a name="l02768"></a>02768             spdiag(ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02769"></a>02769             rhs   (ij,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02770"></a>02770          <span class="keyword">enddo</span>
<a name="l02771"></a>02771       <span class="keyword">enddo</span>
<a name="l02772"></a>02772             
<a name="l02773"></a>02773       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02774"></a>02774       <span class="comment">! Compute matrix elements</span>
<a name="l02775"></a>02775       <span class="comment">!</span>
<a name="l02776"></a>02776       <span class="comment">! Four possible cases to solve:</span>
<a name="l02777"></a>02777       <span class="comment">!   (1) Cold surface (Tsf &lt; 0), snow present</span>
<a name="l02778"></a>02778       <span class="comment">!   (2) Melting surface (Tsf = 0), snow present</span>
<a name="l02779"></a>02779       <span class="comment">!   (3) Cold surface (Tsf &lt; 0), no snow</span>
<a name="l02780"></a>02780       <span class="comment">!   (4) Melting surface (Tsf = 0), no snow</span>
<a name="l02781"></a>02781       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02782"></a>02782 
<a name="l02783"></a>02783       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02784"></a>02784       <span class="comment">! top snow layer</span>
<a name="l02785"></a>02785       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02786"></a>02786 <span class="comment">!        k = 1</span>
<a name="l02787"></a>02787 <span class="comment">!        kr = 2</span>
<a name="l02788"></a>02788 
<a name="l02789"></a>02789          <span class="keyword">do</span> ij = 1, isolve
<a name="l02790"></a>02790             i = indxii(ij)
<a name="l02791"></a>02791             j = indxjj(ij)
<a name="l02792"></a>02792             m = indxij(ij)
<a name="l02793"></a>02793 
<a name="l02794"></a>02794             <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02795"></a>02795                sbdiag(ij,2) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02796"></a>02796                spdiag(ij,2) = -etas(m,1) * kh(m,2)
<a name="l02797"></a>02797                diag  (ij,2) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                 &amp;
<a name="l02798"></a>02798                              + etas(m,1) * kh(m,2)
<a name="l02799"></a>02799                rhs   (ij,2) = Tsn_init(m,1)                      &amp;
<a name="l02800"></a>02800                              + etas(m,1) * Sswabs(i,j,1)         &amp;
<a name="l02801"></a>02801                              + etas(m,1) * fcondtopn(i,j)
<a name="l02802"></a>02802             <span class="keyword">endif</span>   <span class="comment">! l_snow</span>
<a name="l02803"></a>02803          <span class="keyword">enddo</span>   <span class="comment">! ij</span>
<a name="l02804"></a>02804 
<a name="l02805"></a>02805       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02806"></a>02806       <span class="comment">! remaining snow layers</span>
<a name="l02807"></a>02807       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02808"></a>02808 
<a name="l02809"></a>02809       <span class="keyword">if</span> (<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a> &gt; 1) <span class="keyword">then</span>
<a name="l02810"></a>02810 
<a name="l02811"></a>02811          <span class="keyword">do</span> k = 2, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02812"></a>02812             kr = k + 1
<a name="l02813"></a>02813 
<a name="l02814"></a>02814             <span class="keyword">do</span> ij = 1, isolve
<a name="l02815"></a>02815                i = indxii(ij)
<a name="l02816"></a>02816                j = indxjj(ij)
<a name="l02817"></a>02817                m = indxij(ij)
<a name="l02818"></a>02818 
<a name="l02819"></a>02819                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02820"></a>02820                   sbdiag(ij,kr) = -etas(m,k) * kh(m,k)
<a name="l02821"></a>02821                   spdiag(ij,kr) = -etas(m,k) * kh(m,k+1)
<a name="l02822"></a>02822                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02823"></a>02823                                + etas(m,k) * (kh(m,k) + kh(m,k+1))
<a name="l02824"></a>02824                   rhs   (ij,kr) = Tsn_init(m,k) &amp;
<a name="l02825"></a>02825                                + etas(m,k) * Sswabs(i,j,k)
<a name="l02826"></a>02826                <span class="keyword">endif</span>
<a name="l02827"></a>02827             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l02828"></a>02828          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l02829"></a>02829 
<a name="l02830"></a>02830       <span class="keyword">endif</span>                     <span class="comment">! nslyr &gt; 1</span>
<a name="l02831"></a>02831 
<a name="l02832"></a>02832 
<a name="l02833"></a>02833       <span class="keyword">if</span> (<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a> &gt; 1) <span class="keyword">then</span>
<a name="l02834"></a>02834 
<a name="l02835"></a>02835       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02836"></a>02836       <span class="comment">! top ice layer</span>
<a name="l02837"></a>02837       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02838"></a>02838 
<a name="l02839"></a>02839          ki = 1
<a name="l02840"></a>02840          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02841"></a>02841          kr = k + 1
<a name="l02842"></a>02842 
<a name="l02843"></a>02843             <span class="keyword">do</span> ij = 1, isolve
<a name="l02844"></a>02844                i = indxii(ij)
<a name="l02845"></a>02845                j = indxjj(ij)
<a name="l02846"></a>02846                m = indxij(ij)
<a name="l02847"></a>02847 
<a name="l02848"></a>02848                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02849"></a>02849 
<a name="l02850"></a>02850                   sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02851"></a>02851                   spdiag(ij,kr) = -etai(ij,ki) * kh(m,k+1)
<a name="l02852"></a>02852                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                &amp;
<a name="l02853"></a>02853                                  + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02854"></a>02854                   rhs   (ij,kr) = Tin_init(m,ki)                    &amp;
<a name="l02855"></a>02855                                  + etai(ij,ki) * Iswabs(i,j,ki)
<a name="l02856"></a>02856                <span class="keyword">else</span>                  
<a name="l02857"></a>02857                   sbdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02858"></a>02858                   spdiag(ij,kr) = -etai(ij,ki) * kh(m,k+1)
<a name="l02859"></a>02859                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                &amp;
<a name="l02860"></a>02860                                  + etai(ij,ki) * kh(m,k+1)
<a name="l02861"></a>02861                   rhs   (ij,kr) = Tin_init(m,ki)                    &amp;
<a name="l02862"></a>02862                                  + etai(ij,ki) * Iswabs(i,j,ki)       &amp;
<a name="l02863"></a>02863                                  + etai(ij,ki) * fcondtopn(i,j)
<a name="l02864"></a>02864                <span class="keyword">endif</span>  <span class="comment">! l_snow</span>
<a name="l02865"></a>02865             <span class="keyword">enddo</span>   <span class="comment">! ij</span>
<a name="l02866"></a>02866 
<a name="l02867"></a>02867       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02868"></a>02868       <span class="comment">! bottom ice layer</span>
<a name="l02869"></a>02869       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02870"></a>02870 
<a name="l02871"></a>02871          ki = <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l02872"></a>02872          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02873"></a>02873          kr = k + 1
<a name="l02874"></a>02874       
<a name="l02875"></a>02875          <span class="keyword">do</span> ij = 1, isolve
<a name="l02876"></a>02876             i = indxii(ij)
<a name="l02877"></a>02877             j = indxjj(ij)
<a name="l02878"></a>02878             m = indxij(ij)
<a name="l02879"></a>02879             sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02880"></a>02880             spdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02881"></a>02881             diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>  &amp;
<a name="l02882"></a>02882                            + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02883"></a>02883             rhs   (ij,kr) = Tin_init(m,ki) &amp;
<a name="l02884"></a>02884                            + etai(ij,ki)*Iswabs(i,j,ki) &amp;
<a name="l02885"></a>02885                            + etai(ij,ki)*kh(m,k+1)*Tbot(i,j)
<a name="l02886"></a>02886 
<a name="l02887"></a>02887          <span class="keyword">enddo</span>                   <span class="comment">! ij</span>
<a name="l02888"></a>02888       
<a name="l02889"></a>02889       <span class="keyword">else</span>         <span class="comment">! nilyr = 1</span>
<a name="l02890"></a>02890 
<a name="l02891"></a>02891       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02892"></a>02892       <span class="comment">! single ice layer</span>
<a name="l02893"></a>02893       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02894"></a>02894 
<a name="l02895"></a>02895          ki = 1
<a name="l02896"></a>02896          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02897"></a>02897          kr = k + 1
<a name="l02898"></a>02898 
<a name="l02899"></a>02899             <span class="keyword">do</span> ij = 1, isolve
<a name="l02900"></a>02900                i = indxii(ij)
<a name="l02901"></a>02901                j = indxjj(ij)
<a name="l02902"></a>02902                m = indxij(ij)
<a name="l02903"></a>02903 
<a name="l02904"></a>02904                <span class="keyword">if</span> (l_snow(m)) <span class="keyword">then</span>
<a name="l02905"></a>02905                   sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02906"></a>02906                   spdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02907"></a>02907                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                 &amp;
<a name="l02908"></a>02908                                  + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02909"></a>02909                   rhs   (ij,kr) = Tin_init(m,ki)                     &amp;
<a name="l02910"></a>02910                                  + etai(ij,ki) * Iswabs(i,j,ki)      &amp;
<a name="l02911"></a>02911                                  + etai(ij,ki) * kh(m,k+1)*Tbot(i,j)
<a name="l02912"></a>02912                <span class="keyword">else</span>
<a name="l02913"></a>02913                   sbdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02914"></a>02914                   spdiag(ij,kr) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02915"></a>02915                   diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>                                 &amp;
<a name="l02916"></a>02916                                  + etai(ij,ki) * kh(m,k+1)
<a name="l02917"></a>02917                   rhs   (ij,kr) = Tin_init(m,ki)                     &amp;
<a name="l02918"></a>02918                                  + etai(ij,ki) * Iswabs(i,j,ki)      &amp;
<a name="l02919"></a>02919                                  + etai(ij,ki) * fcondtopn(i,j)      &amp;
<a name="l02920"></a>02920                                  + etai(ij,ki) * kh(m,k+1)*Tbot(i,j)
<a name="l02921"></a>02921                <span class="keyword">endif</span>
<a name="l02922"></a>02922             <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l02923"></a>02923 
<a name="l02924"></a>02924       <span class="keyword">endif</span>        <span class="comment">! nilyr &gt; 1</span>
<a name="l02925"></a>02925 
<a name="l02926"></a>02926       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02927"></a>02927       <span class="comment">! interior ice layers</span>
<a name="l02928"></a>02928       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02929"></a>02929 
<a name="l02930"></a>02930       <span class="keyword">do</span> ki = 2, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>-1
<a name="l02931"></a>02931            
<a name="l02932"></a>02932          k  = ki + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02933"></a>02933          kr = k + 1
<a name="l02934"></a>02934          <span class="keyword">do</span> ij = 1, isolve
<a name="l02935"></a>02935             i = indxii(ij)
<a name="l02936"></a>02936             j = indxjj(ij)
<a name="l02937"></a>02937             m = indxij(ij)
<a name="l02938"></a>02938 
<a name="l02939"></a>02939             sbdiag(ij,kr) = -etai(ij,ki) * kh(m,k)
<a name="l02940"></a>02940             spdiag(ij,kr) = -etai(ij,ki) * kh(m,k+1)
<a name="l02941"></a>02941             diag  (ij,kr) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> &amp;
<a name="l02942"></a>02942                            + etai(ij,ki) * (kh(m,k) + kh(m,k+1))
<a name="l02943"></a>02943             rhs   (ij,kr) = Tin_init(m,ki) &amp;
<a name="l02944"></a>02944                            + etai(ij,ki)*Iswabs(i,j,ki)
<a name="l02945"></a>02945 
<a name="l02946"></a>02946          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02947"></a>02947       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l02948"></a>02948 
<a name="l02949"></a>02949 <span class="keyword">      end subroutine get_matrix_elements_know_Tsfc</span>
<a name="l02950"></a>02950 
<a name="l02951"></a>02951 <span class="comment">!=======================================================================</span>
<a name="l02952"></a>02952 <span class="comment">!BOP</span>
<a name="l02953"></a>02953 <span class="comment">!</span>
<a name="l02954"></a>02954 <span class="comment">! !ROUTINE: tridiag_solver - tridiagonal matrix solver</span>
<a name="l02955"></a>02955 <span class="comment">!</span>
<a name="l02956"></a>02956 <span class="comment">! !DESCRIPTION:</span>
<a name="l02957"></a>02957 <span class="comment">!</span>
<a name="l02958"></a>02958 <span class="comment">! Tridiagonal matrix solver--used to solve the implicit vertical heat</span>
<a name="l02959"></a>02959 <span class="comment">! equation in ice and snow</span>
<a name="l02960"></a>02960 <span class="comment">!</span>
<a name="l02961"></a>02961 <span class="comment">! !REVISION HISTORY:</span>
<a name="l02962"></a>02962 <span class="comment">!</span>
<a name="l02963"></a>02963 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l02964"></a>02964 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l02965"></a>02965 <span class="comment">!</span>
<a name="l02966"></a>02966 <span class="comment">! !INTERFACE:</span>
<a name="l02967"></a>02967 <span class="comment">!</span>
<a name="l02968"></a><a class="code" href="namespaceice__therm__vertical.html#aa5780ef62e3f9b27790b7ba6c47116a0">02968</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#aa5780ef62e3f9b27790b7ba6c47116a0">tridiag_solver</a> (nx_block, ny_block, &amp;
<a name="l02969"></a>02969                                  isolve,   icells,   &amp;
<a name="l02970"></a>02970                                  indxii,   indxjj,   &amp;
<a name="l02971"></a>02971                                  nmat,     sbdiag,   &amp;
<a name="l02972"></a>02972                                  diag,     spdiag,   &amp;
<a name="l02973"></a>02973                                  rhs,      xout)
<a name="l02974"></a>02974 <span class="comment">!</span>
<a name="l02975"></a>02975 <span class="comment">! !USES:</span>
<a name="l02976"></a>02976 <span class="comment">!</span>
<a name="l02977"></a>02977 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l02978"></a>02978 <span class="comment">!</span>
<a name="l02979"></a>02979       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02980"></a>02980          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l02981"></a>02981          isolve            ,  <span class="comment">! number of cells with temps not converged</span>
<a name="l02982"></a>02982          icells                <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l02983"></a>02983 
<a name="l02984"></a>02984       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(icells)</span>, 
<a name="l02985"></a>02985          <span class="keywordtype">intent(in)</span> :: 
<a name="l02986"></a>02986          indxii, indxjj  <span class="comment">! compressed indices for cells not converged</span>
<a name="l02987"></a>02987 
<a name="l02988"></a>02988       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l02989"></a>02989          nmat            <span class="comment">! matrix dimension</span>
<a name="l02990"></a>02990 
<a name="l02991"></a>02991       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve,nmat)</span>, 
<a name="l02992"></a>02992            <span class="keywordtype">intent(in)</span> :: 
<a name="l02993"></a>02993          sbdiag      ,  <span class="comment">! sub-diagonal matrix elements</span>
<a name="l02994"></a>02994          diag        ,  <span class="comment">! diagonal matrix elements</span>
<a name="l02995"></a>02995          spdiag      ,  <span class="comment">! super-diagonal matrix elements</span>
<a name="l02996"></a>02996          rhs             <span class="comment">! rhs of tri-diagonal matrix eqn.</span>
<a name="l02997"></a>02997 
<a name="l02998"></a>02998       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve,nmat)</span>, 
<a name="l02999"></a>02999            <span class="keywordtype">intent(inout)</span> :: 
<a name="l03000"></a>03000          xout            <span class="comment">! solution vector</span>
<a name="l03001"></a>03001 <span class="comment">!</span>
<a name="l03002"></a>03002 <span class="comment">!EOP</span>
<a name="l03003"></a>03003 <span class="comment">!</span>
<a name="l03004"></a>03004       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l03005"></a>03005          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l03006"></a>03006          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l03007"></a>03007          k               <span class="comment">! row counter</span>
<a name="l03008"></a>03008 
<a name="l03009"></a>03009       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (isolve) </span>:: 
<a name="l03010"></a>03010          wbeta           <span class="comment">! temporary matrix variable</span>
<a name="l03011"></a>03011 
<a name="l03012"></a>03012       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(isolve,nilyr+nslyr+1)</span>:: 
<a name="l03013"></a>03013          wgamma          <span class="comment">! temporary matrix variable</span>
<a name="l03014"></a>03014 
<a name="l03015"></a>03015 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03016"></a>03016 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03017"></a>03017 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03018"></a>03018       <span class="keyword">do</span> ij = 1, isolve
<a name="l03019"></a>03019          wbeta(ij) = diag(ij,1)
<a name="l03020"></a>03020          xout(ij,1) = rhs(ij,1) / wbeta(ij)
<a name="l03021"></a>03021       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l03022"></a>03022 
<a name="l03023"></a>03023       <span class="keyword">do</span> k = 2, nmat
<a name="l03024"></a>03024 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03025"></a>03025 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03026"></a>03026 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03027"></a>03027          <span class="keyword">do</span> ij = 1, isolve
<a name="l03028"></a>03028             wgamma(ij,k) = spdiag(ij,k-1) / wbeta(ij)
<a name="l03029"></a>03029             wbeta(ij) = diag(ij,k) - sbdiag(ij,k)*wgamma(ij,k)
<a name="l03030"></a>03030             xout(ij,k) = (rhs(ij,k) - sbdiag(ij,k)*xout(ij,k-1)) &amp;
<a name="l03031"></a>03031                          / wbeta(ij)
<a name="l03032"></a>03032          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03033"></a>03033       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l03034"></a>03034 
<a name="l03035"></a>03035       <span class="keyword">do</span> k = nmat-1, 1, -1
<a name="l03036"></a>03036 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03037"></a>03037 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03038"></a>03038 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03039"></a>03039          <span class="keyword">do</span> ij = 1, isolve
<a name="l03040"></a>03040             xout(ij,k) = xout(ij,k) - wgamma(ij,k+1)*xout(ij,k+1)
<a name="l03041"></a>03041          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03042"></a>03042       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l03043"></a>03043 
<a name="l03044"></a>03044 <span class="keyword">      end subroutine tridiag_solver</span>
<a name="l03045"></a>03045 
<a name="l03046"></a>03046 <span class="comment">!=======================================================================</span>
<a name="l03047"></a>03047 <span class="comment">!BOP</span>
<a name="l03048"></a>03048 <span class="comment">!</span>
<a name="l03049"></a>03049 <span class="comment">! !ROUTINE: zerolayer_temperature  - new surface temperature calculation</span>
<a name="l03050"></a>03050 <span class="comment">!</span>
<a name="l03051"></a>03051 <span class="comment">! !DESCRIPTION:</span>
<a name="l03052"></a>03052 <span class="comment">!</span>
<a name="l03053"></a>03053 <span class="comment">! Compute new surface temperature using zero layer model of Semtner</span>
<a name="l03054"></a>03054 <span class="comment">! (1976).</span>
<a name="l03055"></a>03055 <span class="comment">!</span>
<a name="l03056"></a>03056 <span class="comment">! New temperatures are computed iteratively by solving a</span>
<a name="l03057"></a>03057 <span class="comment">! surface flux balance equation (i.e. net surface flux from atmos</span>
<a name="l03058"></a>03058 <span class="comment">! equals conductive flux from the top to the bottom surface).</span>
<a name="l03059"></a>03059 <span class="comment">!</span>
<a name="l03060"></a>03060 <span class="comment">! !REVISION HISTORY:</span>
<a name="l03061"></a>03061 <span class="comment">!</span>
<a name="l03062"></a>03062 <span class="comment">! author:  Alison McLaren, Met Office</span>
<a name="l03063"></a>03063 <span class="comment">!         (but largely taken from temperature_changes)</span>
<a name="l03064"></a>03064 <span class="comment">!</span>
<a name="l03065"></a>03065 <span class="comment">! !INTERFACE:</span>
<a name="l03066"></a>03066 <span class="comment">!</span>
<a name="l03067"></a><a class="code" href="namespaceice__therm__vertical.html#a862eb3ec0eaa2a5ae48961730e1ba7ce">03067</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a862eb3ec0eaa2a5ae48961730e1ba7ce">zerolayer_temperature</a>(nx_block, ny_block, &amp;
<a name="l03068"></a>03068                                        my_task,  istep1,   &amp;
<a name="l03069"></a>03069                                        dt,       icells,   &amp; 
<a name="l03070"></a>03070                                        indxi,    indxj,    &amp;
<a name="l03071"></a>03071                                        rhoa,     flw,      &amp;
<a name="l03072"></a>03072                                        potT,     Qa,       &amp;
<a name="l03073"></a>03073                                        shcoef,   lhcoef,   &amp;
<a name="l03074"></a>03074                                        fswsfc,   fswthrun, &amp;
<a name="l03075"></a>03075                                        hilyr,    hslyr,    &amp;
<a name="l03076"></a>03076                                        Tsf,      Tbot,     &amp;
<a name="l03077"></a>03077                                        fsensn,   flatn,    &amp;
<a name="l03078"></a>03078                                        fswabsn,  flwoutn,  &amp;
<a name="l03079"></a>03079                                        fsurfn,             &amp;
<a name="l03080"></a>03080                                        fcondtopn,fcondbot, &amp;
<a name="l03081"></a>03081                                        l_stop,             &amp;
<a name="l03082"></a>03082                                        istop,    jstop)
<a name="l03083"></a>03083 <span class="comment">!</span>
<a name="l03084"></a>03084 <span class="comment">! !USES:</span>
<a name="l03085"></a>03085 <span class="comment">!</span>
<a name="l03086"></a>03086 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l03087"></a>03087 <span class="comment">!</span>
<a name="l03088"></a>03088       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03089"></a>03089          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l03090"></a>03090          my_task     ,  <span class="comment">! task number (diagnostic only)</span>
<a name="l03091"></a>03091          istep1      ,  <span class="comment">! time step index (diagnostic only)</span>
<a name="l03092"></a>03092          icells          <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l03093"></a>03093 
<a name="l03094"></a>03094       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03095"></a>03095          dt              <span class="comment">! time step</span>
<a name="l03096"></a>03096 
<a name="l03097"></a>03097       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l03098"></a>03098          <span class="keywordtype">intent(in)</span> :: 
<a name="l03099"></a>03099          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l03100"></a>03100 
<a name="l03101"></a>03101       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03102"></a>03102          rhoa        ,  <span class="comment">! air density (kg/m^3)</span>
<a name="l03103"></a>03103          flw         ,  <span class="comment">! incoming longwave radiation (W/m^2)</span>
<a name="l03104"></a>03104          potT        ,  <span class="comment">! air potential temperature  (K)</span>
<a name="l03105"></a>03105          Qa          ,  <span class="comment">! specific humidity (kg/kg)</span>
<a name="l03106"></a>03106          shcoef      ,  <span class="comment">! transfer coefficient for sensible heat</span>
<a name="l03107"></a>03107          lhcoef      ,  <span class="comment">! transfer coefficient for latent heat</span>
<a name="l03108"></a>03108          Tbot        ,  <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l03109"></a>03109          fswsfc      ,  <span class="comment">! SW absorbed at ice/snow surface (W m-2)</span>
<a name="l03110"></a>03110          fswthrun        <span class="comment">! SW through ice to ocean         (W m-2)</span>
<a name="l03111"></a>03111 
<a name="l03112"></a>03112       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03113"></a>03113          hilyr       ,  <span class="comment">! ice layer thickness (m)</span>
<a name="l03114"></a>03114          hslyr           <span class="comment">! snow layer thickness (m)</span>
<a name="l03115"></a>03115 
<a name="l03116"></a>03116       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(inout)</span>:: 
<a name="l03117"></a>03117          fsensn      ,  <span class="comment">! surface downward sensible heat (W m-2)</span>
<a name="l03118"></a>03118          fswabsn     ,  <span class="comment">! shortwave flux absorbed by ice (W/m-2) </span>
<a name="l03119"></a>03119          flatn       ,  <span class="comment">! surface downward latent heat (W m-2)</span>
<a name="l03120"></a>03120          flwoutn     ,  <span class="comment">! upward LW at surface (W m-2)</span>
<a name="l03121"></a>03121          fsurfn      ,  <span class="comment">! net flux to top surface, excluding fcondtopn</span>
<a name="l03122"></a>03122          fcondtopn       <span class="comment">! downward cond flux at top surface (W m-2)</span>
<a name="l03123"></a>03123 
<a name="l03124"></a>03124       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l03125"></a>03125          fcondbot        <span class="comment">! downward cond flux at bottom surface (W m-2)</span>
<a name="l03126"></a>03126 
<a name="l03127"></a>03127       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l03128"></a>03128          <span class="keywordtype">intent(inout)</span>:: 
<a name="l03129"></a>03129          Tsf             <span class="comment">! ice/snow surface temperature, Tsfcn</span>
<a name="l03130"></a>03130 
<a name="l03131"></a>03131       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l03132"></a>03132          l_stop          <span class="comment">! if true, print diagnostics and abort model</span>
<a name="l03133"></a>03133 
<a name="l03134"></a>03134       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l03135"></a>03135          istop, jstop    <span class="comment">! i and j indices of cell where model fails</span>
<a name="l03136"></a>03136 <span class="comment">!</span>
<a name="l03137"></a>03137 <span class="comment">!EOP</span>
<a name="l03138"></a>03138 <span class="comment">!</span>
<a name="l03139"></a>03139       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l03140"></a>03140          l_zerolayerchecks = .true.
<a name="l03141"></a>03141 
<a name="l03142"></a>03142       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l03143"></a>03143          nitermax = 50   <span class="comment">! max number of iterations in temperature solver</span>
<a name="l03144"></a>03144 
<a name="l03145"></a>03145       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l03146"></a>03146          Tsf_errmax = 5.e-4_dbl_kind <span class="comment">! max allowed error in Tsf</span>
<a name="l03147"></a>03147                                      <span class="comment">! recommend Tsf_errmax &lt; 0.01 K</span>
<a name="l03148"></a>03148 
<a name="l03149"></a>03149       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l03150"></a>03150          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l03151"></a>03151          ij, m       ,  <span class="comment">! horizontal indices, combine i and j loops</span>
<a name="l03152"></a>03152          niter           <span class="comment">! iteration counter in temperature solver</span>
<a name="l03153"></a>03153 
<a name="l03154"></a>03154       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l03155"></a>03155          isolve          <span class="comment">! number of cells with temps not converged</span>
<a name="l03156"></a>03156 
<a name="l03157"></a>03157       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l03158"></a>03158          indxii, indxjj  <span class="comment">! compressed indices for cells not converged</span>
<a name="l03159"></a>03159 
<a name="l03160"></a>03160       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l03161"></a>03161          indxij          <span class="comment">! compressed 1D index for cells not converged</span>
<a name="l03162"></a>03162 
<a name="l03163"></a>03163       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:)</span>, <span class="keywordtype">allocatable</span> :: 
<a name="l03164"></a>03164          Tsf_start   ,  <span class="comment">! Tsf at start of iteration</span>
<a name="l03165"></a>03165          dTsf        ,  <span class="comment">! Tsf - Tsf_start</span>
<a name="l03166"></a>03166          dfsurf_dT       <span class="comment">! derivative of fsurfn wrt Tsf</span>
<a name="l03167"></a>03167 
<a name="l03168"></a>03168       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l03169"></a>03169          dTsf_prev   ,  <span class="comment">! dTsf from previous iteration</span>
<a name="l03170"></a>03170          dfsens_dT   ,  <span class="comment">! deriv of fsens wrt Tsf (W m-2 deg-1)</span>
<a name="l03171"></a>03171          dflat_dT    ,  <span class="comment">! deriv of flat wrt Tsf (W m-2 deg-1)</span>
<a name="l03172"></a>03172          dflwout_dT      <span class="comment">! deriv of flwout wrt Tsf (W m-2 deg-1)</span>
<a name="l03173"></a>03173 
<a name="l03174"></a>03174       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:)</span>, <span class="keywordtype">allocatable</span> :: 
<a name="l03175"></a>03175          heff        ,  <span class="comment">! effective ice thickness (m)</span>
<a name="l03176"></a>03176                          <span class="comment">! ( hice + hsno*kseaice/ksnow)</span>
<a name="l03177"></a>03177          kh          , &amp; <span class="comment">! effective conductivity</span>
<a name="l03178"></a>03178          diag        , &amp; <span class="comment">! diagonal matrix elements</span>
<a name="l03179"></a>03179          rhs             <span class="comment">! rhs of tri-diagonal matrix equation</span>
<a name="l03180"></a>03180 
<a name="l03181"></a>03181       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l03182"></a>03182          kratio      ,  <span class="comment">! ratio of ice and snow conductivies</span>
<a name="l03183"></a>03183          avg_Tsf         <span class="comment">! = 1. if Tsf averaged w/Tsf_start, else = 0.</span>
<a name="l03184"></a>03184 
<a name="l03185"></a>03185       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l03186"></a>03186          converged      <span class="comment">! = true when local solution has converged</span>
<a name="l03187"></a>03187 
<a name="l03188"></a>03188       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l03189"></a>03189          all_converged  <span class="comment">! = true when all cells have converged</span>
<a name="l03190"></a>03190 
<a name="l03191"></a>03191       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03192"></a>03192       <span class="comment">! Initialize</span>
<a name="l03193"></a>03193       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03194"></a>03194 
<a name="l03195"></a>03195       all_converged   = .false.
<a name="l03196"></a>03196 
<a name="l03197"></a>03197       <span class="keyword">do</span> ij = 1, icells
<a name="l03198"></a>03198          fcondbot(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03199"></a>03199 
<a name="l03200"></a>03200          converged (ij) = .false.
<a name="l03201"></a>03201 
<a name="l03202"></a>03202          dTsf_prev (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03203"></a>03203 
<a name="l03204"></a>03204       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l03205"></a>03205       
<a name="l03206"></a>03206       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03207"></a>03207       <span class="comment">! Solve for new temperatures.</span>
<a name="l03208"></a>03208       <span class="comment">! Iterate until temperatures converge with minimal temperature</span>
<a name="l03209"></a>03209       <span class="comment">! change.</span>
<a name="l03210"></a>03210       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03211"></a>03211 
<a name="l03212"></a>03212       <span class="keyword">do</span> niter = 1, nitermax
<a name="l03213"></a>03213 
<a name="l03214"></a>03214          <span class="keyword">if</span> (all_converged) <span class="keyword">then</span>  <span class="comment">! thermo calculation is done</span>
<a name="l03215"></a>03215             exit
<a name="l03216"></a>03216          <span class="keyword">else</span>                     <span class="comment">! identify cells not yet converged</span>
<a name="l03217"></a>03217             isolve = 0
<a name="l03218"></a>03218             <span class="keyword">do</span> ij = 1, icells
<a name="l03219"></a>03219                i = indxi(ij)
<a name="l03220"></a>03220                j = indxj(ij)
<a name="l03221"></a>03221                <span class="keyword">if</span> (.not.converged(ij)) <span class="keyword">then</span>
<a name="l03222"></a>03222                   isolve = isolve + 1
<a name="l03223"></a>03223                   indxii(isolve) = i
<a name="l03224"></a>03224                   indxjj(isolve) = j
<a name="l03225"></a>03225                   indxij(isolve) = ij
<a name="l03226"></a>03226                <span class="keyword">endif</span>
<a name="l03227"></a>03227             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l03228"></a>03228          <span class="keyword">endif</span>
<a name="l03229"></a>03229 
<a name="l03230"></a>03230          <span class="keyword">allocate</span>(     diag(isolve))
<a name="l03231"></a>03231          <span class="keyword">allocate</span>(      rhs(isolve))
<a name="l03232"></a>03232          <span class="keyword">allocate</span>(       kh(isolve))
<a name="l03233"></a>03233          <span class="keyword">allocate</span>(     heff(isolve))
<a name="l03234"></a>03234          <span class="keyword">allocate</span>(Tsf_start(isolve))
<a name="l03235"></a>03235          <span class="keyword">allocate</span>(     dTsf(isolve))
<a name="l03236"></a>03236          <span class="keyword">allocate</span>(dfsurf_dT(isolve))
<a name="l03237"></a>03237 
<a name="l03238"></a>03238       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03239"></a>03239       <span class="comment">! Update radiative and turbulent fluxes and their derivatives</span>
<a name="l03240"></a>03240       <span class="comment">! with respect to Tsf.</span>
<a name="l03241"></a>03241       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03242"></a>03242 
<a name="l03243"></a>03243          call <a class="code" href="namespaceice__therm__vertical.html#aa2320460f9c52d821db02db2209fa888">surface_fluxes </a>(nx_block,    ny_block,          &amp;
<a name="l03244"></a>03244                               isolve,      icells,            &amp;
<a name="l03245"></a>03245                               indxii,      indxjj,    indxij, &amp;
<a name="l03246"></a>03246                               Tsf,         fswsfc,            &amp;
<a name="l03247"></a>03247                               rhoa,        flw,               &amp;
<a name="l03248"></a>03248                               potT,        Qa,                &amp;
<a name="l03249"></a>03249                               shcoef,      lhcoef,            &amp;
<a name="l03250"></a>03250                               flwoutn,     fsensn,            &amp;
<a name="l03251"></a>03251                               flatn,       fsurfn,            &amp;
<a name="l03252"></a>03252                               dflwout_dT,  dfsens_dT,         &amp;
<a name="l03253"></a>03253                               dflat_dT,    dfsurf_dT)
<a name="l03254"></a>03254 
<a name="l03255"></a>03255       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03256"></a>03256       <span class="comment">! Compute effective ice thickness (includes snow) and thermal </span>
<a name="l03257"></a>03257       <span class="comment">! conductivity </span>
<a name="l03258"></a>03258       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03259"></a>03259 
<a name="l03260"></a>03260          kratio = kseaice/ksno
<a name="l03261"></a>03261  
<a name="l03262"></a>03262          <span class="keyword">do</span> ij = 1, isolve
<a name="l03263"></a>03263              m = indxij(ij)
<a name="l03264"></a>03264    
<a name="l03265"></a>03265              heff(ij) = hilyr(m) + kratio * hslyr(m)
<a name="l03266"></a>03266              kh(ij) = kseaice / heff(ij)        
<a name="l03267"></a>03267          <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l03268"></a>03268 
<a name="l03269"></a>03269 
<a name="l03270"></a>03270 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03271"></a>03271 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03272"></a>03272 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03273"></a>03273          <span class="keyword">do</span> ij = 1, isolve
<a name="l03274"></a>03274             i = indxii(ij)
<a name="l03275"></a>03275             j = indxjj(ij)
<a name="l03276"></a>03276             m = indxij(ij)
<a name="l03277"></a>03277 
<a name="l03278"></a>03278       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03279"></a>03279       <span class="comment">! Compute conductive flux at top surface, fcondtopn.</span>
<a name="l03280"></a>03280       <span class="comment">! If fsurfn &lt; fcondtopn and Tsf = 0, then reset Tsf to slightly less</span>
<a name="l03281"></a>03281       <span class="comment">!  than zero (but not less than -puny).</span>
<a name="l03282"></a>03282       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03283"></a>03283 
<a name="l03284"></a>03284             fcondtopn(i,j) = kh(ij) * (Tsf(m) - Tbot(i,j))
<a name="l03285"></a>03285 
<a name="l03286"></a>03286             <span class="keyword">if</span> (fsurfn(i,j) &lt; fcondtopn(i,j)) &amp;
<a name="l03287"></a>03287                  Tsf(m) = min (Tsf(m), -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)
<a name="l03288"></a>03288 
<a name="l03289"></a>03289       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03290"></a>03290       <span class="comment">! Save surface temperature at start of iteration</span>
<a name="l03291"></a>03291       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03292"></a>03292 
<a name="l03293"></a>03293             Tsf_start(ij) = Tsf(m)
<a name="l03294"></a>03294 
<a name="l03295"></a>03295          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03296"></a>03296 
<a name="l03297"></a>03297       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03298"></a>03298       <span class="comment">! Solve surface balance equation to obtain the new temperatures.</span>
<a name="l03299"></a>03299       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03300"></a>03300 
<a name="l03301"></a>03301          <span class="keyword">do</span> ij = 1, isolve
<a name="l03302"></a>03302             i = indxii(ij)
<a name="l03303"></a>03303             j = indxjj(ij)
<a name="l03304"></a>03304             m = indxij(ij)
<a name="l03305"></a>03305 
<a name="l03306"></a>03306             diag(ij)  = dfsurf_dT(ij) - kh(ij)
<a name="l03307"></a>03307             rhs(ij)   = dfsurf_dT(ij)*Tsf(m) - fsurfn(i,j)   &amp;
<a name="l03308"></a>03308                         - kh(ij)*Tbot(i,j)
<a name="l03309"></a>03309             Tsf(m)  = rhs(ij) / diag(ij)
<a name="l03310"></a>03310 
<a name="l03311"></a>03311          <span class="keyword">enddo</span>
<a name="l03312"></a>03312 
<a name="l03313"></a>03313       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03314"></a>03314       <span class="comment">! Determine whether the computation has converged to an acceptable</span>
<a name="l03315"></a>03315       <span class="comment">! solution.  Four conditions must be satisfied:</span>
<a name="l03316"></a>03316       <span class="comment">!</span>
<a name="l03317"></a>03317       <span class="comment">!    (1) Tsf &lt;= 0 C.</span>
<a name="l03318"></a>03318       <span class="comment">!    (2) Tsf is not oscillating; i.e., if both dTsf(niter) and</span>
<a name="l03319"></a>03319       <span class="comment">!        dTsf(niter-1) have magnitudes greater than puny, then</span>
<a name="l03320"></a>03320       <span class="comment">!        dTsf(niter)/dTsf(niter-1) cannot be a negative number</span>
<a name="l03321"></a>03321       <span class="comment">!        with magnitude greater than 0.5.  </span>
<a name="l03322"></a>03322       <span class="comment">!    (3) abs(dTsf) &lt; Tsf_errmax</span>
<a name="l03323"></a>03323       <span class="comment">!    (4) If Tsf = 0 C, then the downward turbulent/radiative </span>
<a name="l03324"></a>03324       <span class="comment">!        flux, fsurfn, must be greater than or equal to the downward</span>
<a name="l03325"></a>03325       <span class="comment">!        conductive flux, fcondtopn.</span>
<a name="l03326"></a>03326       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03327"></a>03327 
<a name="l03328"></a>03328          <span class="comment">! initialize global convergence flag</span>
<a name="l03329"></a>03329          all_converged = .true.
<a name="l03330"></a>03330 
<a name="l03331"></a>03331 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03332"></a>03332 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03333"></a>03333 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03334"></a>03334          <span class="keyword">do</span> ij = 1, isolve
<a name="l03335"></a>03335             m = indxij(ij)
<a name="l03336"></a>03336 
<a name="l03337"></a>03337       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03338"></a>03338       <span class="comment">! Initialize convergence flag (true until proven false), dTsf,</span>
<a name="l03339"></a>03339       <span class="comment">!  and temperature-averaging coefficients.</span>
<a name="l03340"></a>03340       <span class="comment">! Average only if test 1 or 2 fails.</span>
<a name="l03341"></a>03341       <span class="comment">! Initialize energy.</span>
<a name="l03342"></a>03342       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03343"></a>03343 
<a name="l03344"></a>03344             converged(m) = .true.
<a name="l03345"></a>03345             dTsf(ij) = Tsf(m) - Tsf_start(ij)
<a name="l03346"></a>03346             avg_Tsf      = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03347"></a>03347 
<a name="l03348"></a>03348       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03349"></a>03349       <span class="comment">! Condition 1: check for Tsf &gt; 0</span>
<a name="l03350"></a>03350       <span class="comment">! If Tsf &gt; 0, set Tsf = 0 and leave converged=.true.</span>
<a name="l03351"></a>03351       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03352"></a>03352 
<a name="l03353"></a>03353             <span class="keyword">if</span> (Tsf(m) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l03354"></a>03354                Tsf(m) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03355"></a>03355                dTsf(ij) = -Tsf_start(ij)
<a name="l03356"></a>03356 
<a name="l03357"></a>03357       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03358"></a>03358       <span class="comment">! Condition 2: check for oscillating Tsf</span>
<a name="l03359"></a>03359       <span class="comment">! If oscillating, average all temps to increase rate of convergence.</span>
<a name="l03360"></a>03360       <span class="comment">! It is possible that this may never occur.</span>
<a name="l03361"></a>03361       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03362"></a>03362 
<a name="l03363"></a>03363             elseif (niter &gt; 1 &amp;                <span class="comment">! condition (2)</span>
<a name="l03364"></a>03364               .and. Tsf_start(ij) &lt;= -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l03365"></a>03365               .and. abs(dTsf(ij)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l03366"></a>03366               .and. abs(dTsf_prev(m)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> &amp;
<a name="l03367"></a>03367               .and. -dTsf(ij)/(dTsf_prev(m)+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &gt; <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a>) <span class="keyword">then</span>
<a name="l03368"></a>03368 
<a name="l03369"></a>03369                avg_Tsf  = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>  <span class="comment">! average with starting temp  </span>
<a name="l03370"></a>03370                dTsf(ij) = <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a> * dTsf(ij)
<a name="l03371"></a>03371                converged(m) = .false.
<a name="l03372"></a>03372                all_converged = .false.
<a name="l03373"></a>03373             <span class="keyword">endif</span>
<a name="l03374"></a>03374 
<a name="l03375"></a>03375       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03376"></a>03376       <span class="comment">! If condition 2 failed, average new surface temperature with</span>
<a name="l03377"></a>03377       <span class="comment">!  starting value.</span>
<a name="l03378"></a>03378       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03379"></a>03379             Tsf(m)  = Tsf(m) &amp;
<a name="l03380"></a>03380                       + avg_Tsf * <a class="code" href="namespaceice__constants.html#a26872e9df91fb7484a1a2ddefd7b71b0">p5</a> * (Tsf_start(ij) - Tsf(m))
<a name="l03381"></a>03381 
<a name="l03382"></a>03382          <span class="keyword">enddo</span>  <span class="comment">! ij</span>
<a name="l03383"></a>03383 
<a name="l03384"></a>03384 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03385"></a>03385 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03386"></a>03386 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03387"></a>03387          <span class="keyword">do</span> ij = 1, isolve
<a name="l03388"></a>03388             i = indxii(ij)
<a name="l03389"></a>03389             j = indxjj(ij)
<a name="l03390"></a>03390             m = indxij(ij)
<a name="l03391"></a>03391 
<a name="l03392"></a>03392       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03393"></a>03393       <span class="comment">! Condition 3: check for large change in Tsf</span>
<a name="l03394"></a>03394       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03395"></a>03395 
<a name="l03396"></a>03396             <span class="keyword">if</span> (abs(dTsf(ij)) &gt; Tsf_errmax) <span class="keyword">then</span>
<a name="l03397"></a>03397                converged(m) = .false.
<a name="l03398"></a>03398                all_converged = .false.
<a name="l03399"></a>03399             <span class="keyword">endif</span>
<a name="l03400"></a>03400 
<a name="l03401"></a>03401       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03402"></a>03402       <span class="comment">! Condition 4: check for fsurfn &lt; fcondtopn with Tsf &gt; 0</span>
<a name="l03403"></a>03403       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03404"></a>03404 
<a name="l03405"></a>03405             fsurfn(i,j) = fsurfn(i,j) + dTsf(ij)*dfsurf_dT(ij)
<a name="l03406"></a>03406             fcondtopn(i,j) = kh(ij) * (Tsf(m)-Tbot(i,j))
<a name="l03407"></a>03407 
<a name="l03408"></a>03408             <span class="keyword">if</span> (Tsf(m) &gt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. fsurfn(i,j) &lt; fcondtopn(i,j)) <span class="keyword">then</span>
<a name="l03409"></a>03409                converged(m) = .false.
<a name="l03410"></a>03410                all_converged = .false.
<a name="l03411"></a>03411             <span class="keyword">endif</span>
<a name="l03412"></a>03412 
<a name="l03413"></a>03413             fcondbot(m) = fcondtopn(i,j)
<a name="l03414"></a>03414 
<a name="l03415"></a>03415             dTsf_prev(m) = dTsf(ij)
<a name="l03416"></a>03416 
<a name="l03417"></a>03417          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03418"></a>03418 
<a name="l03419"></a>03419          <span class="keyword">deallocate</span>(diag)
<a name="l03420"></a>03420          <span class="keyword">deallocate</span>(rhs)
<a name="l03421"></a>03421          <span class="keyword">deallocate</span>(kh)
<a name="l03422"></a>03422          <span class="keyword">deallocate</span>(heff)
<a name="l03423"></a>03423          <span class="keyword">deallocate</span>(Tsf_start)
<a name="l03424"></a>03424          <span class="keyword">deallocate</span>(dTsf)
<a name="l03425"></a>03425          <span class="keyword">deallocate</span>(dfsurf_dT)
<a name="l03426"></a>03426 
<a name="l03427"></a>03427       <span class="keyword">enddo</span>                     <span class="comment">! temperature iteration niter</span>
<a name="l03428"></a>03428 
<a name="l03429"></a>03429       <span class="keyword">if</span> (.not.all_converged) <span class="keyword">then</span>
<a name="l03430"></a>03430 
<a name="l03431"></a>03431          <span class="keyword">do</span> ij = 1, icells
<a name="l03432"></a>03432             i = indxi(ij)
<a name="l03433"></a>03433             j = indxj(ij)
<a name="l03434"></a>03434 
<a name="l03435"></a>03435       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03436"></a>03436       <span class="comment">! Check for convergence failures.</span>
<a name="l03437"></a>03437       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03438"></a>03438             <span class="keyword">if</span> (.not.converged(ij)) <span class="keyword">then</span>
<a name="l03439"></a>03439                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Thermo iteration does not converge,&apos;</span>, &amp;
<a name="l03440"></a>03440                                 <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l03441"></a>03441                                  istep1, my_task, i, j
<a name="l03442"></a>03442                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Ice thickness:&apos;</span>,  hilyr(ij)*<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l03443"></a>03443                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Snow thickness:&apos;</span>, hslyr(ij)*<a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l03444"></a>03444                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;dTsf, Tsf_errmax:&apos;</span>,dTsf_prev(ij), &amp;
<a name="l03445"></a>03445                                  Tsf_errmax
<a name="l03446"></a>03446                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tsf:&apos;</span>, Tsf(ij)
<a name="l03447"></a>03447                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fsurfn:&apos;</span>, fsurfn(i,j)
<a name="l03448"></a>03448                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fcondtopn, fcondbot&apos;</span>, &amp;
<a name="l03449"></a>03449                                  fcondtopn(i,j), fcondbot(ij)
<a name="l03450"></a>03450                l_stop = .true.
<a name="l03451"></a>03451                istop = i
<a name="l03452"></a>03452                jstop = j
<a name="l03453"></a>03453                return
<a name="l03454"></a>03454             <span class="keyword">endif</span>
<a name="l03455"></a>03455          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03456"></a>03456       <span class="keyword">endif</span>                     <span class="comment">! all_converged</span>
<a name="l03457"></a>03457 
<a name="l03458"></a>03458       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03459"></a>03459       <span class="comment">! Check that if Tsfc &lt; 0, then fcondtopn = fsurfn</span>
<a name="l03460"></a>03460       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03461"></a>03461 
<a name="l03462"></a>03462       <span class="keyword">if</span> (l_zerolayerchecks) <span class="keyword">then</span>
<a name="l03463"></a>03463          <span class="keyword">do</span> ij = 1, icells
<a name="l03464"></a>03464             i = indxi(ij)
<a name="l03465"></a>03465             j = indxj(ij)
<a name="l03466"></a>03466             
<a name="l03467"></a>03467             <span class="keyword">if</span> (Tsf(ij) &lt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a> .and. &amp; 
<a name="l03468"></a>03468                   abs(fcondtopn(i,j)-fsurfn(i,j)) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l03469"></a>03469 
<a name="l03470"></a>03470                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fcondtopn does not equal fsurfn,&apos;</span>, &amp;
<a name="l03471"></a>03471                                 <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l03472"></a>03472                                  istep1, my_task, i, j
<a name="l03473"></a>03473                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Tsf=&apos;</span>,Tsf(ij)
<a name="l03474"></a>03474                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fcondtopn=&apos;</span>,fcondtopn(i,j)
<a name="l03475"></a>03475                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;fsurfn=&apos;</span>,fsurfn(i,j)
<a name="l03476"></a>03476                l_stop = .true.
<a name="l03477"></a>03477                istop = i
<a name="l03478"></a>03478                jstop = j
<a name="l03479"></a>03479                return
<a name="l03480"></a>03480             <span class="keyword">endif</span>
<a name="l03481"></a>03481          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03482"></a>03482       <span class="keyword">endif</span>                     <span class="comment">! l_zerolayerchecks</span>
<a name="l03483"></a>03483 
<a name="l03484"></a>03484 
<a name="l03485"></a>03485 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03486"></a>03486 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03487"></a>03487 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03488"></a>03488       <span class="keyword">do</span> ij = 1, icells
<a name="l03489"></a>03489          i = indxi(ij)
<a name="l03490"></a>03490          j = indxj(ij)
<a name="l03491"></a>03491 
<a name="l03492"></a>03492          <span class="comment">! update fluxes that depend on Tsf</span>
<a name="l03493"></a>03493          flwoutn(i,j) = flwoutn(i,j) + dTsf_prev(ij) * dflwout_dT(ij)
<a name="l03494"></a>03494          fsensn(i,j)  = fsensn(i,j)  + dTsf_prev(ij) * dfsens_dT(ij)
<a name="l03495"></a>03495          flatn(i,j)   = flatn(i,j)   + dTsf_prev(ij) * dflat_dT(ij)
<a name="l03496"></a>03496 
<a name="l03497"></a>03497          <span class="comment">! absorbed shortwave flux for coupler</span>
<a name="l03498"></a>03498          fswabsn(i,j) = fswsfc(i,j) + fswthrun(i,j)
<a name="l03499"></a>03499 
<a name="l03500"></a>03500       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l03501"></a>03501 
<a name="l03502"></a>03502 <span class="keyword">      end subroutine zerolayer_temperature</span>
<a name="l03503"></a>03503 
<a name="l03504"></a>03504 <span class="comment">!=======================================================================</span>
<a name="l03505"></a>03505 <span class="comment">!BOP</span>
<a name="l03506"></a>03506 <span class="comment">!</span>
<a name="l03507"></a>03507 <span class="comment">! !ROUTINE: thickness changes - top and bottom growth/melting</span>
<a name="l03508"></a>03508 <span class="comment">!</span>
<a name="l03509"></a>03509 <span class="comment">! !DESCRIPTION:</span>
<a name="l03510"></a>03510 <span class="comment">!</span>
<a name="l03511"></a>03511 <span class="comment">! Compute growth and/or melting at the top and bottom surfaces.</span>
<a name="l03512"></a>03512 <span class="comment">! Convert snow to ice if necessary.</span>
<a name="l03513"></a>03513 <span class="comment">!</span>
<a name="l03514"></a>03514 <span class="comment">! !REVISION HISTORY:</span>
<a name="l03515"></a>03515 <span class="comment">!</span>
<a name="l03516"></a>03516 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l03517"></a>03517 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l03518"></a>03518 <span class="comment">!</span>
<a name="l03519"></a>03519 <span class="comment">! !INTERFACE:</span>
<a name="l03520"></a>03520 <span class="comment">!</span>
<a name="l03521"></a><a class="code" href="namespaceice__therm__vertical.html#ad24b5fda2cb4af3cda6722209668aa77">03521</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#ad24b5fda2cb4af3cda6722209668aa77">thickness_changes</a> (nx_block,  ny_block, &amp;
<a name="l03522"></a>03522                                     dt,                  &amp;
<a name="l03523"></a>03523                                     yday,      icells,   &amp;
<a name="l03524"></a>03524                                     indxi,     indxj,    &amp;
<a name="l03525"></a>03525                                     efinal,              &amp; 
<a name="l03526"></a>03526                                     hin,       hilyr,    &amp;
<a name="l03527"></a>03527                                     hsn,       hslyr,    &amp;
<a name="l03528"></a>03528                                     qin,       qsn,      &amp;
<a name="l03529"></a>03529                                     fbot,      Tbot,     &amp;
<a name="l03530"></a>03530                                     flatn,     fsurfn,   &amp;
<a name="l03531"></a>03531                                     fcondtopn, fcondbot, &amp;
<a name="l03532"></a>03532                                     fsnow,     hsn_new,  &amp;
<a name="l03533"></a>03533                                     fhocnn,    evapn,    &amp;
<a name="l03534"></a>03534                                     meltt,     melts,    &amp;
<a name="l03535"></a>03535                                     meltb,     iage,     &amp;
<a name="l03536"></a>03536                                     congel,    snoice,   &amp;  
<a name="l03537"></a>03537                                     mlt_onset, frz_onset)
<a name="l03538"></a>03538 <span class="comment">!</span>
<a name="l03539"></a>03539 <span class="comment">! !USES:</span>
<a name="l03540"></a>03540 <span class="comment">!</span>
<a name="l03541"></a>03541 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l03542"></a>03542 <span class="comment">!</span>
<a name="l03543"></a>03543       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03544"></a>03544          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l03545"></a>03545          icells          <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l03546"></a>03546 
<a name="l03547"></a>03547       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l03548"></a>03548          <span class="keywordtype">intent(in)</span> :: 
<a name="l03549"></a>03549          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l03550"></a>03550 
<a name="l03551"></a>03551       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03552"></a>03552          dt          ,  <span class="comment">! time step</span>
<a name="l03553"></a>03553          yday            <span class="comment">! day of the year</span>
<a name="l03554"></a>03554 
<a name="l03555"></a>03555       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03556"></a>03556          fbot        ,  <span class="comment">! ice-ocean heat flux at bottom surface (W/m^2)</span>
<a name="l03557"></a>03557          Tbot        ,  <span class="comment">! ice bottom surface temperature (deg C)</span>
<a name="l03558"></a>03558          fsnow       ,  <span class="comment">! snowfall rate (kg m-2 s-1)</span>
<a name="l03559"></a>03559          flatn       ,  <span class="comment">! surface downward latent heat (W m-2)</span>
<a name="l03560"></a>03560          fsurfn      ,  <span class="comment">! net flux to top surface, excluding fcondtopn</span>
<a name="l03561"></a>03561          fcondtopn       <span class="comment">! downward cond flux at top surface (W m-2)</span>
<a name="l03562"></a>03562 
<a name="l03563"></a>03563       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l03564"></a>03564          fcondbot        <span class="comment">! downward cond flux at bottom surface (W m-2)</span>
<a name="l03565"></a>03565 
<a name="l03566"></a>03566       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l03567"></a>03567          <span class="keywordtype">intent(inout)</span> :: 
<a name="l03568"></a>03568          qin             <span class="comment">! ice layer enthalpy (J m-3)</span>
<a name="l03569"></a>03569 
<a name="l03570"></a>03570       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l03571"></a>03571          <span class="keywordtype">intent(inout)</span> :: 
<a name="l03572"></a>03572          qsn             <span class="comment">! snow layer enthalpy (J m-3)</span>
<a name="l03573"></a>03573 
<a name="l03574"></a>03574       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l03575"></a>03575          <span class="keywordtype">intent(inout)</span> :: 
<a name="l03576"></a>03576          hilyr       ,  <span class="comment">! ice layer thickness (m)</span>
<a name="l03577"></a>03577          hslyr           <span class="comment">! snow layer thickness (m)</span>
<a name="l03578"></a>03578 
<a name="l03579"></a>03579       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l03580"></a>03580          <span class="keywordtype">intent(inout)</span> :: 
<a name="l03581"></a>03581          meltt       ,  <span class="comment">! top ice melt             (m/step--&gt;cm/day)</span>
<a name="l03582"></a>03582          melts       ,  <span class="comment">! snow melt                (m/step--&gt;cm/day)</span>
<a name="l03583"></a>03583          meltb       ,  <span class="comment">! basal ice melt           (m/step--&gt;cm/day)</span>
<a name="l03584"></a>03584          congel      ,  <span class="comment">! basal ice growth         (m/step--&gt;cm/day)</span>
<a name="l03585"></a>03585          snoice      ,  <span class="comment">! snow-ice formation       (m/step--&gt;cm/day)</span>
<a name="l03586"></a>03586          iage        ,  <span class="comment">! ice age (s)</span>
<a name="l03587"></a>03587          mlt_onset   ,  <span class="comment">! day of year that sfc melting begins</span>
<a name="l03588"></a>03588          frz_onset       <span class="comment">! day of year that freezing begins (congel or frazil)</span>
<a name="l03589"></a>03589 
<a name="l03590"></a>03590       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l03591"></a>03591          <span class="keywordtype">intent(inout)</span> :: 
<a name="l03592"></a>03592          hin         ,  <span class="comment">! total ice thickness (m)</span>
<a name="l03593"></a>03593          hsn             <span class="comment">! total snow thickness (m)</span>
<a name="l03594"></a>03594 
<a name="l03595"></a>03595       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l03596"></a>03596          efinal          <span class="comment">! final energy of melting (J m-2)</span>
<a name="l03597"></a>03597 
<a name="l03598"></a>03598       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l03599"></a>03599          fhocnn      ,  <span class="comment">! fbot, corrected for any surplus energy (W m-2)</span>
<a name="l03600"></a>03600          evapn           <span class="comment">! ice/snow mass sublimated/condensed (kg m-2 s-1)</span>
<a name="l03601"></a>03601 
<a name="l03602"></a>03602       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(out)</span>:: 
<a name="l03603"></a>03603          hsn_new         <span class="comment">! thickness of new snow (m)</span>
<a name="l03604"></a>03604 <span class="comment">!</span>
<a name="l03605"></a>03605 <span class="comment">!EOP</span>
<a name="l03606"></a>03606 <span class="comment">!</span>
<a name="l03607"></a>03607       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l03608"></a>03608          qbotmax = -p5*rhoi*Lfresh  <span class="comment">! max enthalpy of ice growing at bottom</span>
<a name="l03609"></a>03609 
<a name="l03610"></a>03610       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l03611"></a>03611          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l03612"></a>03612          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l03613"></a>03613          k               <span class="comment">! vertical index</span>
<a name="l03614"></a>03614 
<a name="l03615"></a>03615       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l03616"></a>03616          esub        ,  <span class="comment">! energy for sublimation, &gt; 0    (J m-2)</span>
<a name="l03617"></a>03617          econ        ,  <span class="comment">! energy for condensation, &lt; 0   (J m-2)</span>
<a name="l03618"></a>03618          etop_mlt    ,  <span class="comment">! energy for top melting, &gt; 0    (J m-2)</span>
<a name="l03619"></a>03619          ebot_mlt    ,  <span class="comment">! energy for bottom melting, &gt; 0 (J m-2)</span>
<a name="l03620"></a>03620          ebot_gro        <span class="comment">! energy for bottom growth, &lt; 0  (J m-2)</span>
<a name="l03621"></a>03621 
<a name="l03622"></a>03622       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l03623"></a>03623          dhi         ,  <span class="comment">! change in ice thickness</span>
<a name="l03624"></a>03624          dhs         ,  <span class="comment">! change in snow thickness</span>
<a name="l03625"></a>03625          Ti          ,  <span class="comment">! ice temperature</span>
<a name="l03626"></a>03626          Ts          ,  <span class="comment">! snow temperature</span>
<a name="l03627"></a>03627          qbot        ,  <span class="comment">! enthalpy of ice growing at bottom surface (J m-3)</span>
<a name="l03628"></a>03628          qsub        ,  <span class="comment">! energy/unit volume to sublimate ice/snow (J m-3)</span>
<a name="l03629"></a>03629          hqtot       ,  <span class="comment">! sum of h*q for two layers</span>
<a name="l03630"></a>03630          wk1         ,  <span class="comment">! temporary variable</span>
<a name="l03631"></a>03631          qsnew       ,  <span class="comment">! enthalpy of new snow (J m-3)</span>
<a name="l03632"></a>03632          hstot           <span class="comment">! snow thickness including new snow (m)</span>
<a name="l03633"></a>03633 
<a name="l03634"></a>03634       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr+1) </span>:: 
<a name="l03635"></a>03635          zi1         ,  <span class="comment">! depth of ice layer boundaries (m)</span>
<a name="l03636"></a>03636          zi2             <span class="comment">! adjusted depths, with equal hilyr (m)</span>
<a name="l03637"></a>03637 
<a name="l03638"></a>03638       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr+1) </span>:: 
<a name="l03639"></a>03639          zs1         ,  <span class="comment">! depth of snow layer boundaries (m)</span>
<a name="l03640"></a>03640          zs2             <span class="comment">! adjusted depths, with equal hslyr (m)</span>
<a name="l03641"></a>03641 
<a name="l03642"></a>03642       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr) </span>:: 
<a name="l03643"></a>03643          dzi             <span class="comment">! ice layer thickness after growth/melting</span>
<a name="l03644"></a>03644 
<a name="l03645"></a>03645       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr) </span>:: 
<a name="l03646"></a>03646          dzs             <span class="comment">! snow layer thickness after growth/melting</span>
<a name="l03647"></a>03647 
<a name="l03648"></a>03648       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03649"></a>03649       <span class="comment">! Initialize</span>
<a name="l03650"></a>03650       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03651"></a>03651 
<a name="l03652"></a>03652       hsn_new (:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03653"></a>03653 
<a name="l03654"></a>03654       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l03655"></a>03655          <span class="keyword">do</span> ij = 1, icells
<a name="l03656"></a>03656             dzi(ij,k) = hilyr(ij)
<a name="l03657"></a>03657          <span class="keyword">enddo</span>
<a name="l03658"></a>03658       <span class="keyword">enddo</span>
<a name="l03659"></a>03659 
<a name="l03660"></a>03660       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l03661"></a>03661          <span class="keyword">do</span> ij = 1, icells
<a name="l03662"></a>03662             dzs(ij,k) = hslyr(ij)
<a name="l03663"></a>03663          <span class="keyword">enddo</span>
<a name="l03664"></a>03664       <span class="keyword">enddo</span>
<a name="l03665"></a>03665 
<a name="l03666"></a>03666       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03667"></a>03667       <span class="comment">! For l_brine = false (fresh ice), check for temperatures &gt; 0.</span>
<a name="l03668"></a>03668       <span class="comment">!  Melt ice or snow as needed to bring temperatures back to 0.</span>
<a name="l03669"></a>03669       <span class="comment">! For l_brine = true, this should not be necessary.</span>
<a name="l03670"></a>03670       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03671"></a>03671 
<a name="l03672"></a>03672       <span class="keyword">if</span> (.not. <a class="code" href="namespaceice__therm__vertical.html#aeb4df87d7011ce33c626c76f6a0dc063">l_brine</a>) <span class="keyword">then</span> 
<a name="l03673"></a>03673 
<a name="l03674"></a>03674          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l03675"></a>03675 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03676"></a>03676 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03677"></a>03677 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03678"></a>03678             <span class="keyword">do</span> ij = 1, icells
<a name="l03679"></a>03679 
<a name="l03680"></a>03680                Ts = (Lfresh + qsn(ij,k)/<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>) / cp_ice
<a name="l03681"></a>03681                <span class="keyword">if</span> (Ts &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l03682"></a>03682                   dhs = cp_ice*Ts*dzs(ij,k) / Lfresh
<a name="l03683"></a>03683                   dzs(ij,k) = dzs(ij,k) - dhs
<a name="l03684"></a>03684                   qsn(ij,k) = -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*Lfresh
<a name="l03685"></a>03685                <span class="keyword">endif</span>
<a name="l03686"></a>03686             <span class="keyword">enddo</span>
<a name="l03687"></a>03687          <span class="keyword">enddo</span>
<a name="l03688"></a>03688 
<a name="l03689"></a>03689          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l03690"></a>03690 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03691"></a>03691 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03692"></a>03692 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03693"></a>03693             <span class="keyword">do</span> ij = 1, icells
<a name="l03694"></a>03694 
<a name="l03695"></a>03695                Ti = (Lfresh + qin(ij,k)/rhoi) / cp_ice
<a name="l03696"></a>03696                <span class="keyword">if</span> (Ti &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l03697"></a>03697                   dhi = cp_ice*Ti*dzi(ij,k) / Lfresh
<a name="l03698"></a>03698                   dzi(ij,k) = dzi(ij,k) - dhi
<a name="l03699"></a>03699                   qin(ij,k) = -rhoi*Lfresh
<a name="l03700"></a>03700                <span class="keyword">endif</span>
<a name="l03701"></a>03701             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l03702"></a>03702          <span class="keyword">enddo</span>                  <span class="comment">! k</span>
<a name="l03703"></a>03703 
<a name="l03704"></a>03704       <span class="keyword">endif</span>                     <span class="comment">! .not. l_brine</span>
<a name="l03705"></a>03705 
<a name="l03706"></a>03706       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03707"></a>03707       <span class="comment">! Compute energy available for sublimation/condensation, top melt,</span>
<a name="l03708"></a>03708       <span class="comment">! and bottom growth/melt.</span>
<a name="l03709"></a>03709       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03710"></a>03710 
<a name="l03711"></a>03711       <span class="keyword">do</span> ij = 1, icells
<a name="l03712"></a>03712          i = indxi(ij)
<a name="l03713"></a>03713          j = indxj(ij)
<a name="l03714"></a>03714 
<a name="l03715"></a>03715          wk1 = -flatn(i,j) * dt
<a name="l03716"></a>03716          esub(ij) = max(wk1, <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)     <span class="comment">! energy for sublimation, &gt; 0</span>
<a name="l03717"></a>03717          econ(ij) = min(wk1, <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)     <span class="comment">! energy for condensation, &lt; 0</span>
<a name="l03718"></a>03718 
<a name="l03719"></a>03719          wk1 = (fsurfn(i,j) - fcondtopn(i,j)) * dt
<a name="l03720"></a>03720          etop_mlt(ij) = max(wk1, <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)           <span class="comment">! etop_mlt &gt; 0</span>
<a name="l03721"></a>03721 
<a name="l03722"></a>03722          wk1 = (fcondbot(ij) - fbot(i,j)) * dt
<a name="l03723"></a>03723          ebot_mlt(ij) = max(wk1, <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)           <span class="comment">! ebot_mlt &gt; 0</span>
<a name="l03724"></a>03724          ebot_gro(ij) = min(wk1, <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)           <span class="comment">! ebot_gro &lt; 0</span>
<a name="l03725"></a>03725 
<a name="l03726"></a>03726          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03727"></a>03727          <span class="comment">! Condensation (evapn &gt; 0)</span>
<a name="l03728"></a>03728          <span class="comment">! Note: evapn here has unit of kg/m^2.  Divide by dt later.</span>
<a name="l03729"></a>03729          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03730"></a>03730 
<a name="l03731"></a>03731          evapn   (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>          <span class="comment">! initialize</span>
<a name="l03732"></a>03732 
<a name="l03733"></a>03733          <span class="keyword">if</span> (hsn(ij) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>    <span class="comment">! add snow with enthalpy qsn(ij,1)</span>
<a name="l03734"></a>03734             dhs = econ(ij) / (qsn(ij,1) - <a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*Lvap) <span class="comment">! econ &lt; 0, dhs &gt; 0</span>
<a name="l03735"></a>03735             dzs(ij,1) = dzs(ij,1) + dhs
<a name="l03736"></a>03736             evapn(i,j) = evapn(i,j) + dhs*<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>
<a name="l03737"></a>03737          <span class="keyword">else</span>                        <span class="comment">! add ice with enthalpy qin(ij,1)</span>
<a name="l03738"></a>03738             dhi = econ(ij) / (qin(ij,1) - rhoi*Lvap) <span class="comment">! econ &lt; 0, dhi &gt; 0</span>
<a name="l03739"></a>03739             dzi(ij,1) = dzi(ij,1) + dhi
<a name="l03740"></a>03740             evapn(i,j) = evapn(i,j) + dhi*rhoi
<a name="l03741"></a>03741          <span class="keyword">endif</span>
<a name="l03742"></a>03742 
<a name="l03743"></a>03743          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03744"></a>03744          <span class="comment">! Grow ice (bottom)</span>
<a name="l03745"></a>03745          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03746"></a>03746 
<a name="l03747"></a>03747          <span class="comment">! enthalpy of new ice growing at bottom surface</span>
<a name="l03748"></a>03748          <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l03749"></a>03749            qbot = -rhoi * (cp_ice * (<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>+1)-Tbot(i,j)) &amp;
<a name="l03750"></a>03750                          + Lfresh * (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>-<a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>+1)/Tbot(i,j)) &amp;
<a name="l03751"></a>03751                          - cp_ocn * <a class="code" href="namespaceice__therm__vertical.html#a25807d5de9fde0e10364d63e32691919">Tmlt</a>(<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>+1))
<a name="l03752"></a>03752            qbot = min (qbot, qbotmax)      <span class="comment">! in case Tbot is close to Tmlt</span>
<a name="l03753"></a>03753          <span class="keyword">else</span>   <span class="comment">! zero layer</span>
<a name="l03754"></a>03754            qbot = -rhoi * Lfresh
<a name="l03755"></a>03755          <span class="keyword">endif</span>
<a name="l03756"></a>03756 
<a name="l03757"></a>03757          dhi  = ebot_gro(ij) / qbot     <span class="comment">! dhi &gt; 0</span>
<a name="l03758"></a>03758 
<a name="l03759"></a>03759          hqtot = dzi(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>)*qin(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) + dhi*qbot
<a name="l03760"></a>03760          dzi(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) = dzi(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) + dhi
<a name="l03761"></a>03761 
<a name="l03762"></a>03762          <span class="keyword">if</span> (dzi(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &amp;
<a name="l03763"></a>03763               qin(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>) = hqtot / dzi(ij,<a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>)
<a name="l03764"></a>03764 
<a name="l03765"></a>03765          <span class="comment">! update ice age due to freezing (new ice age = dt)</span>
<a name="l03766"></a>03766 <span class="comment">!         if (tr_iage) &amp;</span>
<a name="l03767"></a>03767 <span class="comment">!            iage(i,j) = (iage(i,j)*hin(ij) + dt*dhi) / (hin(ij) + dhi)</span>
<a name="l03768"></a>03768 
<a name="l03769"></a>03769          <span class="comment">! history diagnostics</span>
<a name="l03770"></a>03770          congel(i,j) = congel(i,j) + dhi
<a name="l03771"></a>03771          <span class="keyword">if</span> (dhi &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. frz_onset(i,j) &lt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &amp;
<a name="l03772"></a>03772                  frz_onset(i,j) = yday
<a name="l03773"></a>03773 
<a name="l03774"></a>03774       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l03775"></a>03775 
<a name="l03776"></a>03776       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l03777"></a>03777 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03778"></a>03778 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03779"></a>03779 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03780"></a>03780          <span class="keyword">do</span> ij = 1, icells
<a name="l03781"></a>03781             i = indxi(ij)
<a name="l03782"></a>03782             j = indxj(ij)
<a name="l03783"></a>03783 
<a name="l03784"></a>03784          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03785"></a>03785          <span class="comment">! Sublimation of snow (evapn &lt; 0)</span>
<a name="l03786"></a>03786          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03787"></a>03787 
<a name="l03788"></a>03788             qsub = qsn(ij,k) - <a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*Lvap <span class="comment">! qsub &lt; 0</span>
<a name="l03789"></a>03789             dhs  = max (-dzs(ij,k), esub(ij)/qsub)  <span class="comment">! esub &gt; 0, dhs &lt; 0</span>
<a name="l03790"></a>03790             dzs(ij,k) = dzs(ij,k) + dhs
<a name="l03791"></a>03791             esub(ij) = esub(ij) - dhs*qsub
<a name="l03792"></a>03792             esub(ij) = max(esub(ij), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)   <span class="comment">! in case of roundoff error</span>
<a name="l03793"></a>03793             evapn(i,j) = evapn(i,j) + dhs*<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>
<a name="l03794"></a>03794 
<a name="l03795"></a>03795          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03796"></a>03796          <span class="comment">! Melt snow (top)</span>
<a name="l03797"></a>03797          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03798"></a>03798 
<a name="l03799"></a>03799             dhs = max(-dzs(ij,k), etop_mlt(ij)/qsn(ij,k))
<a name="l03800"></a>03800             dzs(ij,k) = dzs(ij,k) + dhs         <span class="comment">! qsn &lt; 0, dhs &lt; 0</span>
<a name="l03801"></a>03801             etop_mlt(ij) = etop_mlt(ij) - dhs*qsn(ij,k)
<a name="l03802"></a>03802             etop_mlt(ij) = max(etop_mlt(ij), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="comment">! in case of roundoff error</span>
<a name="l03803"></a>03803 
<a name="l03804"></a>03804             <span class="comment">! history diagnostics</span>
<a name="l03805"></a>03805             <span class="keyword">if</span> (dhs &lt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. mlt_onset(i,j) &lt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &amp;
<a name="l03806"></a>03806                mlt_onset(i,j) = yday
<a name="l03807"></a>03807             melts(i,j) = melts(i,j) - dhs
<a name="l03808"></a>03808 
<a name="l03809"></a>03809          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03810"></a>03810       <span class="keyword">enddo</span>                     <span class="comment">! nslyr</span>
<a name="l03811"></a>03811 
<a name="l03812"></a>03812       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l03813"></a>03813 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03814"></a>03814 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03815"></a>03815 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03816"></a>03816          <span class="keyword">do</span> ij = 1, icells
<a name="l03817"></a>03817             i = indxi(ij)
<a name="l03818"></a>03818             j = indxj(ij)
<a name="l03819"></a>03819 
<a name="l03820"></a>03820          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03821"></a>03821          <span class="comment">! Sublimation of ice (evapn &lt; 0)</span>
<a name="l03822"></a>03822          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03823"></a>03823 
<a name="l03824"></a>03824             qsub = qin(ij,k) - rhoi*Lvap              <span class="comment">! qsub &lt; 0</span>
<a name="l03825"></a>03825             dhi  = max (-dzi(ij,k), esub(ij)/qsub) <span class="comment">! esub &lt; 0, dhi &lt; 0</span>
<a name="l03826"></a>03826             dzi(ij,k) = dzi(ij,k) + dhi
<a name="l03827"></a>03827             esub(ij) = esub(ij) - dhi*qsub
<a name="l03828"></a>03828             esub(ij) = max(esub(ij), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l03829"></a>03829             evapn(i,j) = evapn(i,j) + dhi*rhoi
<a name="l03830"></a>03830 
<a name="l03831"></a>03831          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03832"></a>03832          <span class="comment">! Melt ice (top)</span>
<a name="l03833"></a>03833          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03834"></a>03834 
<a name="l03835"></a>03835             dhi = max(-dzi(ij,k), etop_mlt(ij)/qin(ij,k))
<a name="l03836"></a>03836             dzi(ij,k) = dzi(ij,k) + dhi         <span class="comment">! qin &lt; 0, dhi &lt; 0</span>
<a name="l03837"></a>03837             etop_mlt(ij) = etop_mlt(ij) - dhi*qin(ij,k)
<a name="l03838"></a>03838             etop_mlt(ij) = max(etop_mlt(ij), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l03839"></a>03839 
<a name="l03840"></a>03840             <span class="comment">! history diagnostics</span>
<a name="l03841"></a>03841             <span class="keyword">if</span> (dhi &lt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. mlt_onset(i,j) &lt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) &amp;
<a name="l03842"></a>03842                  mlt_onset(i,j) = yday
<a name="l03843"></a>03843             meltt(i,j) = meltt(i,j) - dhi
<a name="l03844"></a>03844 
<a name="l03845"></a>03845          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03846"></a>03846       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l03847"></a>03847 
<a name="l03848"></a>03848       <span class="keyword">do</span> k = <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>, 1, -1
<a name="l03849"></a>03849 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03850"></a>03850 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03851"></a>03851 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03852"></a>03852          <span class="keyword">do</span> ij = 1, icells
<a name="l03853"></a>03853             i = indxi(ij)
<a name="l03854"></a>03854             j = indxj(ij)
<a name="l03855"></a>03855 
<a name="l03856"></a>03856          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03857"></a>03857          <span class="comment">! Melt ice (bottom)</span>
<a name="l03858"></a>03858          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03859"></a>03859 
<a name="l03860"></a>03860             dhi = max(-dzi(ij,k), ebot_mlt(ij)/qin(ij,k))
<a name="l03861"></a>03861             dzi(ij,k) = dzi(ij,k) + dhi         <span class="comment">! qin &lt; 0, dhi &lt; 0</span>
<a name="l03862"></a>03862             ebot_mlt(ij) = ebot_mlt(ij) - dhi*qin(ij,k)
<a name="l03863"></a>03863             ebot_mlt(ij) = max(ebot_mlt(ij), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l03864"></a>03864 
<a name="l03865"></a>03865             <span class="comment">! history diagnostics</span>
<a name="l03866"></a>03866             meltb(i,j) = meltb(i,j) - dhi
<a name="l03867"></a>03867 
<a name="l03868"></a>03868          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03869"></a>03869       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l03870"></a>03870 
<a name="l03871"></a>03871       <span class="keyword">do</span> k = <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>, 1, -1
<a name="l03872"></a>03872 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03873"></a>03873 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03874"></a>03874 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03875"></a>03875          <span class="keyword">do</span> ij = 1, icells
<a name="l03876"></a>03876 
<a name="l03877"></a>03877          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03878"></a>03878          <span class="comment">! Melt snow (only if all the ice has melted)</span>
<a name="l03879"></a>03879          <span class="comment">!--------------------------------------------------------------</span>
<a name="l03880"></a>03880 
<a name="l03881"></a>03881             dhs = max(-dzs(ij,k), ebot_mlt(ij)/qsn(ij,k))
<a name="l03882"></a>03882             dzs(ij,k) = dzs(ij,k) + dhs         <span class="comment">! qsn &lt; 0, dhs &lt; 0</span>
<a name="l03883"></a>03883             ebot_mlt(ij) = ebot_mlt(ij) - dhs*qsn(ij,k)
<a name="l03884"></a>03884             ebot_mlt(ij) = max(ebot_mlt(ij), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l03885"></a>03885 
<a name="l03886"></a>03886          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03887"></a>03887       <span class="keyword">enddo</span>                     <span class="comment">! nslyr</span>
<a name="l03888"></a>03888 
<a name="l03889"></a>03889 
<a name="l03890"></a>03890       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03891"></a>03891       <span class="comment">! Compute heat flux used by the ice (&lt;=0).</span>
<a name="l03892"></a>03892       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03893"></a>03893 
<a name="l03894"></a>03894       <span class="keyword">do</span> ij = 1, icells
<a name="l03895"></a>03895          i = indxi(ij)
<a name="l03896"></a>03896          j = indxj(ij)
<a name="l03897"></a>03897          fhocnn(i,j) = fbot(i,j) &amp;
<a name="l03898"></a>03898                      + (esub(ij) + etop_mlt(ij) + ebot_mlt(ij))/dt
<a name="l03899"></a>03899       <span class="keyword">enddo</span>
<a name="l03900"></a>03900 
<a name="l03901"></a>03901 <span class="comment">!---!-----------------------------------------------------------------</span>
<a name="l03902"></a>03902 <span class="comment">!---! Add new snowfall at top surface.</span>
<a name="l03903"></a>03903 <span class="comment">!---!-----------------------------------------------------------------</span>
<a name="l03904"></a>03904 
<a name="l03905"></a>03905 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03906"></a>03906 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03907"></a>03907 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03908"></a>03908       <span class="keyword">do</span> ij = 1, icells
<a name="l03909"></a>03909          i = indxi(ij)
<a name="l03910"></a>03910          j = indxj(ij)
<a name="l03911"></a>03911 
<a name="l03912"></a>03912       <span class="comment">!----------------------------------------------------------------</span>
<a name="l03913"></a>03913       <span class="comment">! NOTE: If heat flux diagnostics are to work, new snow should</span>
<a name="l03914"></a>03914       <span class="comment">!       have T = 0 (i.e. q = -rhos*Lfresh) and should not be</span>
<a name="l03915"></a>03915       <span class="comment">!       converted to rain.</span>
<a name="l03916"></a>03916       <span class="comment">!----------------------------------------------------------------</span>
<a name="l03917"></a>03917 
<a name="l03918"></a>03918          <span class="keyword">if</span> (fsnow(i,j) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l03919"></a>03919 
<a name="l03920"></a>03920             hsn_new(ij) = fsnow(i,j)/<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a> * dt
<a name="l03921"></a>03921             qsnew = -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*Lfresh
<a name="l03922"></a>03922             hstot = dzs(ij,1) + hsn_new(ij)
<a name="l03923"></a>03923 
<a name="l03924"></a>03924             <span class="keyword">if</span> (hstot &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l03925"></a>03925                qsn(ij,1) =  (dzs(ij,1) * qsn(ij,1) &amp;
<a name="l03926"></a>03926                           + hsn_new(ij) * qsnew) / hstot
<a name="l03927"></a>03927                <span class="comment">! avoid roundoff errors</span>
<a name="l03928"></a>03928                qsn(ij,1) = min(qsn(ij,1), -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*Lfresh)
<a name="l03929"></a>03929 
<a name="l03930"></a>03930                dzs(ij,1) = hstot
<a name="l03931"></a>03931             <span class="keyword">endif</span>
<a name="l03932"></a>03932          <span class="keyword">endif</span>
<a name="l03933"></a>03933 
<a name="l03934"></a>03934     <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03935"></a>03935     <span class="comment">! Find the new ice and snow thicknesses.</span>
<a name="l03936"></a>03936     <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03937"></a>03937 
<a name="l03938"></a>03938          hin(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03939"></a>03939          hsn(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03940"></a>03940       <span class="keyword">enddo</span>
<a name="l03941"></a>03941 
<a name="l03942"></a>03942       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l03943"></a>03943 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03944"></a>03944 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03945"></a>03945 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03946"></a>03946          <span class="keyword">do</span> ij = 1, icells
<a name="l03947"></a>03947             hin(ij) = hin(ij) + dzi(ij,k)
<a name="l03948"></a>03948          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03949"></a>03949       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l03950"></a>03950 
<a name="l03951"></a>03951       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l03952"></a>03952 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l03953"></a>03953 <span class="comment">!cdir nodep      !NEC</span>
<a name="l03954"></a>03954 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l03955"></a>03955          <span class="keyword">do</span> ij = 1, icells
<a name="l03956"></a>03956             hsn(ij) = hsn(ij) + dzs(ij,k)
<a name="l03957"></a>03957          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l03958"></a>03958       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l03959"></a>03959 
<a name="l03960"></a>03960     <span class="comment">!-------------------------------------------------------------------</span>
<a name="l03961"></a>03961     <span class="comment">! Convert snow to ice if snow lies below freeboard.</span>
<a name="l03962"></a>03962     <span class="comment">!-------------------------------------------------------------------</span>
<a name="l03963"></a>03963 
<a name="l03964"></a>03964       call <a class="code" href="namespaceice__therm__vertical.html#af560526921bc546f96377e533243089f">freeboard </a>(nx_block, ny_block, &amp;
<a name="l03965"></a>03965                       icells,             &amp;
<a name="l03966"></a>03966                       indxi,    indxj,    &amp;
<a name="l03967"></a>03967                       dt,                 &amp;
<a name="l03968"></a>03968                       snoice,             &amp;
<a name="l03969"></a>03969                       iage,               &amp;
<a name="l03970"></a>03970                       hin,      hsn,      &amp;
<a name="l03971"></a>03971                       qin,      qsn,      &amp;
<a name="l03972"></a>03972                       dzi,      dzs)
<a name="l03973"></a>03973 
<a name="l03974"></a>03974 <span class="comment">!---!-------------------------------------------------------------------</span>
<a name="l03975"></a>03975 <span class="comment">!---! Repartition the ice and snow into equal-thickness layers,</span>
<a name="l03976"></a>03976 <span class="comment">!---! conserving energy.</span>
<a name="l03977"></a>03977 <span class="comment">!---!-------------------------------------------------------------------</span>
<a name="l03978"></a>03978 
<a name="l03979"></a>03979       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03980"></a>03980       <span class="comment">! Compute desired layer thicknesses.</span>
<a name="l03981"></a>03981       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03982"></a>03982 
<a name="l03983"></a>03983       <span class="keyword">do</span> ij = 1, icells
<a name="l03984"></a>03984  
<a name="l03985"></a>03985          <span class="keyword">if</span> (hin(ij) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l03986"></a>03986             hilyr(ij) = hin(ij) / <span class="keywordtype">real</span>(nilyr,kind=dbl_kind)
<a name="l03987"></a>03987          <span class="keyword">else</span>
<a name="l03988"></a>03988             hin(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03989"></a>03989             hilyr(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03990"></a>03990          <span class="keyword">endif</span>
<a name="l03991"></a>03991          <span class="keyword">if</span> (hsn(ij) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l03992"></a>03992             hslyr(ij) = hsn(ij) / <span class="keywordtype">real</span>(nslyr,kind=dbl_kind)
<a name="l03993"></a>03993          <span class="keyword">else</span>
<a name="l03994"></a>03994             hsn(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03995"></a>03995             hslyr(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l03996"></a>03996          <span class="keyword">endif</span>
<a name="l03997"></a>03997 
<a name="l03998"></a>03998       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l03999"></a>03999       <span class="comment">! Compute depths zi1 of old layers (unequal thickness).</span>
<a name="l04000"></a>04000       <span class="comment">! Compute depths zi2 of new layers (equal thickness).</span>
<a name="l04001"></a>04001       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04002"></a>04002 
<a name="l04003"></a>04003          zi1(ij,1) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04004"></a>04004          zi1(ij,1+nilyr) = hin(ij)
<a name="l04005"></a>04005  
<a name="l04006"></a>04006          zi2(ij,1) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04007"></a>04007          zi2(ij,1+nilyr) = hin(ij)
<a name="l04008"></a>04008 
<a name="l04009"></a>04009       <span class="keyword">enddo</span>   <span class="comment">! ij</span>
<a name="l04010"></a>04010 
<a name="l04011"></a>04011       <span class="keyword">if</span> (<a class="code" href="namespaceice__therm__vertical.html#a533694de6308b9a0b8839ba5dacc54af">heat_capacity</a>) <span class="keyword">then</span>
<a name="l04012"></a>04012 
<a name="l04013"></a>04013          <span class="keyword">do</span> k = 1, nilyr-1
<a name="l04014"></a>04014 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04015"></a>04015 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04016"></a>04016 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04017"></a>04017             <span class="keyword">do</span> ij = 1, icells
<a name="l04018"></a>04018                zi1(ij,k+1) = zi1(ij,k) + dzi(ij,k)
<a name="l04019"></a>04019                zi2(ij,k+1) = zi2(ij,k) + hilyr(ij)
<a name="l04020"></a>04020             <span class="keyword">end do</span>
<a name="l04021"></a>04021          <span class="keyword">enddo</span>
<a name="l04022"></a>04022 
<a name="l04023"></a>04023         <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04024"></a>04024         <span class="comment">! Conserving energy, compute the enthalpy of the new equal layers.</span>
<a name="l04025"></a>04025         <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04026"></a>04026 
<a name="l04027"></a>04027         call <a class="code" href="namespaceice__therm__vertical.html#a6845923f0ff5d01b9c66f9a41d0eb24d">adjust_enthalpy </a>(nx_block, ny_block, &amp;
<a name="l04028"></a>04028                               nilyr,    icells,   &amp;
<a name="l04029"></a>04029                               indxi,    indxj,    &amp;
<a name="l04030"></a>04030                               zi1,      zi2,      &amp;
<a name="l04031"></a>04031                               hilyr,    hin,      &amp;
<a name="l04032"></a>04032                               qin)
<a name="l04033"></a>04033 
<a name="l04034"></a>04034       <span class="keyword">else</span> <span class="comment">! zero layer (nilyr=1)</span>
<a name="l04035"></a>04035 
<a name="l04036"></a>04036          <span class="keyword">do</span> ij = 1, icells
<a name="l04037"></a>04037             qin(ij,1) = -rhoi * Lfresh
<a name="l04038"></a>04038             qsn(ij,1) = -<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a> * Lfresh
<a name="l04039"></a>04039          <span class="keyword">end do</span>
<a name="l04040"></a>04040        
<a name="l04041"></a>04041       <span class="keyword">endif</span>
<a name="l04042"></a>04042 
<a name="l04043"></a>04043       <span class="keyword">if</span> (nslyr &gt; 1) <span class="keyword">then</span>
<a name="l04044"></a>04044 
<a name="l04045"></a>04045       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04046"></a>04046       <span class="comment">! Compute depths zs1 of old layers (unequal thickness).</span>
<a name="l04047"></a>04047       <span class="comment">! Compute depths zs2 of new layers (equal thickness).</span>
<a name="l04048"></a>04048       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04049"></a>04049 
<a name="l04050"></a>04050          <span class="keyword">do</span> ij = 1, icells
<a name="l04051"></a>04051             zs1(ij,1) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04052"></a>04052             zs1(ij,1+nslyr) = hsn(ij)
<a name="l04053"></a>04053 
<a name="l04054"></a>04054             zs2(ij,1) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04055"></a>04055             zs2(ij,1+nslyr) = hsn(ij)
<a name="l04056"></a>04056          <span class="keyword">enddo</span>
<a name="l04057"></a>04057 
<a name="l04058"></a>04058          <span class="keyword">do</span> k = 1, nslyr-1
<a name="l04059"></a>04059 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04060"></a>04060 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04061"></a>04061 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04062"></a>04062             <span class="keyword">do</span> ij = 1, icells
<a name="l04063"></a>04063                zs1(ij,k+1) = zs1(ij,k) + dzs(ij,k)
<a name="l04064"></a>04064                zs2(ij,k+1) = zs2(ij,k) + hslyr(ij)
<a name="l04065"></a>04065             <span class="keyword">end do</span>
<a name="l04066"></a>04066          <span class="keyword">enddo</span>
<a name="l04067"></a>04067 
<a name="l04068"></a>04068       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04069"></a>04069       <span class="comment">! Conserving energy, compute the enthalpy of the new equal layers.</span>
<a name="l04070"></a>04070       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04071"></a>04071 
<a name="l04072"></a>04072          call <a class="code" href="namespaceice__therm__vertical.html#a6845923f0ff5d01b9c66f9a41d0eb24d">adjust_enthalpy </a>(nx_block, ny_block, &amp;
<a name="l04073"></a>04073                                nslyr,    icells,   &amp;
<a name="l04074"></a>04074                                indxi,    indxj,    &amp;
<a name="l04075"></a>04075                                zs1,      zs2,      &amp;
<a name="l04076"></a>04076                                hslyr,    hsn,      &amp;
<a name="l04077"></a>04077                                qsn)
<a name="l04078"></a>04078 
<a name="l04079"></a>04079       <span class="keyword">endif</span>   <span class="comment">! nslyr &gt; 1</span>
<a name="l04080"></a>04080 
<a name="l04081"></a>04081       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04082"></a>04082       <span class="comment">! Compute final ice-snow energy, including the energy of</span>
<a name="l04083"></a>04083       <span class="comment">!  sublimated/condensed ice.</span>
<a name="l04084"></a>04084       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04085"></a>04085 
<a name="l04086"></a>04086       <span class="keyword">do</span> ij = 1, icells
<a name="l04087"></a>04087          i = indxi(ij)
<a name="l04088"></a>04088          j = indxj(ij)
<a name="l04089"></a>04089          efinal(ij) = -evapn(i,j)*Lvap
<a name="l04090"></a>04090          evapn(i,j) =  evapn(i,j)/dt
<a name="l04091"></a>04091       <span class="keyword">enddo</span>
<a name="l04092"></a>04092 
<a name="l04093"></a>04093       <span class="keyword">do</span> k = 1, nslyr
<a name="l04094"></a>04094 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04095"></a>04095 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04096"></a>04096 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04097"></a>04097          <span class="keyword">do</span> ij = 1, icells
<a name="l04098"></a>04098             efinal(ij) = efinal(ij) + hslyr(ij)*qsn(ij,k)
<a name="l04099"></a>04099          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l04100"></a>04100       <span class="keyword">enddo</span>
<a name="l04101"></a>04101 
<a name="l04102"></a>04102       <span class="keyword">do</span> k = 1, nilyr
<a name="l04103"></a>04103 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04104"></a>04104 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04105"></a>04105 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04106"></a>04106          <span class="keyword">do</span> ij = 1, icells
<a name="l04107"></a>04107             efinal(ij) = efinal(ij) + hilyr(ij)*qin(ij,k)
<a name="l04108"></a>04108          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l04109"></a>04109       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l04110"></a>04110 
<a name="l04111"></a>04111 <span class="keyword">      end subroutine thickness_changes</span>
<a name="l04112"></a>04112 
<a name="l04113"></a>04113 <span class="comment">!=======================================================================</span>
<a name="l04114"></a>04114 <span class="comment">!BOP</span>
<a name="l04115"></a>04115 <span class="comment">!</span>
<a name="l04116"></a>04116 <span class="comment">! !ROUTINE: freeboard - snow-ice conversion</span>
<a name="l04117"></a>04117 <span class="comment">!</span>
<a name="l04118"></a>04118 <span class="comment">! !DESCRIPTION:</span>
<a name="l04119"></a>04119 <span class="comment">!</span>
<a name="l04120"></a>04120 <span class="comment">! If there is enough snow to lower the ice/snow interface below</span>
<a name="l04121"></a>04121 <span class="comment">! sea level, convert enough snow to ice to bring the interface back</span>
<a name="l04122"></a>04122 <span class="comment">! to sea level.</span>
<a name="l04123"></a>04123 <span class="comment">!</span>
<a name="l04124"></a>04124 <span class="comment">! !REVISION HISTORY:</span>
<a name="l04125"></a>04125 <span class="comment">!</span>
<a name="l04126"></a>04126 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l04127"></a>04127 <span class="comment">!         Elizabeth C. Hunke, LANL</span>
<a name="l04128"></a>04128 <span class="comment">!</span>
<a name="l04129"></a>04129 <span class="comment">! !INTERFACE:</span>
<a name="l04130"></a>04130 <span class="comment">!</span>
<a name="l04131"></a><a class="code" href="namespaceice__therm__vertical.html#af560526921bc546f96377e533243089f">04131</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#af560526921bc546f96377e533243089f">freeboard</a> (nx_block, ny_block, &amp;
<a name="l04132"></a>04132                             icells,             &amp;
<a name="l04133"></a>04133                             indxi,    indxj,    &amp;
<a name="l04134"></a>04134                             dt,                 &amp;
<a name="l04135"></a>04135                             snoice,             &amp;
<a name="l04136"></a>04136                             iage,               &amp;
<a name="l04137"></a>04137                             hin,      hsn,      &amp;
<a name="l04138"></a>04138                             qin,      qsn,      &amp;
<a name="l04139"></a>04139                             dzi,      dzs)
<a name="l04140"></a>04140 <span class="comment">!</span>
<a name="l04141"></a>04141 <span class="comment">! !USES:</span>
<a name="l04142"></a>04142 <span class="comment">!</span>
<a name="l04143"></a>04143 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l04144"></a>04144 <span class="comment">!</span>
<a name="l04145"></a>04145       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04146"></a>04146          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l04147"></a>04147          icells              <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l04148"></a>04148 
<a name="l04149"></a>04149       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l04150"></a>04150          <span class="keywordtype">intent(in)</span> :: 
<a name="l04151"></a>04151          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l04152"></a>04152 
<a name="l04153"></a>04153       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04154"></a>04154          dt      <span class="comment">! time step</span>
<a name="l04155"></a>04155 
<a name="l04156"></a>04156       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l04157"></a>04157          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04158"></a>04158          snoice  ,  <span class="comment">! snow-ice formation       (m/step--&gt;cm/day)</span>
<a name="l04159"></a>04159          iage        <span class="comment">! snow thickness (m)</span>
<a name="l04160"></a>04160 
<a name="l04161"></a>04161       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, 
<a name="l04162"></a>04162          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04163"></a>04163          hin     ,  <span class="comment">! ice thickness (m)</span>
<a name="l04164"></a>04164          hsn         <span class="comment">! snow thickness (m)</span>
<a name="l04165"></a>04165 
<a name="l04166"></a>04166       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l04167"></a>04167          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04168"></a>04168          qin         <span class="comment">! ice layer enthalpy (J m-3)</span>
<a name="l04169"></a>04169 
<a name="l04170"></a>04170       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l04171"></a>04171          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04172"></a>04172          dzi         <span class="comment">! ice layer thicknesses (m)</span>
<a name="l04173"></a>04173 
<a name="l04174"></a>04174       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l04175"></a>04175          <span class="keywordtype">intent(in)</span> :: 
<a name="l04176"></a>04176          qsn         <span class="comment">! snow layer enthalpy (J m-3)</span>
<a name="l04177"></a>04177 
<a name="l04178"></a>04178       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l04179"></a>04179          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04180"></a>04180          dzs         <span class="comment">! snow layer thicknesses (m)</span>
<a name="l04181"></a>04181 <span class="comment">!</span>
<a name="l04182"></a>04182 <span class="comment">!EOP</span>
<a name="l04183"></a>04183 <span class="comment">!</span>
<a name="l04184"></a>04184       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l04185"></a>04185          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l04186"></a>04186          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l04187"></a>04187          k               <span class="comment">! vertical index</span>
<a name="l04188"></a>04188 
<a name="l04189"></a>04189       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l04190"></a>04190          dhin        ,  <span class="comment">! change in ice thickness (m)</span>
<a name="l04191"></a>04191          dhsn        ,  <span class="comment">! change in snow thickness (m)</span>
<a name="l04192"></a>04192          hqs             <span class="comment">! sum of h*q for snow (J m-2)</span>
<a name="l04193"></a>04193 
<a name="l04194"></a>04194       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l04195"></a>04195          wk1         ,  <span class="comment">! temporary variable</span>
<a name="l04196"></a>04196          dhs             <span class="comment">! snow to remove from layer (m)</span>
<a name="l04197"></a>04197 
<a name="l04198"></a>04198       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04199"></a>04199       <span class="comment">! Determine whether snow lies below freeboard.</span>
<a name="l04200"></a>04200       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04201"></a>04201 
<a name="l04202"></a>04202       <span class="keyword">do</span> ij = 1, icells
<a name="l04203"></a>04203 
<a name="l04204"></a>04204          dhin(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04205"></a>04205          dhsn(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04206"></a>04206          hqs (ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04207"></a>04207 
<a name="l04208"></a>04208          wk1 = hsn(ij) - hin(ij)*(<a class="code" href="namespaceice__constants.html#a64fecf2ffd940ef72dbaa94c096930de">rhow</a>-<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>)/<a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>
<a name="l04209"></a>04209 
<a name="l04210"></a>04210          <span class="keyword">if</span> (wk1 &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. hsn(ij) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>  <span class="comment">! snow below freeboard</span>
<a name="l04211"></a>04211             dhsn(ij) = min(wk1*<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>/<a class="code" href="namespaceice__constants.html#a64fecf2ffd940ef72dbaa94c096930de">rhow</a>, hsn(ij)) <span class="comment">! snow to remove</span>
<a name="l04212"></a>04212             dhin(ij) = dhsn(ij) * <a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>/<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>        <span class="comment">! ice to add</span>
<a name="l04213"></a>04213          <span class="keyword">endif</span>
<a name="l04214"></a>04214       <span class="keyword">enddo</span>
<a name="l04215"></a>04215 
<a name="l04216"></a>04216       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04217"></a>04217       <span class="comment">! Adjust snow layer thickness.</span>
<a name="l04218"></a>04218       <span class="comment">! Compute energy to transfer from snow to ice.</span>
<a name="l04219"></a>04219       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04220"></a>04220 
<a name="l04221"></a>04221       <span class="keyword">do</span> k = <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>, 1, -1
<a name="l04222"></a>04222 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04223"></a>04223 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04224"></a>04224 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04225"></a>04225          <span class="keyword">do</span> ij = 1, icells
<a name="l04226"></a>04226             <span class="keyword">if</span> (dhin(ij) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l04227"></a>04227                dhs = min(dhsn(ij), dzs(ij,k)) <span class="comment">! snow to remove from layer</span>
<a name="l04228"></a>04228                hsn(ij) = hsn(ij) - dhs
<a name="l04229"></a>04229                dzs(ij,k) = dzs(ij,k) - dhs
<a name="l04230"></a>04230                dhsn(ij) = dhsn(ij) - dhs
<a name="l04231"></a>04231                dhsn(ij) = max(dhsn(ij),<a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l04232"></a>04232                hqs(ij) = hqs(ij) + dhs * qsn(ij,k)
<a name="l04233"></a>04233             <span class="keyword">endif</span>               <span class="comment">! dhin &gt; puny</span>
<a name="l04234"></a>04234          <span class="keyword">enddo</span>
<a name="l04235"></a>04235       <span class="keyword">enddo</span>
<a name="l04236"></a>04236 
<a name="l04237"></a>04237       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04238"></a>04238       <span class="comment">! Transfer volume and energy from snow to top ice layer.</span>
<a name="l04239"></a>04239       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04240"></a>04240 
<a name="l04241"></a>04241 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04242"></a>04242 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04243"></a>04243 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04244"></a>04244       <span class="keyword">do</span> ij = 1, icells
<a name="l04245"></a>04245          i = indxi(ij)
<a name="l04246"></a>04246          j = indxj(ij)
<a name="l04247"></a>04247 
<a name="l04248"></a>04248          <span class="keyword">if</span> (dhin(ij) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l04249"></a>04249             <span class="comment">! update ice age due to freezing (new ice age = dt)</span>
<a name="l04250"></a>04250 <span class="comment">!            if (tr_iage) &amp;</span>
<a name="l04251"></a>04251 <span class="comment">!               iage(i,j) = (iage(i,j)*hin(ij)+dt*dhin(ij))/(hin(ij)+dhin(ij))</span>
<a name="l04252"></a>04252 
<a name="l04253"></a>04253             wk1 = dzi(ij,1) + dhin(ij)
<a name="l04254"></a>04254             hin(ij) = hin(ij) + dhin(ij)
<a name="l04255"></a>04255             qin(ij,1) = (dzi(ij,1)*qin(ij,1) + hqs(ij)) / wk1
<a name="l04256"></a>04256             dzi(ij,1) = wk1
<a name="l04257"></a>04257 
<a name="l04258"></a>04258             <span class="comment">! history diagnostic</span>
<a name="l04259"></a>04259             snoice(i,j) = snoice(i,j) + dhin(ij)
<a name="l04260"></a>04260          <span class="keyword">endif</span>               <span class="comment">! dhin &gt; puny</span>
<a name="l04261"></a>04261 
<a name="l04262"></a>04262       <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l04263"></a>04263 
<a name="l04264"></a>04264 <span class="keyword">      end subroutine freeboard</span>
<a name="l04265"></a>04265 
<a name="l04266"></a>04266 <span class="comment">!=======================================================================</span>
<a name="l04267"></a>04267 <span class="comment">!BOP</span>
<a name="l04268"></a>04268 <span class="comment">!</span>
<a name="l04269"></a>04269 <span class="comment">! !ROUTINE: adjust_enthalpy -- enthalpy of new layers</span>
<a name="l04270"></a>04270 <span class="comment">!</span>
<a name="l04271"></a>04271 <span class="comment">! !DESCRIPTION:</span>
<a name="l04272"></a>04272 <span class="comment">!</span>
<a name="l04273"></a>04273 <span class="comment">! Conserving energy, compute the new enthalpy of equal-thickness ice</span>
<a name="l04274"></a>04274 <span class="comment">! or snow layers.</span>
<a name="l04275"></a>04275 <span class="comment">!</span>
<a name="l04276"></a>04276 <span class="comment">! !REVISION HISTORY:</span>
<a name="l04277"></a>04277 <span class="comment">!</span>
<a name="l04278"></a>04278 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l04279"></a>04279 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l04280"></a>04280 <span class="comment">!</span>
<a name="l04281"></a>04281 <span class="comment">! !INTERFACE:</span>
<a name="l04282"></a>04282 <span class="comment">!</span>
<a name="l04283"></a><a class="code" href="namespaceice__therm__vertical.html#a6845923f0ff5d01b9c66f9a41d0eb24d">04283</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a6845923f0ff5d01b9c66f9a41d0eb24d">adjust_enthalpy</a> (nx_block, ny_block, &amp;
<a name="l04284"></a>04284                                   nlyr,     icells,   &amp;
<a name="l04285"></a>04285                                   indxi,    indxj,    &amp;
<a name="l04286"></a>04286                                   z1,       z2,       &amp;
<a name="l04287"></a>04287                                   hlyr,     hn,       &amp;
<a name="l04288"></a>04288                                   qn)
<a name="l04289"></a>04289 <span class="comment">!</span>
<a name="l04290"></a>04290 <span class="comment">! !USES:</span>
<a name="l04291"></a>04291 <span class="comment">!</span>
<a name="l04292"></a>04292 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l04293"></a>04293 <span class="comment">!</span>
<a name="l04294"></a>04294       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04295"></a>04295          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l04296"></a>04296          nlyr              ,  <span class="comment">! number of layers (nilyr or nslyr)</span>
<a name="l04297"></a>04297          icells                <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l04298"></a>04298 
<a name="l04299"></a>04299       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l04300"></a>04300          <span class="keywordtype">intent(in)</span> :: 
<a name="l04301"></a>04301          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l04302"></a>04302 
<a name="l04303"></a>04303       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nlyr+1)</span>, 
<a name="l04304"></a>04304          <span class="keywordtype">intent(in)</span> :: 
<a name="l04305"></a>04305          z1          ,  <span class="comment">! interface depth for old, unequal layers (m)</span>
<a name="l04306"></a>04306          z2              <span class="comment">! interface depth for new, equal layers (m)</span>
<a name="l04307"></a>04307 
<a name="l04308"></a>04308       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04309"></a>04309          hlyr            <span class="comment">! new layer thickness (m)</span>
<a name="l04310"></a>04310 
<a name="l04311"></a>04311       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04312"></a>04312          hn              <span class="comment">! total thickness (m)</span>
<a name="l04313"></a>04313 
<a name="l04314"></a>04314       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nlyr)</span>, 
<a name="l04315"></a>04315          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04316"></a>04316          qn              <span class="comment">! layer enthalpy (J m-3)</span>
<a name="l04317"></a>04317 <span class="comment">!</span>
<a name="l04318"></a>04318 <span class="comment">!EOP</span>
<a name="l04319"></a>04319 <span class="comment">!</span>
<a name="l04320"></a>04320       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l04321"></a>04321          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l04322"></a>04322          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l04323"></a>04323          k, k1, k2       <span class="comment">! vertical indices</span>
<a name="l04324"></a>04324 
<a name="l04325"></a>04325       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l04326"></a>04326          hovlp           <span class="comment">! overlap between old and new layers (m)</span>
<a name="l04327"></a>04327 
<a name="l04328"></a>04328       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l04329"></a>04329          rhlyr           <span class="comment">! 1./hlyr</span>
<a name="l04330"></a>04330 
<a name="l04331"></a>04331       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nlyr) </span>:: 
<a name="l04332"></a>04332          hq              <span class="comment">! h * q for a layer</span>
<a name="l04333"></a>04333 
<a name="l04334"></a>04334       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04335"></a>04335       <span class="comment">! Compute reciprocal layer thickness.</span>
<a name="l04336"></a>04336       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04337"></a>04337 
<a name="l04338"></a>04338       <span class="keyword">do</span> ij = 1, icells
<a name="l04339"></a>04339          rhlyr(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04340"></a>04340          <span class="keyword">if</span> (hn(ij) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) rhlyr(ij) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> / hlyr(ij)
<a name="l04341"></a>04341       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l04342"></a>04342 
<a name="l04343"></a>04343       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04344"></a>04344       <span class="comment">! Compute h*q for new layers (k2) given overlap with old layers (k1)</span>
<a name="l04345"></a>04345       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04346"></a>04346 
<a name="l04347"></a>04347       <span class="keyword">do</span> k2 = 1, nlyr
<a name="l04348"></a>04348 
<a name="l04349"></a>04349          <span class="keyword">do</span> ij = 1, icells
<a name="l04350"></a>04350             hq(ij,k2) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04351"></a>04351          <span class="keyword">enddo</span>
<a name="l04352"></a>04352 
<a name="l04353"></a>04353          <span class="keyword">do</span> k1 = 1, nlyr
<a name="l04354"></a>04354 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04355"></a>04355 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04356"></a>04356 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04357"></a>04357             <span class="keyword">do</span> ij = 1, icells
<a name="l04358"></a>04358                hovlp = min (z1(ij,k1+1), z2(ij,k2+1)) &amp;
<a name="l04359"></a>04359                      - max (z1(ij,k1),   z2(ij,k2))
<a name="l04360"></a>04360                hovlp = max (hovlp, <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l04361"></a>04361 
<a name="l04362"></a>04362                hq(ij,k2) = hq(ij,k2) + hovlp*qn(ij,k1)
<a name="l04363"></a>04363             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l04364"></a>04364          <span class="keyword">enddo</span>                  <span class="comment">! kold</span>
<a name="l04365"></a>04365       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l04366"></a>04366 
<a name="l04367"></a>04367       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04368"></a>04368       <span class="comment">! Compute new enthalpies.</span>
<a name="l04369"></a>04369       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04370"></a>04370 
<a name="l04371"></a>04371       <span class="keyword">do</span> k = 1, nlyr
<a name="l04372"></a>04372          <span class="keyword">do</span> ij = 1, icells
<a name="l04373"></a>04373             i = indxi(ij)
<a name="l04374"></a>04374             j = indxj(ij)
<a name="l04375"></a>04375             qn(ij,k) = hq(ij,k) * rhlyr(ij)
<a name="l04376"></a>04376          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l04377"></a>04377       <span class="keyword">enddo</span>                     <span class="comment">! k</span>
<a name="l04378"></a>04378 
<a name="l04379"></a>04379 <span class="keyword">      end subroutine adjust_enthalpy</span>
<a name="l04380"></a>04380 
<a name="l04381"></a>04381 <span class="comment">!=======================================================================</span>
<a name="l04382"></a>04382 <span class="comment">!BOP</span>
<a name="l04383"></a>04383 <span class="comment">!</span>
<a name="l04384"></a>04384 <span class="comment">! !ROUTINE: conservation_check_vthermo - energy conservation check</span>
<a name="l04385"></a>04385 <span class="comment">!</span>
<a name="l04386"></a>04386 <span class="comment">! !DESCRIPTION:</span>
<a name="l04387"></a>04387 <span class="comment">!</span>
<a name="l04388"></a>04388 <span class="comment">! Check for energy conservation by comparing the change in energy</span>
<a name="l04389"></a>04389 <span class="comment">! to the net energy input.</span>
<a name="l04390"></a>04390 <span class="comment">!</span>
<a name="l04391"></a>04391 <span class="comment">! !REVISION HISTORY:</span>
<a name="l04392"></a>04392 <span class="comment">!</span>
<a name="l04393"></a>04393 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l04394"></a>04394 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l04395"></a>04395 <span class="comment">!</span>
<a name="l04396"></a>04396 <span class="comment">! !INTERFACE:</span>
<a name="l04397"></a>04397 <span class="comment">!</span>
<a name="l04398"></a><a class="code" href="namespaceice__therm__vertical.html#a4f2f790706910417fe9bbaaa1ad6efa3">04398</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a4f2f790706910417fe9bbaaa1ad6efa3">conservation_check_vthermo</a>(nx_block, ny_block, &amp;
<a name="l04399"></a>04399                                             my_task,  istep1,   &amp;
<a name="l04400"></a>04400                                             dt,       icells,   &amp;
<a name="l04401"></a>04401                                             indxi,    indxj,    &amp;
<a name="l04402"></a>04402                                             fsurfn,   flatn,    &amp;
<a name="l04403"></a>04403                                             fhocnn,   fswint,   &amp;
<a name="l04404"></a>04404                                             fsnow,              &amp;
<a name="l04405"></a>04405                                             einit,    efinal,   &amp;
<a name="l04406"></a>04406                                             l_stop,             &amp;
<a name="l04407"></a>04407                                             istop,    jstop)
<a name="l04408"></a>04408 <span class="comment">!</span>
<a name="l04409"></a>04409 <span class="comment">! !USES:</span>
<a name="l04410"></a>04410 <span class="comment">!</span>
<a name="l04411"></a>04411 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l04412"></a>04412 <span class="comment">!</span>
<a name="l04413"></a>04413       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04414"></a>04414          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l04415"></a>04415          my_task         ,  <span class="comment">! task number (diagnostic only)</span>
<a name="l04416"></a>04416          istep1          ,  <span class="comment">! time step index (diagnostic only)</span>
<a name="l04417"></a>04417          icells              <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l04418"></a>04418 
<a name="l04419"></a>04419       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l04420"></a>04420          <span class="keywordtype">intent(in)</span> :: 
<a name="l04421"></a>04421          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l04422"></a>04422 
<a name="l04423"></a>04423       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04424"></a>04424          dt              <span class="comment">! time step</span>
<a name="l04425"></a>04425 
<a name="l04426"></a>04426       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04427"></a>04427          fsurfn      ,  <span class="comment">! net flux to top surface, excluding fcondtopn</span>
<a name="l04428"></a>04428          flatn       ,  <span class="comment">! surface downward latent heat (W m-2)</span>
<a name="l04429"></a>04429          fhocnn      ,  <span class="comment">! fbot, corrected for any surplus energy</span>
<a name="l04430"></a>04430          fswint      ,  <span class="comment">! SW absorbed in ice interior, below surface (W m-2)</span>
<a name="l04431"></a>04431          fsnow           <span class="comment">! snowfall rate (kg m-2 s-1)</span>
<a name="l04432"></a>04432 
<a name="l04433"></a>04433 
<a name="l04434"></a>04434       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04435"></a>04435          einit       ,  <span class="comment">! initial energy of melting (J m-2)</span>
<a name="l04436"></a>04436          efinal          <span class="comment">! final energy of melting (J m-2)</span>
<a name="l04437"></a>04437 
<a name="l04438"></a>04438       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l04439"></a>04439          l_stop          <span class="comment">! if true, print diagnostics and abort model</span>
<a name="l04440"></a>04440 
<a name="l04441"></a>04441       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l04442"></a>04442          istop, jstop    <span class="comment">! i and j indices of cell where model fails</span>
<a name="l04443"></a>04443 <span class="comment">!</span>
<a name="l04444"></a>04444 <span class="comment">!EOP</span>
<a name="l04445"></a>04445 <span class="comment">!</span>
<a name="l04446"></a>04446       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l04447"></a>04447          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l04448"></a>04448          ij              <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l04449"></a>04449 
<a name="l04450"></a>04450       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l04451"></a>04451          einp        ,  <span class="comment">! energy input during timestep (J m-2)</span>
<a name="l04452"></a>04452          ferr            <span class="comment">! energy conservation error (W m-2)</span>
<a name="l04453"></a>04453 
<a name="l04454"></a>04454       <span class="comment">!----------------------------------------------------------------</span>
<a name="l04455"></a>04455       <span class="comment">! If energy is not conserved, print diagnostics and exit.</span>
<a name="l04456"></a>04456       <span class="comment">!----------------------------------------------------------------</span>
<a name="l04457"></a>04457 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04458"></a>04458 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04459"></a>04459 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04460"></a>04460       <span class="keyword">do</span> ij = 1, icells
<a name="l04461"></a>04461          i = indxi(ij)
<a name="l04462"></a>04462          j = indxj(ij)
<a name="l04463"></a>04463 
<a name="l04464"></a>04464          einp = (fsurfn(i,j) - flatn(i,j) + fswint(i,j) - fhocnn(i,j) &amp;
<a name="l04465"></a>04465                - fsnow(i,j)*Lfresh) * dt
<a name="l04466"></a>04466          ferr = abs(efinal(ij)-einit(ij)-einp) / dt
<a name="l04467"></a>04467          <span class="keyword">if</span> (ferr &gt; <a class="code" href="namespaceice__therm__vertical.html#a0721a294c629506af790049e6d607d53">ferrmax</a>) <span class="keyword">then</span>
<a name="l04468"></a>04468             l_stop = .true.
<a name="l04469"></a>04469             istop = i
<a name="l04470"></a>04470             jstop = j
<a name="l04471"></a>04471 
<a name="l04472"></a>04472       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04473"></a>04473       <span class="comment">! Note that fsurf - flat = fsw + flw + fsens; i.e., the latent</span>
<a name="l04474"></a>04474       <span class="comment">! heat is not included in the energy input, since (efinal - einit)</span>
<a name="l04475"></a>04475       <span class="comment">! is the energy change in the system ice + vapor, and the latent</span>
<a name="l04476"></a>04476       <span class="comment">! heat lost by the ice is equal to that gained by the vapor.</span>
<a name="l04477"></a>04477       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l04478"></a>04478 
<a name="l04479"></a>04479 <span class="comment">!         einp = (fsurfn(i,j) - flatn(i,j) + fswint(i,j) - fhocnn(i,j) &amp;</span>
<a name="l04480"></a>04480 <span class="comment">!                -fsnow(i,j)*Lfresh) * dt</span>
<a name="l04481"></a>04481 <span class="comment">!         ferr = abs(efinal(ij)-einit(ij)-einp) / dt</span>
<a name="l04482"></a>04482 
<a name="l04483"></a>04483          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Thermo energy conservation error&apos;</span>
<a name="l04484"></a>04484          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;istep1, my_task, i, j:&apos;</span>, &amp;
<a name="l04485"></a>04485                            istep1, my_task, i, j
<a name="l04486"></a>04486          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Flux error (W/m^2) =&apos;</span>, ferr
<a name="l04487"></a>04487          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Energy error (J) =&apos;</span>, ferr*dt
<a name="l04488"></a>04488          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Initial energy =&apos;</span>, einit(ij)
<a name="l04489"></a>04489          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Final energy =&apos;</span>, efinal(ij)
<a name="l04490"></a>04490          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;efinal - einit =&apos;</span>, &amp;
<a name="l04491"></a>04491                            efinal(ij)-einit(ij)
<a name="l04492"></a>04492          <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Input energy =&apos;</span>, einp
<a name="l04493"></a>04493          return
<a name="l04494"></a>04494          <span class="keyword">endif</span>
<a name="l04495"></a>04495       <span class="keyword">enddo</span>
<a name="l04496"></a>04496 
<a name="l04497"></a>04497 <span class="keyword">      end subroutine conservation_check_vthermo</span>
<a name="l04498"></a>04498 
<a name="l04499"></a>04499 <span class="comment">!=======================================================================</span>
<a name="l04500"></a>04500 <span class="comment">!BOP</span>
<a name="l04501"></a>04501 <span class="comment">!</span>
<a name="l04502"></a>04502 <span class="comment">! !ROUTINE: update_state_vthermo - new state variables</span>
<a name="l04503"></a>04503 <span class="comment">!</span>
<a name="l04504"></a>04504 <span class="comment">! !DESCRIPTION:</span>
<a name="l04505"></a>04505 <span class="comment">!</span>
<a name="l04506"></a>04506 <span class="comment">! Given the vertical thermo state variables (hin, hsn, qin,</span>
<a name="l04507"></a>04507 <span class="comment">!  qsn, Tsf), compute the new ice state variables (vicen, vsnon,</span>
<a name="l04508"></a>04508 <span class="comment">!  eicen, esnon, Tsfcn).</span>
<a name="l04509"></a>04509 <span class="comment">! Zero out state variables if ice has melted entirely.</span>
<a name="l04510"></a>04510 <span class="comment">!</span>
<a name="l04511"></a>04511 <span class="comment">! !REVISION HISTORY:</span>
<a name="l04512"></a>04512 <span class="comment">!</span>
<a name="l04513"></a>04513 <span class="comment">! authors William H. Lipscomb, LANL</span>
<a name="l04514"></a>04514 <span class="comment">!         C. M. Bitz, UW</span>
<a name="l04515"></a>04515 <span class="comment">!</span>
<a name="l04516"></a>04516 <span class="comment">! !INTERFACE:</span>
<a name="l04517"></a>04517 <span class="comment">!</span>
<a name="l04518"></a><a class="code" href="namespaceice__therm__vertical.html#a64f63f03c5a0e61472486ace19c6b9d5">04518</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__therm__vertical.html#a64f63f03c5a0e61472486ace19c6b9d5">update_state_vthermo</a> (nx_block, ny_block, &amp;
<a name="l04519"></a>04519                                        icells,             &amp;
<a name="l04520"></a>04520                                        indxi,    indxj,    &amp;
<a name="l04521"></a>04521                                        Tf,       Tsf,      &amp;
<a name="l04522"></a>04522                                        hin,      hsn,      &amp;
<a name="l04523"></a>04523                                        qin,      qsn,      &amp;
<a name="l04524"></a>04524                                        aicen,    vicen,    &amp;
<a name="l04525"></a>04525                                        vsnon,    Tsfcn,    &amp;
<a name="l04526"></a>04526                                        eicen,    esnon)
<a name="l04527"></a>04527 <span class="comment">!</span>
<a name="l04528"></a>04528 <span class="comment">! !USES:</span>
<a name="l04529"></a>04529 <span class="comment">!</span>
<a name="l04530"></a>04530 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l04531"></a>04531 <span class="comment">!</span>
<a name="l04532"></a>04532       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04533"></a>04533          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l04534"></a>04534          icells              <span class="comment">! number of cells with aicen &gt; puny</span>
<a name="l04535"></a>04535 
<a name="l04536"></a>04536       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(nx_block*ny_block)</span>, 
<a name="l04537"></a>04537          <span class="keywordtype">intent(in)</span> :: 
<a name="l04538"></a>04538          indxi, indxj    <span class="comment">! compressed indices for cells with aicen &gt; puny</span>
<a name="l04539"></a>04539 
<a name="l04540"></a>04540       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04541"></a>04541          Tf              <span class="comment">! freezing temperature (C)</span>
<a name="l04542"></a>04542 
<a name="l04543"></a>04543       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04544"></a>04544          Tsf             <span class="comment">! ice/snow surface temperature, Tsfcn</span>
<a name="l04545"></a>04545 
<a name="l04546"></a>04546       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l04547"></a>04547          hin         ,  <span class="comment">! ice thickness (m)</span>
<a name="l04548"></a>04548          hsn             <span class="comment">! snow thickness (m)</span>
<a name="l04549"></a>04549 
<a name="l04550"></a>04550       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nilyr)</span>, 
<a name="l04551"></a>04551          <span class="keywordtype">intent(in)</span> :: 
<a name="l04552"></a>04552          qin             <span class="comment">! ice layer enthalpy (J m-3)</span>
<a name="l04553"></a>04553 
<a name="l04554"></a>04554       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,nslyr)</span>, 
<a name="l04555"></a>04555          <span class="keywordtype">intent(in)</span> :: 
<a name="l04556"></a>04556          qsn             <span class="comment">! snow layer enthalpy (J m-3)</span>
<a name="l04557"></a>04557 
<a name="l04558"></a>04558       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l04559"></a>04559          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04560"></a>04560          aicen       ,  <span class="comment">! concentration of ice</span>
<a name="l04561"></a>04561          vicen       ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l04562"></a>04562          vsnon       ,  <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l04563"></a>04563          Tsfcn           <span class="comment">! temperature of ice/snow top surface  (C)</span>
<a name="l04564"></a>04564 
<a name="l04565"></a>04565       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nilyr)</span>, 
<a name="l04566"></a>04566          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04567"></a>04567          eicen           <span class="comment">! energy of melting for each ice layer (J/m^2)</span>
<a name="l04568"></a>04568 
<a name="l04569"></a>04569       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nslyr)</span>, 
<a name="l04570"></a>04570          <span class="keywordtype">intent(inout)</span> :: 
<a name="l04571"></a>04571          esnon           <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l04572"></a>04572 <span class="comment">!</span>
<a name="l04573"></a>04573 <span class="comment">!EOP</span>
<a name="l04574"></a>04574 <span class="comment">!</span>
<a name="l04575"></a>04575       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l04576"></a>04576          i, j        ,  <span class="comment">! horizontal indices</span>
<a name="l04577"></a>04577          ij          ,  <span class="comment">! horizontal index, combines i and j loops</span>
<a name="l04578"></a>04578          k               <span class="comment">! ice layer index</span>
<a name="l04579"></a>04579 
<a name="l04580"></a>04580 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l04581"></a>04581 <span class="comment">!cdir nodep      !NEC</span>
<a name="l04582"></a>04582 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l04583"></a>04583       <span class="keyword">do</span> ij = 1, icells
<a name="l04584"></a>04584          i = indxi(ij)
<a name="l04585"></a>04585          j = indxj(ij)
<a name="l04586"></a>04586 
<a name="l04587"></a>04587          <span class="keyword">if</span> (hin(ij) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l04588"></a>04588             <span class="comment">! aicen is already up to date</span>
<a name="l04589"></a>04589             vicen(i,j) = aicen(i,j) * hin(ij)
<a name="l04590"></a>04590             vsnon(i,j) = aicen(i,j) * hsn(ij)
<a name="l04591"></a>04591             Tsfcn(i,j) = Tsf(ij)
<a name="l04592"></a>04592          <span class="keyword">else</span>  <span class="comment">! (hin(ij) == c0)</span>
<a name="l04593"></a>04593             aicen(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04594"></a>04594             vicen(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04595"></a>04595             vsnon(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04596"></a>04596             Tsfcn(i,j) = Tf(i,j)
<a name="l04597"></a>04597          <span class="keyword">endif</span>
<a name="l04598"></a>04598 
<a name="l04599"></a>04599       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l04600"></a>04600 
<a name="l04601"></a>04601       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l04602"></a>04602          <span class="keyword">do</span> ij = 1, icells
<a name="l04603"></a>04603             i = indxi(ij)
<a name="l04604"></a>04604             j = indxj(ij)
<a name="l04605"></a>04605 
<a name="l04606"></a>04606             <span class="keyword">if</span> (hin(ij) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l04607"></a>04607                eicen(i,j,k) = qin(ij,k) * vicen(i,j) &amp;
<a name="l04608"></a>04608                                           /<span class="keywordtype">real</span>(nilyr,kind=dbl_kind)
<a name="l04609"></a>04609             <span class="keyword">else</span>
<a name="l04610"></a>04610                eicen(i,j,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04611"></a>04611             <span class="keyword">endif</span>
<a name="l04612"></a>04612 
<a name="l04613"></a>04613          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l04614"></a>04614       <span class="keyword">enddo</span>                     <span class="comment">! nilyr</span>
<a name="l04615"></a>04615 
<a name="l04616"></a>04616       <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l04617"></a>04617          <span class="keyword">do</span> ij = 1, icells
<a name="l04618"></a>04618             i = indxi(ij)
<a name="l04619"></a>04619             j = indxj(ij)
<a name="l04620"></a>04620 
<a name="l04621"></a>04621             <span class="keyword">if</span> (hin(ij) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l04622"></a>04622                esnon(i,j,k) = qsn(ij,k) * vsnon(i,j) &amp;
<a name="l04623"></a>04623                                           /<span class="keywordtype">real</span>(nslyr,kind=dbl_kind)
<a name="l04624"></a>04624             <span class="keyword">else</span>
<a name="l04625"></a>04625                esnon(i,j,k) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l04626"></a>04626             <span class="keyword">endif</span>
<a name="l04627"></a>04627 
<a name="l04628"></a>04628          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l04629"></a>04629       <span class="keyword">enddo</span>                     <span class="comment">! nslyr</span>
<a name="l04630"></a>04630 
<a name="l04631"></a>04631 <span class="keyword">      end subroutine update_state_vthermo</span>
<a name="l04632"></a>04632 
<a name="l04633"></a>04633 
<a name="l04634"></a>04634 
<a name="l04635"></a>04635 <span class="comment">!=======================================================================</span>
<a name="l04636"></a>04636 
<a name="l04637"></a>04637 <span class="keyword">      end module ice_therm_vertical</span>
<a name="l04638"></a>04638 
<a name="l04639"></a>04639 <span class="comment">!=======================================================================</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Tue Oct 6 14:02:24 2009 for CICE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
