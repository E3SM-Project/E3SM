<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CICE: ice_itd.F90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Types&nbsp;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>ice_itd.F90</h1><a href="ice__itd_8F90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">!=======================================================================</span>
<a name="l00002"></a>00002 <span class="comment">!BOP</span>
<a name="l00003"></a>00003 <span class="comment">!</span>
<a name="l00004"></a>00004 <span class="comment">! !MODULE: ice_itd - initialize and redistribute ice in the ITD</span>
<a name="l00005"></a>00005 <span class="comment">!</span>
<a name="l00006"></a>00006 <span class="comment">! !DESCRIPTION:</span>
<a name="l00007"></a>00007 <span class="comment">!</span>
<a name="l00008"></a>00008 <span class="comment">! Routines to initialize the ice thickness distribution and</span>
<a name="l00009"></a>00009 <span class="comment">! utilities to redistribute ice among categories. These routines</span>
<a name="l00010"></a>00010 <span class="comment">! are not specific to a particular numerical implementation.</span>
<a name="l00011"></a>00011 <span class="comment">!</span>
<a name="l00012"></a>00012 <span class="comment">! See Bitz, C.M., and W.H. Lipscomb, 1999:</span>
<a name="l00013"></a>00013 <span class="comment">! An energy-conserving thermodynamic model of sea ice,</span>
<a name="l00014"></a>00014 <span class="comment">! J. Geophys. Res., 104, 15,669--15,677.</span>
<a name="l00015"></a>00015 <span class="comment">!</span>
<a name="l00016"></a>00016 <span class="comment">! See Bitz, C.M., M.M. Holland, A.J. Weaver, M. Eby, 2001:</span>
<a name="l00017"></a>00017 <span class="comment">! Simulating the ice-thickness distribution in a climate model,</span>
<a name="l00018"></a>00018 <span class="comment">! J. Geophys. Res., 106, 2441--2464.</span>
<a name="l00019"></a>00019 <span class="comment">!</span>
<a name="l00020"></a>00020 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00021"></a>00021 <span class="comment">!  SVN:$Id: ice_itd.F90 138 2008-07-08 20:39:37Z eclare $</span>
<a name="l00022"></a>00022 <span class="comment">!</span>
<a name="l00023"></a>00023 <span class="comment">! authors: C. M. Bitz, UW</span>
<a name="l00024"></a>00024 <span class="comment">!          William H. Lipscomb and Elizabeth C. Hunke, LANL</span>
<a name="l00025"></a>00025 <span class="comment">!</span>
<a name="l00026"></a>00026 <span class="comment">! 2003: Vectorized by Clifford Chen (Fujitsu) and William Lipscomb</span>
<a name="l00027"></a>00027 <span class="comment">!</span>
<a name="l00028"></a>00028 <span class="comment">! 2004 WHL: Added multiple snow layers, block structure, cleanup_itd</span>
<a name="l00029"></a>00029 <span class="comment">! 2006 ECH: Added WMO standard ice thickness categories as kcatbound=2</span>
<a name="l00030"></a>00030 <span class="comment">!           Streamlined for efficiency </span>
<a name="l00031"></a>00031 <span class="comment">!           Converted to free source form (F90)</span>
<a name="l00032"></a>00032 <span class="comment">!</span>
<a name="l00033"></a>00033 <span class="comment">! !INTERFACE:</span>
<a name="l00034"></a>00034 <span class="comment">!</span>
<a name="l00035"></a><a class="code" href="namespaceice__itd.html">00035</a>       <span class="keyword">module</span> ice_itd
<a name="l00036"></a>00036 <span class="comment">!</span>
<a name="l00037"></a>00037 <span class="comment">! !USES:</span>
<a name="l00038"></a>00038 <span class="comment">!</span>
<a name="l00039"></a>00039       use <span class="keywordflow">ice_kinds_mod</span>
<a name="l00040"></a>00040       use <span class="keywordflow">ice_communicate</span>, only: my_task, master_task
<a name="l00041"></a>00041       use <span class="keywordflow">ice_domain_size</span>
<a name="l00042"></a>00042       use <span class="keywordflow">ice_constants</span>
<a name="l00043"></a>00043       use <span class="keywordflow">ice_fileunits</span>
<a name="l00044"></a>00044       use <span class="keywordflow">ice_exit</span>
<a name="l00045"></a>00045 <span class="comment">!</span>
<a name="l00046"></a>00046 <span class="comment">!EOP</span>
<a name="l00047"></a>00047 <span class="comment">!</span>
<a name="l00048"></a>00048       <span class="keyword">implicit none</span>
<a name="l00049"></a>00049       <span class="keywordtype">save</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="namespaceice__itd.html#abda5299945828ac5cca9a7e6522991e3">00051</a>       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00052"></a>00052          kitd        ,  <span class="comment">! type of itd conversions</span>
<a name="l00053"></a>00053                          <span class="comment">!   0 = delta function</span>
<a name="l00054"></a>00054                          <span class="comment">!   1 = linear remap</span>
<a name="l00055"></a>00055          kcatbound   , &amp; <span class="comment">!   0 = old category boundary formula</span>
<a name="l00056"></a>00056                          <span class="comment">!   1 = new formula giving round numbers</span>
<a name="l00057"></a>00057                          <span class="comment">!   2 = WMO standard</span>
<a name="l00058"></a>00058          ilyr1 (<a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>), &amp; <span class="comment">! array position of top ice layer in each cat</span>
<a name="l00059"></a>00059          ilyrn (<a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>), &amp; <span class="comment">! array position of bottom ice layer in each cat</span>
<a name="l00060"></a>00060          slyr1 (<a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>), &amp; <span class="comment">! array position of top snow layer in each cat</span>
<a name="l00061"></a>00061          slyrn (<a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>)    <span class="comment">! array position of bottom snow layer in each cat</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="namespaceice__itd.html#a096dec1f870d22da21163b6dcacb1d2c">00063</a>       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l00064"></a>00064          hi_min = p01    <span class="comment">! minimum ice thickness allowed (m)</span>
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">00066</a>       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00067"></a>00067          hin_max(0:ncat) <span class="comment">! category limits (m)</span>
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="namespaceice__itd.html#a679cef320723f15b41bdfc5811701cea">00069</a>       <span class="keywordtype">character (len=35) </span>:: c_hi_range(ncat)
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">!-------------------------------------------------------------------</span>
<a name="l00072"></a>00072 <span class="comment">! a note regarding hi_min and hin_max(0):</span>
<a name="l00073"></a>00073 <span class="comment">! both represent a minimum ice thickness.  hin_max(0) is</span>
<a name="l00074"></a>00074 <span class="comment">! intended to be used for particular numerical implementations</span>
<a name="l00075"></a>00075 <span class="comment">! of category conversions in the ice thickness distribution.</span>
<a name="l00076"></a>00076 <span class="comment">! hi_min is a more general purpose parameter, but is specifically</span>
<a name="l00077"></a>00077 <span class="comment">! for maintaining stability in the thermodynamics.</span>
<a name="l00078"></a>00078 <span class="comment">! hin_max(0) = 0.1 m for the delta function itd</span>
<a name="l00079"></a>00079 <span class="comment">! hin_max(0) = 0.0 m for linear remapping</span>
<a name="l00080"></a>00080 <span class="comment">!</span>
<a name="l00081"></a>00081 <span class="comment">! Also note that the upper limit on the thickest category</span>
<a name="l00082"></a>00082 <span class="comment">! is only used for the linear remapping scheme</span>
<a name="l00083"></a>00083 <span class="comment">! and it is not a true upper limit on the thickness</span>
<a name="l00084"></a>00084 <span class="comment">!-------------------------------------------------------------------</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">!=======================================================================</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088       <span class="keyword">contains</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">!=======================================================================</span>
<a name="l00091"></a>00091 <span class="comment">!BOP</span>
<a name="l00092"></a>00092 <span class="comment">!</span>
<a name="l00093"></a>00093 <span class="comment">! !IROUTINE: init_itd - initalize area fraction and thickness boundaries for ITD</span>
<a name="l00094"></a>00094 <span class="comment">!</span>
<a name="l00095"></a>00095 <span class="comment">! !INTERFACE:</span>
<a name="l00096"></a>00096 <span class="comment">!</span>
<a name="l00097"></a><a class="code" href="namespaceice__itd.html#a2c5da98ae0797cd69f98ffce134e4ef7">00097</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a2c5da98ae0797cd69f98ffce134e4ef7">init_itd</a>
<a name="l00098"></a>00098 <span class="comment">!</span>
<a name="l00099"></a>00099 <span class="comment">! !DESCRIPTION:</span>
<a name="l00100"></a>00100 <span class="comment">!</span>
<a name="l00101"></a>00101 <span class="comment">! Initialize area fraction and thickness boundaries for the itd model</span>
<a name="l00102"></a>00102 <span class="comment">!</span>
<a name="l00103"></a>00103 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00104"></a>00104 <span class="comment">!</span>
<a name="l00105"></a>00105 <span class="comment">! authors: William H. Lipscomb and Elizabeth C. Hunke, LANL</span>
<a name="l00106"></a>00106 <span class="comment">!          C. M. Bitz, UW</span>
<a name="l00107"></a>00107 <span class="comment">!</span>
<a name="l00108"></a>00108 <span class="comment">! !USES:</span>
<a name="l00109"></a>00109 <span class="comment">!</span>
<a name="l00110"></a>00110 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00111"></a>00111 <span class="comment">!</span>
<a name="l00112"></a>00112 <span class="comment">!EOP</span>
<a name="l00113"></a>00113 <span class="comment">!</span>
<a name="l00114"></a>00114       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00115"></a>00115            n    <span class="comment">! thickness category index</span>
<a name="l00116"></a>00116 
<a name="l00117"></a>00117       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00118"></a>00118            cc1, cc2, cc3,  <span class="comment">! parameters for kcatbound = 0</span>
<a name="l00119"></a>00119            x1           , 
<a name="l00120"></a>00120            rn           ,  <span class="comment">! real(n)</span>
<a name="l00121"></a>00121            rncat        ,  <span class="comment">! real(ncat)</span>
<a name="l00122"></a>00122            d1           ,  <span class="comment">! parameters for kcatbound = 1 (m)</span>
<a name="l00123"></a>00123            d2
<a name="l00124"></a>00124 
<a name="l00125"></a>00125       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(5) </span>:: wmo5 <span class="comment">! data for wmo itd</span>
<a name="l00126"></a>00126       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(6) </span>:: wmo6 <span class="comment">! data for wmo itd</span>
<a name="l00127"></a>00127       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(7) </span>:: wmo7 <span class="comment">! data for wmo itd</span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129       <span class="keywordtype">character(len=8) </span>:: c_hinmax1,c_hinmax2
<a name="l00130"></a>00130       <span class="keywordtype">character(len=2) </span>:: c_nc
<a name="l00131"></a>00131 
<a name="l00132"></a>00132       rncat = <span class="keywordtype">real</span>(ncat, kind=dbl_kind)
<a name="l00133"></a>00133       d1 = 3.0_dbl_kind / rncat
<a name="l00134"></a>00134       d2 = 0.5_dbl_kind / rncat
<a name="l00135"></a>00135 
<a name="l00136"></a>00136       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00137"></a>00137       <span class="comment">! Choose category boundaries based on one of three options.</span>
<a name="l00138"></a>00138       <span class="comment">!</span>
<a name="l00139"></a>00139       <span class="comment">! The first formula (kcatbound = 0) was used in Lipscomb (2001) </span>
<a name="l00140"></a>00140       <span class="comment">!  and in CICE versions 3.0 and 3.1.</span>
<a name="l00141"></a>00141       <span class="comment">!</span>
<a name="l00142"></a>00142       <span class="comment">! The second formula is more user-friendly in the sense that it</span>
<a name="l00143"></a>00143       <span class="comment">!  is easy to obtain round numbers for category boundaries:</span>
<a name="l00144"></a>00144       <span class="comment">!</span>
<a name="l00145"></a>00145       <span class="comment">!    H(n) = n * [d1 + d2*(n-1)] </span>
<a name="l00146"></a>00146       <span class="comment">! </span>
<a name="l00147"></a>00147       <span class="comment">! Default values are d1 = 300/ncat, d2 = 50/ncat.</span>
<a name="l00148"></a>00148       <span class="comment">! For ncat = 5, boundaries in cm are 60, 140, 240, 360, which are </span>
<a name="l00149"></a>00149       <span class="comment">!  close to the standard values given by the first formula.</span>
<a name="l00150"></a>00150       <span class="comment">! For ncat = 10, boundaries in cm are 30, 70, 120, 180, 250, 330,</span>
<a name="l00151"></a>00151       <span class="comment">!  420, 520, 630.    </span>
<a name="l00152"></a>00152       <span class="comment">!</span>
<a name="l00153"></a>00153       <span class="comment">! The third option provides support for World Meteorological</span>
<a name="l00154"></a>00154       <span class="comment">!  Organization classification based on thickness.  The full</span>
<a name="l00155"></a>00155       <span class="comment">!  WMO thickness distribution is used if ncat = 7;  if ncat=5 </span>
<a name="l00156"></a>00156       <span class="comment">!  or ncat = 6, some of the thinner categories are combined.</span>
<a name="l00157"></a>00157       <span class="comment">! For ncat = 5,  boundaries are         30, 70, 120, 200, &gt;200 cm.</span>
<a name="l00158"></a>00158       <span class="comment">! For ncat = 6,  boundaries are     15, 30, 70, 120, 200, &gt;200 cm.</span>
<a name="l00159"></a>00159       <span class="comment">! For ncat = 7,  boundaries are 10, 15, 30, 70, 120, 200, &gt;200 cm.</span>
<a name="l00160"></a>00160       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       <span class="keyword">if</span> (kcatbound == 0) <span class="keyword">then</span>   <span class="comment">! original scheme</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164          <span class="keyword">if</span> (<a class="code" href="namespaceice__itd.html#abda5299945828ac5cca9a7e6522991e3">kitd</a> == 1) <span class="keyword">then</span>
<a name="l00165"></a>00165             <span class="comment">! linear remapping itd category limits</span>
<a name="l00166"></a>00166             cc1 = <a class="code" href="namespaceice__constants.html#a0ae384e716bc1243a7bd1c6d1ace209f">c3</a>/rncat
<a name="l00167"></a>00167             cc2 = <a class="code" href="namespaceice__constants.html#a7ea763e48f3b0d07e97e411c1abd6da1">c15</a>*cc1
<a name="l00168"></a>00168             cc3 = <a class="code" href="namespaceice__constants.html#a0ae384e716bc1243a7bd1c6d1ace209f">c3</a>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>     <span class="comment">! minimum ice thickness, m</span>
<a name="l00171"></a>00171          <span class="keyword">else</span>
<a name="l00172"></a>00172             <span class="comment">! delta function itd category limits</span>
<a name="l00173"></a>00173             cc1 = max(1.1_dbl_kind/rncat,<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>*<a class="code" href="namespaceice__itd.html#a096dec1f870d22da21163b6dcacb1d2c">hi_min</a>)
<a name="l00174"></a>00174             cc2 = <a class="code" href="namespaceice__constants.html#a5db59b63c17c3ed647e3cdd61b04793c">c25</a>*cc1
<a name="l00175"></a>00175             cc3 = 2.25_dbl_kind
<a name="l00176"></a>00176 
<a name="l00177"></a>00177             <span class="comment">! hin_max(0) should not be zero</span>
<a name="l00178"></a>00178             <span class="comment">! use some caution in making it less than 0.10</span>
<a name="l00179"></a>00179             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) = <a class="code" href="namespaceice__itd.html#a096dec1f870d22da21163b6dcacb1d2c">hi_min</a> <span class="comment">! minimum ice thickness, m</span>
<a name="l00180"></a>00180          <span class="keyword">endif</span>                  <span class="comment">! kitd</span>
<a name="l00181"></a>00181 
<a name="l00182"></a>00182          <span class="keyword">do</span> n = 1, ncat
<a name="l00183"></a>00183             x1 = <span class="keywordtype">real(n-1,kind=dbl_kind)</span> / rncat
<a name="l00184"></a>00184             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n) = <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n-1) &amp;
<a name="l00185"></a>00185                        + cc1 + cc2*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> + tanh(cc3*(x1-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)))
<a name="l00186"></a>00186          <span class="keyword">enddo</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188       elseif (kcatbound == 1) <span class="keyword">then</span>  <span class="comment">! new scheme</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190          <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00191"></a>00191          <span class="keyword">do</span> n = 1, ncat
<a name="l00192"></a>00192             rn = <span class="keywordtype">real</span>(n, kind=dbl_kind)
<a name="l00193"></a>00193             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n) = rn * (d1 + (rn-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)*d2)
<a name="l00194"></a>00194          <span class="keyword">enddo</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196       elseif (kcatbound == 2) <span class="keyword">then</span>  <span class="comment">! WMO standard</span>
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="keyword">if</span> (ncat == 5) <span class="keyword">then</span>
<a name="l00199"></a>00199          <span class="comment">! thinnest 3 categories combined</span>
<a name="l00200"></a>00200          <span class="keyword">data</span> wmo5 / 0.30_dbl_kind, 0.70_dbl_kind, &amp;
<a name="l00201"></a>00201                     1.20_dbl_kind, 2.00_dbl_kind,  &amp;
<a name="l00202"></a>00202                     999._dbl_kind  /
<a name="l00203"></a>00203          <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00204"></a>00204          <span class="keyword">do</span> n = 1, ncat
<a name="l00205"></a>00205             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n) = wmo5(n)
<a name="l00206"></a>00206          <span class="keyword">enddo</span>
<a name="l00207"></a>00207        elseif (ncat == 6) <span class="keyword">then</span>
<a name="l00208"></a>00208          <span class="comment">! thinnest 2 categories combined</span>
<a name="l00209"></a>00209          <span class="keyword">data</span> wmo6 / 0.15_dbl_kind, &amp;
<a name="l00210"></a>00210                     0.30_dbl_kind, 0.70_dbl_kind,  &amp;
<a name="l00211"></a>00211                     1.20_dbl_kind, 2.00_dbl_kind,  &amp;
<a name="l00212"></a>00212                     999._dbl_kind /
<a name="l00213"></a>00213          <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00214"></a>00214          <span class="keyword">do</span> n = 1, ncat
<a name="l00215"></a>00215             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n) = wmo6(n)
<a name="l00216"></a>00216          <span class="keyword">enddo</span>
<a name="l00217"></a>00217        elseif (ncat == 7) <span class="keyword">then</span>
<a name="l00218"></a>00218          <span class="comment">! all thickness categories </span>
<a name="l00219"></a>00219          <span class="keyword">data</span> wmo7 / 0.10_dbl_kind, 0.15_dbl_kind, &amp;
<a name="l00220"></a>00220                     0.30_dbl_kind, 0.70_dbl_kind,  &amp;
<a name="l00221"></a>00221                     1.20_dbl_kind, 2.00_dbl_kind,  &amp;
<a name="l00222"></a>00222                     999._dbl_kind  /
<a name="l00223"></a>00223          <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00224"></a>00224          <span class="keyword">do</span> n = 1, ncat
<a name="l00225"></a>00225             <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n) = wmo7(n)
<a name="l00226"></a>00226          <span class="keyword">enddo</span>
<a name="l00227"></a>00227        <span class="keyword">else</span>
<a name="l00228"></a>00228          <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;kcatbound=3 (WMO) must have ncat=5, 6 or 7&apos;</span>
<a name="l00229"></a>00229          stop
<a name="l00230"></a>00230        <span class="keyword">endif</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232       <span class="keyword">endif</span> <span class="comment">! kcatbound</span>
<a name="l00233"></a>00233 
<a name="l00234"></a>00234       <span class="keyword">if</span> (<a class="code" href="namespaceice__communicate.html#a70e729e746e2e5ec592ccba505136002">my_task</a> == <a class="code" href="namespaceice__communicate.html#a769a45947743f12c592e4cef37a18b6c">master_task</a>) <span class="keyword">then</span>
<a name="l00235"></a>00235          <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l00236"></a>00236          <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;hin_max(n-1) &lt; Cat n &lt; hin_max(n)&apos;</span>
<a name="l00237"></a>00237          <span class="keyword">do</span> n = 1, ncat
<a name="l00238"></a>00238             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n-1),<span class="stringliteral">&apos; &lt; Cat &apos;</span>,n, <span class="stringliteral">&apos; &lt; &apos;</span>,<a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n)
<a name="l00239"></a>00239             <span class="comment">! Write integer n to character string</span>
<a name="l00240"></a>00240             <span class="keyword">write</span> (c_nc, <span class="stringliteral">&apos;(i2)&apos;</span>) n    
<a name="l00241"></a>00241 
<a name="l00242"></a>00242             <span class="comment">! Write hin_max to character string</span>
<a name="l00243"></a>00243             <span class="keyword">write</span> (c_hinmax1, <span class="stringliteral">&apos;(f5.3)&apos;</span>) <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n-1)
<a name="l00244"></a>00244             <span class="keyword">write</span> (c_hinmax2, <span class="stringliteral">&apos;(f5.3)&apos;</span>) <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n)
<a name="l00245"></a>00245 
<a name="l00246"></a>00246             <span class="comment">! Save character string to write to history file</span>
<a name="l00247"></a>00247             <a class="code" href="namespaceice__itd.html#a679cef320723f15b41bdfc5811701cea">c_hi_range</a>(n)=c_hinmax1//<span class="stringliteral">&apos;m &lt; hi Cat &apos;</span>//c_nc//<span class="stringliteral">&apos; &lt; &apos;</span>// &amp;
<a name="l00248"></a>00248                           c_hinmax2//<span class="stringliteral">&apos;m&apos;</span>
<a name="l00249"></a>00249          <span class="keyword">enddo</span>
<a name="l00250"></a>00250          <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l00251"></a>00251       <span class="keyword">endif</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00254"></a>00254       <span class="comment">! vectors identifying first and last layer in each category</span>
<a name="l00255"></a>00255       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00256"></a>00256       ilyr1(1) = 1                       <span class="comment">! if nilyr  = 4</span>
<a name="l00257"></a>00257       ilyrn(1) = <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>                   <span class="comment">!   ilyr1 = { 1,5,9 }</span>
<a name="l00258"></a>00258       <span class="keyword">do</span> n = 2, ncat                     <span class="comment">!   ilyrn = { 4,8,12} etc</span>
<a name="l00259"></a>00259          ilyr1(n) = ilyrn(n-1) + 1
<a name="l00260"></a>00260          ilyrn(n) = ilyrn(n-1) + <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l00261"></a>00261       <span class="keyword">enddo</span>
<a name="l00262"></a>00262 
<a name="l00263"></a>00263       slyr1(1) = 1
<a name="l00264"></a>00264       slyrn(1) = <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l00265"></a>00265       <span class="keyword">do</span> n = 2, ncat
<a name="l00266"></a>00266          slyr1(n) = slyrn(n-1) + 1
<a name="l00267"></a>00267          slyrn(n) = slyrn(n-1) + <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l00268"></a>00268       <span class="keyword">enddo</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 <span class="keyword">      end subroutine init_itd</span>
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="comment">!=======================================================================</span>
<a name="l00273"></a>00273 <span class="comment">!BOP</span>
<a name="l00274"></a>00274 <span class="comment">!</span>
<a name="l00275"></a>00275 <span class="comment">! !IROUTINE: aggregate - aggregate ice state variables</span>
<a name="l00276"></a>00276 <span class="comment">!</span>
<a name="l00277"></a>00277 <span class="comment">! !INTERFACE:</span>
<a name="l00278"></a>00278 <span class="comment">!</span>
<a name="l00279"></a><a class="code" href="namespaceice__itd.html#a8360ff94dd398d403890bfe9e8030b51">00279</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a8360ff94dd398d403890bfe9e8030b51">aggregate</a> (nx_block, ny_block, &amp;
<a name="l00280"></a>00280                             aicen,    trcrn,    &amp;
<a name="l00281"></a>00281                             vicen,    vsnon,    &amp;
<a name="l00282"></a>00282                             eicen,    esnon,    &amp;
<a name="l00283"></a>00283                             aice,     trcr,     &amp;
<a name="l00284"></a>00284                             vice,     vsno,     &amp;
<a name="l00285"></a>00285                             eice,     esno,     &amp;
<a name="l00286"></a>00286                             aice0,              &amp;
<a name="l00287"></a>00287                             tmask,    trcr_depend)
<a name="l00288"></a>00288 <span class="comment">!</span>
<a name="l00289"></a>00289 <span class="comment">! !DESCRIPTION:</span>
<a name="l00290"></a>00290 <span class="comment">!</span>
<a name="l00291"></a>00291 <span class="comment">! Aggregate ice state variables over thickness categories.</span>
<a name="l00292"></a>00292 <span class="comment">!</span>
<a name="l00293"></a>00293 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00294"></a>00294 <span class="comment">!</span>
<a name="l00295"></a>00295 <span class="comment">! authors: C. M. Bitz, UW</span>
<a name="l00296"></a>00296 <span class="comment">!          W. H. Lipscomb, LANL</span>
<a name="l00297"></a>00297 <span class="comment">!</span>
<a name="l00298"></a>00298 <span class="comment">! !USES:</span>
<a name="l00299"></a>00299 <span class="comment">!</span>
<a name="l00300"></a>00300 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00301"></a>00301 <span class="comment">!</span>
<a name="l00302"></a>00302       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00303"></a>00303            nx_block, ny_block  <span class="comment">! block dimensions</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ncat)</span>, 
<a name="l00306"></a>00306          <span class="keywordtype">intent(in)</span> :: 
<a name="l00307"></a>00307          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l00308"></a>00308          vicen ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l00309"></a>00309          vsnon     <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr,ncat)</span>, 
<a name="l00312"></a>00312          <span class="keywordtype">intent(in)</span> :: 
<a name="l00313"></a>00313          trcrn     <span class="comment">! ice tracers</span>
<a name="l00314"></a>00314 
<a name="l00315"></a>00315       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntilyr)</span>, 
<a name="l00316"></a>00316          <span class="keywordtype">intent(in)</span> :: 
<a name="l00317"></a>00317          eicen     <span class="comment">! energy of melting for each ice layer  (J/m^2)</span>
<a name="l00318"></a>00318 
<a name="l00319"></a>00319       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntslyr)</span>, 
<a name="l00320"></a>00320          <span class="keywordtype">intent(in)</span> :: 
<a name="l00321"></a>00321          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l00324"></a>00324          <span class="keywordtype">intent(in)</span> :: 
<a name="l00325"></a>00325          tmask     <span class="comment">! land/boundary mask, thickness (T-cell)</span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (ntrcr)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00328"></a>00328          trcr_depend <span class="comment">! = 0 for aicen tracers, 1 for vicen, 2 for vsnon</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>,  
<a name="l00331"></a>00331          <span class="keywordtype">intent(out)</span> :: 
<a name="l00332"></a>00332          aice  ,  <span class="comment">! concentration of ice</span>
<a name="l00333"></a>00333          vice  ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l00334"></a>00334          vsno  ,  <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l00335"></a>00335          eice  ,  <span class="comment">! energy of melt. of ice           (J/m^2)</span>
<a name="l00336"></a>00336          esno  ,  <span class="comment">! energy of melt. of snow layer    (J/m^2)</span>
<a name="l00337"></a>00337          aice0     <span class="comment">! concentration of open water</span>
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr)</span>,  
<a name="l00340"></a>00340          <span class="keywordtype">intent(out)</span> :: 
<a name="l00341"></a>00341          trcr      <span class="comment">! ice tracers</span>
<a name="l00342"></a>00342 <span class="comment">!</span>
<a name="l00343"></a>00343 <span class="comment">!EOP</span>
<a name="l00344"></a>00344 <span class="comment">!</span>
<a name="l00345"></a>00345       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00346"></a>00346         icells                <span class="comment">! number of ocean/ice cells</span>
<a name="l00347"></a>00347 
<a name="l00348"></a>00348       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block) </span>:: 
<a name="l00349"></a>00349         indxi,               <span class="comment">! compressed indices in i/j directions</span>
<a name="l00350"></a>00350         indxj
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00353"></a>00353         i, j, k, n, it, 
<a name="l00354"></a>00354         ij                    <span class="comment">! combined i/j horizontal index</span>
<a name="l00355"></a>00355 
<a name="l00356"></a>00356       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:,:)</span>, <span class="keywordtype">allocatable</span> :: 
<a name="l00357"></a>00357         atrcr      <span class="comment">! sum of aicen*trcrn or vicen*trcrn or vsnon*trcrn</span>
<a name="l00358"></a>00358 
<a name="l00359"></a>00359       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00360"></a>00360       <span class="comment">! Initialize</span>
<a name="l00361"></a>00361       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00362"></a>00362 
<a name="l00363"></a>00363       icells = 0
<a name="l00364"></a>00364       <span class="keyword">do</span> j = 1, ny_block
<a name="l00365"></a>00365       <span class="keyword">do</span> i = 1, nx_block
<a name="l00366"></a>00366          <span class="keyword">if</span> (tmask(i,j)) <span class="keyword">then</span>
<a name="l00367"></a>00367             icells = icells + 1
<a name="l00368"></a>00368             indxi(icells) = i
<a name="l00369"></a>00369             indxj(icells) = j
<a name="l00370"></a>00370          <span class="keyword">endif</span>                  <span class="comment">! tmask</span>
<a name="l00371"></a>00371 
<a name="l00372"></a>00372          aice0(i,j) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>
<a name="l00373"></a>00373          aice (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00374"></a>00374          vice (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00375"></a>00375          vsno (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00376"></a>00376          eice (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00377"></a>00377          esno (i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00378"></a>00378       <span class="keyword">enddo</span>
<a name="l00379"></a>00379       <span class="keyword">enddo</span>
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 
<a name="l00382"></a>00382       <span class="keyword">allocate</span> (atrcr(icells,ntrcr))
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00385"></a>00385       <span class="comment">! Aggregate</span>
<a name="l00386"></a>00386       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00387"></a>00387 
<a name="l00388"></a>00388       atrcr(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00389"></a>00389 
<a name="l00390"></a>00390       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00393"></a>00393 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00394"></a>00394 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00395"></a>00395          <span class="keyword">do</span> ij = 1, icells
<a name="l00396"></a>00396             i = indxi(ij)
<a name="l00397"></a>00397             j = indxj(ij)
<a name="l00398"></a>00398             aice(i,j) = aice(i,j) + aicen(i,j,n)
<a name="l00399"></a>00399             vice(i,j) = vice(i,j) + vicen(i,j,n)
<a name="l00400"></a>00400             vsno(i,j) = vsno(i,j) + vsnon(i,j,n)
<a name="l00401"></a>00401          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l00402"></a>00402 
<a name="l00403"></a>00403          <span class="keyword">do</span> it = 1, ntrcr
<a name="l00404"></a>00404             <span class="keyword">if</span> (trcr_depend(it) == 0) <span class="keyword">then</span>  <span class="comment">! ice area tracer</span>
<a name="l00405"></a>00405 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00406"></a>00406 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00407"></a>00407 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00408"></a>00408                <span class="keyword">do</span> ij = 1, icells
<a name="l00409"></a>00409                   i = indxi(ij)
<a name="l00410"></a>00410                   j = indxj(ij)
<a name="l00411"></a>00411                   atrcr(ij,it) = atrcr(ij,it)  &amp;
<a name="l00412"></a>00412                                 + trcrn(i,j,it,n)*aicen(i,j,n)
<a name="l00413"></a>00413                <span class="keyword">enddo</span>            <span class="comment">! ij</span>
<a name="l00414"></a>00414 
<a name="l00415"></a>00415             elseif (trcr_depend(it) == 1) <span class="keyword">then</span>  <span class="comment">! ice volume tracer</span>
<a name="l00416"></a>00416 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00417"></a>00417 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00418"></a>00418 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00419"></a>00419                <span class="keyword">do</span> ij = 1, icells
<a name="l00420"></a>00420                   i = indxi(ij)
<a name="l00421"></a>00421                   j = indxj(ij)
<a name="l00422"></a>00422                   atrcr(ij,it) = atrcr(ij,it)  &amp;
<a name="l00423"></a>00423                                 + trcrn(i,j,it,n)*vicen(i,j,n)
<a name="l00424"></a>00424                <span class="keyword">enddo</span>            <span class="comment">! ij</span>
<a name="l00425"></a>00425 
<a name="l00426"></a>00426             elseif (trcr_depend(it) ==2) <span class="keyword">then</span> <span class="comment">! snow volume tracer</span>
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00429"></a>00429 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00430"></a>00430 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00431"></a>00431                <span class="keyword">do</span> ij = 1, icells
<a name="l00432"></a>00432                   i = indxi(ij)
<a name="l00433"></a>00433                   j = indxj(ij)
<a name="l00434"></a>00434                   atrcr(ij,it) = atrcr(ij,it)  &amp;
<a name="l00435"></a>00435                                 + trcrn(i,j,it,n)*vsnon(i,j,n)
<a name="l00436"></a>00436                <span class="keyword">enddo</span>            <span class="comment">! ij</span>
<a name="l00437"></a>00437 
<a name="l00438"></a>00438             <span class="keyword">endif</span>               <span class="comment">! trcr_depend</span>
<a name="l00439"></a>00439          <span class="keyword">enddo</span>                  <span class="comment">! ntrcr</span>
<a name="l00440"></a>00440 
<a name="l00441"></a>00441          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l00442"></a>00442 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00443"></a>00443 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00444"></a>00444 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00445"></a>00445             <span class="keyword">do</span> ij = 1, icells
<a name="l00446"></a>00446                i = indxi(ij)
<a name="l00447"></a>00447                j = indxj(ij)
<a name="l00448"></a>00448                eice(i,j) = eice(i,j) + eicen(i,j,ilyr1(n)+k-1)
<a name="l00449"></a>00449             <span class="keyword">enddo</span>
<a name="l00450"></a>00450          <span class="keyword">enddo</span>                  <span class="comment">! nilyr</span>
<a name="l00451"></a>00451 
<a name="l00452"></a>00452          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l00453"></a>00453 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l00454"></a>00454 <span class="comment">!cdir nodep      !NEC</span>
<a name="l00455"></a>00455 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l00456"></a>00456             <span class="keyword">do</span> ij = 1, icells
<a name="l00457"></a>00457                i = indxi(ij)
<a name="l00458"></a>00458                j = indxj(ij)
<a name="l00459"></a>00459                esno(i,j) = esno(i,j) + esnon(i,j,slyr1(n)+k-1)
<a name="l00460"></a>00460             <span class="keyword">enddo</span>
<a name="l00461"></a>00461          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463       <span class="keyword">enddo</span>                     <span class="comment">! ncat</span>
<a name="l00464"></a>00464 
<a name="l00465"></a>00465       <span class="comment">! Open water fraction</span>
<a name="l00466"></a>00466 
<a name="l00467"></a>00467       <span class="keyword">do</span> ij = 1, icells
<a name="l00468"></a>00468          i = indxi(ij)
<a name="l00469"></a>00469          j = indxj(ij)
<a name="l00470"></a>00470          aice0(i,j) = max (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> - aice(i,j), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l00471"></a>00471       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l00472"></a>00472 
<a name="l00473"></a>00473       <span class="comment">! Tracers</span>
<a name="l00474"></a>00474 
<a name="l00475"></a>00475       call <a class="code" href="namespaceice__itd.html#ae64b7540ec9e84001de195ffec097bc3">compute_tracers </a>(nx_block,     ny_block,   &amp;
<a name="l00476"></a>00476                             icells,   indxi,   indxj, &amp;
<a name="l00477"></a>00477                             trcr_depend,              &amp;
<a name="l00478"></a>00478                             atrcr(:,:), aice(:,:),    &amp;
<a name="l00479"></a>00479                             vice (:,:),   vsno(:,:),  &amp;
<a name="l00480"></a>00480                             trcr(:,:,:))
<a name="l00481"></a>00481 
<a name="l00482"></a>00482       <span class="keyword">deallocate</span> (atrcr)
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="keyword">      end subroutine aggregate</span>
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 <span class="comment">!=======================================================================</span>
<a name="l00487"></a>00487 <span class="comment">!BOP</span>
<a name="l00488"></a>00488 <span class="comment">!</span>
<a name="l00489"></a>00489 <span class="comment">! !IROUTINE: aggregate_area - aggregate ice area</span>
<a name="l00490"></a>00490 <span class="comment">!</span>
<a name="l00491"></a>00491 <span class="comment">! !INTERFACE:</span>
<a name="l00492"></a>00492 <span class="comment">!</span>
<a name="l00493"></a><a class="code" href="namespaceice__itd.html#a428ffa5cfc4adb00cd323a2d76bf1c4d">00493</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a428ffa5cfc4adb00cd323a2d76bf1c4d">aggregate_area</a> (nx_block, ny_block,        &amp;
<a name="l00494"></a>00494                                  aicen,    aice,     aice0)
<a name="l00495"></a>00495 <span class="comment">!</span>
<a name="l00496"></a>00496 <span class="comment">! !DESCRIPTION:</span>
<a name="l00497"></a>00497 <span class="comment">!</span>
<a name="l00498"></a>00498 <span class="comment">! Aggregate ice area (but not other state variables) over thickness </span>
<a name="l00499"></a>00499 <span class="comment">! categories.</span>
<a name="l00500"></a>00500 <span class="comment">!</span>
<a name="l00501"></a>00501 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00502"></a>00502 <span class="comment">!</span>
<a name="l00503"></a>00503 <span class="comment">! authors: William H. Lipscomb, LANL</span>
<a name="l00504"></a>00504 <span class="comment">!          modified Jan 2004 by Clifford Chen, Fujitsu</span>
<a name="l00505"></a>00505 <span class="comment">!</span>
<a name="l00506"></a>00506 <span class="comment">! !USES:</span>
<a name="l00507"></a>00507 <span class="comment">!</span>
<a name="l00508"></a>00508 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00509"></a>00509 <span class="comment">!</span>
<a name="l00510"></a>00510       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00511"></a>00511          nx_block, ny_block  <span class="comment">! block dimensions</span>
<a name="l00512"></a>00512 
<a name="l00513"></a>00513       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:,:,:)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00514"></a>00514          aicen     <span class="comment">! concentration of ice</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (:,:)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l00517"></a>00517          aice,    <span class="comment">! concentration of ice</span>
<a name="l00518"></a>00518          aice0     <span class="comment">! concentration of open water</span>
<a name="l00519"></a>00519 <span class="comment">!</span>
<a name="l00520"></a>00520 <span class="comment">!EOP</span>
<a name="l00521"></a>00521 <span class="comment">!</span>
<a name="l00522"></a>00522       <span class="keywordtype">integer (kind=int_kind) </span>:: i, j, n
<a name="l00523"></a>00523 
<a name="l00524"></a>00524       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00525"></a>00525       <span class="comment">! Aggregate</span>
<a name="l00526"></a>00526       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00527"></a>00527 
<a name="l00528"></a>00528       aice(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l00531"></a>00531          <span class="keyword">do</span> j = 1, ny_block
<a name="l00532"></a>00532          <span class="keyword">do</span> i = 1, nx_block
<a name="l00533"></a>00533             aice(i,j) = aice(i,j) + aicen(i,j,n)
<a name="l00534"></a>00534          <span class="keyword">enddo</span>                  <span class="comment">! i</span>
<a name="l00535"></a>00535          <span class="keyword">enddo</span>                  <span class="comment">! j</span>
<a name="l00536"></a>00536       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538       <span class="keyword">do</span> j = 1, ny_block
<a name="l00539"></a>00539       <span class="keyword">do</span> i = 1, nx_block
<a name="l00540"></a>00540 
<a name="l00541"></a>00541          <span class="comment">! open water fraction</span>
<a name="l00542"></a>00542          aice0(i,j) = max (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> - aice(i,j), <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>)
<a name="l00543"></a>00543 
<a name="l00544"></a>00544       <span class="keyword">enddo</span>                     <span class="comment">! i</span>
<a name="l00545"></a>00545       <span class="keyword">enddo</span>                     <span class="comment">! j</span>
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 <span class="keyword">      end subroutine aggregate_area</span>
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 <span class="comment">!=======================================================================</span>
<a name="l00550"></a>00550 <span class="comment">!BOP</span>
<a name="l00551"></a>00551 <span class="comment">!</span>
<a name="l00552"></a>00552 <span class="comment">! !IROUTINE: rebin - rebins thicknesses into defined categories</span>
<a name="l00553"></a>00553 <span class="comment">!</span>
<a name="l00554"></a>00554 <span class="comment">! !INTERFACE:</span>
<a name="l00555"></a>00555 <span class="comment">!</span>
<a name="l00556"></a><a class="code" href="namespaceice__itd.html#a9c2920aedaba5102293185bec0142577">00556</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a9c2920aedaba5102293185bec0142577">rebin</a> (nx_block, ny_block,        &amp;
<a name="l00557"></a>00557                         icells,   indxi,    indxj, &amp;
<a name="l00558"></a>00558                         trcr_depend,               &amp;
<a name="l00559"></a>00559                         aicen,    trcrn,           &amp;
<a name="l00560"></a>00560                         vicen,    vsnon,           &amp;
<a name="l00561"></a>00561                         eicen,    esnon,           &amp;
<a name="l00562"></a>00562                         l_stop,                    &amp;
<a name="l00563"></a>00563                         istop,    jstop)
<a name="l00564"></a>00564 <span class="comment">!</span>
<a name="l00565"></a>00565 <span class="comment">! !DESCRIPTION:</span>
<a name="l00566"></a>00566 <span class="comment">!</span>
<a name="l00567"></a>00567 <span class="comment">! Rebins thicknesses into defined categories</span>
<a name="l00568"></a>00568 <span class="comment">!</span>
<a name="l00569"></a>00569 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00570"></a>00570 <span class="comment">!</span>
<a name="l00571"></a>00571 <span class="comment">! authors: William H. Lipscomb and Elizabeth C. Hunke, LANL</span>
<a name="l00572"></a>00572 <span class="comment">!</span>
<a name="l00573"></a>00573 <span class="comment">! !USES:</span>
<a name="l00574"></a>00574 <span class="comment">!</span>
<a name="l00575"></a>00575 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00576"></a>00576 <span class="comment">!</span>
<a name="l00577"></a>00577       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00578"></a>00578          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l00579"></a>00579          icells                <span class="comment">! number of grid cells with ice</span>
<a name="l00580"></a>00580 
<a name="l00581"></a>00581        <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l00582"></a>00582          <span class="keywordtype">intent(in)</span> :: 
<a name="l00583"></a>00583          indxi, indxj      <span class="comment">! compressed i/j indices</span>
<a name="l00584"></a>00584 
<a name="l00585"></a>00585       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (ntrcr)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00586"></a>00586          trcr_depend <span class="comment">! = 0 for aicen tracers, 1 for vicen, 2 for vsnon</span>
<a name="l00587"></a>00587 
<a name="l00588"></a>00588       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ncat)</span>, 
<a name="l00589"></a>00589          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00590"></a>00590          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l00591"></a>00591          vicen ,  <span class="comment">! volume per unit area of ice           (m)</span>
<a name="l00592"></a>00592          vsnon     <span class="comment">! volume per unit area of snow          (m)</span>
<a name="l00593"></a>00593 
<a name="l00594"></a>00594       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr,ncat)</span>, 
<a name="l00595"></a>00595          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00596"></a>00596          trcrn     <span class="comment">! ice tracers</span>
<a name="l00597"></a>00597 
<a name="l00598"></a>00598       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntilyr)</span>, 
<a name="l00599"></a>00599          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00600"></a>00600          eicen     <span class="comment">! energy of melting for each ice layer  (J/m^2)</span>
<a name="l00601"></a>00601 
<a name="l00602"></a>00602       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntslyr)</span>, 
<a name="l00603"></a>00603          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00604"></a>00604          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l00605"></a>00605 
<a name="l00606"></a>00606       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l00607"></a>00607          l_stop    <span class="comment">! if true, abort on return</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l00610"></a>00610          istop, jstop    <span class="comment">! indices of grid cell where model aborts</span>
<a name="l00611"></a>00611 <span class="comment">!</span>
<a name="l00612"></a>00612 <span class="comment">!EOP</span>
<a name="l00613"></a>00613 <span class="comment">!</span>
<a name="l00614"></a>00614       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00615"></a>00615          i,j          ,  <span class="comment">! horizontal indices</span>
<a name="l00616"></a>00616          n            ,  <span class="comment">! category index</span>
<a name="l00617"></a>00617          ij                <span class="comment">! combined horizontal index</span>
<a name="l00618"></a>00618 
<a name="l00619"></a>00619       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l00620"></a>00620          shiftflag          <span class="comment">! = .true. if ice must be shifted</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells,ncat) </span>:: 
<a name="l00623"></a>00623          donor              <span class="comment">! donor category index</span>
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,ncat) </span>:: 
<a name="l00626"></a>00626          daice          ,  <span class="comment">! ice area transferred</span>
<a name="l00627"></a>00627          dvice          ,  <span class="comment">! ice volume transferred</span>
<a name="l00628"></a>00628          hicen              <span class="comment">! ice thickness for each cat (m)</span>
<a name="l00629"></a>00629 
<a name="l00630"></a>00630       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00631"></a>00631       <span class="comment">! Initialize</span>
<a name="l00632"></a>00632       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00633"></a>00633 
<a name="l00634"></a>00634       l_stop = .false.
<a name="l00635"></a>00635       istop = 0
<a name="l00636"></a>00636       jstop = 0
<a name="l00637"></a>00637 
<a name="l00638"></a>00638       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l00639"></a>00639          <span class="keyword">do</span> ij = 1, icells       <span class="comment">! aice(i,j) &gt; puny</span>
<a name="l00640"></a>00640             i = indxi(ij)
<a name="l00641"></a>00641             j = indxj(ij)
<a name="l00642"></a>00642 
<a name="l00643"></a>00643             donor(ij,n) = 0
<a name="l00644"></a>00644             daice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00645"></a>00645             dvice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00646"></a>00646 
<a name="l00647"></a>00647       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00648"></a>00648       <span class="comment">! Compute ice thickness.</span>
<a name="l00649"></a>00649       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00650"></a>00650             <span class="keyword">if</span> (aicen(i,j,n) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l00651"></a>00651                hicen(ij,n) = vicen(i,j,n) / aicen(i,j,n)
<a name="l00652"></a>00652             <span class="keyword">else</span>
<a name="l00653"></a>00653                hicen(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00654"></a>00654             <span class="keyword">endif</span>
<a name="l00655"></a>00655          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l00656"></a>00656       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l00657"></a>00657 
<a name="l00658"></a>00658       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00659"></a>00659       <span class="comment">! make sure thickness of cat 1 is at least hin_max(0)</span>
<a name="l00660"></a>00660       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00661"></a>00661       <span class="keyword">do</span> ij = 1, icells       <span class="comment">! aice(i,j) &gt; puny</span>
<a name="l00662"></a>00662          i = indxi(ij)
<a name="l00663"></a>00663          j = indxj(ij)
<a name="l00664"></a>00664 
<a name="l00665"></a>00665          <span class="keyword">if</span> (aicen(i,j,1) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l00666"></a>00666             <span class="keyword">if</span> (hicen(ij,1) &lt;= <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) .and. <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a> ) <span class="keyword">then</span>
<a name="l00667"></a>00667                aicen(i,j,1) = vicen(i,j,1) / <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0)
<a name="l00668"></a>00668                hicen(ij,1) = <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0)
<a name="l00669"></a>00669             <span class="keyword">endif</span>
<a name="l00670"></a>00670          <span class="keyword">endif</span>
<a name="l00671"></a>00671       <span class="keyword">enddo</span>                     <span class="comment">! ij</span>
<a name="l00672"></a>00672 
<a name="l00673"></a>00673       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00674"></a>00674       <span class="comment">! If a category thickness is not in bounds, shift the</span>
<a name="l00675"></a>00675       <span class="comment">! entire area, volume, and energy to the neighboring category</span>
<a name="l00676"></a>00676       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00677"></a>00677 
<a name="l00678"></a>00678       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00679"></a>00679       <span class="comment">! Move thin categories up</span>
<a name="l00680"></a>00680       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00681"></a>00681 
<a name="l00682"></a>00682       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>-1          <span class="comment">! loop over category boundaries</span>
<a name="l00683"></a>00683 
<a name="l00684"></a>00684       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00685"></a>00685       <span class="comment">! identify thicknesses that are too big</span>
<a name="l00686"></a>00686       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00687"></a>00687          shiftflag = .false.
<a name="l00688"></a>00688          <span class="keyword">do</span> ij = 1, icells       <span class="comment">! aice(i,j) &gt; puny</span>
<a name="l00689"></a>00689             i = indxi(ij)
<a name="l00690"></a>00690             j = indxj(ij)
<a name="l00691"></a>00691 
<a name="l00692"></a>00692             <span class="keyword">if</span> (aicen(i,j,n) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. &amp;
<a name="l00693"></a>00693                 hicen(ij,n) &gt; <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n)) <span class="keyword">then</span>
<a name="l00694"></a>00694                shiftflag = .true.
<a name="l00695"></a>00695                donor(ij,n) = n
<a name="l00696"></a>00696                daice(ij,n) = aicen(i,j,n)
<a name="l00697"></a>00697                dvice(ij,n) = vicen(i,j,n)
<a name="l00698"></a>00698             <span class="keyword">endif</span>
<a name="l00699"></a>00699          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l00700"></a>00700 
<a name="l00701"></a>00701          <span class="keyword">if</span> (shiftflag) <span class="keyword">then</span>
<a name="l00702"></a>00702 
<a name="l00703"></a>00703       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00704"></a>00704       <span class="comment">! shift ice between categories</span>
<a name="l00705"></a>00705       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00706"></a>00706             call <a class="code" href="namespaceice__itd.html#aa67e5ce0b62a39a084d0058459df445e">shift_ice </a>(nx_block, ny_block,    &amp;
<a name="l00707"></a>00707                             indxi,    indxj,       &amp;
<a name="l00708"></a>00708                             icells,   trcr_depend, &amp;
<a name="l00709"></a>00709                             aicen,    trcrn,       &amp;
<a name="l00710"></a>00710                             vicen,    vsnon,       &amp;
<a name="l00711"></a>00711                             eicen,    esnon,       &amp;
<a name="l00712"></a>00712                             hicen,    donor,       &amp;
<a name="l00713"></a>00713                             daice,    dvice,       &amp;
<a name="l00714"></a>00714                             l_stop,                &amp;
<a name="l00715"></a>00715                             istop,    jstop)
<a name="l00716"></a>00716 
<a name="l00717"></a>00717             <span class="keyword">if</span> (l_stop) return
<a name="l00718"></a>00718 
<a name="l00719"></a>00719       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00720"></a>00720       <span class="comment">! reset shift parameters</span>
<a name="l00721"></a>00721       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00722"></a>00722 
<a name="l00723"></a>00723          <span class="keyword">do</span> ij = 1, icells       <span class="comment">! aice(i,j) &gt; puny</span>
<a name="l00724"></a>00724             donor(ij,n) = 0
<a name="l00725"></a>00725             daice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00726"></a>00726             dvice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00727"></a>00727          <span class="keyword">enddo</span>
<a name="l00728"></a>00728 
<a name="l00729"></a>00729          <span class="keyword">endif</span>                  <span class="comment">! shiftflag</span>
<a name="l00730"></a>00730 
<a name="l00731"></a>00731       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l00732"></a>00732 
<a name="l00733"></a>00733       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00734"></a>00734       <span class="comment">! Move thick categories down</span>
<a name="l00735"></a>00735       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00736"></a>00736 
<a name="l00737"></a>00737       <span class="keyword">do</span> n = <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>-1, 1, -1      <span class="comment">! loop over category boundaries</span>
<a name="l00738"></a>00738 
<a name="l00739"></a>00739       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00740"></a>00740       <span class="comment">! identify thicknesses that are too small</span>
<a name="l00741"></a>00741       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00742"></a>00742          shiftflag = .false.
<a name="l00743"></a>00743          <span class="keyword">do</span> ij = 1, icells       <span class="comment">! aice(i,j) &gt; puny</span>
<a name="l00744"></a>00744             i = indxi(ij)
<a name="l00745"></a>00745             j = indxj(ij)
<a name="l00746"></a>00746 
<a name="l00747"></a>00747             <span class="keyword">if</span> (aicen(i,j,n+1) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. &amp;
<a name="l00748"></a>00748                 hicen(ij,n+1) &lt;= <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(n)) <span class="keyword">then</span>
<a name="l00749"></a>00749                shiftflag = .true.
<a name="l00750"></a>00750                donor(ij,n) = n+1
<a name="l00751"></a>00751                daice(ij,n) = aicen(i,j,n+1)
<a name="l00752"></a>00752                dvice(ij,n) = vicen(i,j,n+1)
<a name="l00753"></a>00753             <span class="keyword">endif</span>
<a name="l00754"></a>00754          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l00755"></a>00755 
<a name="l00756"></a>00756          <span class="keyword">if</span> (shiftflag) <span class="keyword">then</span>
<a name="l00757"></a>00757 
<a name="l00758"></a>00758       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00759"></a>00759       <span class="comment">! shift ice between categories</span>
<a name="l00760"></a>00760       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00761"></a>00761             call <a class="code" href="namespaceice__itd.html#aa67e5ce0b62a39a084d0058459df445e">shift_ice </a>(nx_block, ny_block,    &amp;
<a name="l00762"></a>00762                             indxi,    indxj,       &amp;
<a name="l00763"></a>00763                             icells,   trcr_depend, &amp;
<a name="l00764"></a>00764                             aicen,    trcrn,       &amp;
<a name="l00765"></a>00765                             vicen,    vsnon,       &amp;
<a name="l00766"></a>00766                             eicen,    esnon,       &amp;
<a name="l00767"></a>00767                             hicen,    donor,       &amp;
<a name="l00768"></a>00768                             daice,    dvice,       &amp;
<a name="l00769"></a>00769                             l_stop,                &amp;
<a name="l00770"></a>00770                             istop,    jstop)
<a name="l00771"></a>00771 
<a name="l00772"></a>00772             <span class="keyword">if</span> (l_stop) return
<a name="l00773"></a>00773 
<a name="l00774"></a>00774       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00775"></a>00775       <span class="comment">! reset shift parameters</span>
<a name="l00776"></a>00776       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l00777"></a>00777 
<a name="l00778"></a>00778          <span class="keyword">do</span> ij = 1, icells       <span class="comment">! aice(i,j) &gt; puny</span>
<a name="l00779"></a>00779             donor(ij,n) = 0
<a name="l00780"></a>00780             daice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00781"></a>00781             dvice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00782"></a>00782          <span class="keyword">enddo</span>
<a name="l00783"></a>00783 
<a name="l00784"></a>00784          <span class="keyword">endif</span>                  <span class="comment">! shiftflag</span>
<a name="l00785"></a>00785 
<a name="l00786"></a>00786       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l00787"></a>00787 
<a name="l00788"></a>00788 
<a name="l00789"></a>00789 <span class="keyword">      end subroutine rebin</span>
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="comment">!=======================================================================</span>
<a name="l00792"></a>00792 <span class="comment">!BOP</span>
<a name="l00793"></a>00793 <span class="comment">!</span>
<a name="l00794"></a>00794 <span class="comment">! !IROUTINE: reduce_area - reduce area when ice melts for special case ncat=1</span>
<a name="l00795"></a>00795 <span class="comment">!</span>
<a name="l00796"></a>00796 <span class="comment">! !INTERFACE:</span>
<a name="l00797"></a>00797 <span class="comment">!</span>
<a name="l00798"></a><a class="code" href="namespaceice__itd.html#aebf0bc54e5651ee1e36e7562ecaa4d73">00798</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#aebf0bc54e5651ee1e36e7562ecaa4d73">reduce_area</a> (nx_block, ny_block, &amp;
<a name="l00799"></a>00799                               ilo, ihi, jlo, jhi, &amp;
<a name="l00800"></a>00800                               tmask,              &amp;
<a name="l00801"></a>00801                               aicen,     vicen,   &amp;
<a name="l00802"></a>00802                               aicen_init,vicen_init)
<a name="l00803"></a>00803 <span class="comment">!</span>
<a name="l00804"></a>00804 <span class="comment">! !DESCRIPTION:</span>
<a name="l00805"></a>00805 <span class="comment">!</span>
<a name="l00806"></a>00806 <span class="comment">! Reduce area when ice melts for special case of ncat=1</span>
<a name="l00807"></a>00807 <span class="comment">!</span>
<a name="l00808"></a>00808 <span class="comment">! Use CSM 1.0-like method of reducing ice area</span>
<a name="l00809"></a>00809 <span class="comment">! when melting occurs: assume only half the ice volume</span>
<a name="l00810"></a>00810 <span class="comment">! change goes to thickness decrease, the other half</span>
<a name="l00811"></a>00811 <span class="comment">! to reduction in ice fraction</span>
<a name="l00812"></a>00812 <span class="comment">!</span>
<a name="l00813"></a>00813 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00814"></a>00814 <span class="comment">!</span>
<a name="l00815"></a>00815 <span class="comment">! authors: C. M. Bitz, UW</span>
<a name="l00816"></a>00816 <span class="comment">! modified by: Elizabeth C. Hunke, LANL</span>
<a name="l00817"></a>00817 <span class="comment">!</span>
<a name="l00818"></a>00818 <span class="comment">! !USES:</span>
<a name="l00819"></a>00819 <span class="comment">!</span>
<a name="l00820"></a>00820 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00821"></a>00821 <span class="comment">!</span>
<a name="l00822"></a>00822       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00823"></a>00823          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l00824"></a>00824          ilo,ihi,jlo,jhi       <span class="comment">! beginning and end of physical domain</span>
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l00827"></a>00827          <span class="keywordtype">intent(in)</span> :: 
<a name="l00828"></a>00828          tmask     <span class="comment">! land/boundary mask, thickness (T-cell)</span>
<a name="l00829"></a>00829 
<a name="l00830"></a>00830       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l00831"></a>00831          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00832"></a>00832          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l00833"></a>00833          vicen     <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l00834"></a>00834 
<a name="l00835"></a>00835       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00836"></a>00836          aicen_init,  <span class="comment">! old ice area for category 1 (m)</span>
<a name="l00837"></a>00837          vicen_init    <span class="comment">! old ice volume for category 1 (m)</span>
<a name="l00838"></a>00838 <span class="comment">!</span>
<a name="l00839"></a>00839 <span class="comment">!EOP</span>
<a name="l00840"></a>00840 <span class="comment">!</span>
<a name="l00841"></a>00841       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00842"></a>00842          i, j        <span class="comment">! horizontal indices</span>
<a name="l00843"></a>00843 
<a name="l00844"></a>00844       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00845"></a>00845          hi0     ,  <span class="comment">! initial hi</span>
<a name="l00846"></a>00846          hi1     ,  <span class="comment">! current hi</span>
<a name="l00847"></a>00847          dhi         <span class="comment">! hi1 - hi0</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849       <span class="keyword">do</span> j = jlo, jhi
<a name="l00850"></a>00850       <span class="keyword">do</span> i = ilo, ihi
<a name="l00851"></a>00851          <span class="keyword">if</span> (tmask(i,j)) <span class="keyword">then</span>
<a name="l00852"></a>00852 
<a name="l00853"></a>00853             hi0 = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00854"></a>00854             <span class="keyword">if</span> (aicen_init(i,j) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) &amp;
<a name="l00855"></a>00855                 hi0 = vicen_init(i,j) / aicen_init(i,j)
<a name="l00856"></a>00856 
<a name="l00857"></a>00857             hi1 = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l00858"></a>00858             <span class="keyword">if</span> (aicen(i,j) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) &amp;
<a name="l00859"></a>00859                 hi1 = vicen(i,j) / aicen(i,j)
<a name="l00860"></a>00860 
<a name="l00861"></a>00861             <span class="comment">! make sure thickness of cat 1 is at least hin_max(0)</span>
<a name="l00862"></a>00862             <span class="keyword">if</span> (hi1 &lt;= <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) .and. <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a> ) <span class="keyword">then</span>
<a name="l00863"></a>00863                aicen(i,j) = vicen(i,j) / <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0)
<a name="l00864"></a>00864                hi1 = <a class="code" href="namespaceice__itd.html#aa7b9ac33772390c73597dec2ed768aba">hin_max</a>(0)
<a name="l00865"></a>00865             <span class="keyword">endif</span>
<a name="l00866"></a>00866 
<a name="l00867"></a>00867             <span class="keyword">if</span> (aicen(i,j) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l00868"></a>00868                dhi = hi1 - hi0
<a name="l00869"></a>00869                <span class="keyword">if</span> (dhi &lt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l00870"></a>00870                   hi1  = vicen(i,j) / aicen(i,j)
<a name="l00871"></a>00871                   aicen(i,j) = <a class="code" href="namespaceice__constants.html#a683e0c28523a17a5d2cd40066167570a">c2</a> * vicen(i,j) / (hi1 + hi0)
<a name="l00872"></a>00872                <span class="keyword">endif</span>
<a name="l00873"></a>00873             <span class="keyword">endif</span>
<a name="l00874"></a>00874 
<a name="l00875"></a>00875          <span class="keyword">endif</span>                  <span class="comment">! tmask</span>
<a name="l00876"></a>00876       <span class="keyword">enddo</span>                     <span class="comment">! i</span>
<a name="l00877"></a>00877       <span class="keyword">enddo</span>                     <span class="comment">! j</span>
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 <span class="keyword">      end subroutine reduce_area</span>
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 <span class="comment">!=======================================================================</span>
<a name="l00882"></a>00882 <span class="comment">!BOP</span>
<a name="l00883"></a>00883 <span class="comment">!</span>
<a name="l00884"></a>00884 <span class="comment">! !IROUTINE: shift_ice - shift ice across category boundaries</span>
<a name="l00885"></a>00885 <span class="comment">!</span>
<a name="l00886"></a>00886 <span class="comment">! !INTERFACE:</span>
<a name="l00887"></a>00887 <span class="comment">!</span>
<a name="l00888"></a><a class="code" href="namespaceice__itd.html#aa67e5ce0b62a39a084d0058459df445e">00888</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#aa67e5ce0b62a39a084d0058459df445e">shift_ice</a> (nx_block, ny_block,    &amp;
<a name="l00889"></a>00889                             indxi,    indxj,       &amp;
<a name="l00890"></a>00890                             icells,   trcr_depend, &amp;
<a name="l00891"></a>00891                             aicen,    trcrn,       &amp;
<a name="l00892"></a>00892                             vicen,    vsnon,       &amp;
<a name="l00893"></a>00893                             eicen,    esnon,       &amp;
<a name="l00894"></a>00894                             hicen,    donor,       &amp;
<a name="l00895"></a>00895                             daice,    dvice,       &amp;
<a name="l00896"></a>00896                             l_stop,                &amp;
<a name="l00897"></a>00897                             istop,    jstop)
<a name="l00898"></a>00898 <span class="comment">!</span>
<a name="l00899"></a>00899 <span class="comment">! !DESCRIPTION:</span>
<a name="l00900"></a>00900 <span class="comment">!</span>
<a name="l00901"></a>00901 <span class="comment">! Shift ice across category boundaries, conserving area, volume, and</span>
<a name="l00902"></a>00902 <span class="comment">! energy.</span>
<a name="l00903"></a>00903 <span class="comment">!</span>
<a name="l00904"></a>00904 <span class="comment">! !REVISION HISTORY:</span>
<a name="l00905"></a>00905 <span class="comment">!</span>
<a name="l00906"></a>00906 <span class="comment">! authors: William H. Lipscomb and Elizabeth C. Hunke, LANL</span>
<a name="l00907"></a>00907 <span class="comment">!</span>
<a name="l00908"></a>00908 <span class="comment">! !USES:</span>
<a name="l00909"></a>00909 <span class="comment">!</span>
<a name="l00910"></a>00910 <span class="comment">!</span>
<a name="l00911"></a>00911 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l00912"></a>00912 <span class="comment">!</span>
<a name="l00913"></a>00913       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00914"></a>00914          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l00915"></a>00915          icells                <span class="comment">! number of ocean/ice cells</span>
<a name="l00916"></a>00916 
<a name="l00917"></a>00917       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l00918"></a>00918          <span class="keywordtype">intent(in)</span> :: 
<a name="l00919"></a>00919          indxi             ,  <span class="comment">! compressed indices in i/j directions</span>
<a name="l00920"></a>00920          indxj
<a name="l00921"></a>00921 
<a name="l00922"></a>00922       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (ntrcr)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l00923"></a>00923          trcr_depend <span class="comment">! = 0 for aicen tracers, 1 for vicen, 2 for vsnon</span>
<a name="l00924"></a>00924 
<a name="l00925"></a>00925       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ncat)</span>, 
<a name="l00926"></a>00926          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00927"></a>00927          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l00928"></a>00928          vicen ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l00929"></a>00929          vsnon     <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l00930"></a>00930 
<a name="l00931"></a>00931       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr,ncat)</span>, 
<a name="l00932"></a>00932          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00933"></a>00933          trcrn     <span class="comment">! ice tracers</span>
<a name="l00934"></a>00934 
<a name="l00935"></a>00935       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntilyr)</span>, 
<a name="l00936"></a>00936          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00937"></a>00937          eicen     <span class="comment">! energy of melting for each ice layer (J/m^2)</span>
<a name="l00938"></a>00938 
<a name="l00939"></a>00939       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntslyr)</span>, 
<a name="l00940"></a>00940          <span class="keywordtype">intent(inout)</span> :: 
<a name="l00941"></a>00941          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l00942"></a>00942 
<a name="l00943"></a>00943       <span class="comment">! NOTE: Third index of donor, daice, dvice should be ncat-1,</span>
<a name="l00944"></a>00944       <span class="comment">!       except that compilers would have trouble when ncat = 1 </span>
<a name="l00945"></a>00945       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(icells,ncat)</span>, 
<a name="l00946"></a>00946          <span class="keywordtype">intent(in)</span> :: 
<a name="l00947"></a>00947          donor             <span class="comment">! donor category index</span>
<a name="l00948"></a>00948 
<a name="l00949"></a>00949       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells,ncat)</span>, 
<a name="l00950"></a>00950            <span class="keywordtype">intent(inout)</span> :: 
<a name="l00951"></a>00951          daice         ,  <span class="comment">! ice area transferred across boundary</span>
<a name="l00952"></a>00952          dvice         ,  <span class="comment">! ice volume transferred across boundary</span>
<a name="l00953"></a>00953          hicen             <span class="comment">! ice thickness for each cat        (m)</span>
<a name="l00954"></a>00954 
<a name="l00955"></a>00955       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l00956"></a>00956          l_stop    <span class="comment">! if true, abort on return</span>
<a name="l00957"></a>00957 
<a name="l00958"></a>00958       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l00959"></a>00959          istop, jstop    <span class="comment">! indices of grid cell where model aborts</span>
<a name="l00960"></a>00960 <span class="comment">!</span>
<a name="l00961"></a>00961 <span class="comment">!EOP</span>
<a name="l00962"></a>00962 <span class="comment">!</span>
<a name="l00963"></a>00963       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00964"></a>00964          i, j, m       ,  <span class="comment">! horizontal indices</span>
<a name="l00965"></a>00965          n             ,  <span class="comment">! thickness category index</span>
<a name="l00966"></a>00966          nr            ,  <span class="comment">! receiver category</span>
<a name="l00967"></a>00967          nd            ,  <span class="comment">! donor category</span>
<a name="l00968"></a>00968          k             ,  <span class="comment">! ice layer index</span>
<a name="l00969"></a>00969          it            ,  <span class="comment">! tracer index</span>
<a name="l00970"></a>00970          ilo,ihi,jlo,jhi   <span class="comment">! beginning and end of physical domain</span>
<a name="l00971"></a>00971 
<a name="l00972"></a>00972       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells,ntrcr,ncat) </span>:: 
<a name="l00973"></a>00973          atrcrn            <span class="comment">! aicen*trcrn</span>
<a name="l00974"></a>00974 
<a name="l00975"></a>00975       <span class="keywordtype">real (kind=dbl_kind) </span>:: 
<a name="l00976"></a>00976          dvsnow        ,  <span class="comment">! snow volume transferred</span>
<a name="l00977"></a>00977          desnow        ,  <span class="comment">! snow energy transferred</span>
<a name="l00978"></a>00978          deice         ,  <span class="comment">! ice energy transferred</span>
<a name="l00979"></a>00979          datrcr            <span class="comment">! aicen*train transferred</span>
<a name="l00980"></a>00980 
<a name="l00981"></a>00981       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (icells) </span>:: 
<a name="l00982"></a>00982         indxii       ,  <span class="comment">! compressed indices for i/j directions</span>
<a name="l00983"></a>00983         indxjj       , 
<a name="l00984"></a>00984         indxij
<a name="l00985"></a>00985 
<a name="l00986"></a>00986       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l00987"></a>00987         ishift      ,  <span class="comment">! number of cells with ice to transfer</span>
<a name="l00988"></a>00988         ij              <span class="comment">! combined i/j horizontal index</span>
<a name="l00989"></a>00989 
<a name="l00990"></a>00990       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l00991"></a>00991         daice_negative     ,  <span class="comment">! true if daice &lt; -puny</span>
<a name="l00992"></a>00992         dvice_negative     ,  <span class="comment">! true if dvice &lt; -puny</span>
<a name="l00993"></a>00993         daice_greater_aicen,  <span class="comment">! true if daice &gt; aicen</span>
<a name="l00994"></a>00994         dvice_greater_vicen    <span class="comment">! true if dvice &gt; vicen</span>
<a name="l00995"></a>00995 
<a name="l00996"></a>00996       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block) </span>:: 
<a name="l00997"></a>00997          worka, 
<a name="l00998"></a>00998          workb
<a name="l00999"></a>00999 
<a name="l01000"></a>01000       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01001"></a>01001       <span class="comment">! Initialize</span>
<a name="l01002"></a>01002       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01003"></a>01003 
<a name="l01004"></a>01004       l_stop = .false.
<a name="l01005"></a>01005       istop = 0
<a name="l01006"></a>01006       jstop = 0
<a name="l01007"></a>01007 
<a name="l01008"></a>01008       worka(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01009"></a>01009       workb(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01010"></a>01010 
<a name="l01011"></a>01011       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01012"></a>01012       <span class="comment">! Define variables equal to aicen*trcrn, vicen*trcrn, vsnon*trcrn</span>
<a name="l01013"></a>01013       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01014"></a>01014 
<a name="l01015"></a>01015       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l01016"></a>01016          <span class="keyword">do</span> it = 1, ntrcr
<a name="l01017"></a>01017             <span class="keyword">if</span> (trcr_depend(it) == 0) <span class="keyword">then</span> <span class="comment">! ice area tracer</span>
<a name="l01018"></a>01018                <span class="keyword">do</span> ij = 1, icells
<a name="l01019"></a>01019                   i = indxi(ij)
<a name="l01020"></a>01020                   j = indxj(ij)
<a name="l01021"></a>01021                   atrcrn(ij,it,n) = aicen(i,j,n)*trcrn(i,j,it,n)
<a name="l01022"></a>01022                <span class="keyword">enddo</span>
<a name="l01023"></a>01023             elseif (trcr_depend(it) ==1) <span class="keyword">then</span>  <span class="comment">! ice volume tracer</span>
<a name="l01024"></a>01024                <span class="keyword">do</span> ij = 1, icells
<a name="l01025"></a>01025                   i = indxi(ij)
<a name="l01026"></a>01026                   j = indxj(ij)
<a name="l01027"></a>01027                   atrcrn(ij,it,n) = vicen(i,j,n)*trcrn(i,j,it,n)
<a name="l01028"></a>01028                <span class="keyword">enddo</span>
<a name="l01029"></a>01029             elseif (trcr_depend(it) ==2) <span class="keyword">then</span>  <span class="comment">! snow volume tracer</span>
<a name="l01030"></a>01030                <span class="keyword">do</span> ij = 1, icells
<a name="l01031"></a>01031                   i = indxi(ij)
<a name="l01032"></a>01032                   j = indxj(ij)
<a name="l01033"></a>01033                   atrcrn(ij,it,n) = vsnon(i,j,n)*trcrn(i,j,it,n)
<a name="l01034"></a>01034                <span class="keyword">enddo</span>
<a name="l01035"></a>01035             <span class="keyword">endif</span>
<a name="l01036"></a>01036          <span class="keyword">enddo</span>
<a name="l01037"></a>01037       <span class="keyword">enddo</span>
<a name="l01038"></a>01038 
<a name="l01039"></a>01039       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01040"></a>01040       <span class="comment">! Check for daice or dvice out of range, allowing for roundoff error</span>
<a name="l01041"></a>01041       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01042"></a>01042 
<a name="l01043"></a>01043       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>-1
<a name="l01044"></a>01044 
<a name="l01045"></a>01045          daice_negative = .false.
<a name="l01046"></a>01046          dvice_negative = .false.
<a name="l01047"></a>01047          daice_greater_aicen = .false.
<a name="l01048"></a>01048          dvice_greater_vicen = .false.
<a name="l01049"></a>01049 
<a name="l01050"></a>01050 
<a name="l01051"></a>01051          <span class="keyword">do</span> ij = 1, icells
<a name="l01052"></a>01052             i = indxi(ij)
<a name="l01053"></a>01053             j = indxj(ij)
<a name="l01054"></a>01054 
<a name="l01055"></a>01055             <span class="keyword">if</span> (donor(ij,n) &gt; 0) <span class="keyword">then</span>
<a name="l01056"></a>01056                nd = donor(ij,n)
<a name="l01057"></a>01057 
<a name="l01058"></a>01058                <span class="keyword">if</span> (daice(ij,n) &lt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l01059"></a>01059                   <span class="keyword">if</span> (daice(ij,n) &gt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*aicen(i,j,nd)) <span class="keyword">then</span>
<a name="l01060"></a>01060                      daice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a> <span class="comment">! shift no ice</span>
<a name="l01061"></a>01061                      dvice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01062"></a>01062                   <span class="keyword">else</span>
<a name="l01063"></a>01063                      daice_negative = .true.
<a name="l01064"></a>01064                   <span class="keyword">endif</span>
<a name="l01065"></a>01065                <span class="keyword">endif</span>
<a name="l01066"></a>01066          
<a name="l01067"></a>01067                <span class="keyword">if</span> (dvice(ij,n) &lt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span>
<a name="l01068"></a>01068                   <span class="keyword">if</span> (dvice(ij,n) &gt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*vicen(i,j,nd)) <span class="keyword">then</span>   
<a name="l01069"></a>01069                      daice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a> <span class="comment">! shift no ice</span>
<a name="l01070"></a>01070                      dvice(ij,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01071"></a>01071                   <span class="keyword">else</span>
<a name="l01072"></a>01072                      dvice_negative = .true.
<a name="l01073"></a>01073                   <span class="keyword">endif</span>
<a name="l01074"></a>01074                <span class="keyword">endif</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076                <span class="keyword">if</span> (daice(ij,n) &gt; aicen(i,j,nd)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>-<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01077"></a>01077                   <span class="keyword">if</span> (daice(ij,n) &lt; aicen(i,j,nd)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01078"></a>01078                      daice(ij,n) = aicen(i,j,nd)
<a name="l01079"></a>01079                      dvice(ij,n) = vicen(i,j,nd)
<a name="l01080"></a>01080                   <span class="keyword">else</span>
<a name="l01081"></a>01081                      daice_greater_aicen = .true.
<a name="l01082"></a>01082                   <span class="keyword">endif</span>
<a name="l01083"></a>01083                <span class="keyword">endif</span>    
<a name="l01084"></a>01084 
<a name="l01085"></a>01085                <span class="keyword">if</span> (dvice(ij,n) &gt; vicen(i,j,nd)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>-<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01086"></a>01086                   <span class="keyword">if</span> (dvice(ij,n) &lt; vicen(i,j,nd)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01087"></a>01087                      daice(ij,n) = aicen(i,j,nd)
<a name="l01088"></a>01088                      dvice(ij,n) = vicen(i,j,nd)
<a name="l01089"></a>01089                   <span class="keyword">else</span>
<a name="l01090"></a>01090                      dvice_greater_vicen = .true.
<a name="l01091"></a>01091                   <span class="keyword">endif</span>
<a name="l01092"></a>01092                <span class="keyword">endif</span>
<a name="l01093"></a>01093 
<a name="l01094"></a>01094             <span class="keyword">endif</span>               <span class="comment">! donor &gt; 0</span>
<a name="l01095"></a>01095          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01096"></a>01096 
<a name="l01097"></a>01097       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01098"></a>01098       <span class="comment">! error messages</span>
<a name="l01099"></a>01099       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01100"></a>01100 
<a name="l01101"></a>01101          <span class="keyword">if</span> (daice_negative) <span class="keyword">then</span>
<a name="l01102"></a>01102          <span class="keyword">do</span> ij = 1, icells
<a name="l01103"></a>01103             i = indxi(ij)
<a name="l01104"></a>01104             j = indxj(ij)
<a name="l01105"></a>01105 
<a name="l01106"></a>01106                <span class="keyword">if</span> (donor(ij,n) &gt; 0 .and.  &amp;
<a name="l01107"></a>01107                    daice(ij,n) &lt;= -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*aicen(i,j,nd)) <span class="keyword">then</span>
<a name="l01108"></a>01108                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01109"></a>01109                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;shift_ice: negative daice&apos;</span>
<a name="l01110"></a>01110                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j:&apos;</span>, i, j
<a name="l01111"></a>01111                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;boundary, donor cat:&apos;</span>, n, nd
<a name="l01112"></a>01112                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;daice =&apos;</span>, daice(ij,n)
<a name="l01113"></a>01113                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;dvice =&apos;</span>, dvice(ij,n)
<a name="l01114"></a>01114                   l_stop = .true.
<a name="l01115"></a>01115                   istop = i
<a name="l01116"></a>01116                   jstop = j
<a name="l01117"></a>01117                <span class="keyword">endif</span>
<a name="l01118"></a>01118             <span class="keyword">enddo</span>
<a name="l01119"></a>01119          <span class="keyword">endif</span>
<a name="l01120"></a>01120          <span class="keyword">if</span> (l_stop) return
<a name="l01121"></a>01121 
<a name="l01122"></a>01122          <span class="keyword">if</span> (dvice_negative) <span class="keyword">then</span>
<a name="l01123"></a>01123          <span class="keyword">do</span> ij = 1, icells
<a name="l01124"></a>01124             i = indxi(ij)
<a name="l01125"></a>01125             j = indxj(ij)
<a name="l01126"></a>01126 
<a name="l01127"></a>01127                <span class="keyword">if</span> (donor(ij,n) &gt; 0 .and.  &amp;
<a name="l01128"></a>01128                    dvice(ij,n) &lt;= -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>*vicen(i,j,nd)) <span class="keyword">then</span>
<a name="l01129"></a>01129                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01130"></a>01130                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;shift_ice: negative dvice&apos;</span>
<a name="l01131"></a>01131                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j:&apos;</span>, i, j
<a name="l01132"></a>01132                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;boundary, donor cat:&apos;</span>, n, nd
<a name="l01133"></a>01133                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;daice =&apos;</span>, daice(ij,n)
<a name="l01134"></a>01134                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;dvice =&apos;</span>, dvice(ij,n)
<a name="l01135"></a>01135                   l_stop = .true.
<a name="l01136"></a>01136                   istop = i
<a name="l01137"></a>01137                   jstop = j
<a name="l01138"></a>01138                <span class="keyword">endif</span>
<a name="l01139"></a>01139             <span class="keyword">enddo</span>
<a name="l01140"></a>01140          <span class="keyword">endif</span>
<a name="l01141"></a>01141          <span class="keyword">if</span> (l_stop) return
<a name="l01142"></a>01142 
<a name="l01143"></a>01143          <span class="keyword">if</span> (daice_greater_aicen) <span class="keyword">then</span>
<a name="l01144"></a>01144          <span class="keyword">do</span> ij = 1, icells
<a name="l01145"></a>01145             i = indxi(ij)
<a name="l01146"></a>01146             j = indxj(ij)
<a name="l01147"></a>01147 
<a name="l01148"></a>01148                <span class="keyword">if</span> (donor(ij,n) &gt; 0) <span class="keyword">then</span>
<a name="l01149"></a>01149                   nd = donor(ij,n)
<a name="l01150"></a>01150                   <span class="keyword">if</span> (daice(ij,n) &gt;= aicen(i,j,nd)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01151"></a>01151                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01152"></a>01152                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;shift_ice: daice &gt; aicen&apos;</span>
<a name="l01153"></a>01153                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j:&apos;</span>, i, j
<a name="l01154"></a>01154                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;boundary, donor cat:&apos;</span>, n, nd
<a name="l01155"></a>01155                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;daice =&apos;</span>, daice(ij,n)
<a name="l01156"></a>01156                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;aicen =&apos;</span>, aicen(i,j,nd)
<a name="l01157"></a>01157                      l_stop = .true.
<a name="l01158"></a>01158                      istop = i
<a name="l01159"></a>01159                      jstop = j
<a name="l01160"></a>01160                   <span class="keyword">endif</span>
<a name="l01161"></a>01161                <span class="keyword">endif</span>
<a name="l01162"></a>01162             <span class="keyword">enddo</span>
<a name="l01163"></a>01163          <span class="keyword">endif</span>
<a name="l01164"></a>01164          <span class="keyword">if</span> (l_stop) return
<a name="l01165"></a>01165 
<a name="l01166"></a>01166          <span class="keyword">if</span> (dvice_greater_vicen) <span class="keyword">then</span>
<a name="l01167"></a>01167          <span class="keyword">do</span> ij = 1, icells
<a name="l01168"></a>01168             i = indxi(ij)
<a name="l01169"></a>01169             j = indxj(ij)
<a name="l01170"></a>01170 
<a name="l01171"></a>01171                <span class="keyword">if</span> (donor(ij,n) &gt; 0) <span class="keyword">then</span>
<a name="l01172"></a>01172                   nd = donor(ij,n)
<a name="l01173"></a>01173                   <span class="keyword">if</span> (dvice(ij,n) &gt;= vicen(i,j,nd)*(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01174"></a>01174                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01175"></a>01175                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;shift_ice: dvice &gt; vicen&apos;</span>
<a name="l01176"></a>01176                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j:&apos;</span>, i, j
<a name="l01177"></a>01177                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;boundary, donor cat:&apos;</span>, n, nd
<a name="l01178"></a>01178                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;dvice =&apos;</span>, dvice(ij,n)
<a name="l01179"></a>01179                      <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;vicen =&apos;</span>, vicen(i,j,nd)
<a name="l01180"></a>01180                      l_stop = .true.
<a name="l01181"></a>01181                      istop = i
<a name="l01182"></a>01182                      jstop = j
<a name="l01183"></a>01183                   <span class="keyword">endif</span>
<a name="l01184"></a>01184                <span class="keyword">endif</span>
<a name="l01185"></a>01185             <span class="keyword">enddo</span>
<a name="l01186"></a>01186          <span class="keyword">endif</span>
<a name="l01187"></a>01187          <span class="keyword">if</span> (l_stop) return
<a name="l01188"></a>01188 
<a name="l01189"></a>01189       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01190"></a>01190       <span class="comment">! transfer volume and energy between categories</span>
<a name="l01191"></a>01191       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01192"></a>01192 
<a name="l01193"></a>01193          ishift = 0
<a name="l01194"></a>01194          <span class="keyword">do</span> ij = 1, icells
<a name="l01195"></a>01195             i = indxi(ij)
<a name="l01196"></a>01196             j = indxj(ij)
<a name="l01197"></a>01197 
<a name="l01198"></a>01198            <span class="keyword">if</span> (daice(ij,n) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) <span class="keyword">then</span> <span class="comment">! daice(n) can be &lt; puny</span>
<a name="l01199"></a>01199              ishift = ishift + 1
<a name="l01200"></a>01200              indxii(ishift) = i
<a name="l01201"></a>01201              indxjj(ishift) = j
<a name="l01202"></a>01202              indxij(ishift) = ij
<a name="l01203"></a>01203            <span class="keyword">endif</span>   <span class="comment">! tmask</span>
<a name="l01204"></a>01204          <span class="keyword">enddo</span>
<a name="l01205"></a>01205 
<a name="l01206"></a>01206 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01207"></a>01207 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01208"></a>01208 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01209"></a>01209          <span class="keyword">do</span> ij = 1, ishift
<a name="l01210"></a>01210             i = indxii(ij)
<a name="l01211"></a>01211             j = indxjj(ij)
<a name="l01212"></a>01212             m = indxij(ij)
<a name="l01213"></a>01213 
<a name="l01214"></a>01214             nd = donor(m,n)
<a name="l01215"></a>01215             worka(i,j) = dvice(m,n) / vicen(i,j,nd)
<a name="l01216"></a>01216             <span class="keyword">if</span> (nd  ==  n) <span class="keyword">then</span>
<a name="l01217"></a>01217                nr = nd+1
<a name="l01218"></a>01218             <span class="keyword">else</span>                <span class="comment">! nd = n+1</span>
<a name="l01219"></a>01219                nr = n
<a name="l01220"></a>01220             <span class="keyword">endif</span>
<a name="l01221"></a>01221 
<a name="l01222"></a>01222             aicen(i,j,nd) = aicen(i,j,nd) - daice(m,n)
<a name="l01223"></a>01223             aicen(i,j,nr) = aicen(i,j,nr) + daice(m,n)
<a name="l01224"></a>01224 
<a name="l01225"></a>01225             vicen(i,j,nd) = vicen(i,j,nd) - dvice(m,n)
<a name="l01226"></a>01226             vicen(i,j,nr) = vicen(i,j,nr) + dvice(m,n)
<a name="l01227"></a>01227 
<a name="l01228"></a>01228             dvsnow = vsnon(i,j,nd) * worka(i,j)
<a name="l01229"></a>01229             vsnon(i,j,nd) = vsnon(i,j,nd) - dvsnow
<a name="l01230"></a>01230             vsnon(i,j,nr) = vsnon(i,j,nr) + dvsnow
<a name="l01231"></a>01231             workb(i,j) = dvsnow
<a name="l01232"></a>01232 
<a name="l01233"></a>01233          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01234"></a>01234 
<a name="l01235"></a>01235          <span class="keyword">do</span> it = 1, ntrcr
<a name="l01236"></a>01236 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01237"></a>01237 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01238"></a>01238 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01239"></a>01239             <span class="keyword">do</span> ij = 1, ishift
<a name="l01240"></a>01240                i = indxii(ij)
<a name="l01241"></a>01241                j = indxjj(ij)
<a name="l01242"></a>01242                m = indxij(ij)
<a name="l01243"></a>01243 
<a name="l01244"></a>01244                nd = donor(m,n)
<a name="l01245"></a>01245                <span class="keyword">if</span> (nd == n) <span class="keyword">then</span>
<a name="l01246"></a>01246                   nr = nd+1
<a name="l01247"></a>01247                <span class="keyword">else</span>             <span class="comment">! nd = n+1</span>
<a name="l01248"></a>01248                   nr = n
<a name="l01249"></a>01249                <span class="keyword">endif</span>
<a name="l01250"></a>01250 
<a name="l01251"></a>01251                <span class="keyword">if</span> (trcr_depend(it) == 0) <span class="keyword">then</span>
<a name="l01252"></a>01252                   datrcr = daice(m,n)*trcrn(i,j,it,nd)
<a name="l01253"></a>01253                elseif (trcr_depend(it) == 1) <span class="keyword">then</span>
<a name="l01254"></a>01254                   datrcr = dvice(m,n)*trcrn(i,j,it,nd)
<a name="l01255"></a>01255                elseif (trcr_depend(it) == 2) <span class="keyword">then</span>
<a name="l01256"></a>01256                   datrcr = workb(i,j)  *trcrn(i,j,it,nd)
<a name="l01257"></a>01257                <span class="keyword">endif</span>
<a name="l01258"></a>01258 
<a name="l01259"></a>01259                atrcrn(m,it,nd) = atrcrn(m,it,nd) - datrcr
<a name="l01260"></a>01260                atrcrn(m,it,nr) = atrcrn(m,it,nr) + datrcr
<a name="l01261"></a>01261             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01262"></a>01262          <span class="keyword">enddo</span>                  <span class="comment">! ntrcr</span>
<a name="l01263"></a>01263 
<a name="l01264"></a>01264          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l01265"></a>01265 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01266"></a>01266 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01267"></a>01267 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01268"></a>01268             <span class="keyword">do</span> ij = 1, ishift
<a name="l01269"></a>01269                i = indxii(ij)
<a name="l01270"></a>01270                j = indxjj(ij)
<a name="l01271"></a>01271                m = indxij(ij)
<a name="l01272"></a>01272 
<a name="l01273"></a>01273                nd = donor(m,n)
<a name="l01274"></a>01274                <span class="keyword">if</span> (nd == n) <span class="keyword">then</span>
<a name="l01275"></a>01275                   nr = nd+1
<a name="l01276"></a>01276                <span class="keyword">else</span>             <span class="comment">! nd = n+1</span>
<a name="l01277"></a>01277                   nr = n
<a name="l01278"></a>01278                <span class="keyword">endif</span>
<a name="l01279"></a>01279 
<a name="l01280"></a>01280                deice = eicen(i,j,ilyr1(nd)+k-1) * worka(i,j)
<a name="l01281"></a>01281                eicen(i,j,ilyr1(nd)+k-1) = &amp;
<a name="l01282"></a>01282                     eicen(i,j,ilyr1(nd)+k-1) - deice
<a name="l01283"></a>01283                eicen(i,j,ilyr1(nr)+k-1) = &amp;
<a name="l01284"></a>01284                     eicen(i,j,ilyr1(nr)+k-1) + deice
<a name="l01285"></a>01285             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01286"></a>01286          <span class="keyword">enddo</span>                  <span class="comment">! nilyr</span>
<a name="l01287"></a>01287 
<a name="l01288"></a>01288          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l01289"></a>01289 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01290"></a>01290 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01291"></a>01291 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01292"></a>01292             <span class="keyword">do</span> ij = 1, ishift
<a name="l01293"></a>01293                i = indxii(ij)
<a name="l01294"></a>01294                j = indxjj(ij)
<a name="l01295"></a>01295                m = indxij(ij)
<a name="l01296"></a>01296 
<a name="l01297"></a>01297                nd = donor(m,n)
<a name="l01298"></a>01298                <span class="keyword">if</span> (nd == n) <span class="keyword">then</span>
<a name="l01299"></a>01299                   nr = nd+1
<a name="l01300"></a>01300                <span class="keyword">else</span>             <span class="comment">! nd = n+1</span>
<a name="l01301"></a>01301                   nr = n
<a name="l01302"></a>01302                <span class="keyword">endif</span>
<a name="l01303"></a>01303 
<a name="l01304"></a>01304                desnow = esnon(i,j,slyr1(nd)+k-1) * worka(i,j)
<a name="l01305"></a>01305                esnon(i,j,slyr1(nd)+k-1) = &amp;
<a name="l01306"></a>01306                     esnon(i,j,slyr1(nd)+k-1) - desnow
<a name="l01307"></a>01307                esnon(i,j,slyr1(nr)+k-1) = &amp;
<a name="l01308"></a>01308                     esnon(i,j,slyr1(nr)+k-1) + desnow
<a name="l01309"></a>01309             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l01310"></a>01310          <span class="keyword">enddo</span>                  <span class="comment">! nslyr</span>
<a name="l01311"></a>01311 
<a name="l01312"></a>01312       <span class="keyword">enddo</span>                     <span class="comment">! boundaries, 1 to ncat-1</span>
<a name="l01313"></a>01313 
<a name="l01314"></a>01314       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01315"></a>01315       <span class="comment">! Update ice thickness and tracers</span>
<a name="l01316"></a>01316       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01317"></a>01317 
<a name="l01318"></a>01318       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l01319"></a>01319 
<a name="l01320"></a>01320          <span class="keyword">do</span> ij = 1, icells
<a name="l01321"></a>01321             i = indxi(ij)
<a name="l01322"></a>01322             j = indxj(ij)
<a name="l01323"></a>01323 
<a name="l01324"></a>01324             <span class="keyword">if</span> (aicen(i,j,n) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01325"></a>01325                hicen(ij,n)   = vicen (i,j,n)   / aicen(i,j,n)
<a name="l01326"></a>01326             <span class="keyword">else</span>
<a name="l01327"></a>01327                hicen(ij,n)   = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01328"></a>01328             <span class="keyword">endif</span>
<a name="l01329"></a>01329          <span class="keyword">enddo</span>
<a name="l01330"></a>01330 
<a name="l01331"></a>01331          call <a class="code" href="namespaceice__itd.html#ae64b7540ec9e84001de195ffec097bc3">compute_tracers </a>(nx_block,        ny_block,       &amp;
<a name="l01332"></a>01332                                icells,          indxi,   indxj, &amp;
<a name="l01333"></a>01333                                trcr_depend,                     &amp;
<a name="l01334"></a>01334                                atrcrn(:,:,n),   aicen(:,:,  n), &amp;
<a name="l01335"></a>01335                                vicen (:,:,  n), vsnon(:,:,  n), &amp;
<a name="l01336"></a>01336                                trcrn(:,:,:,n))
<a name="l01337"></a>01337 
<a name="l01338"></a>01338       <span class="keyword">enddo</span>                     <span class="comment">! ncat</span>
<a name="l01339"></a>01339 
<a name="l01340"></a>01340 <span class="keyword">      end subroutine shift_ice</span>
<a name="l01341"></a>01341 
<a name="l01342"></a>01342 <span class="comment">!=======================================================================</span>
<a name="l01343"></a>01343 <span class="comment">!BOP</span>
<a name="l01344"></a>01344 <span class="comment">!</span>
<a name="l01345"></a>01345 <span class="comment">! !IROUTINE: column_sum - sum field over all ice categories</span>
<a name="l01346"></a>01346 <span class="comment">!</span>
<a name="l01347"></a>01347 <span class="comment">! !INTERFACE:</span>
<a name="l01348"></a>01348 <span class="comment">!</span>
<a name="l01349"></a><a class="code" href="namespaceice__itd.html#acc3eccaeb97f8a721fd0b9127b1fa183">01349</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#acc3eccaeb97f8a721fd0b9127b1fa183">column_sum</a> (nx_block, ny_block,       &amp;
<a name="l01350"></a>01350                              icells,   indxi,   indxj, &amp;
<a name="l01351"></a>01351                              nsum,                     &amp;
<a name="l01352"></a>01352                              xin,      xout)
<a name="l01353"></a>01353 <span class="comment">!</span>
<a name="l01354"></a>01354 <span class="comment">! !DESCRIPTION:</span>
<a name="l01355"></a>01355 <span class="comment">!</span>
<a name="l01356"></a>01356 <span class="comment">! For each grid cell, sum field over all ice categories.</span>
<a name="l01357"></a>01357 <span class="comment">!</span>
<a name="l01358"></a>01358 <span class="comment">! !REVISION HISTORY:</span>
<a name="l01359"></a>01359 <span class="comment">!</span>
<a name="l01360"></a>01360 <span class="comment">! author: William H. Lipscomb, LANL</span>
<a name="l01361"></a>01361 <span class="comment">!</span>
<a name="l01362"></a>01362 <span class="comment">! !USES:</span>
<a name="l01363"></a>01363 <span class="comment">!</span>
<a name="l01364"></a>01364 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l01365"></a>01365 <span class="comment">!</span>
<a name="l01366"></a>01366       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01367"></a>01367          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l01368"></a>01368          nsum              ,  <span class="comment">! number of categories/layers</span>
<a name="l01369"></a>01369          icells                <span class="comment">! number of ice/ocean grid cells</span>
<a name="l01370"></a>01370 
<a name="l01371"></a>01371       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l01372"></a>01372          <span class="keywordtype">intent(in)</span> :: 
<a name="l01373"></a>01373          indxi,  indxj          <span class="comment">! compressed i/j indices</span>
<a name="l01374"></a>01374 
<a name="l01375"></a>01375       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,nsum)</span>, 
<a name="l01376"></a>01376            <span class="keywordtype">intent(in)</span> :: 
<a name="l01377"></a>01377            xin              <span class="comment">! input field</span>
<a name="l01378"></a>01378 
<a name="l01379"></a>01379       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l01380"></a>01380            xout             <span class="comment">! output field</span>
<a name="l01381"></a>01381 <span class="comment">!</span>
<a name="l01382"></a>01382 <span class="comment">!EOP</span>
<a name="l01383"></a>01383 <span class="comment">!</span>
<a name="l01384"></a>01384       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01385"></a>01385            i, j, ij     ,  <span class="comment">! horizontal indices</span>
<a name="l01386"></a>01386            n                <span class="comment">! category/layer index</span>
<a name="l01387"></a>01387 
<a name="l01388"></a>01388       <span class="keyword">do</span> ij = 1, icells
<a name="l01389"></a>01389          xout(ij) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01390"></a>01390       <span class="keyword">enddo</span>
<a name="l01391"></a>01391 
<a name="l01392"></a>01392       <span class="keyword">do</span> n = 1, nsum
<a name="l01393"></a>01393          <span class="keyword">do</span> ij = 1, icells
<a name="l01394"></a>01394             i = indxi(ij)
<a name="l01395"></a>01395             j = indxj(ij)
<a name="l01396"></a>01396             xout(ij) = xout(ij) + xin(i,j,n)
<a name="l01397"></a>01397          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l01398"></a>01398       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l01399"></a>01399 
<a name="l01400"></a>01400 <span class="keyword">      end subroutine column_sum</span>
<a name="l01401"></a>01401 
<a name="l01402"></a>01402 <span class="comment">!=======================================================================</span>
<a name="l01403"></a>01403 <span class="comment">!BOP</span>
<a name="l01404"></a>01404 <span class="comment">!</span>
<a name="l01405"></a>01405 <span class="comment">! !IROUTINE: column_conservation_check</span>
<a name="l01406"></a>01406 <span class="comment">!</span>
<a name="l01407"></a>01407 <span class="comment">! !INTERFACE:</span>
<a name="l01408"></a>01408 <span class="comment">!</span>
<a name="l01409"></a><a class="code" href="namespaceice__itd.html#a6371b4812310c8ffbdf11c024b9e0c5a">01409</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a6371b4812310c8ffbdf11c024b9e0c5a">column_conservation_check</a> (nx_block, ny_block,       &amp;
<a name="l01410"></a>01410                                             icells,   indxi,   indxj, &amp;
<a name="l01411"></a>01411                                             fieldid,                  &amp;
<a name="l01412"></a>01412                                             x1,       x2,             &amp;
<a name="l01413"></a>01413                                             max_err,  l_stop,         &amp;
<a name="l01414"></a>01414                                             istop,    jstop)
<a name="l01415"></a>01415 <span class="comment">!</span>
<a name="l01416"></a>01416 <span class="comment">! !DESCRIPTION:</span>
<a name="l01417"></a>01417 <span class="comment">!</span>
<a name="l01418"></a>01418 <span class="comment">! For each physical grid cell, check that initial and final values</span>
<a name="l01419"></a>01419 <span class="comment">! of a conserved field are equal to within a small value.</span>
<a name="l01420"></a>01420 <span class="comment">!</span>
<a name="l01421"></a>01421 <span class="comment">! !REVISION HISTORY:</span>
<a name="l01422"></a>01422 <span class="comment">!</span>
<a name="l01423"></a>01423 <span class="comment">! author: William H. Lipscomb, LANL</span>
<a name="l01424"></a>01424 <span class="comment">!</span>
<a name="l01425"></a>01425 <span class="comment">! !USES:</span>
<a name="l01426"></a>01426 <span class="comment">!</span>
<a name="l01427"></a>01427 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l01428"></a>01428 <span class="comment">!</span>
<a name="l01429"></a>01429       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01430"></a>01430          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l01431"></a>01431          icells                <span class="comment">! number of ice/ocean grid cells</span>
<a name="l01432"></a>01432 
<a name="l01433"></a>01433       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l01434"></a>01434          <span class="keywordtype">intent(in)</span> :: 
<a name="l01435"></a>01435          indxi,  indxj     <span class="comment">! compressed i/j indices</span>
<a name="l01436"></a>01436 
<a name="l01437"></a>01437       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(icells)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01438"></a>01438          x1            ,  <span class="comment">! initial field</span>
<a name="l01439"></a>01439          x2                <span class="comment">! final field</span>
<a name="l01440"></a>01440 
<a name="l01441"></a>01441       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01442"></a>01442          max_err           <span class="comment">! max allowed error</span>
<a name="l01443"></a>01443 
<a name="l01444"></a>01444       <span class="keywordtype">character (len=char_len)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01445"></a>01445          fieldid           <span class="comment">! field identifier</span>
<a name="l01446"></a>01446 
<a name="l01447"></a>01447       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l01448"></a>01448          l_stop            <span class="comment">! if true, abort on return</span>
<a name="l01449"></a>01449 
<a name="l01450"></a>01450       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(inout)</span> :: 
<a name="l01451"></a>01451          istop, jstop      <span class="comment">! indices of grid cell where model aborts</span>
<a name="l01452"></a>01452 <span class="comment">!</span>
<a name="l01453"></a>01453 <span class="comment">!EOP</span>
<a name="l01454"></a>01454 <span class="comment">!</span>
<a name="l01455"></a>01455       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01456"></a>01456          ij                    <span class="comment">! horizontal indices</span>
<a name="l01457"></a>01457 
<a name="l01458"></a>01458       <span class="keyword">do</span> ij = 1, icells
<a name="l01459"></a>01459          <span class="keyword">if</span> (abs (x2(ij)-x1(ij)) &gt; max_err) <span class="keyword">then</span>
<a name="l01460"></a>01460             l_stop = .true.
<a name="l01461"></a>01461             istop = indxi(ij)
<a name="l01462"></a>01462             jstop = indxj(ij)
<a name="l01463"></a>01463 
<a name="l01464"></a>01464             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01465"></a>01465             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Conservation error: &apos;</span>, trim(fieldid)
<a name="l01466"></a>01466             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j =&apos;</span>, istop, jstop
<a name="l01467"></a>01467             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Initial value =&apos;</span>, x1(ij)
<a name="l01468"></a>01468             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Final value =&apos;</span>,   x2(ij)
<a name="l01469"></a>01469             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Difference =&apos;</span>, x2(ij) - x1(ij)
<a name="l01470"></a>01470          <span class="keyword">endif</span>
<a name="l01471"></a>01471       <span class="keyword">enddo</span>
<a name="l01472"></a>01472 
<a name="l01473"></a>01473 <span class="keyword">      end subroutine column_conservation_check</span>
<a name="l01474"></a>01474 
<a name="l01475"></a>01475 <span class="comment">!=======================================================================</span>
<a name="l01476"></a>01476 <span class="comment">!BOP</span>
<a name="l01477"></a>01477 <span class="comment">!</span>
<a name="l01478"></a>01478 <span class="comment">! !IROUTINE: compute_tracers - compute tracer fields</span>
<a name="l01479"></a>01479 <span class="comment">!</span>
<a name="l01480"></a>01480 <span class="comment">! !INTERFACE:</span>
<a name="l01481"></a>01481 <span class="comment">!</span>
<a name="l01482"></a><a class="code" href="namespaceice__itd.html#ae64b7540ec9e84001de195ffec097bc3">01482</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#ae64b7540ec9e84001de195ffec097bc3">compute_tracers</a> (nx_block, ny_block,       &amp;
<a name="l01483"></a>01483                                   icells,   indxi,   indxj, &amp;
<a name="l01484"></a>01484                                   trcr_depend,              &amp;
<a name="l01485"></a>01485                                   atrcrn,   aicen,          &amp;
<a name="l01486"></a>01486                                   vicen,    vsnon,          &amp;
<a name="l01487"></a>01487                                   trcrn)
<a name="l01488"></a>01488 <span class="comment">!</span>
<a name="l01489"></a>01489 <span class="comment">! !DESCRIPTION:</span>
<a name="l01490"></a>01490 <span class="comment">!</span>
<a name="l01491"></a>01491 <span class="comment">! Compute tracer fields.</span>
<a name="l01492"></a>01492 <span class="comment">! Given atrcrn = aicen*trcrn (or vicen*trcrn, vsnon*trcrn), compute trcrn.</span>
<a name="l01493"></a>01493 <span class="comment">!</span>
<a name="l01494"></a>01494 <span class="comment">! !REVISION HISTORY:</span>
<a name="l01495"></a>01495 <span class="comment">!</span>
<a name="l01496"></a>01496 <span class="comment">! author: William H. Lipscomb, LANL</span>
<a name="l01497"></a>01497 <span class="comment">!          </span>
<a name="l01498"></a>01498 <span class="comment">! !USES:</span>
<a name="l01499"></a>01499 <span class="comment">!</span>
<a name="l01500"></a>01500       use <span class="keywordflow">ice_state</span>, only: nt_Tsfc
<a name="l01501"></a>01501 <span class="comment">!</span>
<a name="l01502"></a>01502 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l01503"></a>01503 <span class="comment">!</span>
<a name="l01504"></a>01504       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01505"></a>01505          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l01506"></a>01506          icells                <span class="comment">! number of ice/ocean grid cells</span>
<a name="l01507"></a>01507 
<a name="l01508"></a>01508       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l01509"></a>01509          <span class="keywordtype">intent(in)</span> :: 
<a name="l01510"></a>01510          indxi,  indxj       <span class="comment">! compressed i/j indices</span>
<a name="l01511"></a>01511 
<a name="l01512"></a>01512       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (ntrcr)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01513"></a>01513          trcr_depend <span class="comment">! = 0 for aicen tracers, 1 for vicen, 2 for vsnon</span>
<a name="l01514"></a>01514 
<a name="l01515"></a>01515       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (icells,ntrcr)</span>, 
<a name="l01516"></a>01516          <span class="keywordtype">intent(in)</span> :: 
<a name="l01517"></a>01517          atrcrn    <span class="comment">! aicen*trcrn or vicen*trcrn or vsnon*trcrn</span>
<a name="l01518"></a>01518 
<a name="l01519"></a>01519       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l01520"></a>01520          <span class="keywordtype">intent(in)</span> :: 
<a name="l01521"></a>01521          aicen ,  <span class="comment">! concentration of ice</span>
<a name="l01522"></a>01522          vicen ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l01523"></a>01523          vsnon     <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l01524"></a>01524 
<a name="l01525"></a>01525       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr)</span>, 
<a name="l01526"></a>01526          <span class="keywordtype">intent(out)</span> :: 
<a name="l01527"></a>01527          trcrn     <span class="comment">! ice tracers</span>
<a name="l01528"></a>01528 <span class="comment">!</span>
<a name="l01529"></a>01529 <span class="comment">!EOP</span>
<a name="l01530"></a>01530 <span class="comment">!</span>
<a name="l01531"></a>01531       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01532"></a>01532          i, j, it, ij       <span class="comment">! counting indices</span>
<a name="l01533"></a>01533 
<a name="l01534"></a>01534 
<a name="l01535"></a>01535       trcrn(:,:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01536"></a>01536 
<a name="l01537"></a>01537       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01538"></a>01538       <span class="comment">! Compute new tracers</span>
<a name="l01539"></a>01539       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01540"></a>01540 
<a name="l01541"></a>01541       <span class="keyword">do</span> it = 1, ntrcr
<a name="l01542"></a>01542          <span class="keyword">if</span> (it == <a class="code" href="namespaceice__state.html#a40b462400c0ddbc648e6aa0dd6a417b7">nt_Tsfc</a>) <span class="keyword">then</span>      <span class="comment">! surface temperature</span>
<a name="l01543"></a>01543             <span class="keyword">do</span> ij = 1, icells
<a name="l01544"></a>01544                i = indxi(ij)
<a name="l01545"></a>01545                j = indxj(ij)
<a name="l01546"></a>01546                <span class="keyword">if</span> (aicen(i,j) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01547"></a>01547                   trcrn(i,j,it) = atrcrn(ij,it) / aicen(i,j)
<a name="l01548"></a>01548                <span class="keyword">else</span>
<a name="l01549"></a>01549                   trcrn(i,j,it) = Tocnfrz
<a name="l01550"></a>01550                <span class="keyword">endif</span>
<a name="l01551"></a>01551             <span class="keyword">enddo</span>
<a name="l01552"></a>01552 
<a name="l01553"></a>01553          elseif (trcr_depend(it) == 0) <span class="keyword">then</span> <span class="comment">! ice area tracers</span>
<a name="l01554"></a>01554             <span class="keyword">do</span> ij = 1, icells
<a name="l01555"></a>01555                i = indxi(ij)
<a name="l01556"></a>01556                j = indxj(ij)
<a name="l01557"></a>01557                <span class="keyword">if</span> (aicen(i,j) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01558"></a>01558                   trcrn(i,j,it) = atrcrn(ij,it) / aicen(i,j)
<a name="l01559"></a>01559                <span class="keyword">else</span>
<a name="l01560"></a>01560                   trcrn(i,j,it) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01561"></a>01561                <span class="keyword">endif</span>
<a name="l01562"></a>01562             <span class="keyword">enddo</span>
<a name="l01563"></a>01563 
<a name="l01564"></a>01564          elseif (trcr_depend(it) == 1) <span class="keyword">then</span> <span class="comment">! ice volume tracers</span>
<a name="l01565"></a>01565             <span class="keyword">do</span> ij = 1, icells
<a name="l01566"></a>01566                i = indxi(ij)
<a name="l01567"></a>01567                j = indxj(ij)
<a name="l01568"></a>01568                <span class="keyword">if</span> (vicen(i,j) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01569"></a>01569                   trcrn(i,j,it) = atrcrn(ij,it) / vicen(i,j)
<a name="l01570"></a>01570                <span class="keyword">else</span>
<a name="l01571"></a>01571                   trcrn(i,j,it) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01572"></a>01572                <span class="keyword">endif</span>
<a name="l01573"></a>01573             <span class="keyword">enddo</span>
<a name="l01574"></a>01574 
<a name="l01575"></a>01575          elseif (trcr_depend(it) == 2) <span class="keyword">then</span> <span class="comment">! snow volume tracers</span>
<a name="l01576"></a>01576             <span class="keyword">do</span> ij = 1, icells
<a name="l01577"></a>01577                i = indxi(ij)
<a name="l01578"></a>01578                j = indxj(ij)
<a name="l01579"></a>01579                <span class="keyword">if</span> (vsnon(i,j) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01580"></a>01580                   trcrn(i,j,it) = atrcrn(ij,it) / vsnon(i,j)
<a name="l01581"></a>01581                <span class="keyword">else</span>
<a name="l01582"></a>01582                   trcrn(i,j,it) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01583"></a>01583                <span class="keyword">endif</span>
<a name="l01584"></a>01584             <span class="keyword">enddo</span>
<a name="l01585"></a>01585 
<a name="l01586"></a>01586          <span class="keyword">endif</span>                  <span class="comment">! trcr_depend</span>
<a name="l01587"></a>01587       <span class="keyword">enddo</span>                     <span class="comment">! ntrcr</span>
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 <span class="keyword">      end subroutine compute_tracers</span>
<a name="l01590"></a>01590 
<a name="l01591"></a>01591 <span class="comment">!=======================================================================</span>
<a name="l01592"></a>01592 <span class="comment">!BOP</span>
<a name="l01593"></a>01593 <span class="comment">!</span>
<a name="l01594"></a>01594 <span class="comment">! !IROUTINE: cleanup_itd - rebin if needed, eliminate small ice areas,</span>
<a name="l01595"></a>01595 <span class="comment">!                          and aggregate over categories</span>
<a name="l01596"></a>01596 <span class="comment">!</span>
<a name="l01597"></a>01597 <span class="comment">! !INTERFACE:</span>
<a name="l01598"></a>01598 <span class="comment">!</span>
<a name="l01599"></a><a class="code" href="namespaceice__itd.html#a3e9112301701b3265ffbd9273598a98d">01599</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a3e9112301701b3265ffbd9273598a98d">cleanup_itd</a> (nx_block,    ny_block,   &amp;
<a name="l01600"></a>01600                               ilo, ihi,    jlo, jhi,   &amp;
<a name="l01601"></a>01601                               dt,                      &amp;
<a name="l01602"></a>01602                               aicen,       trcrn,      &amp;
<a name="l01603"></a>01603                               vicen,       vsnon,      &amp;
<a name="l01604"></a>01604                               eicen,       esnon,      &amp;
<a name="l01605"></a>01605                               aice0,       aice,       &amp;
<a name="l01606"></a>01606                               trcr_depend, fresh,      &amp;
<a name="l01607"></a>01607                               fsalt,       fhocn,      &amp;
<a name="l01608"></a>01608                               fsoot,       tr_aero,    &amp;
<a name="l01609"></a>01609                               heat_capacity, l_stop,   &amp;
<a name="l01610"></a>01610                               istop,         jstop,    &amp;
<a name="l01611"></a>01611                               limit_aice_in)
<a name="l01612"></a>01612 <span class="comment">!</span>
<a name="l01613"></a>01613 <span class="comment">! !DESCRIPTION:</span>
<a name="l01614"></a>01614 <span class="comment">!</span>
<a name="l01615"></a>01615 <span class="comment">! Cleanup subroutine that rebins thickness categories if necessary,</span>
<a name="l01616"></a>01616 <span class="comment">!  eliminates very small ice areas while conserving mass and energy, </span>
<a name="l01617"></a>01617 <span class="comment">!  aggregates state variables, and does a boundary call.  </span>
<a name="l01618"></a>01618 <span class="comment">! It is a good idea to call this subroutine after the thermodynamics</span>
<a name="l01619"></a>01619 <span class="comment">!  (thermo_vertical/thermo_itd) and again after the dynamics </span>
<a name="l01620"></a>01620 <span class="comment">!  (evp/transport/ridging).</span>
<a name="l01621"></a>01621 <span class="comment">!</span>
<a name="l01622"></a>01622 <span class="comment">! !REVISION HISTORY:</span>
<a name="l01623"></a>01623 <span class="comment">!</span>
<a name="l01624"></a>01624 <span class="comment">! author: William H. Lipscomb, LANL</span>
<a name="l01625"></a>01625 <span class="comment">!</span>
<a name="l01626"></a>01626 <span class="comment">! !USES:</span>
<a name="l01627"></a>01627 <span class="comment">!</span>
<a name="l01628"></a>01628 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l01629"></a>01629 <span class="comment">!</span>
<a name="l01630"></a>01630       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> ::  
<a name="l01631"></a>01631          nx_block, ny_block,  <span class="comment">! block dimensions </span>
<a name="l01632"></a>01632          ilo,ihi,jlo,jhi       <span class="comment">! beginning and end of physical domain</span>
<a name="l01633"></a>01633  
<a name="l01634"></a>01634       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> ::  
<a name="l01635"></a>01635          dt        <span class="comment">! time step </span>
<a name="l01636"></a>01636  
<a name="l01637"></a>01637       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ncat)</span>,  
<a name="l01638"></a>01638          <span class="keywordtype">intent(inout)</span> ::  
<a name="l01639"></a>01639          aicen ,  <span class="comment">! concentration of ice </span>
<a name="l01640"></a>01640          vicen ,  <span class="comment">! volume per unit area of ice          (m) </span>
<a name="l01641"></a>01641          vsnon     <span class="comment">! volume per unit area of snow         (m) </span>
<a name="l01642"></a>01642  
<a name="l01643"></a>01643       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr,ncat)</span>,  
<a name="l01644"></a>01644          <span class="keywordtype">intent(inout)</span> ::  
<a name="l01645"></a>01645          trcrn     <span class="comment">! ice tracers </span>
<a name="l01646"></a>01646  
<a name="l01647"></a>01647       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntilyr)</span>,  
<a name="l01648"></a>01648          <span class="keywordtype">intent(inout)</span> ::  
<a name="l01649"></a>01649          eicen     <span class="comment">! energy of melting for each ice layer (J/m^2) </span>
<a name="l01650"></a>01650  
<a name="l01651"></a>01651       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntslyr)</span>,  
<a name="l01652"></a>01652          <span class="keywordtype">intent(inout)</span> ::  
<a name="l01653"></a>01653          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2) </span>
<a name="l01654"></a>01654  
<a name="l01655"></a>01655       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>,  
<a name="l01656"></a>01656          <span class="keywordtype">intent(inout)</span> ::  
<a name="l01657"></a>01657          aice  ,  <span class="comment">! total ice concentration</span>
<a name="l01658"></a>01658          aice0     <span class="comment">! concentration of open water </span>
<a name="l01659"></a>01659      
<a name="l01660"></a>01660       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension(ntrcr)</span>, <span class="keywordtype">intent(in)</span> ::  
<a name="l01661"></a>01661          trcr_depend  <span class="comment">! tracer dependency information</span>
<a name="l01662"></a>01662 
<a name="l01663"></a>01663       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01664"></a>01664          tr_aero,      
<a name="l01665"></a>01665          heat_capacity   <span class="comment">! if false, ice and snow have zero heat capacity</span>
<a name="l01666"></a>01666 
<a name="l01667"></a>01667       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l01668"></a>01668          l_stop    <span class="comment">! if true, abort on return</span>
<a name="l01669"></a>01669 
<a name="l01670"></a>01670       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l01671"></a>01671          istop, jstop <span class="comment">! indices of grid cell where model aborts</span>
<a name="l01672"></a>01672 
<a name="l01673"></a>01673       <span class="comment">! ice-ocean fluxes (required for strict conservation)</span>
<a name="l01674"></a>01674       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l01675"></a>01675          <span class="keywordtype">intent(inout)</span>, <span class="keywordtype">optional</span> :: 
<a name="l01676"></a>01676          fresh    ,  <span class="comment">! fresh water flux to ocean (kg/m^2/s)</span>
<a name="l01677"></a>01677          fsalt    ,  <span class="comment">! salt flux to ocean        (kg/m^2/s)</span>
<a name="l01678"></a>01678          fhocn        <span class="comment">! net heat flux to ocean     (W/m^2)</span>
<a name="l01679"></a>01679 
<a name="l01680"></a>01680       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,n_aeromx)</span>, 
<a name="l01681"></a>01681          <span class="keywordtype">intent(inout)</span>, <span class="keywordtype">optional</span> :: 
<a name="l01682"></a>01682          fsoot        <span class="comment">! soot flux to ocean        (kg/m^2/s)</span>
<a name="l01683"></a>01683 
<a name="l01684"></a>01684       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(in)</span>, <span class="keywordtype">optional</span> ::   
<a name="l01685"></a>01685          limit_aice_in      <span class="comment">! if false, allow aice to be out of bounds</span>
<a name="l01686"></a>01686                             <span class="comment">! may want to allow this for unit tests</span>
<a name="l01687"></a>01687 <span class="comment">!    </span>
<a name="l01688"></a>01688 <span class="comment">!EOP</span>
<a name="l01689"></a>01689 <span class="comment">!</span>
<a name="l01690"></a>01690       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01691"></a>01691          i, j             ,  <span class="comment">! horizontal indices</span>
<a name="l01692"></a>01692          n                ,  <span class="comment">! category index</span>
<a name="l01693"></a>01693          icells               <span class="comment">! number of grid cells with ice</span>
<a name="l01694"></a>01694 
<a name="l01695"></a>01695        <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block) </span>:: 
<a name="l01696"></a>01696          indxi, indxj      <span class="comment">! compressed i/j indices</span>
<a name="l01697"></a>01697 
<a name="l01698"></a>01698       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block) </span>:: 
<a name="l01699"></a>01699          dfresh   ,  <span class="comment">! zapped fresh water flux (kg/m^2/s)</span>
<a name="l01700"></a>01700          dfsalt   ,  <span class="comment">! zapped salt flux   (kg/m^2/s)</span>
<a name="l01701"></a>01701          dfhocn       <span class="comment">! zapped energy flux ( W/m^2)</span>
<a name="l01702"></a>01702 
<a name="l01703"></a>01703       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,n_aeromx) </span>:: 
<a name="l01704"></a>01704          dfsoot    <span class="comment">! zapped soot flux   (kg/m^2/s)</span>
<a name="l01705"></a>01705 
<a name="l01706"></a>01706       <span class="keywordtype">logical (kind=log_kind) </span>::   
<a name="l01707"></a>01707          limit_aice         <span class="comment">! if true, check for aice out of bounds</span>
<a name="l01708"></a>01708 
<a name="l01709"></a>01709       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01710"></a>01710       <span class="comment">! Initialize</span>
<a name="l01711"></a>01711       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01712"></a>01712 
<a name="l01713"></a>01713       <span class="keyword">if</span> (present(limit_aice_in)) <span class="keyword">then</span>
<a name="l01714"></a>01714          limit_aice = limit_aice_in
<a name="l01715"></a>01715       <span class="keyword">else</span>
<a name="l01716"></a>01716          limit_aice = .true.
<a name="l01717"></a>01717       <span class="keyword">endif</span>
<a name="l01718"></a>01718 
<a name="l01719"></a>01719       l_stop = .false.
<a name="l01720"></a>01720       istop = 0
<a name="l01721"></a>01721       jstop = 0
<a name="l01722"></a>01722 
<a name="l01723"></a>01723       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01724"></a>01724       <span class="comment">! Compute total ice area.</span>
<a name="l01725"></a>01725       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01726"></a>01726 
<a name="l01727"></a>01727       call <a class="code" href="namespaceice__itd.html#a428ffa5cfc4adb00cd323a2d76bf1c4d">aggregate_area </a>(nx_block, ny_block, &amp;
<a name="l01728"></a>01728                            aicen(:,:,:), &amp;
<a name="l01729"></a>01729                            aice,     aice0)
<a name="l01730"></a>01730 
<a name="l01731"></a>01731 
<a name="l01732"></a>01732       <span class="keyword">if</span> (limit_aice) <span class="keyword">then</span>  <span class="comment">! check for aice out of bounds</span>
<a name="l01733"></a>01733       
<a name="l01734"></a>01734          <span class="keyword">do</span> j = jlo,jhi
<a name="l01735"></a>01735          <span class="keyword">do</span> i = ilo,ihi
<a name="l01736"></a>01736             <span class="keyword">if</span> (aice(i,j) &gt; <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .or. aice(i,j) &lt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01737"></a>01737                l_stop = .true.
<a name="l01738"></a>01738                istop = i
<a name="l01739"></a>01739                jstop = j
<a name="l01740"></a>01740             <span class="keyword">endif</span>
<a name="l01741"></a>01741          <span class="keyword">enddo</span>
<a name="l01742"></a>01742          <span class="keyword">enddo</span>
<a name="l01743"></a>01743 
<a name="l01744"></a>01744          <span class="keyword">if</span> (l_stop) <span class="keyword">then</span>      <span class="comment">! area out of bounds</span>
<a name="l01745"></a>01745             i = istop
<a name="l01746"></a>01746             j = jstop
<a name="l01747"></a>01747             <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l01748"></a>01748             <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;aggregate ice area out of bounds&apos;</span>
<a name="l01749"></a>01749             <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;my_task, i, j, aice:&apos;</span>, &amp;
<a name="l01750"></a>01750                               <a class="code" href="namespaceice__communicate.html#a70e729e746e2e5ec592ccba505136002">my_task</a>, i, j, aice(i,j)
<a name="l01751"></a>01751             <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l01752"></a>01752                <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;n, aicen:&apos;</span>, n, aicen(i,j,n)
<a name="l01753"></a>01753             <span class="keyword">enddo</span>
<a name="l01754"></a>01754             return
<a name="l01755"></a>01755          <span class="keyword">endif</span>                  <span class="comment">! l_stop</span>
<a name="l01756"></a>01756       <span class="keyword">endif</span>                     <span class="comment">! limit_aice</span>
<a name="l01757"></a>01757 
<a name="l01758"></a>01758       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01759"></a>01759       <span class="comment">! Identify grid cells with ice.</span>
<a name="l01760"></a>01760       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01761"></a>01761 
<a name="l01762"></a>01762       icells = 0
<a name="l01763"></a>01763       <span class="keyword">do</span> j = jlo,jhi
<a name="l01764"></a>01764       <span class="keyword">do</span> i = ilo,ihi
<a name="l01765"></a>01765          <span class="keyword">if</span> (aice(i,j) &gt; <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01766"></a>01766             icells = icells + 1
<a name="l01767"></a>01767             indxi(icells) = i
<a name="l01768"></a>01768             indxj(icells) = j
<a name="l01769"></a>01769          <span class="keyword">endif</span>
<a name="l01770"></a>01770       <span class="keyword">enddo</span>
<a name="l01771"></a>01771       <span class="keyword">enddo</span>
<a name="l01772"></a>01772 
<a name="l01773"></a>01773       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01774"></a>01774       <span class="comment">! Make sure ice in each category is within its thickness bounds.</span>
<a name="l01775"></a>01775       <span class="comment">! NOTE: The rebin subroutine is needed only in the rare cases</span>
<a name="l01776"></a>01776       <span class="comment">!       when the linear_itd subroutine cannot transfer ice</span>
<a name="l01777"></a>01777       <span class="comment">!       correctly (e.g., very fast ice growth).</span>
<a name="l01778"></a>01778       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01779"></a>01779 
<a name="l01780"></a>01780       call <a class="code" href="namespaceice__itd.html#a9c2920aedaba5102293185bec0142577">rebin </a>(nx_block,   ny_block, &amp;
<a name="l01781"></a>01781                   icells,   indxi,    indxj, &amp;
<a name="l01782"></a>01782                   trcr_depend, &amp;
<a name="l01783"></a>01783                   aicen(:,:,:),      trcrn(:,:,:,:), &amp;
<a name="l01784"></a>01784                   vicen(:,:,:),      vsnon(:,:,:),   &amp;
<a name="l01785"></a>01785                   eicen(:,:,:),      esnon(:,:,:),   &amp;
<a name="l01786"></a>01786                   l_stop, &amp;
<a name="l01787"></a>01787                   istop,      jstop)
<a name="l01788"></a>01788 
<a name="l01789"></a>01789       <span class="keyword">if</span> (l_stop) return
<a name="l01790"></a>01790 
<a name="l01791"></a>01791       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01792"></a>01792       <span class="comment">! Zero out ice categories with very small areas.</span>
<a name="l01793"></a>01793       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01794"></a>01794 
<a name="l01795"></a>01795       <span class="keyword">if</span> (limit_aice) <span class="keyword">then</span>
<a name="l01796"></a>01796          call <a class="code" href="namespaceice__itd.html#a137780a223f20265133e26e9e96d36a5">zap_small_areas </a>(nx_block, ny_block, &amp;
<a name="l01797"></a>01797                                ilo, ihi, jlo, jhi, &amp;
<a name="l01798"></a>01798                                dt,              &amp;
<a name="l01799"></a>01799                                aice,     aice0, &amp;
<a name="l01800"></a>01800                                aicen(:,:,:),    trcrn(:,:,:,:), &amp;
<a name="l01801"></a>01801                                vicen(:,:,:),    vsnon(:,:,:),   &amp;
<a name="l01802"></a>01802                                eicen(:,:,:),    esnon(:,:,:),   &amp;
<a name="l01803"></a>01803                                dfresh,   dfsalt, &amp;
<a name="l01804"></a>01804                                dfhocn,   dfsoot, &amp;
<a name="l01805"></a>01805                                tr_aero,          &amp;
<a name="l01806"></a>01806                                l_stop,           &amp;
<a name="l01807"></a>01807                                istop,    jstop)
<a name="l01808"></a>01808          <span class="keyword">if</span> (l_stop) return
<a name="l01809"></a>01809       <span class="keyword">endif</span>   <span class="comment">! l_limit_aice</span>
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     <span class="comment">!-------------------------------------------------------------------</span>
<a name="l01812"></a>01812     <span class="comment">! Update ice-ocean fluxes for strict conservation</span>
<a name="l01813"></a>01813     <span class="comment">!-------------------------------------------------------------------</span>
<a name="l01814"></a>01814 
<a name="l01815"></a>01815       <span class="keyword">if</span> (present(fresh)) &amp;
<a name="l01816"></a>01816            fresh     (:,:) = fresh(:,:)      + dfresh(:,:) 
<a name="l01817"></a>01817       <span class="keyword">if</span> (present(fsalt)) &amp;
<a name="l01818"></a>01818            fsalt     (:,:) = fsalt(:,:)      + dfsalt(:,:)
<a name="l01819"></a>01819       <span class="keyword">if</span> (present(fhocn)) &amp;
<a name="l01820"></a>01820            fhocn     (:,:) = fhocn(:,:)      + dfhocn(:,:)
<a name="l01821"></a>01821       <span class="keyword">if</span> (present(fsoot)) &amp;
<a name="l01822"></a>01822            fsoot   (:,:,:) = fsoot(:,:,:)    + dfsoot(:,:,:)
<a name="l01823"></a>01823 
<a name="l01824"></a>01824       <span class="comment">!----------------------------------------------------------------</span>
<a name="l01825"></a>01825       <span class="comment">! If using zero-layer model (no heat capacity), check that the </span>
<a name="l01826"></a>01826       <span class="comment">! energy of snow and ice is correct. </span>
<a name="l01827"></a>01827       <span class="comment">!----------------------------------------------------------------</span>
<a name="l01828"></a>01828 
<a name="l01829"></a>01829       <span class="keyword">if</span> (.not. heat_capacity) <span class="keyword">then</span>
<a name="l01830"></a>01830 
<a name="l01831"></a>01831          call <a class="code" href="namespaceice__itd.html#a55c2adda4305308869dac586cefe447a">zerolayer_check</a>(nx_block,    ny_block,   &amp;
<a name="l01832"></a>01832                               icells,  indxi,   indxj, &amp;
<a name="l01833"></a>01833                               aicen,                   &amp;
<a name="l01834"></a>01834                               vicen,       vsnon,      &amp;
<a name="l01835"></a>01835                               eicen,       esnon,      &amp;
<a name="l01836"></a>01836                               l_stop,                  &amp;
<a name="l01837"></a>01837                               istop,       jstop)
<a name="l01838"></a>01838 
<a name="l01839"></a>01839       <span class="keyword">endif</span>
<a name="l01840"></a>01840 
<a name="l01841"></a>01841 <span class="keyword">      end subroutine cleanup_itd</span>
<a name="l01842"></a>01842 
<a name="l01843"></a>01843 <span class="comment">!=======================================================================</span>
<a name="l01844"></a>01844 <span class="comment">!BOP</span>
<a name="l01845"></a>01845 <span class="comment">!</span>
<a name="l01846"></a>01846 <span class="comment">! !IROUTINE: zap_small_areas - eliminate very small ice areas</span>
<a name="l01847"></a>01847 <span class="comment">!</span>
<a name="l01848"></a>01848 <span class="comment">! !INTERFACE:</span>
<a name="l01849"></a>01849 <span class="comment">!</span>
<a name="l01850"></a><a class="code" href="namespaceice__itd.html#a137780a223f20265133e26e9e96d36a5">01850</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a137780a223f20265133e26e9e96d36a5">zap_small_areas</a> (nx_block, ny_block, &amp;
<a name="l01851"></a>01851                                   ilo, ihi, jlo, jhi, &amp;
<a name="l01852"></a>01852                                   dt,                 &amp;
<a name="l01853"></a>01853                                   aice,     aice0,    &amp;
<a name="l01854"></a>01854                                   aicen,    trcrn,    &amp;
<a name="l01855"></a>01855                                   vicen,    vsnon,    &amp;
<a name="l01856"></a>01856                                   eicen,    esnon,    &amp;
<a name="l01857"></a>01857                                   dfresh,   dfsalt,   &amp;
<a name="l01858"></a>01858                                   dfhocn,   dfsoot,   &amp;
<a name="l01859"></a>01859                                   tr_aero,            &amp;
<a name="l01860"></a>01860                                   l_stop,             &amp;
<a name="l01861"></a>01861                                   istop,    jstop)
<a name="l01862"></a>01862 <span class="comment">!</span>
<a name="l01863"></a>01863 <span class="comment">! !DESCRIPTION:</span>
<a name="l01864"></a>01864 <span class="comment">!</span>
<a name="l01865"></a>01865 <span class="comment">! For each ice category in each grid cell, remove ice if the fractional</span>
<a name="l01866"></a>01866 <span class="comment">! area is less than puny.</span>
<a name="l01867"></a>01867 <span class="comment">!</span>
<a name="l01868"></a>01868 <span class="comment">! !REVISION HISTORY:</span>
<a name="l01869"></a>01869 <span class="comment">!</span>
<a name="l01870"></a>01870 <span class="comment">! author: William H. Lipscomb, LANL</span>
<a name="l01871"></a>01871 <span class="comment">!</span>
<a name="l01872"></a>01872 <span class="comment">! !USES:</span>
<a name="l01873"></a>01873 <span class="comment">!</span>
<a name="l01874"></a>01874       use <span class="keywordflow">ice_state</span>, only: nt_Tsfc, nt_aero
<a name="l01875"></a>01875 <span class="comment">!</span>
<a name="l01876"></a>01876 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l01877"></a>01877 <span class="comment">!</span>
<a name="l01878"></a>01878       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01879"></a>01879          nx_block, ny_block,  <span class="comment">! block dimensions</span>
<a name="l01880"></a>01880          ilo,ihi,jlo,jhi       <span class="comment">! beginning and end of physical domain</span>
<a name="l01881"></a>01881 
<a name="l01882"></a>01882       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01883"></a>01883          dt                    <span class="comment">! time step</span>
<a name="l01884"></a>01884 
<a name="l01885"></a>01885       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l01886"></a>01886          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01887"></a>01887          aice     ,  <span class="comment">! total ice concentration</span>
<a name="l01888"></a>01888          aice0        <span class="comment">! concentration of open water</span>
<a name="l01889"></a>01889 
<a name="l01890"></a>01890       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension(nx_block,ny_block,ncat)</span>, 
<a name="l01891"></a>01891          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01892"></a>01892          aicen    ,  <span class="comment">! concentration of ice</span>
<a name="l01893"></a>01893          vicen    ,  <span class="comment">! volume per unit area of ice          (m)</span>
<a name="l01894"></a>01894          vsnon        <span class="comment">! volume per unit area of snow         (m)</span>
<a name="l01895"></a>01895 
<a name="l01896"></a>01896       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntilyr)</span>, 
<a name="l01897"></a>01897          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01898"></a>01898          eicen        <span class="comment">! energy of melting for each ice layer  (J/m^2)</span>
<a name="l01899"></a>01899 
<a name="l01900"></a>01900       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntslyr)</span>, 
<a name="l01901"></a>01901          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01902"></a>01902          esnon        <span class="comment">! energy of melting for each snow layer (J/m^2)</span>
<a name="l01903"></a>01903 
<a name="l01904"></a>01904       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntrcr,ncat)</span>, 
<a name="l01905"></a>01905          <span class="keywordtype">intent(inout)</span> :: 
<a name="l01906"></a>01906          trcrn        <span class="comment">! ice tracers</span>
<a name="l01907"></a>01907 
<a name="l01908"></a>01908       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block)</span>, 
<a name="l01909"></a>01909          <span class="keywordtype">intent(out)</span> :: 
<a name="l01910"></a>01910          dfresh   ,  <span class="comment">! zapped fresh water flux (kg/m^2/s)</span>
<a name="l01911"></a>01911          dfsalt   ,  <span class="comment">! zapped salt flux   (kg/m^2/s)</span>
<a name="l01912"></a>01912          dfhocn       <span class="comment">! zapped energy flux ( W/m^2)</span>
<a name="l01913"></a>01913 
<a name="l01914"></a>01914       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,n_aeromx)</span>, 
<a name="l01915"></a>01915          <span class="keywordtype">intent(out)</span> :: 
<a name="l01916"></a>01916          dfsoot    <span class="comment">! zapped soot flux   (kg/m^2/s)</span>
<a name="l01917"></a>01917 
<a name="l01918"></a>01918       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(in)</span> :: 
<a name="l01919"></a>01919          tr_aero
<a name="l01920"></a>01920 
<a name="l01921"></a>01921       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l01922"></a>01922          l_stop   <span class="comment">! if true, abort on return</span>
<a name="l01923"></a>01923 
<a name="l01924"></a>01924       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l01925"></a>01925          istop, jstop <span class="comment">! indices of grid cell where model aborts</span>
<a name="l01926"></a>01926 <span class="comment">!</span>
<a name="l01927"></a>01927 <span class="comment">!EOP</span>
<a name="l01928"></a>01928 <span class="comment">!</span>
<a name="l01929"></a>01929       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l01930"></a>01930          i,j, n, k, it  ,  <span class="comment">! counting indices</span>
<a name="l01931"></a>01931          icells         ,  <span class="comment">! number of cells with ice to zap</span>
<a name="l01932"></a>01932          ij                 <span class="comment">! combined i/j horizontal index</span>
<a name="l01933"></a>01933 
<a name="l01934"></a>01934       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block) </span>:: 
<a name="l01935"></a>01935         indxi       ,  <span class="comment">! compressed indices for i/j directions</span>
<a name="l01936"></a>01936         indxj
<a name="l01937"></a>01937 
<a name="l01938"></a>01938       <span class="keywordtype">real (kind=dbl_kind) </span>:: xtmp      <span class="comment">! temporary variable</span>
<a name="l01939"></a>01939 
<a name="l01940"></a>01940       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01941"></a>01941       <span class="comment">! Initialize</span>
<a name="l01942"></a>01942       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01943"></a>01943 
<a name="l01944"></a>01944       l_stop = .false.
<a name="l01945"></a>01945       istop = 0
<a name="l01946"></a>01946       jstop = 0
<a name="l01947"></a>01947 
<a name="l01948"></a>01948       dfresh(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01949"></a>01949       dfsalt(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01950"></a>01950       dfhocn(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01951"></a>01951       dfsoot(:,:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01952"></a>01952 
<a name="l01953"></a>01953       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01954"></a>01954       <span class="comment">! Zap categories with very small areas.</span>
<a name="l01955"></a>01955       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01956"></a>01956 
<a name="l01957"></a>01957       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l01958"></a>01958 
<a name="l01959"></a>01959       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01960"></a>01960       <span class="comment">! Count categories to be zapped.</span>
<a name="l01961"></a>01961       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01962"></a>01962 
<a name="l01963"></a>01963          icells = 0
<a name="l01964"></a>01964          <span class="keyword">do</span> j = jlo, jhi
<a name="l01965"></a>01965          <span class="keyword">do</span> i = ilo, ihi
<a name="l01966"></a>01966             <span class="keyword">if</span> (aicen(i,j,n) &lt; -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>) <span class="keyword">then</span>
<a name="l01967"></a>01967                <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Zap ice: negative ice area&apos;</span>
<a name="l01968"></a>01968                <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j, n, aicen =&apos;</span>, &amp;
<a name="l01969"></a>01969                                   i, j, n, aicen(i,j,n)
<a name="l01970"></a>01970                l_stop = .true.
<a name="l01971"></a>01971                istop = i
<a name="l01972"></a>01972                jstop = j
<a name="l01973"></a>01973                return
<a name="l01974"></a>01974             elseif ((aicen(i,j,n) &gt;= -<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a> .and. aicen(i,j,n) &lt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>) .or. &amp;
<a name="l01975"></a>01975                     (aicen(i,j,n) &gt; <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a> .and. aicen(i,j,n) &lt;= <a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l01976"></a>01976                icells = icells + 1
<a name="l01977"></a>01977                indxi(icells) = i
<a name="l01978"></a>01978                indxj(icells) = j
<a name="l01979"></a>01979             <span class="keyword">endif</span>
<a name="l01980"></a>01980          <span class="keyword">enddo</span>
<a name="l01981"></a>01981          <span class="keyword">enddo</span>
<a name="l01982"></a>01982 
<a name="l01983"></a>01983       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01984"></a>01984       <span class="comment">! Zap ice energy and use ocean heat to melt ice</span>
<a name="l01985"></a>01985       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l01986"></a>01986 
<a name="l01987"></a>01987          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a>
<a name="l01988"></a>01988 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l01989"></a>01989 <span class="comment">!cdir nodep      !NEC</span>
<a name="l01990"></a>01990 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l01991"></a>01991             <span class="keyword">do</span> ij = 1, icells
<a name="l01992"></a>01992                i = indxi(ij)
<a name="l01993"></a>01993                j = indxj(ij)
<a name="l01994"></a>01994 
<a name="l01995"></a>01995                xtmp = eicen(i,j,ilyr1(n)+k-1) / dt <span class="comment">! &lt; 0</span>
<a name="l01996"></a>01996                dfhocn(i,j) = dfhocn(i,j) + xtmp
<a name="l01997"></a>01997                eicen(i,j,ilyr1(n)+k-1) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l01998"></a>01998 
<a name="l01999"></a>01999             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l02000"></a>02000          <span class="keyword">enddo</span>                  <span class="comment">! k</span>
<a name="l02001"></a>02001 
<a name="l02002"></a>02002       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02003"></a>02003       <span class="comment">! Zap snow energy and use ocean heat to melt snow</span>
<a name="l02004"></a>02004       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02005"></a>02005 
<a name="l02006"></a>02006          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a>
<a name="l02007"></a>02007 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02008"></a>02008 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02009"></a>02009 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02010"></a>02010             <span class="keyword">do</span> ij = 1, icells
<a name="l02011"></a>02011                i = indxi(ij)
<a name="l02012"></a>02012                j = indxj(ij)
<a name="l02013"></a>02013 
<a name="l02014"></a>02014                xtmp = esnon(i,j,slyr1(n)+k-1) / dt <span class="comment">! &lt; 0</span>
<a name="l02015"></a>02015                dfhocn(i,j) = dfhocn(i,j) + xtmp
<a name="l02016"></a>02016                esnon(i,j,slyr1(n)+k-1) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02017"></a>02017 
<a name="l02018"></a>02018             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l02019"></a>02019          <span class="keyword">enddo</span>                  <span class="comment">! k</span>
<a name="l02020"></a>02020 
<a name="l02021"></a>02021       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02022"></a>02022       <span class="comment">! Zap ice and snow volume, add water and salt to ocean</span>
<a name="l02023"></a>02023       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02024"></a>02024 
<a name="l02025"></a>02025 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02026"></a>02026 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02027"></a>02027 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02028"></a>02028          <span class="keyword">do</span> ij = 1, icells
<a name="l02029"></a>02029             i = indxi(ij)
<a name="l02030"></a>02030             j = indxj(ij)
<a name="l02031"></a>02031 
<a name="l02032"></a>02032             xtmp = (<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*vicen(i,j,n) + <a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*vsnon(i,j,n)) / dt
<a name="l02033"></a>02033             dfresh(i,j) = dfresh(i,j) + xtmp
<a name="l02034"></a>02034 
<a name="l02035"></a>02035             xtmp = <a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*vicen(i,j,n)*ice_ref_salinity*<a class="code" href="namespaceice__constants.html#a32bc94e42275169979f5be642d23634e">p001</a> / dt
<a name="l02036"></a>02036             dfsalt(i,j) = dfsalt(i,j) + xtmp
<a name="l02037"></a>02037 
<a name="l02038"></a>02038             aice0(i,j) = aice0(i,j) + aicen(i,j,n)
<a name="l02039"></a>02039             aicen(i,j,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02040"></a>02040             vicen(i,j,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02041"></a>02041             vsnon(i,j,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02042"></a>02042             trcrn(i,j,<a class="code" href="namespaceice__state.html#a40b462400c0ddbc648e6aa0dd6a417b7">nt_Tsfc</a>,n) = Tocnfrz
<a name="l02043"></a>02043 
<a name="l02044"></a>02044          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02045"></a>02045 
<a name="l02046"></a>02046          <span class="keyword">if</span> (tr_aero) <span class="keyword">then</span>
<a name="l02047"></a>02047 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02048"></a>02048 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02049"></a>02049 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02050"></a>02050           <span class="keyword">do</span> ij = 1, icells
<a name="l02051"></a>02051            i = indxi(ij)
<a name="l02052"></a>02052            j = indxj(ij)
<a name="l02053"></a>02053            <span class="keyword">do</span> it=1,n_aero
<a name="l02054"></a>02054             xtmp &amp;
<a name="l02055"></a>02055               = (vsnon(i,j,n)*(trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>  +4*(it-1),n)   &amp;
<a name="l02056"></a>02056                               +trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>+1+4*(it-1),n))  &amp;
<a name="l02057"></a>02057               +  vicen(i,j,n)*(trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>+2+4*(it-1),n)   &amp;
<a name="l02058"></a>02058                               +trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>+3+4*(it-1),n))) &amp;
<a name="l02059"></a>02059               / dt
<a name="l02060"></a>02060             dfsoot(i,j,it) = dfsoot(i,j,it) + xtmp
<a name="l02061"></a>02061            <span class="keyword">enddo</span>                 <span class="comment">! n</span>
<a name="l02062"></a>02062           <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02063"></a>02063          <span class="keyword">endif</span>
<a name="l02064"></a>02064 
<a name="l02065"></a>02065       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02066"></a>02066       <span class="comment">! Zap tracers</span>
<a name="l02067"></a>02067       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02068"></a>02068          
<a name="l02069"></a>02069          <span class="keyword">if</span> (ntrcr &gt;= 2) <span class="keyword">then</span>
<a name="l02070"></a>02070             <span class="keyword">do</span> it = 1, ntrcr   <span class="comment">! this assumes nt_Tsfc = 1</span>
<a name="l02071"></a>02071                <span class="keyword">do</span> ij = 1, icells
<a name="l02072"></a>02072                   i = indxi(ij)
<a name="l02073"></a>02073                   j = indxj(ij)
<a name="l02074"></a>02074                   trcrn(i,j,it,n) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02075"></a>02075                <span class="keyword">enddo</span>
<a name="l02076"></a>02076             <span class="keyword">enddo</span>
<a name="l02077"></a>02077          <span class="keyword">endif</span>
<a name="l02078"></a>02078 
<a name="l02079"></a>02079       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l02080"></a>02080 
<a name="l02081"></a>02081       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02082"></a>02082       <span class="comment">! Count cells with excess ice (aice &gt; c1) due to roundoff errors.</span>
<a name="l02083"></a>02083       <span class="comment">! Zap a little ice in each category so that aice = c1.</span>
<a name="l02084"></a>02084       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02085"></a>02085 
<a name="l02086"></a>02086       icells = 0
<a name="l02087"></a>02087       <span class="keyword">do</span> j = jlo, jhi
<a name="l02088"></a>02088       <span class="keyword">do</span> i = ilo, ihi
<a name="l02089"></a>02089          <span class="keyword">if</span> (aice(i,j) &gt; (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l02090"></a>02090             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;Zap ice: excess ice area&apos;</span>
<a name="l02091"></a>02091             <span class="keyword">write</span> (<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j, aice =&apos;</span>, &amp;
<a name="l02092"></a>02092                                i, j, aice(i,j)
<a name="l02093"></a>02093             l_stop = .true.
<a name="l02094"></a>02094             istop = i
<a name="l02095"></a>02095             jstop = j
<a name="l02096"></a>02096             return
<a name="l02097"></a>02097          elseif (aice(i,j) &gt; <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a> .and. aice(i,j) &lt; (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>+<a class="code" href="namespaceice__constants.html#af5d2a72e22e7a53706b6a41ba932a67d">puny</a>)) <span class="keyword">then</span>
<a name="l02098"></a>02098             icells = icells + 1
<a name="l02099"></a>02099             indxi(icells) = i
<a name="l02100"></a>02100             indxj(icells) = j
<a name="l02101"></a>02101          <span class="keyword">endif</span>
<a name="l02102"></a>02102       <span class="keyword">enddo</span>
<a name="l02103"></a>02103       <span class="keyword">enddo</span>
<a name="l02104"></a>02104 
<a name="l02105"></a>02105       <span class="keyword">do</span> n = 1, <a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l02106"></a>02106 
<a name="l02107"></a>02107       <span class="comment">!----------------------------------------------------------------- </span>
<a name="l02108"></a>02108       <span class="comment">! Zap ice energy and use ocean heat to melt ice </span>
<a name="l02109"></a>02109       <span class="comment">!----------------------------------------------------------------- </span>
<a name="l02110"></a>02110        
<a name="l02111"></a>02111          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#a5c1a0b8bcf4dc16b485be17beea4f6bf">nilyr</a> 
<a name="l02112"></a>02112 <span class="comment">!DIR$ CONCURRENT !Cray </span>
<a name="l02113"></a>02113 <span class="comment">!cdir nodep      !NEC </span>
<a name="l02114"></a>02114 <span class="comment">!ocl novrec      !Fujitsu </span>
<a name="l02115"></a>02115             <span class="keyword">do</span> ij = 1, icells 
<a name="l02116"></a>02116                i = indxi(ij) 
<a name="l02117"></a>02117                j = indxj(ij) 
<a name="l02118"></a>02118  
<a name="l02119"></a>02119                xtmp = eicen(i,j,ilyr1(n)+k-1)  &amp;
<a name="l02120"></a>02120                     * (aice(i,j)-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)/aice(i,j) / dt <span class="comment">! &lt; 0 </span>
<a name="l02121"></a>02121                dfhocn(i,j) = dfhocn(i,j) + xtmp 
<a name="l02122"></a>02122                eicen(i,j,ilyr1(n)+k-1) = eicen(i,j,ilyr1(n)+k-1) &amp;
<a name="l02123"></a>02123                                         * (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>/aice(i,j))
<a name="l02124"></a>02124  
<a name="l02125"></a>02125             <span class="keyword">enddo</span>               <span class="comment">! ij </span>
<a name="l02126"></a>02126          <span class="keyword">enddo</span>                  <span class="comment">! k </span>
<a name="l02127"></a>02127  
<a name="l02128"></a>02128       <span class="comment">!----------------------------------------------------------------- </span>
<a name="l02129"></a>02129       <span class="comment">! Zap snow energy and use ocean heat to melt snow </span>
<a name="l02130"></a>02130       <span class="comment">!----------------------------------------------------------------- </span>
<a name="l02131"></a>02131 
<a name="l02132"></a>02132          <span class="keyword">do</span> k = 1, <a class="code" href="namespaceice__domain__size.html#aa5abf2eae8654b241bf06dac90d70c6b">nslyr</a> 
<a name="l02133"></a>02133 <span class="comment">!DIR$ CONCURRENT !Cray </span>
<a name="l02134"></a>02134 <span class="comment">!cdir nodep      !NEC </span>
<a name="l02135"></a>02135 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02136"></a>02136             <span class="keyword">do</span> ij = 1, icells
<a name="l02137"></a>02137                i = indxi(ij) 
<a name="l02138"></a>02138                j = indxj(ij) 
<a name="l02139"></a>02139  
<a name="l02140"></a>02140                xtmp = esnon(i,j,slyr1(n)+k-1)  &amp;
<a name="l02141"></a>02141                     * (aice(i,j)-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)/aice(i,j) / dt <span class="comment">! &lt; 0 </span>
<a name="l02142"></a>02142                dfhocn(i,j) = dfhocn(i,j) + xtmp 
<a name="l02143"></a>02143                esnon(i,j,slyr1(n)+k-1) = esnon(i,j,slyr1(n)+k-1) &amp;
<a name="l02144"></a>02144                                         *(<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>/aice(i,j))
<a name="l02145"></a>02145  
<a name="l02146"></a>02146             <span class="keyword">enddo</span>               <span class="comment">! ij</span>
<a name="l02147"></a>02147          <span class="keyword">enddo</span>                  <span class="comment">! k</span>
<a name="l02148"></a>02148  
<a name="l02149"></a>02149       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02150"></a>02150       <span class="comment">! Zap ice and snow volume, add water and salt to ocean</span>
<a name="l02151"></a>02151       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02152"></a>02152 
<a name="l02153"></a>02153 <span class="comment">!DIR$ CONCURRENT !Cray </span>
<a name="l02154"></a>02154 <span class="comment">!cdir nodep      !NEC </span>
<a name="l02155"></a>02155 <span class="comment">!ocl novrec      !Fujitsu </span>
<a name="l02156"></a>02156          <span class="keyword">do</span> ij = 1, icells 
<a name="l02157"></a>02157             i = indxi(ij) 
<a name="l02158"></a>02158             j = indxj(ij) 
<a name="l02159"></a>02159  
<a name="l02160"></a>02160             xtmp = (<a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*vicen(i,j,n) + <a class="code" href="namespaceice__constants.html#ae2404a45dc46ecdb371055dd52dcfe1f">rhos</a>*vsnon(i,j,n)) &amp;
<a name="l02161"></a>02161                  * (aice(i,j)-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)/aice(i,j) / dt 
<a name="l02162"></a>02162             dfresh(i,j) = dfresh(i,j) + xtmp 
<a name="l02163"></a>02163  
<a name="l02164"></a>02164             xtmp = <a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a>*vicen(i,j,n)*ice_ref_salinity*<a class="code" href="namespaceice__constants.html#a32bc94e42275169979f5be642d23634e">p001</a> &amp;
<a name="l02165"></a>02165                  * (aice(i,j)-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)/aice(i,j) / dt
<a name="l02166"></a>02166             dfsalt(i,j) = dfsalt(i,j) + xtmp 
<a name="l02167"></a>02167  
<a name="l02168"></a>02168             aicen(i,j,n) = aicen(i,j,n) * (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>/aice(i,j)) 
<a name="l02169"></a>02169             vicen(i,j,n) = vicen(i,j,n) * (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>/aice(i,j)) 
<a name="l02170"></a>02170             vsnon(i,j,n) = vsnon(i,j,n) * (<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>/aice(i,j))
<a name="l02171"></a>02171  
<a name="l02172"></a>02172          <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02173"></a>02173 
<a name="l02174"></a>02174       <span class="comment">! Note: Tracers are unchanged.</span>
<a name="l02175"></a>02175 
<a name="l02176"></a>02176 <span class="comment">!DIR$ CONCURRENT !Cray</span>
<a name="l02177"></a>02177 <span class="comment">!cdir nodep      !NEC</span>
<a name="l02178"></a>02178 <span class="comment">!ocl novrec      !Fujitsu</span>
<a name="l02179"></a>02179          <span class="keyword">if</span> (tr_aero) <span class="keyword">then</span>
<a name="l02180"></a>02180           <span class="keyword">do</span> ij = 1, icells
<a name="l02181"></a>02181            i = indxi(ij)
<a name="l02182"></a>02182            j = indxj(ij)
<a name="l02183"></a>02183            <span class="keyword">do</span> it=1,n_aero
<a name="l02184"></a>02184             xtmp &amp;
<a name="l02185"></a>02185               = (vsnon(i,j,n)*(trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>  +4*(it-1),n)   &amp;
<a name="l02186"></a>02186                               +trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>+1+4*(it-1),n))  &amp;
<a name="l02187"></a>02187               +  vicen(i,j,n)*(trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>+2+4*(it-1),n)   &amp;
<a name="l02188"></a>02188                               +trcrn(i,j,<a class="code" href="namespaceice__state.html#a17498b6cf9c7353f2704a5cd0b579718">nt_aero</a>+3+4*(it-1),n))) &amp;
<a name="l02189"></a>02189               * (aice(i,j)-<a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>)/aice(i,j) / dt
<a name="l02190"></a>02190             dfsoot(i,j,it) = dfsoot(i,j,it) + xtmp
<a name="l02191"></a>02191            <span class="keyword">enddo</span>                 <span class="comment">! n</span>
<a name="l02192"></a>02192           <span class="keyword">enddo</span>                  <span class="comment">! ij</span>
<a name="l02193"></a>02193          <span class="keyword">endif</span>
<a name="l02194"></a>02194 
<a name="l02195"></a>02195       <span class="keyword">enddo</span>                     <span class="comment">! n</span>
<a name="l02196"></a>02196 
<a name="l02197"></a>02197       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02198"></a>02198       <span class="comment">! Correct aice</span>
<a name="l02199"></a>02199       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02200"></a>02200 
<a name="l02201"></a>02201 <span class="comment">!DIR$ CONCURRENT !Cray </span>
<a name="l02202"></a>02202 <span class="comment">!cdir nodep      !NEC </span>
<a name="l02203"></a>02203 <span class="comment">!ocl novrec      !Fujitsu </span>
<a name="l02204"></a>02204       <span class="keyword">do</span> ij = 1, icells 
<a name="l02205"></a>02205          i = indxi(ij) 
<a name="l02206"></a>02206          j = indxj(ij) 
<a name="l02207"></a>02207          aice(i,j) = <a class="code" href="namespaceice__constants.html#a74c3f6d59942aec40dda487c6af99039">c1</a>
<a name="l02208"></a>02208          aice0(i,j) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02209"></a>02209       <span class="keyword">enddo</span>
<a name="l02210"></a>02210 
<a name="l02211"></a>02211 <span class="keyword">      end subroutine zap_small_areas</span>
<a name="l02212"></a>02212 
<a name="l02213"></a>02213 <span class="comment">!=======================================================================</span>
<a name="l02214"></a>02214 <span class="comment">!BOP</span>
<a name="l02215"></a>02215 <span class="comment">!</span>
<a name="l02216"></a>02216 <span class="comment">! !IROUTINE: zerolayer_check - check that snow and ice energy is</span>
<a name="l02217"></a>02217 <span class="comment">!                         correct when using zero layer thermodynamics</span>
<a name="l02218"></a>02218 <span class="comment">!</span>
<a name="l02219"></a>02219 <span class="comment">! !INTERFACE:</span>
<a name="l02220"></a>02220 <span class="comment">!</span>
<a name="l02221"></a><a class="code" href="namespaceice__itd.html#a55c2adda4305308869dac586cefe447a">02221</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceice__itd.html#a55c2adda4305308869dac586cefe447a">zerolayer_check</a> (nx_block,    ny_block,   &amp;
<a name="l02222"></a>02222                                   icells,  indxi,   indxj, &amp;
<a name="l02223"></a>02223                                   aicen,                   &amp;
<a name="l02224"></a>02224                                   vicen,       vsnon,      &amp;
<a name="l02225"></a>02225                                   eicen,       esnon,      &amp;
<a name="l02226"></a>02226                                   l_stop,                  &amp;
<a name="l02227"></a>02227                                   istop,       jstop)
<a name="l02228"></a>02228 <span class="comment">!</span>
<a name="l02229"></a>02229 <span class="comment">! !DESCRIPTION:</span>
<a name="l02230"></a>02230 <span class="comment">!</span>
<a name="l02231"></a>02231 <span class="comment">! Checks that the snow and ice energy in the zero layer thermodynamics</span>
<a name="l02232"></a>02232 <span class="comment">! model still agrees with the snow and ice volume.</span>
<a name="l02233"></a>02233 <span class="comment">! If there is an error, the model will abort.</span>
<a name="l02234"></a>02234 <span class="comment">! This subroutine is only called if heat_capacity = .false.</span>
<a name="l02235"></a>02235 <span class="comment">!</span>
<a name="l02236"></a>02236 <span class="comment">! !REVISION HISTORY:</span>
<a name="l02237"></a>02237 <span class="comment">!</span>
<a name="l02238"></a>02238 <span class="comment">! author: Alison McLaren, Met Office</span>
<a name="l02239"></a>02239 <span class="comment">!</span>
<a name="l02240"></a>02240 <span class="comment">! !USES:</span>
<a name="l02241"></a>02241 <span class="comment">!</span>
<a name="l02242"></a>02242 <span class="comment">!</span>
<a name="l02243"></a>02243 <span class="comment">! !INPUT/OUTPUT PARAMETERS:</span>
<a name="l02244"></a>02244 <span class="comment">!</span>
<a name="l02245"></a>02245       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(in)</span> ::  
<a name="l02246"></a>02246          nx_block, ny_block,  <span class="comment">! block dimensions </span>
<a name="l02247"></a>02247          icells                <span class="comment">! number of grid cells with ice</span>
<a name="l02248"></a>02248 
<a name="l02249"></a>02249       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">dimension (nx_block*ny_block)</span>, 
<a name="l02250"></a>02250          <span class="keywordtype">intent(in)</span> :: 
<a name="l02251"></a>02251          indxi, indxj      <span class="comment">! compressed i/j indices</span>
<a name="l02252"></a>02252  
<a name="l02253"></a>02253       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ncat)</span>,  
<a name="l02254"></a>02254          <span class="keywordtype">intent(inout)</span> ::  
<a name="l02255"></a>02255          aicen ,  <span class="comment">! concentration of ice </span>
<a name="l02256"></a>02256          vicen ,  <span class="comment">! volume per unit area of ice          (m) </span>
<a name="l02257"></a>02257          vsnon     <span class="comment">! volume per unit area of snow         (m) </span>
<a name="l02258"></a>02258  
<a name="l02259"></a>02259       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntilyr)</span>,  
<a name="l02260"></a>02260          <span class="keywordtype">intent(in)</span> ::  
<a name="l02261"></a>02261          eicen     <span class="comment">! energy of melting for each ice layer (J/m^2) </span>
<a name="l02262"></a>02262  
<a name="l02263"></a>02263       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block,ntslyr)</span>,  
<a name="l02264"></a>02264          <span class="keywordtype">intent(in)</span> ::  
<a name="l02265"></a>02265          esnon     <span class="comment">! energy of melting for each snow layer (J/m^2) </span>
<a name="l02266"></a>02266       
<a name="l02267"></a>02267       <span class="keywordtype">logical (kind=log_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l02268"></a>02268          l_stop    <span class="comment">! if true, abort on return</span>
<a name="l02269"></a>02269 
<a name="l02270"></a>02270       <span class="keywordtype">integer (kind=int_kind)</span>, <span class="keywordtype">intent(out)</span> :: 
<a name="l02271"></a>02271          istop, jstop <span class="comment">! indices of grid cell where model aborts</span>
<a name="l02272"></a>02272 <span class="comment">!</span>
<a name="l02273"></a>02273 <span class="comment">!EOP</span>
<a name="l02274"></a>02274 <span class="comment">!</span>
<a name="l02275"></a>02275       <span class="keywordtype">integer (kind=int_kind) </span>:: 
<a name="l02276"></a>02276          i, j             ,  <span class="comment">! horizontal indices</span>
<a name="l02277"></a>02277          n                ,  <span class="comment">! category index</span>
<a name="l02278"></a>02278          ij                   <span class="comment">! combined horizontal index</span>
<a name="l02279"></a>02279 
<a name="l02280"></a>02280       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">parameter</span> :: 
<a name="l02281"></a>02281          max_error = puny*Lfresh*rhos <span class="comment">! max error in zero layer energy check</span>
<a name="l02282"></a>02282                                       <span class="comment">! (so max volume error = puny)</span>
<a name="l02283"></a>02283 
<a name="l02284"></a>02284       <span class="keywordtype">logical (kind=log_kind) </span>:: 
<a name="l02285"></a>02285          ice_energy_correct  ,  <span class="comment">! zero layer ice energy check</span>
<a name="l02286"></a>02286          snow_energy_correct     <span class="comment">! zero layer snow energy check</span>
<a name="l02287"></a>02287 
<a name="l02288"></a>02288       <span class="keywordtype">real (kind=dbl_kind)</span>, <span class="keywordtype">dimension (nx_block,ny_block) </span>:: 
<a name="l02289"></a>02289          worka, 
<a name="l02290"></a>02290          workb
<a name="l02291"></a>02291 
<a name="l02292"></a>02292       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02293"></a>02293       <span class="comment">! Initialize</span>
<a name="l02294"></a>02294       <span class="comment">!-----------------------------------------------------------------</span>
<a name="l02295"></a>02295 
<a name="l02296"></a>02296       l_stop = .false.
<a name="l02297"></a>02297       istop = 0
<a name="l02298"></a>02298       jstop = 0
<a name="l02299"></a>02299 
<a name="l02300"></a>02300       worka(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02301"></a>02301       workb(:,:) = <a class="code" href="namespaceice__constants.html#a8320d3c058c4ae0e12bbf1b11305e51e">c0</a>
<a name="l02302"></a>02302 
<a name="l02303"></a>02303       <span class="comment">!----------------------------------------------------------------</span>
<a name="l02304"></a>02304       <span class="comment">! Calculate difference between ice and snow energies and the</span>
<a name="l02305"></a>02305       <span class="comment">! energy values derived from the ice and snow volumes</span>
<a name="l02306"></a>02306       <span class="comment">!----------------------------------------------------------------</span>
<a name="l02307"></a>02307 
<a name="l02308"></a>02308       ice_energy_correct  = .true.
<a name="l02309"></a>02309       snow_energy_correct = .true.
<a name="l02310"></a>02310 
<a name="l02311"></a>02311       <span class="keyword">do</span> n=1,<a class="code" href="namespaceice__domain__size.html#af6426e75baee1427e99bac2564d5afd7">ncat</a>
<a name="l02312"></a>02312 
<a name="l02313"></a>02313          <span class="keyword">do</span> ij=1,icells
<a name="l02314"></a>02314             i=indxi(ij)
<a name="l02315"></a>02315             j=indxj(ij)
<a name="l02316"></a>02316 
<a name="l02317"></a>02317             worka(i,j) = eicen(i,j,n) + <a class="code" href="namespaceice__constants.html#ab8aa44724cb8c314b55a09244600f68d">rhoi</a> * Lfresh * vicen(i,j,n)
<a name="l02318"></a>02318             workb(i,j) = esnon(i,j,n) + rhos * Lfresh * vsnon(i,j,n)
<a name="l02319"></a>02319 
<a name="l02320"></a>02320             <span class="keyword">if</span>(abs(worka(i,j)) &gt; max_error) <span class="keyword">then</span>
<a name="l02321"></a>02321                ice_energy_correct = .false.
<a name="l02322"></a>02322             <span class="keyword">endif</span>
<a name="l02323"></a>02323 
<a name="l02324"></a>02324             <span class="keyword">if</span>(abs(workb(i,j)) &gt; max_error) <span class="keyword">then</span>
<a name="l02325"></a>02325                snow_energy_correct = .false.
<a name="l02326"></a>02326             <span class="keyword">endif</span>
<a name="l02327"></a>02327          <span class="keyword">enddo</span>
<a name="l02328"></a>02328 
<a name="l02329"></a>02329       <span class="comment">!----------------------------------------------------------------</span>
<a name="l02330"></a>02330       <span class="comment">! If there is a problem, abort with error message</span>
<a name="l02331"></a>02331       <span class="comment">!----------------------------------------------------------------</span>
<a name="l02332"></a>02332 
<a name="l02333"></a>02333          <span class="keyword">if</span> (.not. ice_energy_correct) <span class="keyword">then</span>
<a name="l02334"></a>02334 
<a name="l02335"></a>02335             <span class="keyword">do</span> ij=1,icells
<a name="l02336"></a>02336                i=indxi(ij)
<a name="l02337"></a>02337                j=indxj(ij)
<a name="l02338"></a>02338 
<a name="l02339"></a>02339                <span class="keyword">if</span>(abs(worka(i,j)) &gt; max_error) <span class="keyword">then</span>
<a name="l02340"></a>02340                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l02341"></a>02341                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) &amp;
<a name="l02342"></a>02342                     <span class="stringliteral">&apos;zerolayer check - wrong ice energy&apos;</span>
<a name="l02343"></a>02343                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j, n:&apos;</span>, i,j,n
<a name="l02344"></a>02344                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;eicen =&apos;</span>, eicen(i,j,n)
<a name="l02345"></a>02345                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;error=&apos;</span>,  worka(i,j)
<a name="l02346"></a>02346                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;vicen =&apos;</span>, vicen(i,j,n)
<a name="l02347"></a>02347                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;aicen =&apos;</span>, aicen(i,j,n)
<a name="l02348"></a>02348                   l_stop = .true.
<a name="l02349"></a>02349                   istop = i
<a name="l02350"></a>02350                   jstop = j
<a name="l02351"></a>02351                <span class="keyword">endif</span>
<a name="l02352"></a>02352             <span class="keyword">enddo</span>
<a name="l02353"></a>02353 
<a name="l02354"></a>02354          <span class="keyword">endif</span>
<a name="l02355"></a>02355          <span class="keyword">if</span> (l_stop) return
<a name="l02356"></a>02356 
<a name="l02357"></a>02357          <span class="keyword">if</span> (.not. snow_energy_correct) <span class="keyword">then</span>
<a name="l02358"></a>02358 
<a name="l02359"></a>02359             <span class="keyword">do</span> ij=1,icells
<a name="l02360"></a>02360                i=indxi(ij)
<a name="l02361"></a>02361                j=indxj(ij)
<a name="l02362"></a>02362 
<a name="l02363"></a>02363                <span class="keyword">if</span>(abs(workb(i,j)) &gt; max_error) <span class="keyword">then</span>
<a name="l02364"></a>02364                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos; &apos;</span>
<a name="l02365"></a>02365                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) &amp;
<a name="l02366"></a>02366                     <span class="stringliteral">&apos;zerolayer_check - wrong snow energy&apos;</span>
<a name="l02367"></a>02367                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;i, j, n:&apos;</span>, i,j,n
<a name="l02368"></a>02368                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;esnon =&apos;</span>, esnon(i,j,n)
<a name="l02369"></a>02369                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;error=&apos;</span>,  workb(i,j)
<a name="l02370"></a>02370                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;vsnon =&apos;</span>, vsnon(i,j,n)
<a name="l02371"></a>02371                   <span class="keyword">write</span>(<a class="code" href="namespaceice__fileunits.html#a5a65f292ace9ba700843f3e293922842">nu_diag</a>,*) <span class="stringliteral">&apos;aicen =&apos;</span>, aicen(i,j,n)
<a name="l02372"></a>02372                   l_stop = .true.
<a name="l02373"></a>02373                   istop = i
<a name="l02374"></a>02374                   jstop = j
<a name="l02375"></a>02375                   return
<a name="l02376"></a>02376                <span class="keyword">endif</span>
<a name="l02377"></a>02377             <span class="keyword">enddo</span>
<a name="l02378"></a>02378 
<a name="l02379"></a>02379          <span class="keyword">endif</span>
<a name="l02380"></a>02380 
<a name="l02381"></a>02381       <span class="keyword">enddo</span>  <span class="comment">! ncat</span>
<a name="l02382"></a>02382 
<a name="l02383"></a>02383 <span class="keyword">      end subroutine zerolayer_check</span>
<a name="l02384"></a>02384 
<a name="l02385"></a>02385 <span class="comment">!=======================================================================</span>
<a name="l02386"></a>02386 
<a name="l02387"></a>02387 <span class="keyword">      end module ice_itd</span>
<a name="l02388"></a>02388 
<a name="l02389"></a>02389 <span class="comment">!=======================================================================</span>
<a name="l02390"></a>02390 
<a name="l02391"></a>02391 
<a name="l02392"></a>02392 
<a name="l02393"></a>02393 
<a name="l02394"></a>02394 
<a name="l02395"></a>02395 
<a name="l02396"></a>02396 
<a name="l02397"></a>02397 
<a name="l02398"></a>02398 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Tue Oct 6 14:02:23 2009 for CICE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
