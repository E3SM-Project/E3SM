/**
 * @file emulator_config.hpp
 * @brief Configuration structures for emulator components.
 *
 * Defines the configuration structures used by emulator components,
 * including build-time settings, runtime parameters, and model I/O
 * configuration. Configuration is typically loaded from YAML files
 * generated by the buildnml script.
 */

#ifndef EMULATOR_CONFIG_HPP
#define EMULATOR_CONFIG_HPP

#include "emulator_diagnostics.hpp"
#include <string>
#include <vector>

namespace emulator {

/**
 * @brief Build-time configuration (set by buildnml, fixed for a case).
 *
 * These values are determined at case creation time and cannot change
 * between runs without rebuilding the case.
 */
struct BuildConfig {
  std::string grid_name;                  ///< Grid name (e.g., "gauss180x360")
  std::string inference_backend = "stub"; ///< Backend: "stub" or "libtorch"
};

/**
 * @brief Runtime configuration (can change per run via atm_in YAML).
 *
 * These values can be modified between runs without rebuilding the case.
 */
struct RuntimeConfig {
  std::string model_path; ///< Path to AI model file (TorchScript .pt)
  std::string ic_file;    ///< Initial conditions file path
  bool enabled = true;    ///< Enable inference (false = pass-through mode)
};

/**
 * @brief Model I/O variable configuration.
 *
 * Specifies which fields are used as inputs and outputs for the
 * AI model, and controls the data layout during inference.
 */
struct ModelIOConfig {
  std::vector<std::string> input_variables;  ///< Fields to pack as model input
  std::vector<std::string> output_variables; ///< Fields to extract from output

  /**
   * @brief Enable spatial mode for CNN-based models (e.g., ACE2).
   *
   * When true (CNN mode):
   *
   * - Input data is reshaped from [H*W, C] to [1, C, H, W] before inference
   * - Output data is reshaped from [1, C, H, W] to [H*W, C] after inference
   * - The entire grid is processed as a single sample (batch_size=1)
   *
   * When false (pointwise/MLP mode):
   *
   * - Data remains in [batch_size, channels] format
   * - Each grid point is processed independently (batch_size=H*W)
   *
   * @note Default: true (assumes CNN model like ACE2)
   */
  bool spatial_mode = true;
};

/**
 * @brief Coupling configuration options.
 *
 * Controls behavior of the component's interaction with the MCT coupler.
 */
struct CouplingConfig {
  bool zero_init_exports = true; ///< Zero export fields on initialization
  bool debug = false;            ///< Enable coupling debug output
};

/**
 * @brief Base configuration structure for all emulator components.
 *
 * Aggregates all configuration sub-structures. The YAML configuration
 * file is generated by buildnml by merging defaults with user overrides.
 *
 * ## Configuration Sections
 *
 * - **build**: Set at case creation, fixed for the case
 * - **runtime**: Can be modified per run via atm_in YAML
 * - **model_io**: Controls AI model input/output variables
 * - **coupling**: Controls MCT coupling behavior
 *
 * ## Example YAML
 * ```yaml
 * eatm:
 *   build:
 *     grid_name: gauss180x360
 *     inference_backend: libtorch
 *   runtime:
 *     model_path: /path/to/model.pt
 *     ic_file: /path/to/initial_conditions.nc
 *   model_io:
 *     spatial_mode: true
 *     input_variables: [Ta, Qa, Ua, Va]
 *     output_variables: [prec, lwdn, swdn]
 * ```
 */
struct EmulatorConfig {
  BuildConfig build;            ///< Build-time configuration
  RuntimeConfig runtime;        ///< Runtime configuration
  ModelIOConfig model_io;       ///< Model I/O configuration
  CouplingConfig coupling;      ///< Coupling configuration
  DiagnosticConfig diagnostics; ///< Diagnostic output configuration

  // Legacy accessors for compatibility (deprecated)
  std::string grid_file; ///< @deprecated Use domain info instead
};

/**
 * @brief Parse emulator configuration from a YAML file.
 *
 * Reads the specified YAML file and extracts the configuration for
 * the given component section.
 *
 * @param yaml_file Path to YAML configuration file
 * @param section_name Name of the component section (e.g., "eatm", "eocn")
 * @return Parsed configuration structure
 * @throws std::runtime_error if file cannot be read or section is missing
 */
EmulatorConfig parse_emulator_config(const std::string &yaml_file,
                                     const std::string &section_name);

/**
 * @brief Parse emulator configuration with fallback to defaults.
 *
 * Attempts to parse the YAML file. If the file doesn't exist or
 * parsing fails, returns default configuration values.
 *
 * @param yaml_file Path to YAML configuration file
 * @param section_name Name of the component section (e.g., "eatm", "eocn")
 * @param verbose Print debug information if true
 * @return Parsed configuration structure (or defaults on failure)
 */
EmulatorConfig
parse_emulator_config_with_defaults(const std::string &yaml_file,
                                    const std::string &section_name,
                                    bool verbose = false);

} // namespace emulator

#endif // EMULATOR_CONFIG_HPP
