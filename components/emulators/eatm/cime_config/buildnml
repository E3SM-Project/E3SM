#!/usr/bin/env python3

"""Build runtime configuration for EATM.
"""

import logging
import os
import sys

_CIMEROOT = os.path.join(
    os.path.dirname(os.path.abspath(__file__)),
    "..", "..", "..", "..", "cime",
)
sys.path.append(os.path.join(_CIMEROOT, "scripts", "Tools"))

from standard_script_setup import *  # noqa: F401,F403,E402
from CIME.case import Case  # noqa: E402
from CIME.utils import safe_copy  # noqa: E402
from CIME.buildnml import parse_input  # noqa: E402

logger = logging.getLogger(__name__)


def _create_atm_in(case, confdir, inst_string):
    """Create atm configuration file."""
    output_file = os.path.join(confdir, f"atm_in{inst_string}")

    grid = case.get_value("ATM_GRID")
    domain_file = case.get_value("ATM_DOMAIN_FILE")
    domain_path = case.get_value("ATM_DOMAIN_PATH")

    with open(output_file, "w", encoding="utf-8") as f:
        f.write("# EATM configuration\n")
        f.write("mode: stub\n")
        f.write(f"grid: {grid}\n")
        f.write(f"nx: {case.get_value('ATM_NX')}\n")
        f.write(f"ny: {case.get_value('ATM_NY')}\n")
        if domain_path and domain_file:
            f.write(f"domain_file: {os.path.join(domain_path, domain_file)}\n")
        elif domain_file:
            f.write(f"domain_file: {domain_file}\n")

    logger.info("Generated EATM configuration: %s", output_file)
    return output_file


def buildnml(case, caseroot, compname):
    """ build the namelist """
    if compname != "eatm":
        raise AttributeError(
            f"Expected compname 'eatm', got '{compname}'"
        )

    rundir = case.get_value("RUNDIR")
    ninst = case.get_value("NINST_ATM")
    if ninst is None:
        ninst = case.get_value("NINST")

    confdir = os.path.join(
        caseroot, "Buildconf", compname + "conf")
    if not os.path.isdir(confdir):
        os.makedirs(confdir)

    data_list_path = os.path.join(
        caseroot, "Buildconf", "eatm.input_data_list")
    if os.path.exists(data_list_path):
        os.remove(data_list_path)

    for inst_counter in range(1, ninst + 1):
        inst_string = ""
        if ninst > 1:
            inst_string = "_{:04d}".format(inst_counter)

        rpointer = "rpointer.atm"
        rp_src = os.path.join(rundir, rpointer)
        rp_dst = os.path.join(rundir, rpointer + inst_string)
        if os.path.isfile(rp_src) and not os.path.isfile(rp_dst):
            safe_copy(rp_src, rp_dst)

        config_file = _create_atm_in(
            case, confdir, inst_string)

        if os.path.isdir(rundir):
            filename = "atm_in"
            if inst_string:
                filename = f"atm_in{inst_string}"
            safe_copy(config_file, os.path.join(rundir, filename))


def _main_func():
    caseroot = parse_input(sys.argv)
    with Case(caseroot) as case:
        buildnml(case, caseroot, "eatm")


if __name__ == "__main__":
    _main_func()
