#! /usr/bin/env perl
use strict;

if ($#ARGV == -1) {
    die " ERROR ww3 buildlib: must specify a caseroot input argument";
}
my ($CASEROOT) = @ARGV;
chdir "${CASEROOT}";

my $CASEROOT		= `./xmlquery CASEROOT       --value`;
my $CASETOOLS		= `./xmlquery CASETOOLS      --value`;
my $SRCROOT		= `./xmlquery SRCROOT        --value`;
my $MACH		= `./xmlquery MACH           --value`;
my $OBJROOT		= `./xmlquery OBJROOT        --value`;
my $LIBROOT		= `./xmlquery LIBROOT        --value`;
my $GMAKE_J		= `./xmlquery GMAKE_J        --value`;
my $GMAKE		= `./xmlquery GMAKE          --value`;
my $COMPILER            = `./xmlquery COMPILER       --value`;
my $MPILIB              = `./xmlquery MPILIB         --value`;
my $COMP_INTERFACE      = `./xmlquery COMP_INTERFACE --value`;
my $EXEROOT             = `./xmlquery EXEROOT        --value`;
my $NINST_VALUE         = `./xmlquery NINST_VALUE    --value`;

# Define and cd to the WW3 bin directory
my $repodir = "$SRCROOT/components/ww3/src/source";
my $modeldir = "$repodir/WW3/model";
my $bindir = "$modeldir/bin";
chdir $bindir;

# Run w3_setup to create wwatch3.env file (if needed)
if (not -f "$bindir/wwatch3.env"){
  `cp $repodir/switch_E3SM $bindir`;
  open(file,">w3_setup.inp") or die "Could not open file w3_setup.inp to write";
  print file "n\n";
  close(file);
  `./w3_setup $modeldir -c Gnu -s E3SM < w3_setup.inp`;
  `rm w3_setup.inp`;
  `rm switch_E3SM`;
}

# Generate pre-processed WW3 source code
my $tmpdir = "$modeldir/tmp";
my $tarfile = "$modeldir/work/ww3_shel.tar.gz";
`./w3_source ww3_shel`;
`mv $tarfile $tmpdir`;
chdir $tmpdir;
`tar -xzvf ww3_shel.tar.gz`;

# Cleanup untracked file
chdir $modeldir;
`rm makefile`;

chdir "$OBJROOT/wav/obj";
open(file,">Filepath") or die "Could not open file Filepath to write";
print file "${CASEROOT}/SourceMods/src.ww3\n";
print file "${tmpdir}\n";
print file "${SRCROOT}/components/ww3/src/cpl\n";
close(file);
my $sysmod = "$GMAKE complib -j $GMAKE_J MODEL=ww3 COMPLIB=$LIBROOT/libwav.a -f $CASETOOLS/Makefile CASEROOT=$CASEROOT CASETOOLS=$CASETOOLS COMPILER=$COMPILER MPILIB=$MPILIB COMP_INTERFACE=$COMP_INTERFACE EXEROOT=$EXEROOT NINST_VALUE=$NINST_VALUE";
system($sysmod) == 0 or die "ERROR: $sysmod failed: $?\n";

exit(0);
