<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PIO User&#39;s Guide: Example of PIO usage in CAM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Types&nbsp;List</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="CAMexample">Example of PIO usage in CAM </a></h1><h2><a class="anchor" id="intro">
Implementation of PIO in CAM</a></h2>
<p>CAM references PIO through both interface routines (which call PIO routines) and PIO routines proper. The interface routines control much of the setting up of PIO output and input, whereas the actual output and input is accomplished through direct PIO calls. The PIO routines are located in models/utils/pio. A description of the PIO package along with usage information may be found in the main PIO documentation. We will first describe the interface and then cover the direct calls.</p>
<h2><a class="anchor" id="description">
Description of the CAM Interface</a></h2>
<p>The CAM interface to PIO consists of the pio_utils module, which is the file models/atm/cam/src/utils/pio_utils.F90.</p>
<p>Init_pio_subsystem is the first routine called. It is called from cam_init and initializes PIO in CAM. Init_pio_subsystem calls read_namelist_pio, which calls set_pio_parameters. The main parameters set includes the IO mode (netcdf vs pnetcdf), number of IO tasks, and IO stride.</p>
<p>Cam_pio_createfile and cam_pio_openfile create and open a PIO file, respectively. Cam_pio_createfile is called from cam_write_restart, h_define (called from wshist, which is called from write_restart_history), and atm_write_srfrest_mct.</p>
<p>Cam_pio_openfile is called from setup_initial (called from cam_initial), cam_read_restart, read_restart_history, atm_read_srfrest_mct, and wrapup (called from cam_run4).</p>
<p>Clean_iodesc_list, called from startup_initialconds and cam_read_restart, cleans the list of IO descriptors.</p>
<p>Get_phys_decomp and get_dyn_decomp create decompositions for physics and dynamics variables, respectively. Get_decomp is an interface to those routines.</p>
<p>Get_phys_decomp is directly called from infld_real_2d, infld_real_3d, infld_real_3dncol; read_restart_physics, write_restart_physics; and pbuf_read_restart, pbuf_write_restart.</p>
<p>Get_dyn_decomp is directly called from infld_real_2d and infld_real_3d.</p>
<p>Get_decomp is called from read_restart_history and dump_field (called from wshist, which is called from write_restart_history). We see that the only time the get_decomp interface is called is when dealing with history variables (where each variable contains a description telling whether it relates to dynamics or physics).</p>
<p>Get_phys_decomp and get_dyn_decomp have an optional column (or column_in) argument, which is used when defining history variables over a range of columns rather than the whole domain.</p>
<p>Whenever a decomposition is created, a description of that decomposition is stored in a list. When a new variable is catalogued, that list is searched to see if that needed decomposition already exists. The routine performing that search is find_iodesc (called from get_phys_decomp and get_dyn_decomp). This capability is supported only when the range of history output is the whole domain.</p>
<p>Get_phys_decomp calls get_phys_ldof (or get_column_ldof), and get_dyn_decomp calls get_dyn_ldof (or get_column_ldof). These routines do the bulk of the work in constructing the IO decompositions. Get_column_ldof is called when the history output is restricted to a subset of the domain.</p>
<h2><a class="anchor" id="direct">
Direct calls to PIO</a></h2>
<p>Virtually all the calls to PIO routines reference the <a class="el" href="namespacepio.html">pio</a> module, located in <a class="el" href="pio_8F90_source.html">pio.F90</a>. Many of the variables contained in the <a class="el" href="namespacepio.html">pio</a> module are referenced as well. This section of the documentation focuses on these calls and surrounding environs and discusses data types only peripherally.</p>
<h2><a class="anchor" id="historyWrite">
Writing a history file</a></h2>
<p>Write_restart_history (in control/cam_history.F90) controls the writing of a history file. Wshist writes the main variables that are on history tapes. Pio_put_var is used to write header information, and subroutine dump_field writes the main history variables, using primarily <a class="el" href="group__PIO__write__darray.html">PIO_write_darray</a>. Additional variables are then written using <a class="el" href="group__PIO__put__var.html">PIO_put_var</a>. (Recall that <a class="el" href="group__PIO__write__darray.html">PIO_write_darray</a> isused to write distributed arrays.)</p>
<h2><a class="anchor" id="historyRead">
Reading a history file</a></h2>
<p>Read_restart_history (in control/cam_history.F90) controls the reading of a history file. Individual parameters are first read using pio_get_var. History variables are then read in using <a class="el" href="group__PIO__read__darray.html">PIO_read_darray</a> (which reads distributed arrays).</p>
<h2><a class="anchor" id="restartWrite">
Writing a restart dump</a></h2>
<p>Cam_write_restart (in control/cam_restart.F90) controls the writing of a restart dump. The calling chain includes write_restart_hycoef (which writes the pressure coefficients), write_restart_dynamics, write_restart_physics, and write_restart_history. Write_restart_coef is in hycoef.F90 and uses <a class="el" href="group__PIO__put__var.html">PIO_put_var</a> calls. Write_restart_dynamics is in restart_dynamics.F90 (in the dynamics subdirectory relevant to the active dynamical core) and issues primarily <a class="el" href="group__PIO__write__darray.html">PIO_write_darray</a> calls. Write_restart_physics is in physics/cam/restart_physics.F90. It calls a number of restart routines relating to chemistry and aerosols, such as pbuf_write_restart (in physics/cam/phys_buffer.F90), chem_write_restart (in chemistry/mozart), and write_prescribed_?????_restart (where ????? = ozone, ghg, aero, volcaero), located in chemistry/utils/prescribed_?????.F90. Pbuf_write_restart calls the relevant decomposition routine followed by <a class="el" href="group__PIO__write__darray.html">PIO_write_darray</a>. Chem_write_restart calls write_?????_restart (where ????? = tracer_cnst, tracer_srcs, linoz_data, spedata), located in chemistry/mozart/?????.F90. These routines typically use <a class="el" href="group__PIO__put__var.html">PIO_put_var</a>. Write_restart_history is in cam_history.F90 and uses <a class="el" href="group__PIO__put__var.html">PIO_put_var</a>.</p>
<h2><a class="anchor" id="restartRead">
Reading a restart dump</a></h2>
<p>Cam_read_restart (in control/cam_restart.F90) controls the reading of a restart dump. The calling chain corresponds to that for cam_write_restart, and includes read_restart_hycoef, read_restart_dynamics, read_restart_physics, and read_restart_history. Typical routines called are pio_get_var and <a class="el" href="group__PIO__read__darray.html">PIO_read_darray</a>.</p>
<h2><a class="anchor" id="Init">
Initialization</a></h2>
<p>Cam_init (in control/cam_comp.F90) calls cam_initial and phys_init. Cam_initial, which is located in the relevant dynamics subdirectory, calls initial_conds, located in control/startup_initialconds. Initial_conds calls read_inidat, which is located in the relevant dynamics subdirectory. Read_inidat calls infld, located in control/ncdio_atm.F90. Infld calls the relevant decomposition routine followed by <a class="el" href="group__PIO__read__darray.html">PIO_read_darray</a>.</p>
<p>Phys_init is located in physics/cam/phys_grid.F90 and calls a number of initialization routines. An important one is phys_inidat, which makes several calls to infld. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Wed Dec 16 15:25:20 2009 for PIO User's Guide by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
