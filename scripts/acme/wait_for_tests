#!/usr/bin/env python

"""
Wait for a queued ACME test to finish by watching the TestStatus file.
If the test passes, 0 is returned, otherwise a non-zero error code
is returned.
"""

import acme_util
acme_util.check_minimum_python_version(2, 7)
import wait_for_tests

import argparse, sys

###############################################################################
def parse_command_line(args, description):
###############################################################################
    parser = argparse.ArgumentParser(
usage="""\n%s [<Path to TestStatus> <Path to TestStatus> ...]  [--verbose]
OR
%s --help
OR
%s --test

\033[1mEXAMPLES:\033[0m
    \033[1;32m# Wait for test in current dir\033[0m
    > %s
    \033[1;32m# Wait for test in user specified tests\033[0m
    > %s path/to/testdir
    \033[1;32m# Wait for all tests in a test area\033[0m
    > %s path/to/testarea/*/TestStatus
""" % ((os.path.basename(args[0]), ) * 6),

description=description,

formatter_class=argparse.ArgumentDefaultsHelpFormatter
)

    parser.add_argument("paths", default=".", nargs="*", help="Paths to test directories or status file. Pwd default.")

    parser.add_argument("-v", "--verbose", action="store_true", dest="verbose", default=False,
                        help="Print extra information")

    parser.add_argument("-n", "--no-wait", action="store_true", dest="no_wait", default=False,
                        help="Do not wait for tests to finish")

    parser.add_argument("-t", "--check-throughput", action="store_true", dest="check_throughput", default=False,
                        help="Fail if throughput check fails (fail if tests slow down)")

    parser.add_argument("-d", "--cdash-build-name", action="store", dest="cdash_build_name", default=None,
                        help="Build name, implies you want results send to Cdash")

    args = parser.parse_args(args[1:])

    acme_util.set_verbosity(args.verbose)

    return args.paths, args.no_wait, args.check_throughput, args.cdash_build_name

###############################################################################
def _main_func(description):
###############################################################################
    if ("--test" in sys.argv):
        wait_for_tests.run_unit_tests()
        return

    test_paths, no_wait, check_throughput, cdash_build_name = \
        parse_command_line(sys.argv, description)

    sys.exit(0 if wait_for_tests.wait_for_tests(test_paths, no_wait, check_throughput, cdash_build_name) else 1)

###############################################################################

if (__name__ == "__main__"):
    _main_func(__doc__)
