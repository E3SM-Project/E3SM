#!/usr/bin/env python

"""
Script to query xml test lists.
"""
from __future__ import print_function
from Tools.standard_script_setup import *
from CIME.test_utils import get_tests_from_xml

logger = logging.getLogger(__name__)

###############################################################################
def parse_command_line(description):
###############################################################################
    parser = argparse.ArgumentParser(
        description=description)

    CIME.utils.setup_standard_logging_options(parser)

    parser.add_argument("--count", action="store_true",
                        help="Rather than listing tests, just give counts by category/machine/compiler")

    parser.add_argument("--xml-machine",
                        help="Use this machine key in the lookup in testlist.xml, default is all")

    parser.add_argument("--xml-compiler",
                        help="Use this compiler key in the lookup in testlist.xml, default is all")

    parser.add_argument("--xml-category",
                        help="Use this category key in the lookup in testlist.xml, default is all")

    parser.add_argument("--xml-testlist",
                        help="Use this testlist to lookup tests, default specified in config_files.xml")

    args = parser.parse_args()

    CIME.utils.handle_standard_logging_options(args)

    return args

###############################################################################
def print_test_data(test_data):
###############################################################################
    """
    Args:
        test_data (dict): dictionary of test data, containing at least these keys:
            - name: full test name
            - category: test category
    """

    categories = sorted(set([item['category'] for item in test_data]))
    max_category_len = max([len(category) for category in categories])
    for category in categories:
        test_subset = [one_test for one_test in test_data if
                       one_test['category'] == category]
        for one_test in test_subset:
            print("%-*s: %s"%(max_category_len, category, one_test['name']))

###############################################################################
def count_test_data(test_data):
###############################################################################
    """
    Args:
        test_data (dict): dictionary of test data, containing at least these keys:
            - name: full test name
            - category: test category
            - machine
            - compiler
    """

    tab_stop = ' '*4

    categories = sorted(set([item['category'] for item in test_data]))
    for category in categories:
        tests_this_category = [one_test for one_test in test_data if
                               one_test['category'] == category]
        print("%s: %d"%(category, len(tests_this_category)))

        machines = sorted(set([item['machine'] for item in tests_this_category]))
        for machine in machines:
            tests_this_machine = [one_test for one_test in tests_this_category if
                                  one_test['machine'] == machine]
            print("%s%s: %d"%(tab_stop, machine, len(tests_this_machine)))

            compilers = sorted(set([item['compiler'] for item in tests_this_machine]))
            for compiler in compilers:
                tests_this_compiler = [one_test for one_test in tests_this_machine if
                                       one_test['compiler'] == compiler]
                print("%s%s: %d"%(tab_stop*2, compiler, len(tests_this_compiler)))

###############################################################################
def _main_func(description):
###############################################################################
    args = parse_command_line(description)

    test_data = get_tests_from_xml(
        xml_machine = args.xml_machine,
        xml_category = args.xml_category,
        xml_compiler = args.xml_compiler,
        xml_testlist = args.xml_testlist)

    if args.count:
        count_test_data(test_data)
    else:
        print_test_data(test_data)
    
if __name__ == "__main__":
    _main_func(__doc__)
